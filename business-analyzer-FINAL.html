<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CDFWGR24FR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CDFWGR24FR');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Analyzer - FORAY Protocol</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <!--
    ============================================================================
    FORAY Business Use Case Analyzer
    ============================================================================
    Version:       2.5.0
    Created:       2026-01-29T00:00:00Z
    Modified:      2026-02-02T22:00:00Z

    Author:        Marvin Percival
    Email:         marvinp@dunin7.com
    GitHub:        github.com/DUNIN7/foray-kaspathon

    License:       Business Source License 1.1
    Copyright (c) 2026 Marvin Percival. All rights reserved.

    Changelog:
      v2.5.0 (2026-02-02)
        - Added Google Analytics 4 tracking (G-CDFWGR24FR)
        - Fixed Cloudflare email protection corruption in footer email link
        - Removed injected Cloudflare email-decode script tag
        - Repaired truncated file ending (closeMobileMenu, Escape handler, closing tags)

      v2.4.0 (2026-02-02)
        - Added "Start New Analysis" reset button next to Print button
        - Reset clears input, results, JSON, narrative, scrolls to top,
          and focuses the textarea for immediate re-entry
      
      v2.3.2 (2026-02-02)
        - Removed forced page break before narrative section; content
          now flows naturally after JSON/validation with no wasted space
        - Tightened JSON print font to 7pt for denser output
        - Removed break-before: page from main page @media print too
      
      v2.3.1 (2026-02-02)
        - Fixed print layout: narrative label + block wrapped in single
          container so page break keeps them together (no more orphaned
          "Transaction Narrative" header with blank page below)
        - Tightened print section margins and h3 spacing
      
      v2.3.0 (2026-02-02)
        - BUGFIX: detectIndustry() no longer defaults to manufacturing
          for unrecognized businesses; passes actual user description
          to API for contextual transaction generation
        - Added more keyword matches (biotech, shipping, cargo, utility, etc.)
        - Print report now includes Business Description as first section
        - Business description shown in italic with navy left-border styling
      
      v2.2.1 (2026-02-02)
        - Added "Print Full Report" button at bottom of narrative section
        - Print window auto-closes after print/cancel dialog completes
      
      v2.2.0 (2026-02-02)
        - Redesigned from 2-column side-by-side to stacked full-width layout
        - Input panel uses horizontal 2-column inner layout on wide screens
        - Results, JSON, and narrative all use full page width
        - Eliminated unbalanced tall-right-column problem
      
      v2.1.0 (2026-02-02)
        - Loading spinners converted to centered modal overlay
        - Both analysis and sample generation show full-screen loading popup
        - Loading modal always visible regardless of scroll position
      
      v2.0.0 (2026-02-02)
        - Adopted demo.html light-theme color profile and card layout
        - Added "Generate Sample Transaction" with JSON + narrative output
        - Collapsible JSON block with copy/download actions
        - Validation badge bar between JSON and narrative
        - Industry-specific sample transaction prompts (6 verticals)
        - Print stylesheet for professional output
        - Fixed API endpoint port (3002 -> 3001)
      
      v1.2.0 (2026-01-31)
        - Removed corrupted emoji from Analyze button
        - Changed "immutable" to "tamper-evident" (content review)
      
      v1.1.0 (2026-01-30)
        - Added unified navigation with responsive hamburger menu
      
      v1.0.0 (2026-01-29)
        - Initial release with AI-powered business analysis
    ============================================================================
    -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom right, #F7F9FA, #E8F4F5);
            min-height: 100vh;
            padding-top: 44px;
        }

        .font-mono { font-family: 'IBM Plex Mono', monospace; }

        /* === BULLETPROOF NAV CSS v4.0 - FULLY SELF-CONTAINED === */
        .nav { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; background: rgba(26, 29, 33, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(125, 211, 214, 0.1); font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px; line-height: 1.5; box-sizing: border-box; }
        .nav * { box-sizing: border-box; }
        .nav-logo { display: flex; align-items: center; gap: 0.5rem; text-decoration: none; font-family: inherit; font-size: inherit; line-height: inherit; }
        .nav-logo-text { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; line-height: 1; display: flex; align-items: center; }
        .nav-logo-foray { color: #0D7377; }
        .nav-logo-protocol { color: #F7F9FA; font-weight: 400; }
        .nav-badge { font-size: 0.65rem; padding: 0.2rem 0.5rem; background: #E6A817; color: #1A1D21; border-radius: 4px; font-weight: 600; line-height: 1; display: inline-block; vertical-align: middle; font-family: inherit; }
        .nav-links { display: flex; gap: 2rem; align-items: center; }
        .nav-link { color: #94A3A8; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; font-family: inherit; line-height: 1; }
        .nav-link:hover, .nav-link.active { color: #14B8B8; }
        .nav-hamburger { display: none; flex-direction: column; justify-content: center; align-items: center; width: 40px; height: 40px; background: transparent; border: none; cursor: pointer; z-index: 1001; padding: 8px; }
        .nav-hamburger span { display: block; width: 24px; height: 2px; background: #F7F9FA; margin: 3px 0; transition: all 0.3s ease; border-radius: 2px; }
        .nav-hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .nav-hamburger.active span:nth-child(2) { opacity: 0; }
        .nav-hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
        .nav-mobile-menu { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 29, 33, 0.98); backdrop-filter: blur(20px); z-index: 999; flex-direction: column; justify-content: center; align-items: center; gap: 2rem; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
        .nav-mobile-menu.active { opacity: 1; visibility: visible; }
        .nav-mobile-menu .nav-link { font-size: 1.5rem; font-weight: 500; color: #F7F9FA; line-height: 1; }
        .nav-mobile-menu .nav-link:hover { color: #14B8B8; }
        @media (max-width: 768px) { .nav-links { display: none; } .nav-hamburger { display: flex; } .nav-mobile-menu { display: flex; } }
        /* === END BULLETPROOF NAV CSS === */

        /* FORAY Brand Colors - identical to demo.html */
        :root {
            --primary-teal: #0D7377;
            --secondary-navy: #1B365D;
            --accent-cyan: #14B8B8;
            --highlight-mint: #7DD3D6;
            --action-amber: #E6A817;
            --text-dark: #1A1D21;
            --text-light: #F7F9FA;
            --bg-light: #F7F9FA;
            --bg-dark: #1A1D21;
            --gray-600: #636E72;
            --gray-400: #94A3A8;
            --gray-200: #E5E9EB;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
        }

        .page-header {
            padding: 1.5rem 1.5rem 0.75rem;
            margin-bottom: 1.5rem;
        }
        .page-header-content { max-width: 1200px; margin: 0 auto; }
        .page-header h1 {
            font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;
            display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;
        }
        .page-header .protocol-name { color: var(--primary-teal); }
        .page-header .protocol-word { color: var(--highlight-mint); }
        .page-header .page-name { color: var(--secondary-navy); }
        .version-badge {
            display: inline-block; padding: 0.25rem 0.5rem; font-size: 0.75rem;
            font-weight: 700; border-radius: 0.25rem; background: var(--action-amber); color: white;
        }
        .page-header p { font-size: 1rem; color: var(--gray-600); font-weight: 400; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem 2rem; }

        /* Card system - identical to demo.html */
        .card {
            background: white; border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); margin-bottom: 1.25rem; overflow: hidden;
        }
        .card-header {
            background: var(--bg-light); padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--highlight-mint);
        }
        .card-header h2 {
            color: var(--secondary-navy); font-size: 1.125rem; font-weight: 600;
            margin: 0; display: flex; align-items: center; gap: 0.5rem;
        }
        .card-body { padding: 1.5rem; background: #FFFFFF; }

        .section-intro { color: var(--gray-600); font-size: 0.9375rem; line-height: 1.5; margin-bottom: 1rem; }

        /* Stacked full-width layout */
        .main-grid { display: flex; flex-direction: column; gap: 1.25rem; }

        /* Input card: horizontal inner layout */
        .input-inner {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: start;
        }
        .input-inner .form-group { margin-bottom: 0; }
        .input-inner .form-group textarea { min-height: 160px; }
        .input-right { display: flex; flex-direction: column; gap: 0.75rem; }
        @media (max-width: 768px) { .input-inner { grid-template-columns: 1fr; } }

        /* Form elements - identical to demo.html */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label {
            display: block; font-weight: 600; color: var(--secondary-navy);
            margin-bottom: 0.5rem; font-size: 0.9375rem;
        }
        .form-group textarea {
            width: 100%; padding: 0.75rem 1rem; border: 2px solid #E8F4F5;
            border-radius: 0.5rem; font-size: 0.9375rem; font-family: 'IBM Plex Sans', sans-serif;
            transition: border-color 0.2s; background-color: #FFFFFF; min-height: 180px; resize: vertical;
        }
        .form-group textarea:focus { outline: none; border-color: var(--primary-teal); }
        .form-group textarea::placeholder { color: var(--gray-400); }
        .form-group .hint { font-size: 0.8125rem; color: var(--gray-400); margin-top: 0.375rem; }

        /* Buttons - identical to demo.html */
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem;
            font-size: 0.9375rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; font-family: 'IBM Plex Sans', sans-serif;
            text-decoration: none; display: inline-block;
        }
        .btn-primary { background: var(--primary-teal); color: white; }
        .btn-primary:hover { background: var(--accent-cyan); transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-light); color: var(--gray-600); border: 2px solid transparent; }
        .btn-secondary:hover { border-color: var(--gray-400); }
        .btn-generate {
            background: linear-gradient(135deg, var(--secondary-navy), var(--primary-teal));
            color: white; width: 100%;
        }
        .btn-generate:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Example buttons */
        .example-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.5rem; margin-top: 0.75rem;
        }
        .example-btn {
            padding: 0.5rem 0.625rem; background: white; border: 2px solid var(--bg-light);
            border-radius: 0.375rem; cursor: pointer; transition: all 0.2s; text-align: center;
            font-family: 'IBM Plex Sans', sans-serif; font-size: 0.8125rem; font-weight: 500;
            color: var(--secondary-navy); line-height: 1.3;
        }
        .example-btn:hover {
            border-color: var(--primary-teal);
            background: linear-gradient(135deg, rgba(13, 115, 119, 0.05), rgba(125, 211, 214, 0.05));
        }
        .example-btn small { display: block; color: var(--gray-400); font-size: 0.6875rem; font-weight: 400; margin-top: 0.125rem; }

        /* Welcome banner - identical to demo.html */
        .welcome-banner { border-left: 4px solid var(--primary-teal); background: linear-gradient(135deg, rgba(13, 115, 119, 0.05), rgba(125, 211, 214, 0.05)); }
        .welcome-banner .card-body { padding: 1.25rem; }
        .welcome-title { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .welcome-title h3 { margin: 0; color: var(--secondary-navy); font-size: 1.125rem; font-weight: 600; }
        .welcome-text { color: var(--gray-600); font-size: 0.9375rem; line-height: 1.6; }

        /* Loading Modal Overlay */
        .loading-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(27, 54, 93, 0.7); z-index: 2000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .loading-overlay.active { display: flex; }
        .loading-box {
            background: white; border-radius: 0.75rem; padding: 2.5rem 3rem;
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s; max-width: 400px; width: 90%;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .spinner {
            display: inline-block; width: 48px; height: 48px;
            border: 4px solid var(--gray-200); border-top-color: var(--primary-teal);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-box h3 { color: var(--secondary-navy); margin-top: 1.25rem; font-size: 1.125rem; font-weight: 600; }
        .loading-box p { color: var(--gray-600); margin-top: 0.5rem; font-size: 0.9375rem; line-height: 1.5; }

        /* Error */
        .error-msg {
            display: none; padding: 1rem 1.25rem; background: #FEF2F2;
            border: 2px solid #FCA5A5; border-left: 4px solid var(--error);
            border-radius: 0.5rem; color: #991B1B; margin-top: 1rem; font-size: 0.9375rem;
        }
        .error-msg.active { display: block; }

        /* Analysis results */
        .results { display: none; }
        .results.active { display: block; }
        .result-content {
            padding: 1.5rem; background: white; border-left: 4px solid var(--primary-teal);
            border-radius: 0.5rem; margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .result-content h3 { color: var(--secondary-navy); font-size: 1.125rem; margin-bottom: 0.75rem; }
        .result-content p, .result-content li { color: var(--gray-600); line-height: 1.6; margin-bottom: 0.5rem; font-size: 0.9375rem; }
        .result-content ul { padding-left: 1.5rem; }
        .result-content strong { color: var(--secondary-navy); }

        /* === SAMPLE TRANSACTION OUTPUT === */
        .sample-section { display: none; margin-top: 1.25rem; }
        .sample-section.active { display: block; }

        .sample-divider {
            border-top: 2px solid var(--highlight-mint); padding-top: 1.25rem; margin-top: 0.5rem;
        }
        .sample-intro { color: var(--gray-600); font-size: 0.9375rem; line-height: 1.5; margin-bottom: 1rem; }
        .sample-intro strong { color: var(--primary-teal); }

        .sample-output { display: none; margin-top: 1.25rem; }
        .sample-output.active { display: block; }

        /* JSON block - uses demo.html json-container pattern */
        .json-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.25rem; background: var(--bg-light);
            border: 2px solid var(--primary-teal); border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0; cursor: pointer; user-select: none;
        }
        .json-header:hover { background: #EFF7F7; }
        .json-header-title {
            color: var(--secondary-navy); font-weight: 600; font-size: 0.9375rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .json-header-title .schema-tag {
            font-size: 0.6875rem; padding: 0.15rem 0.5rem; background: var(--action-amber);
            color: white; border-radius: 0.25rem; font-weight: 700;
        }
        .json-header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .json-small-btn {
            padding: 0.25rem 0.75rem; background: white; border: 1px solid var(--gray-200);
            border-radius: 0.25rem; color: var(--gray-600); font-size: 0.75rem; font-weight: 500;
            cursor: pointer; font-family: 'IBM Plex Sans', sans-serif; transition: all 0.2s;
        }
        .json-small-btn:hover { border-color: var(--primary-teal); color: var(--primary-teal); }
        .json-toggle { color: var(--gray-400); font-size: 0.75rem; transition: transform 0.3s; margin-left: 0.5rem; }
        .json-toggle.collapsed { transform: rotate(-90deg); }
        .json-body {
            max-height: 400px; overflow-y: auto; padding: 1.25rem;
            background: var(--bg-dark); border: 2px solid var(--primary-teal);
            border-radius: 0 0 0.5rem 0.5rem; transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .json-body.collapsed { max-height: 0; padding: 0 1.25rem; overflow: hidden; }
        .json-body pre {
            color: var(--text-light); font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8125rem; line-height: 1.5; margin: 0; white-space: pre-wrap; word-break: break-word;
        }
        .json-body::-webkit-scrollbar { width: 6px; }
        .json-body::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .json-body::-webkit-scrollbar-thumb { background: rgba(13,115,119,0.4); border-radius: 3px; }

        /* Validation bar */
        .validation-bar {
            display: flex; gap: 0.75rem; align-items: center; margin-top: 0.75rem;
            padding: 0.625rem 1rem; background: rgba(16, 185, 129, 0.06);
            border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 0.375rem; font-size: 0.8125rem;
        }
        .validation-bar.has-warnings { background: rgba(245, 158, 11, 0.06); border-color: rgba(245, 158, 11, 0.2); }
        .validation-bar.has-errors { background: rgba(239, 68, 68, 0.06); border-color: rgba(239, 68, 68, 0.2); }
        .v-badge { padding: 0.2rem 0.625rem; border-radius: 0.25rem; font-weight: 700; font-size: 0.75rem; }
        .v-badge.valid { background: rgba(16, 185, 129, 0.15); color: #059669; }
        .v-badge.warning { background: rgba(245, 158, 11, 0.15); color: #D97706; }
        .v-badge.error { background: rgba(239, 68, 68, 0.15); color: #DC2626; }
        .v-detail { color: var(--gray-600); font-size: 0.8125rem; }

        /* Narrative block */
        .narrative-block {
            margin-top: 1.25rem; background: white; border-radius: 0.5rem;
            border: 2px solid var(--highlight-mint); border-left: 4px solid var(--primary-teal);
            overflow: hidden;
        }
        .narrative-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.25rem; background: var(--bg-light);
            border-bottom: 1px solid var(--gray-200);
        }
        .narrative-header-title { color: var(--secondary-navy); font-weight: 600; font-size: 0.9375rem; }
        .narrative-body { padding: 1.25rem; }
        .narrative-body p { color: var(--gray-600); font-size: 0.9375rem; line-height: 1.75; margin-bottom: 0.75rem; }
        .narrative-body strong { color: var(--secondary-navy); }

        /* Footer - identical to demo.html */
        .footer { text-align: center; color: var(--gray-600); padding: 2rem 1.5rem; }
        .footer a { color: var(--primary-teal); text-decoration: none; font-weight: 600; }
        .footer a:hover { color: var(--accent-cyan); text-decoration: underline; }

        /* === PRINT === */
        @media print {
            body { background: white !important; padding: 0; }
            /* Hide interactive elements */
            .nav, .nav-mobile-menu, .loading-overlay, .welcome-banner, .footer,
            .example-grid, .error-msg, .input-right { display: none !important; }
            /* Hide the input card entirely */
            .main-grid > .card:first-child { display: none !important; }
            /* Force stacked layout */
            .main-grid { display: block !important; }
            .container { max-width: 100%; padding: 0 1rem; }
            /* Page header */
            .page-header { padding: 10px 0; margin-bottom: 15px; border-bottom: 2px solid #0D7377; }
            .page-header h1 { font-size: 1.6em; }
            .version-badge { background: #999; }
            /* Cards */
            .card { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
            .card-header { background: #f5f5f5 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .card-body { padding: 1rem; }
            /* Force results visible */
            .results { display: block !important; }
            .results .result-content { box-shadow: none; border-left: 4px solid #0D7377; break-inside: avoid; page-break-inside: avoid; margin-bottom: 0.75rem; }
            .result-content h3 { color: #1B365D; font-size: 1rem; }
            .result-content p, .result-content li { color: #333; font-size: 10pt; line-height: 1.5; }
            .result-content strong { color: #1B365D; }
            /* Sample transaction section */
            .sample-section { display: block !important; }
            .sample-section .btn { display: none !important; }
            .sample-output { display: block !important; }
            /* JSON block */
            .json-header { background: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .json-header-actions { display: none !important; }
            .json-body { max-height: none !important; background: #f8f8f8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .json-body.collapsed { max-height: none !important; padding: 1.25rem !important; overflow: visible !important; }
            .json-body pre { color: #1a1a1a; font-size: 7.5pt; line-height: 1.4; word-break: break-all; }
            /* Validation bar */
            .validation-bar { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* Narrative block */
            .narrative-block { margin-top: 1rem; }
            .narrative-header { background: #f5f5f5 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .narrative-header .json-small-btn { display: none !important; }
            .narrative-body p { color: #333; font-size: 10pt; line-height: 1.6; }
            .narrative-body strong { color: #0D7377; }
        }

        @media (max-width: 768px) {
            .example-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <a href="index.html" class="nav-logo">
            <span class="nav-logo-text">
                <span class="nav-logo-foray">FORAY</span> <span class="nav-logo-protocol">Protocol</span>
            </span>
            <span class="nav-badge">v4.1</span>
        </a>
        <div class="nav-links">
            <a href="demo.html" class="nav-link">Demo</a>
            <a href="docs.html" class="nav-link">Documentation</a>
            <a href="examples.html" class="nav-link">Examples</a>
            <a href="about.html" class="nav-link">About</a>
            <a href="https://github.com/DUNIN7/foray-kaspathon" class="nav-link" target="_blank">GitHub</a>
        </div>
        <button class="nav-hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">
            <span></span><span></span><span></span>
        </button>
    </nav>
    <div class="nav-mobile-menu" id="mobileMenu">
        <a href="demo.html" class="nav-link" onclick="closeMobileMenu()">Demo</a>
        <a href="docs.html" class="nav-link" onclick="closeMobileMenu()">Documentation</a>
        <a href="examples.html" class="nav-link" onclick="closeMobileMenu()">Examples</a>
        <a href="about.html" class="nav-link" onclick="closeMobileMenu()">About</a>
        <a href="https://github.com/DUNIN7/foray-kaspathon" class="nav-link" target="_blank" onclick="closeMobileMenu()">GitHub</a>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <h1>
                    <span class="protocol-name">FORAY</span>
                    <span class="protocol-word">Protocol</span>
                    <span class="page-name">Business Analyzer</span>
                </h1>
                <span class="version-badge">v4.1</span>
            </div>
            <p>Discover how FORAY Protocol maps to your business transactions</p>
        </div>
    </div>

    <div class="container">
        <!-- Welcome Banner -->
        <div class="card welcome-banner" id="welcomeBanner">
            <div class="card-body">
                <div class="welcome-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--primary-teal);">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4M12 8h.01"></path>
                    </svg>
                    <h3>How It Works</h3>
                </div>
                <p class="welcome-text">
                    Describe your business and our AI will analyze your transaction types, map them to FORAY's 4-component model
                    (Arrangements, Accruals, Anticipations, Actions), and identify compliance benefits.
                    Then generate a sample FORAY transaction specific to your industry.
                </p>
            </div>
        </div>

        <!-- Main Layout - Stacked Full Width -->
        <div class="main-grid">
            <!-- Input Card -->
            <div class="card">
                <div class="card-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="7.5 4.21 12 6.81 16.5 4.21"/>
                            <polyline points="7.5 19.79 7.5 14.6 3 12"/>
                            <polyline points="21 12 16.5 14.6 16.5 19.79"/>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                        Describe Your Business
                    </h2>
                </div>
                <div class="card-body">
                    <div class="input-inner">
                        <div class="form-group">
                            <label>Tell us about your company, industry, and key transactions</label>
                            <textarea id="businessDescription" placeholder="Example: We're a mid-sized defense contractor manufacturing precision components for military aircraft. We manage complex supply chains with multiple tier-1 and tier-2 suppliers, track labor hours against government contracts, and need to maintain DCAA compliance for cost accounting..."></textarea>
                            <div class="hint">Include industry, transaction types, compliance requirements, and pain points</div>
                        </div>
                        <div class="input-right">
                            <p style="font-weight: 600; color: var(--secondary-navy); font-size: 0.9375rem;">Quick Examples:</p>
                            <div class="example-grid">
                                <button class="example-btn" data-example="defense">Defense Contractor <small>DCAA/DFARS</small></button>
                                <button class="example-btn" data-example="finance">Financial Services <small>SOX/Basel III</small></button>
                                <button class="example-btn" data-example="energy">Energy Company <small>PPA/FERC</small></button>
                                <button class="example-btn" data-example="manufacturing">Manufacturing <small>ISO 9001</small></button>
                                <button class="example-btn" data-example="pharma">Pharmaceutical <small>FDA/cGMP</small></button>
                                <button class="example-btn" data-example="logistics">Logistics <small>Customs/Hazmat</small></button>
                            </div>
                            <button class="btn btn-primary" id="analyzeBtn" style="width: 100%; margin-top: 0.5rem;">Analyze My Business with FORAY</button>
                        </div>
                    </div>
                    <div class="error-msg" id="errorMsg"></div>
                </div>
            </div>

            <!-- Results Card -->
            <div class="card" id="resultsCard">
                <div class="card-header">
                    <h2>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        FORAY Analysis Results
                    </h2>
                </div>
                <div class="card-body">
                    <p class="section-intro">
                        Our AI identifies your key transaction types and explains how FORAY's 4-component architecture creates
                        tamper-evident audit trails while protecting sensitive data.
                    </p>

                    <div class="results" id="results"></div>

                    <!-- Sample Transaction Section -->
                    <div class="sample-section" id="sampleSection">
                        <div class="sample-divider">
                            <p class="sample-intro">
                                <strong>See it in action:</strong>
                                Generate a sample FORAY v4.1 transaction for your industry, with structured JSON
                                and a plain-language narrative suitable for audit committee review.
                            </p>
                            <button class="btn btn-generate" id="generateSampleBtn">Generate Sample FORAY Transaction</button>
                        </div>

                        <div class="sample-output" id="sampleOutput">
                            <!-- JSON Block -->
                            <div class="json-header" onclick="toggleJSON()">
                                <span class="json-header-title">
                                    FORAY Protocol JSON
                                    <span class="schema-tag">v4.1</span>
                                </span>
                                <div class="json-header-actions">
                                    <button class="json-small-btn" onclick="event.stopPropagation(); copyJSON()">Copy</button>
                                    <button class="json-small-btn" onclick="event.stopPropagation(); downloadJSON()">Download</button>
                                    <span class="json-toggle" id="jsonToggle">&#9660;</span>
                                </div>
                            </div>
                            <div class="json-body" id="jsonBody">
                                <pre id="jsonContent"></pre>
                            </div>

                            <!-- Validation -->
                            <div class="validation-bar" id="validationBar">
                                <span class="v-badge valid" id="vBadge">VALID</span>
                                <span class="v-detail" id="vDetail">Schema v4.1 &middot; All components verified</span>
                            </div>

                            <!-- Narrative -->
                            <div class="narrative-block">
                                <div class="narrative-header">
                                    <span class="narrative-header-title">Transaction Narrative</span>
                                    <button class="json-small-btn" onclick="printReport()">Print</button>
                                </div>
                                <div class="narrative-body" id="narrativeContent"></div>
                            </div>

                            <!-- Bottom Actions -->
                            <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1.25rem; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="printReport()" style="padding: 0.625rem 2.5rem;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 0.375rem;">
                                        <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                        <rect x="6" y="14" width="12" height="8"></rect>
                                    </svg>
                                    Print Full Report
                                </button>
                                <button class="btn btn-secondary" onclick="resetAnalyzer()" style="padding: 0.625rem 2.5rem; border: 2px solid var(--gray-200);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 0.375rem;">
                                        <polyline points="1 4 1 10 7 10"></polyline>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                    </svg>
                                    Start New Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>
            <strong>FORAY Protocol</strong> &mdash; Privacy-Preserving Blockchain Audit Infrastructure<br>
            <a href="https://github.com/DUNIN7/foray-kaspathon" target="_blank">GitHub</a> &bull;
            <a href="mailto:marvinp@dunin7.com">marvinp@dunin7.com</a> &bull;
            Marvin Percival
        </p>
    </div>

    <!-- Loading Modal Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <h3 id="loadingTitle">Analyzing...</h3>
            <p id="loadingMessage">This typically takes 10-15 seconds.</p>
        </div>
    </div>

    <script>
        // ================================================================
        // Configuration
        // ================================================================
        var API_BASE = 'http://localhost:3001';
        // For Cloudflare Tunnel: var API_BASE = 'https://foray.dunin7.com';

        var currentFORAYJSON = null;
        var lastBusinessDescription = '';

        // ================================================================
        // Loading Modal
        // ================================================================
        function showLoading(title, message) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ================================================================
        // Examples
        // ================================================================
        var examples = {
            defense: "We're a mid-sized defense contractor manufacturing precision components for military aircraft. We manage complex supply chains with multiple tier-1 and tier-2 suppliers, track labor hours against government contracts, and need to maintain DCAA compliance for cost accounting. Our biggest challenges are documenting indirect cost allocations, proving timekeeping accuracy, and managing material traceability for sensitive components.",
            finance: "We're a regional investment bank specializing in structured products and derivatives trading. We execute hundreds of FX trades daily, manage RMBS securitizations, and provide repo financing to institutional clients. We need SOX 404 compliance, Basel III capital adequacy reporting, and Dodd-Frank swap data repository submissions. Our main pain points are cross-system reconciliation and audit trail integrity.",
            energy: "We're a renewable energy developer operating solar farms across North Africa with power sales into European markets. We manage long-term PPAs with utilities, track REC generation and trading, handle cross-border settlements in multiple currencies, and coordinate with transmission operators. We need FERC compliance, project finance covenant tracking, and sovereign guarantee verification.",
            manufacturing: "We manufacture industrial pumps and valves for oil & gas applications. We manage multi-level BOMs with specialized metallurgy, track work orders through our job shop, allocate labor and overhead costs, and maintain ISO 9001 quality certifications. Our challenges include cost variance analysis, supplier quality tracking, and transfer pricing documentation for our Mexican subsidiary.",
            pharma: "We're a pharmaceutical manufacturer producing generic drugs under contract for major brands. We maintain FDA cGMP compliance, track batch genealogy from raw materials through finished goods, manage complex royalty calculations, and coordinate with contract testing laboratories. Our key needs are 21 CFR Part 11 compliance, lot traceability for recalls, and clinical trial cost tracking.",
            logistics: "We operate a third-party logistics network providing warehousing and distribution services across 12 facilities. We manage inventory for 200+ clients, track freight movements across multiple carriers, handle customs documentation for international shipments, and process complex billing with tiered rate structures. Our pain points are proof of custody, invoice disputes, and regulatory compliance for hazmat shipments."
        };

        var sampleTxPrompts = {
            defense: { name: "Defense Contract Labor Allocation", description: "Monthly labor cost allocation for Contract W56HZV-25-C-0042 (Apache AH-64E main rotor hub). Direct labor: 320 hours at $85/hr ($27,200). Overhead allocation at 142% of direct labor ($38,624). G&A at 12% of total ($7,898.88). Material costs: $45,000 titanium alloy, $12,500 fasteners. CAS 418 compliant allocation. Period: January 2026. Contractor: Precision Defense Manufacturing LLC." },
            finance: { name: "FX Spot Trade USD/JPY", description: "Foreign exchange spot trade executed January 27, 2026. Sell 5,000,000 USD and buy 732,500,000 JPY at spot rate 146.50. Settlement date T+2 on January 29, 2026. Counterparty: Mizuho Securities. Trade reference: FX-2026-0127-005. Basel III RWA impact calculated. SOX 404 controls applied." },
            energy: { name: "Solar PPA Monthly Settlement", description: "Monthly settlement for 25-year Solar PPA between SolarNorth Africa SARL and Iberdrola Espana. January 2026 delivery: 12,450 MWh at EUR 0.058/kWh (EUR 722,100). RECs generated: 12,450 at EUR 3.20 each (EUR 39,840). Curtailment credit: 380 MWh at 75% rate. Cross-border settlement Morocco to Spain via SWIFT. FERC and CNMC compliance." },
            manufacturing: { name: "Work Order Cost Roll-Up", description: "Work order WO-2026-0289 for 50 units of Model P-4500 centrifugal pump. Direct materials: $125,000 (stainless steel casings, impellers, mechanical seals). Direct labor: 480 hours machining at $45/hr, 160 hours assembly at $38/hr. Manufacturing overhead at 175% of direct labor. Quality testing: 100% hydrostatic test, 10% X-ray inspection. ISO 9001 documented. Completion date January 28, 2026." },
            pharma: { name: "Drug Batch Genealogy Record", description: "Production batch BATCH-2026-AMX-0142 of Amoxicillin 500mg capsules. 500,000 units manufactured January 20-24, 2026. Raw materials: API from Supplier S-001 (CoA lot AM-2025-889), excipients from Supplier S-004. In-process testing: dissolution 95.2%, content uniformity 99.1%, microbial limits pass. QC release by Quality Director. FDA 21 CFR Part 211 compliant. Royalty at 4.5% of wholesale ($0.12/unit = $60,000 batch value, $2,700 royalty)." },
            logistics: { name: "Cross-Border Freight Settlement", description: "International shipment SHP-2026-00847 from Shanghai to Chicago via Long Beach. 2x40ft containers of industrial electronics (HTS 8537.10). Ocean freight: $4,200/container. Customs brokerage: $850. Drayage Long Beach to rail: $1,200. Rail Chicago: $2,800. Warehouse receiving: $450. Total: $13,700. Customs duties at 3.4% on declared value $285,000 ($9,690). Client: TechDistro Inc. Hazmat documentation for lithium batteries (UN3481)." }
        };

        // ================================================================
        // Event Listeners
        // ================================================================
        document.querySelectorAll('.example-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.getElementById('businessDescription').value = examples[btn.dataset.example];
            });
        });
        document.getElementById('analyzeBtn').addEventListener('click', analyzeBusinessAI);
        document.getElementById('generateSampleBtn').addEventListener('click', generateSampleTransaction);

        // ================================================================
        // Business Analysis
        // ================================================================
        async function analyzeBusinessAI() {
            var description = document.getElementById('businessDescription').value.trim();
            if (!description) { showError('Please describe your business first.'); return; }
            lastBusinessDescription = description;

            document.getElementById('analyzeBtn').disabled = true;
            showLoading('Analyzing Your Business', 'Mapping your transactions to FORAY components. This typically takes 10-15 seconds.');
            document.getElementById('results').classList.remove('active');
            document.getElementById('errorMsg').classList.remove('active');
            document.getElementById('sampleSection').classList.remove('active');
            document.getElementById('sampleOutput').classList.remove('active');

            try {
                var response = await fetch(API_BASE + '/api/analyze-business', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ businessDescription: description })
                });
                if (!response.ok) {
                    var errData = await response.json().catch(function() { return {}; });
                    throw new Error(errData.error || 'Request failed: ' + response.status);
                }
                var data = await response.json();
                displayResults(data.analysis || '');
            } catch (error) {
                console.error('Analysis error:', error);
                showError('Analysis failed: ' + error.message + '. Ensure the API server is running on port 3001.');
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                hideLoading();
            }
        }

        function displayResults(html) {
            var el = document.getElementById('results');
            el.innerHTML = '<div class="result-content">' + html + '</div>';
            el.classList.add('active');
            document.getElementById('sampleSection').classList.add('active');
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ================================================================
        // Sample Transaction Generation
        // ================================================================
        async function generateSampleTransaction() {
            var btn = document.getElementById('generateSampleBtn');
            var outputEl = document.getElementById('sampleOutput');

            btn.disabled = true;
            showLoading('Generating FORAY Transaction', 'Creating v4.1 JSON structure and narrative companion. This typically takes 10-15 seconds.');
            outputEl.classList.remove('active');

            var prompt = detectIndustry(lastBusinessDescription);

            try {
                var response = await fetch(API_BASE + '/api/generate-foray', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transactionName: prompt.name, transactionDescription: prompt.description })
                });
                if (!response.ok) {
                    var errData = await response.json().catch(function() { return {}; });
                    throw new Error(errData.error || 'Generation failed: ' + response.status);
                }
                var data = await response.json();
                currentFORAYJSON = data.forayJSON;

                document.getElementById('jsonContent').textContent = JSON.stringify(data.forayJSON, null, 2);
                showValidation(data.validation);
                showNarrative(data.narrative);

                outputEl.classList.add('active');
                outputEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch (error) {
                console.error('Generation error:', error);
                showError('Transaction generation failed: ' + error.message);
            } finally {
                btn.disabled = false;
                hideLoading();
            }
        }

        function detectIndustry(desc) {
            var d = desc.toLowerCase();
            if (d.includes('defense') || d.includes('military') || d.includes('dcaa') || d.includes('dfars')) return sampleTxPrompts.defense;
            if (d.includes('bank') || d.includes('derivative') || d.includes('trading') || d.includes('securitiz') || d.includes('hedge fund') || d.includes('forex')) return sampleTxPrompts.finance;
            if (d.includes('energy') || d.includes('solar') || d.includes('ppa') || d.includes('renewable') || d.includes('power plant') || d.includes('utility')) return sampleTxPrompts.energy;
            if (d.includes('manufactur') || d.includes('pump') || d.includes('valve') || d.includes('bom') || d.includes('work order') || d.includes('assembly')) return sampleTxPrompts.manufacturing;
            if (d.includes('pharma') || d.includes('drug') || d.includes('fda') || d.includes('cgmp') || d.includes('clinical') || d.includes('biotech')) return sampleTxPrompts.pharma;
            if (d.includes('logistics') || d.includes('warehouse') || d.includes('freight') || d.includes('customs') || d.includes('shipping') || d.includes('cargo')) return sampleTxPrompts.logistics;
            // No match  generate a transaction based on the user's actual description
            return {
                name: 'Industry-Specific Transaction',
                description: 'Generate a realistic FORAY v4.1 transaction for this business: ' + desc.substring(0, 600)
            };
        }

        function showValidation(v) {
            var bar = document.getElementById('validationBar');
            var badge = document.getElementById('vBadge');
            var detail = document.getElementById('vDetail');
            if (!v) { badge.textContent = 'GENERATED'; detail.textContent = 'Validation data not available'; return; }
            if (v.valid && v.warnings.length === 0) {
                bar.className = 'validation-bar'; badge.className = 'v-badge valid'; badge.textContent = 'VALID';
                detail.textContent = 'Schema v4.1 \u00B7 All components verified';
            } else if (v.valid) {
                bar.className = 'validation-bar has-warnings'; badge.className = 'v-badge warning';
                badge.textContent = v.warnings.length + ' WARNING' + (v.warnings.length > 1 ? 'S' : '');
                detail.textContent = v.warnings[0];
            } else {
                bar.className = 'validation-bar has-errors'; badge.className = 'v-badge error';
                badge.textContent = v.errors.length + ' ERROR' + (v.errors.length > 1 ? 'S' : '');
                detail.textContent = v.errors[0];
            }
        }

        function showNarrative(narrative) {
            var el = document.getElementById('narrativeContent');
            if (!narrative) {
                el.innerHTML = '<p style="color: var(--gray-400); font-style: italic;">Narrative not available. The JSON above contains the complete structured data.</p>';
                return;
            }
            el.innerHTML = narrative.split(/\n\n+/).map(function(p) {
                return '<p>' + p.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') + '</p>';
            }).join('');
        }

        // ================================================================
        // JSON Controls
        // ================================================================
        function toggleJSON() {
            document.getElementById('jsonBody').classList.toggle('collapsed');
            document.getElementById('jsonToggle').classList.toggle('collapsed');
        }

        async function copyJSON() {
            if (!currentFORAYJSON) return;
            try {
                await navigator.clipboard.writeText(JSON.stringify(currentFORAYJSON, null, 2));
                alert('FORAY JSON copied to clipboard.');
            } catch (e) {
                var ta = document.createElement('textarea');
                ta.value = JSON.stringify(currentFORAYJSON, null, 2);
                document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                alert('FORAY JSON copied to clipboard.');
            }
        }

        function downloadJSON() {
            if (!currentFORAYJSON) return;
            var id = currentFORAYJSON.transaction_id || 'sample-transaction';
            var blob = new Blob([JSON.stringify(currentFORAYJSON, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a'); a.href = url; a.download = 'foray-' + id + '.json'; a.click();
            URL.revokeObjectURL(url);
        }

        // ================================================================
        // Print Report
        // ================================================================
        function printReport() {
            var businessDesc = lastBusinessDescription || '';
            var resultsHTML = document.getElementById('results').innerHTML || '';
            var jsonText = document.getElementById('jsonContent').textContent || '';
            var validationHTML = document.getElementById('validationBar') ? document.getElementById('validationBar').outerHTML : '';
            var narrativeHTML = document.getElementById('narrativeContent').innerHTML || '';

            var win = window.open('', '_blank');
            win.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8">');
            win.document.write('<title>FORAY Business Analysis Report</title>');
            win.document.write('<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">');
            win.document.write('<style>');
            win.document.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
            win.document.write('body { font-family: "IBM Plex Sans", sans-serif; color: #333; padding: 2rem; max-width: 900px; margin: 0 auto; }');
            win.document.write('.header { border-bottom: 3px solid #0D7377; padding-bottom: 0.75rem; margin-bottom: 1.5rem; }');
            win.document.write('.header h1 { font-size: 1.5rem; color: #1B365D; }');
            win.document.write('.header h1 span { color: #0D7377; }');
            win.document.write('.header p { color: #636E72; font-size: 0.875rem; margin-top: 0.25rem; }');
            win.document.write('.section-label { font-size: 1.125rem; font-weight: 700; color: #1B365D; margin: 1.25rem 0 0.5rem; padding-bottom: 0.25rem; border-bottom: 2px solid #7DD3D6; }');
            win.document.write('.biz-desc { background: #f7f9fa; border-left: 4px solid #1B365D; padding: 1rem 1.25rem; margin: 0.75rem 0; border-radius: 0 0.375rem 0.375rem 0; }');
            win.document.write('.biz-desc p { font-size: 0.9375rem; line-height: 1.6; color: #333; font-style: italic; }');
            win.document.write('.analysis-content h3 { color: #0D7377; font-size: 1rem; font-weight: 600; margin: 0.75rem 0 0.375rem; }');
            win.document.write('.analysis-content p, .analysis-content li { font-size: 0.9375rem; line-height: 1.6; margin-bottom: 0.375rem; color: #333; }');
            win.document.write('.analysis-content ul { padding-left: 1.5rem; margin-bottom: 0.75rem; }');
            win.document.write('.analysis-content strong { color: #1B365D; }');
            win.document.write('.json-block { background: #f5f5f5; border: 1px solid #ccc; border-left: 4px solid #0D7377; border-radius: 0.375rem; padding: 1rem; margin: 0.75rem 0; overflow-x: auto; }');
            win.document.write('.json-block pre { font-family: "IBM Plex Mono", monospace; font-size: 7.5pt; line-height: 1.4; color: #1a1a1a; white-space: pre-wrap; word-break: break-word; }');
            win.document.write('.validation-bar { display: flex; gap: 0.75rem; align-items: center; margin: 0.75rem 0; padding: 0.5rem 0.75rem; background: rgba(16,185,129,0.06); border: 1px solid rgba(16,185,129,0.2); border-radius: 0.375rem; font-size: 0.8125rem; }');
            win.document.write('.v-badge { padding: 0.2rem 0.625rem; border-radius: 0.25rem; font-weight: 700; font-size: 0.75rem; }');
            win.document.write('.v-badge.valid { background: rgba(16,185,129,0.15); color: #059669; }');
            win.document.write('.v-badge.warning { background: rgba(245,158,11,0.15); color: #D97706; }');
            win.document.write('.v-badge.error { background: rgba(239,68,68,0.15); color: #DC2626; }');
            win.document.write('.v-detail { color: #636E72; }');
            win.document.write('.narrative-block { border-left: 4px solid #0D7377; padding: 1rem 1.25rem; margin: 0.75rem 0; background: #f9fefe; border-radius: 0 0.375rem 0.375rem 0; }');
            win.document.write('.narrative-block p { font-size: 0.9375rem; line-height: 1.75; margin-bottom: 0.625rem; color: #333; }');
            win.document.write('.narrative-block strong { color: #0D7377; }');
            win.document.write('.narrative-section { margin-top: 1.25rem; }');
            win.document.write('.footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ddd; font-size: 0.8125rem; color: #636E72; text-align: center; }');
            win.document.write('@media print { body { padding: 0.5rem; } .json-block pre { font-size: 7pt; line-height: 1.3; } }');
            win.document.write('</style></head><body>');

            // Header
            win.document.write('<div class="header">');
            win.document.write('<h1><span>FORAY</span> Protocol &mdash; Business Analysis Report</h1>');
            win.document.write('<p>Generated ' + new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) + ' &bull; Schema v4.1 &bull; foray.dunin7.com</p>');
            win.document.write('</div>');

            // Business Description
            if (businessDesc) {
                var safeDesc = businessDesc.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
                win.document.write('<div class="section-label">Business Description</div>');
                win.document.write('<div class="biz-desc"><p>' + safeDesc + '</p></div>');
            }

            // Analysis Results
            if (resultsHTML) {
                win.document.write('<div class="section-label">FORAY Analysis</div>');
                win.document.write('<div class="analysis-content">' + resultsHTML + '</div>');
            }

            // JSON
            if (jsonText) {
                win.document.write('<div class="section-label">Sample FORAY Transaction (JSON)</div>');
                win.document.write('<div class="json-block"><pre>' + jsonText.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre></div>');
            }

            // Validation
            if (validationHTML) {
                win.document.write(validationHTML);
            }

            // Narrative (wrapped so label + block stay together on page break)
            if (narrativeHTML) {
                win.document.write('<div class="narrative-section">');
                win.document.write('<div class="section-label">Transaction Narrative</div>');
                win.document.write('<div class="narrative-block">' + narrativeHTML + '</div>');
                win.document.write('</div>');
            }

            // Footer
            win.document.write('<div class="footer">');
            win.document.write('FORAY Protocol &bull; Marvin Percival &bull; marvinp@dunin7.com &bull; github.com/DUNIN7/foray-kaspathon');
            win.document.write('</div>');

            win.document.write('</body></html>');
            win.document.close();
            win.focus();
            setTimeout(function() {
                win.print();
                win.close();
            }, 500);
        }

        // ================================================================
        // Utility
        // ================================================================
        function resetAnalyzer() {
            // Clear input
            document.getElementById('businessDescription').value = '';
            lastBusinessDescription = '';
            currentFORAYJSON = null;

            // Hide results and sample sections
            document.getElementById('results').classList.remove('active');
            document.getElementById('results').innerHTML = '';
            document.getElementById('sampleSection').classList.remove('active');
            document.getElementById('sampleOutput').classList.remove('active');
            document.getElementById('errorMsg').classList.remove('active');

            // Clear generated content
            document.getElementById('jsonContent').textContent = '';
            document.getElementById('narrativeContent').innerHTML = '';

            // Re-enable buttons
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('generateSampleBtn').disabled = false;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('businessDescription').focus();
        }

        function showError(msg) {
            var el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('active');
        }

        function toggleMobileMenu() {
            document.querySelector('.nav-hamburger').classList.toggle('active');
            var m = document.getElementById('mobileMenu'); m.classList.toggle('active');
            document.body.style.overflow = m.classList.contains('active') ? 'hidden' : '';
        }
        function closeMobileMenu() {
            document.querySelector('.nav-hamburger').classList.remove('active');
            document.getElementById('mobileMenu').classList.remove('active');
            document.body.style.overflow = '';
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeMobileMenu();
        });
    </script>
</body>
</html>