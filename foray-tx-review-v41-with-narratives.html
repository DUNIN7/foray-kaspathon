<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FORAY Protocol Transaction Review v4.1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'IBM Plex Sans', sans-serif; }
    .font-mono { font-family: 'IBM Plex Mono', monospace; }
    
    @media print {
      .no-print { display: none !important; }
      body { 
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        background: white !important;
      }
      .print-break-inside-avoid { break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useMemo } = React;

    // FORAY Brand Colors
    const forayColors = {
      primaryTeal: '#0D7377',
      secondaryNavy: '#1B365D',
      accentCyan: '#14B8B8',
      highlightMint: '#7DD3D6',
      actionAmber: '#E6A817',
      textDark: '#1A1D21',
      textLight: '#F7F9FA',
      bgLight: '#F7F9FA',
      bgDark: '#1A1D21',
      gray600: '#636E72',
      gray400: '#94A3A8',
      successGreen: '#10B981',
      warningOrange: '#F59E0B',
      errorRed: '#EF4444'
    };

    // Icons as SVG components
    const ChevronDown = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M6 9l6 6 6-6"/>
      </svg>
    );
    
    const ChevronRight = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    );
    
    const Lock = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
    );
    
    const Unlock = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>
      </svg>
    );
    
    const X = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );
    
    const FileText = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
      </svg>
    );
    
    const BookOpen = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
      </svg>
    );
    
    const TrendingUp = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
      </svg>
    );
    
    const DollarSign = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
    );
    
    const Users = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    );
    
    const Activity = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
    );
    
    const Upload = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    );
    
    const AlertCircle = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    );
    
    const CheckCircle = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
    );
    
    const Link2 = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"/><line x1="8" y1="12" x2="16" y2="12"/>
      </svg>
    );
    
    const GitBranch = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/>
      </svg>
    );
    
    const ArrowRight = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
      </svg>
    );
    
    const Layers = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>
      </svg>
    );
    
    const Printer = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
      </svg>
    );
    
    const RotateCcw = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
      </svg>
    );
    
    const Database = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
      </svg>
    );
    
    const Server = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>
      </svg>
    );

    // V4.1 Migration Utility
    function migrateToV41(transaction) {
      const version = transaction.schema_version || transaction._v || '3.0';
      
      if (version === '4.1') return transaction;
      
      const v41 = JSON.parse(JSON.stringify(transaction));
      v41.schema_version = '4.1';
      
      // Convert top-level fields to foray_core structure if needed
      if (!v41.foray_core) {
        v41.foray_core = {
          entity: v41.entity || v41.e || 'Unknown',
          entity_hash: v41.entity_hash || null,
          transaction_type: v41.transaction_type || v41.ty || 'unknown',
          total_value: v41.total_value || v41.tv || 0,
          currency: v41.currency || v41.cu || 'USD',
          status: v41.status || 'active',
          compliance_flags: v41.compliance_flags || v41.rc || []
        };
      }
      
      // Migrate blockchain_anchor from V3 kaspa_commitment
      if (!v41.blockchain_anchor && (v41.kaspa_commitment || v41._kc)) {
        v41.blockchain_anchor = {
          kaspa_tx_id: v41.kaspa_commitment || v41._kc || null,
          block_height: v41.block_height || v41.bh || null,
          confirmation_time_ms: null,
          anchored_at: v41.timestamp || v41.ts || null
        };
      }
      
      // Migrate Accruals
      for (const accrual of v41.accruals || []) {
        const core = accrual.foray_core || accrual;
        if (core.arrangement_ref !== undefined) {
          core.arrangement_refs = core.arrangement_ref ? [core.arrangement_ref] : [];
          delete core.arrangement_ref;
        }
        if (!core.arrangement_refs) core.arrangement_refs = [];
        if (!accrual.foray_core) {
          accrual.foray_core = { ...core };
          delete accrual.arrangement_ref;
        }
      }
      
      // Migrate Anticipations
      for (const anticipation of v41.anticipations || []) {
        const core = anticipation.foray_core || anticipation;
        if (core.accrual_ref !== undefined) {
          core.accrual_refs = core.accrual_ref ? [core.accrual_ref] : [];
          delete core.accrual_ref;
        }
        if (!core.accrual_refs) core.accrual_refs = [];
        if (!core.arrangement_refs) core.arrangement_refs = [];
        if (!anticipation.foray_core) {
          anticipation.foray_core = { ...core };
          delete anticipation.accrual_ref;
        }
      }
      
      // Migrate Actions
      for (const action of v41.actions || []) {
        const core = action.foray_core || action;
        if (core.anticipation_ref !== undefined) {
          core.anticipation_refs = core.anticipation_ref ? [core.anticipation_ref] : [];
          delete core.anticipation_ref;
        }
        if (!core.anticipation_refs) core.anticipation_refs = [];
        if (!core.accrual_refs) core.accrual_refs = [];
        if (!core.arrangement_refs) core.arrangement_refs = [];
        if (!core.allocations) core.allocations = [];
        if (!action.foray_core) {
          action.foray_core = { ...core };
          delete action.anticipation_ref;
        }
      }
      
      // Migrate Arrangements
      for (const arrangement of v41.arrangements || []) {
        if (!arrangement.foray_core) {
          const { id, ...rest } = arrangement;
          arrangement.foray_core = { ...rest };
        }
      }
      
      return v41;
    }

    // V4.1 Validation
    function validateV41Transaction(transaction) {
      const errors = [];
      const warnings = [];
      
      const totalComponents = 
        (transaction.arrangements?.length || 0) +
        (transaction.accruals?.length || 0) +
        (transaction.anticipations?.length || 0) +
        (transaction.actions?.length || 0);
      
      if (totalComponents === 0) {
        errors.push('At least one component required');
      }
      
      const allIds = new Set();
      for (const arr of transaction.arrangements || []) allIds.add(arr.id);
      for (const acc of transaction.accruals || []) allIds.add(acc.id);
      for (const ant of transaction.anticipations || []) allIds.add(ant.id);
      for (const act of transaction.actions || []) allIds.add(act.id);
      
      const validateRefs = (refs, componentId, refType) => {
        for (const ref of refs || []) {
          if (!allIds.has(ref)) {
            errors.push(`${componentId}: Referenced ${refType} '${ref}' does not exist`);
          }
        }
      };
      
      for (const acc of transaction.accruals || []) {
        const core = acc.foray_core || acc;
        validateRefs(core.arrangement_refs, acc.id, 'arrangement');
      }
      
      for (const ant of transaction.anticipations || []) {
        const core = ant.foray_core || ant;
        validateRefs(core.accrual_refs, ant.id, 'accrual');
        validateRefs(core.arrangement_refs, ant.id, 'arrangement');
      }
      
      for (const act of transaction.actions || []) {
        const core = act.foray_core || act;
        validateRefs(core.anticipation_refs, act.id, 'anticipation');
        validateRefs(core.accrual_refs, act.id, 'accrual');
        validateRefs(core.arrangement_refs, act.id, 'arrangement');
        
        if (core.allocations?.length > 0) {
          const sum = core.allocations.reduce((acc, a) => acc + (a.amount || 0), 0);
          const settled = core.amount_settled || 0;
          if (Math.abs(sum - settled) > 0.01) {
            errors.push(`${act.id}: Allocation sum (${sum}) != amount_settled (${settled})`);
          }
        }
      }
      
      let entryPointType = null;
      if (transaction.arrangements?.length > 0) entryPointType = 'arrangement';
      else if (transaction.accruals?.length > 0) entryPointType = 'accrual';
      else if (transaction.anticipations?.length > 0) entryPointType = 'anticipation';
      else if (transaction.actions?.length > 0) entryPointType = 'action';
      
      return {
        valid: errors.length === 0,
        errors,
        warnings,
        entryPointType,
        componentCounts: {
          arrangements: transaction.arrangements?.length || 0,
          accruals: transaction.accruals?.length || 0,
          anticipations: transaction.anticipations?.length || 0,
          actions: transaction.actions?.length || 0
        }
      };
    }

    // Shared Components
    const Card = ({ children, className = '', style = {}, id }) => (
      <div 
        id={id}
        className={`rounded-xl shadow-sm p-6 ${className}`}
        style={{ backgroundColor: 'white', border: `1px solid ${forayColors.gray400}20`, ...style }}
      >
        {children}
      </div>
    );

    const SectionHeader = ({ title, icon: Icon, isExpanded, onToggle, count, badge, action }) => (
      <div 
        className="w-full flex items-center justify-between p-4 rounded-lg transition-colors"
        style={{ 
          backgroundColor: isExpanded ? `${forayColors.primaryTeal}10` : 'transparent',
          border: `1px solid ${isExpanded ? forayColors.primaryTeal : forayColors.gray400}40`
        }}
      >
        <button onClick={onToggle} className="flex items-center gap-3 flex-grow text-left">
          {Icon && <Icon className="w-5 h-5" style={{ color: forayColors.primaryTeal }} />}
          <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>{title}</span>
          {count !== undefined && (
            <span className="px-2 py-0.5 text-xs rounded-full" style={{ backgroundColor: `${forayColors.primaryTeal}20`, color: forayColors.primaryTeal }}>
              {count}
            </span>
          )}
          {badge && (
            <span className="px-2 py-0.5 text-xs rounded-full" style={{ backgroundColor: `${forayColors.actionAmber}20`, color: forayColors.actionAmber }}>
              {badge}
            </span>
          )}
        </button>
        <div className="flex items-center gap-2">
          {action}
          <button onClick={onToggle}>
            {isExpanded ? (
              <ChevronDown className="w-5 h-5" style={{ color: forayColors.gray600 }} />
            ) : (
              <ChevronRight className="w-5 h-5" style={{ color: forayColors.gray600 }} />
            )}
          </button>
        </div>
      </div>
    );

    const KeyValue = ({ label, value, mono = false }) => (
      <div className="flex justify-between items-center py-2 border-b" style={{ borderColor: `${forayColors.gray400}30` }}>
        <span className="text-sm" style={{ color: forayColors.gray600 }}>{label}</span>
        <span className={`text-sm font-medium ${mono ? 'font-mono' : ''}`} style={{ color: forayColors.textDark }}>
          {value ?? 'N/A'}
        </span>
      </div>
    );

    const StatusBadge = ({ status }) => {
      const statusColors = {
        active: { bg: '#dbeafe', text: '#1d4ed8' },
        completed: { bg: '#d1fae5', text: '#047857' },
        pending: { bg: '#fef3c7', text: '#b45309' },
        failed: { bg: '#fee2e2', text: '#b91c1c' },
        reversed: { bg: '#f3e8ff', text: '#7c3aed' }
      };
      const colors = statusColors[status?.toLowerCase()] || statusColors.active;
      return (
        <span className="px-3 py-1 text-xs font-medium rounded-full" style={{ backgroundColor: colors.bg, color: colors.text }}>
          {status || 'Unknown'}
        </span>
      );
    };

    const RefBadge = ({ refId, refType, clickable = true, onNavigate }) => {
      const typeColors = {
        arrangement: forayColors.primaryTeal,
        accrual: forayColors.accentCyan,
        anticipation: forayColors.actionAmber,
        action: forayColors.successGreen
      };
      const color = typeColors[refType] || forayColors.gray600;
      
      if (clickable && onNavigate) {
        return (
          <button 
            onClick={() => onNavigate(refId)}
            className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-mono rounded cursor-pointer hover:opacity-80 transition-opacity" 
            style={{ backgroundColor: `${color}20`, color: color, border: `1px solid ${color}40` }}
            title={`Click to jump to ${refId}`}
          >
            <Link2 className="w-3 h-3" />
            {refId}
          </button>
        );
      }
      
      return (
        <span className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-mono rounded" style={{ backgroundColor: `${color}20`, color: color, border: `1px solid ${color}40` }}>
          <Link2 className="w-3 h-3" />
          {refId}
        </span>
      );
    };

    const ReferencesDisplay = ({ refs, refType, label, onNavigate }) => {
      if (!refs || refs.length === 0) return null;
      return (
        <div className="mb-3">
          <p className="text-xs font-medium mb-1.5" style={{ color: forayColors.gray600 }}>{label} ({refs.length})</p>
          <div className="flex flex-wrap gap-1.5">
            {refs.map((ref, idx) => <RefBadge key={idx} refId={ref} refType={refType} onNavigate={onNavigate} />)}
          </div>
        </div>
      );
    };

    const AllocationsDisplay = ({ allocations, currency = 'USD', onNavigate }) => {
      if (!allocations || allocations.length === 0) return null;
      
      const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount || 0);
      const total = allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
      
      return (
        <div className="mt-4 p-3 rounded-lg" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
          <div className="flex items-center gap-2 mb-3">
            <GitBranch className="w-4 h-4" style={{ color: forayColors.accentCyan }} />
            <p className="text-sm font-semibold" style={{ color: forayColors.secondaryNavy }}>Payment Allocations ({allocations.length})</p>
          </div>
          <div className="space-y-2">
            {allocations.map((alloc, idx) => (
              <div key={idx} className="flex items-center justify-between p-2 rounded" style={{ backgroundColor: 'white' }}>
                <div className="flex items-center gap-2">
                  <ArrowRight className="w-3 h-3" style={{ color: forayColors.gray400 }} />
                  <RefBadge refId={alloc.ref} refType={alloc.ref_type} onNavigate={onNavigate} />
                  {alloc.allocation_type && (
                    <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: alloc.allocation_type === 'full' ? '#d1fae5' : '#fef3c7', color: alloc.allocation_type === 'full' ? '#047857' : '#b45309' }}>
                      {alloc.allocation_type}
                    </span>
                  )}
                </div>
                <div className="text-right">
                  <span className="font-mono text-sm font-semibold" style={{ color: forayColors.textDark }}>{formatCurrency(alloc.amount)}</span>
                  {alloc.remaining_balance !== undefined && alloc.remaining_balance > 0 && (
                    <p className="text-xs" style={{ color: forayColors.gray600 }}>Remaining: {formatCurrency(alloc.remaining_balance)}</p>
                  )}
                </div>
              </div>
            ))}
          </div>
          <div className="mt-2 pt-2 flex justify-between items-center" style={{ borderTop: `1px solid ${forayColors.gray400}30` }}>
            <span className="text-sm font-medium" style={{ color: forayColors.gray600 }}>Total Allocated</span>
            <span className="font-mono font-bold" style={{ color: forayColors.primaryTeal }}>{formatCurrency(total)}</span>
          </div>
        </div>
      );
    };

    const DependencyGraph = ({ dependencies, onNavigate }) => {
      if (!dependencies || dependencies.length === 0) return null;
      return (
        <div className="mt-3">
          <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>Dependencies</p>
          <div className="flex flex-wrap gap-1.5">
            {dependencies.map((dep, idx) => {
              let refType = 'arrangement';
              if (dep.startsWith('ACC_')) refType = 'accrual';
              else if (dep.startsWith('ANT_')) refType = 'anticipation';
              else if (dep.startsWith('ACT_')) refType = 'action';
              return <RefBadge key={idx} refId={dep} refType={refType} onNavigate={onNavigate} />;
            })}
          </div>
        </div>
      );
    };

    const renderObjectAsTable = (obj, title) => {
      if (!obj || Object.keys(obj).length === 0) return null;
      return (
        <div className="mt-3">
          <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>{title}</p>
          <div className="rounded border" style={{ borderColor: `${forayColors.gray400}30` }}>
            {Object.entries(obj).map(([key, value], idx) => (
              <div key={idx} className="flex justify-between p-2 text-sm" style={{ borderBottom: idx < Object.entries(obj).length - 1 ? `1px solid ${forayColors.gray400}20` : 'none', backgroundColor: idx % 2 === 0 ? 'white' : forayColors.bgLight }}>
                <span style={{ color: forayColors.gray600 }}>{key.replace(/_/g, ' ')}</span>
                <span className="font-medium font-mono text-xs" style={{ color: forayColors.textDark }}>
                  {typeof value === 'object' ? JSON.stringify(value) : String(value)}
                </span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Sample V4.1 Transactions
    const sampleTransactions = {
      batchPayment: {
        name: "Batch Payment (3 Invoices)",
        description: "AP batch clearing multiple invoices with allocations",
        data: {
          "transaction_id": "AP_2026_Q1_BATCH_PAYMENT_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-25T10:00:00Z",
          "foray_core": {
            "entity": "Acme Corporation",
            "entity_hash": "sha256:def456abc789...",
            "transaction_type": "batch_payment",
            "total_value": 10000.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["SOX_404", "GAAP"]
          },
          "component_hashes": {
            "arrangements": "sha256:a1b2c3...",
            "accruals": "sha256:d4e5f6...",
            "anticipations": "sha256:g7h8i9...",
            "actions": "sha256:j0k1l2..."
          },
          "arrangements": [
            {
              "id": "ARR_VENDOR_MSA_001",
              "foray_core": {
                "type": "master_service_agreement",
                "effective_date": "2025-01-01T00:00:00Z",
                "parties": [
                  { "role": "buyer", "name": "Acme Corporation", "jurisdiction": "US" },
                  { "role": "vendor", "name": "TechSupply Inc", "jurisdiction": "US" }
                ],
                "description": "Master agreement for IT supplies",
                "total_value": 100000.00,
                "currency": "USD",
                "terms": { "payment_terms": "Net 30", "auto_renewal": true },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            { "id": "ACC_INVOICE_001", "foray_core": { "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "accounts_payable", "description": "Server hardware invoice", "computation_method": "FixedAmount", "output": 3000.00, "currency": "USD", "dependencies": ["ARR_VENDOR_MSA_001"] } },
            { "id": "ACC_INVOICE_002", "foray_core": { "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "accounts_payable", "description": "Software licenses", "computation_method": "FixedAmount", "output": 4000.00, "currency": "USD", "dependencies": ["ARR_VENDOR_MSA_001"] } },
            { "id": "ACC_INVOICE_003", "foray_core": { "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "accounts_payable", "description": "Cloud services", "computation_method": "Calculated", "formula_id": "sha256:usage...", "output": 3500.00, "currency": "USD", "dependencies": ["ARR_VENDOR_MSA_001"] } }
          ],
          "anticipations": [
            { "id": "ANT_PAYMENT_DUE_001", "foray_core": { "accrual_refs": ["ACC_INVOICE_001"], "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "scheduled_payment", "description": "Payment due for hardware", "expected_amount": 3000.00, "currency": "USD", "expected_date": "2026-01-31", "probability_factor": 1.0, "dependencies": ["ACC_INVOICE_001"] } },
            { "id": "ANT_PAYMENT_DUE_002", "foray_core": { "accrual_refs": ["ACC_INVOICE_002"], "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "scheduled_payment", "description": "Payment due for software", "expected_amount": 4000.00, "currency": "USD", "expected_date": "2026-01-31", "probability_factor": 1.0, "dependencies": ["ACC_INVOICE_002"] } },
            { "id": "ANT_PAYMENT_DUE_003", "foray_core": { "accrual_refs": ["ACC_INVOICE_003"], "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "scheduled_payment", "description": "Payment due for cloud", "expected_amount": 3500.00, "currency": "USD", "expected_date": "2026-01-31", "probability_factor": 1.0, "dependencies": ["ACC_INVOICE_003"] } }
          ],
          "actions": [
            {
              "id": "ACT_BATCH_PAYMENT_001",
              "foray_core": {
                "anticipation_refs": ["ANT_PAYMENT_DUE_001", "ANT_PAYMENT_DUE_002", "ANT_PAYMENT_DUE_003"],
                "accrual_refs": ["ACC_INVOICE_001", "ACC_INVOICE_002", "ACC_INVOICE_003"],
                "arrangement_refs": ["ARR_VENDOR_MSA_001"],
                "type": "batch_payment",
                "description": "Consolidated payment clearing 3 invoices",
                "amount_settled": 10000.00,
                "currency": "USD",
                "settlement_date": "2026-01-25T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "TechSupply Inc",
                "allocations": [
                  { "ref": "ANT_PAYMENT_DUE_001", "ref_type": "anticipation", "amount": 3000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 },
                  { "ref": "ANT_PAYMENT_DUE_002", "ref_type": "anticipation", "amount": 4000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 },
                  { "ref": "ANT_PAYMENT_DUE_003", "ref_type": "anticipation", "amount": 3000.00, "currency": "USD", "allocation_type": "partial", "remaining_balance": 500.00 }
                ],
                "variance": { "expected": 10500.00, "actual": 10000.00, "difference": -500.00, "explanation": "Partial payment on cloud services" },
                "dependencies": ["ANT_PAYMENT_DUE_001", "ANT_PAYMENT_DUE_002", "ANT_PAYMENT_DUE_003"]
              }
            }
          ],
          "merkle_root": "sha256:9f8e7d6c5b4a3210...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qr7f3a2b9d8e...", "block_height": 2850123, "confirmation_time_ms": 1150, "anchored_at": "2026-01-25T10:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:audit123...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/AP_2026_Q1_BATCH_PAYMENT_001"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 3, "attack_complexity": "2^96 operations" }
        }
      },
      
      cashSale: {
        name: "Cash Sale (Action Only)",
        description: "Simple retail transaction - no arrangements needed",
        data: {
          "transaction_id": "RETAIL_2026_CASH_SALE_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-25T14:30:00Z",
          "foray_core": {
            "entity": "Main Street Coffee Shop",
            "entity_hash": "sha256:coffee123...",
            "transaction_type": "cash_sale",
            "total_value": 47.50,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["PCI_DSS", "Sales_Tax"]
          },
          "component_hashes": { "arrangements": "sha256:empty...", "accruals": "sha256:empty...", "anticipations": "sha256:empty...", "actions": "sha256:act123..." },
          "arrangements": [],
          "accruals": [],
          "anticipations": [],
          "actions": [
            {
              "id": "ACT_CASH_SALE_001",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": [],
                "type": "cash_receipt",
                "description": "Walk-in cash sale - coffee, pastry, merchandise",
                "amount_settled": 47.50,
                "currency": "USD",
                "settlement_date": "2026-01-25T14:30:00Z",
                "settlement_status": "completed",
                "payment_method": "cash",
                "counterparty": "Walk-in Customer",
                "allocations": [],
                "details": { "register_id": "REG-001", "items_sold": 3, "payment_tendered": 50.00, "change_given": 2.50 },
                "breakdown": { "subtotal": 43.18, "sales_tax_rate": 0.10, "sales_tax": 4.32, "total": 47.50 },
                "dependencies": []
              }
            }
          ],
          "merkle_root": "sha256:cashsale123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrcash123...", "block_height": 2850000, "confirmation_time_ms": 1100, "anchored_at": "2026-01-25T14:30:02Z" },
          "privacy_metadata": { "formulas_obfuscated": 0, "instance_pools": 0, "attack_complexity": "N/A" }
        }
      },
      
      depreciation: {
        name: "Depreciation (Accrual Only)",
        description: "Month-end adjusting entry - no cash movement",
        data: {
          "transaction_id": "ACCT_2026_Q1_DEPRECIATION_JAN",
          "schema_version": "4.1",
          "timestamp": "2026-01-31T23:59:00Z",
          "foray_core": {
            "entity": "Acme Corporation",
            "entity_hash": "sha256:acme123...",
            "transaction_type": "adjusting_entry",
            "total_value": 12500.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["GAAP", "SOX_404", "ASC_360"]
          },
          "component_hashes": { "arrangements": "sha256:empty...", "accruals": "sha256:depr123...", "anticipations": "sha256:empty...", "actions": "sha256:empty..." },
          "arrangements": [],
          "accruals": [
            {
              "id": "ACC_DEPRECIATION_EQUIPMENT",
              "foray_core": {
                "arrangement_refs": [],
                "type": "depreciation_expense",
                "description": "January equipment depreciation - straight line",
                "computation_method": "Calculated",
                "formula_id": "sha256:straightline...",
                "inputs": { "asset_cost": 600000.00, "salvage_value": 0, "useful_life_months": 120 },
                "output": 5000.00,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "6100-Depreciation Expense", "amount": 5000.00 }, "credit": { "account": "1510-Accumulated Depreciation", "amount": 5000.00 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": []
              }
            },
            {
              "id": "ACC_DEPRECIATION_VEHICLES",
              "foray_core": {
                "arrangement_refs": [],
                "type": "depreciation_expense",
                "description": "January vehicle fleet depreciation",
                "computation_method": "Calculated",
                "formula_id": "sha256:straightline...",
                "inputs": { "asset_cost": 300000.00, "salvage_value": 30000, "useful_life_months": 60 },
                "output": 4500.00,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "6110-Depreciation Expense - Vehicles", "amount": 4500.00 }, "credit": { "account": "1520-Accumulated Depreciation - Vehicles", "amount": 4500.00 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": []
              }
            },
            {
              "id": "ACC_DEPRECIATION_BUILDING",
              "foray_core": {
                "arrangement_refs": [],
                "type": "depreciation_expense",
                "description": "January building depreciation",
                "computation_method": "Calculated",
                "formula_id": "sha256:straightline...",
                "inputs": { "asset_cost": 1440000.00, "salvage_value": 0, "useful_life_months": 480 },
                "output": 3000.00,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "6120-Depreciation Expense - Building", "amount": 3000.00 }, "credit": { "account": "1530-Accumulated Depreciation - Building", "amount": 3000.00 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": []
              }
            }
          ],
          "anticipations": [],
          "actions": [],
          "merkle_root": "sha256:depr789...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrdepr123...", "block_height": 2852000, "confirmation_time_ms": 980, "anchored_at": "2026-01-31T23:59:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:depaudit...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/DEPRECIATION_JAN"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 3, "attack_complexity": "2^96 operations" }
        }
      },
      
      autoLoan: {
        name: "Auto Loan (Full Chain)",
        description: "Consumer loan with arrangement &rarr; accruals &rarr; anticipations &rarr; actions",
        data: {
          "transaction_id": "AUTO_LOAN_2026_Q1_JOHN_DOE",
          "schema_version": "4.1",
          "timestamp": "2026-01-23T15:00:00Z",
          "foray_core": {
            "entity": "Auto Finance Co",
            "entity_hash": "sha256:autofinance...",
            "transaction_type": "auto_loan",
            "total_value": 25000.00,
            "currency": "USD",
            "status": "active",
            "compliance_flags": ["Consumer_Credit", "Truth_in_Lending_Act", "Reg_Z"]
          },
          "component_hashes": { "arrangements": "sha256:arr1...", "accruals": "sha256:acc2...", "anticipations": "sha256:ant3...", "actions": "sha256:act4..." },
          "arrangements": [
            {
              "id": "ARR_AUTO_LOAN_AGREEMENT",
              "foray_core": {
                "type": "auto_loan",
                "effective_date": "2026-01-23T00:00:00Z",
                "parties": [
                  { "role": "lender", "name": "Auto Finance Co", "jurisdiction": "US" },
                  { "role": "borrower", "name": "John Doe", "jurisdiction": "US" }
                ],
                "description": "60-month auto loan at 4.5% APR",
                "total_value": 25000.00,
                "currency": "USD",
                "terms": { "principal_amount": 25000, "interest_rate": 0.045, "term_months": 60, "monthly_payment": 466.08 },
                "legal_documentation": ["Auto Loan Agreement", "Truth in Lending Disclosure"],
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_INTEREST_MONTH_1",
              "foray_core": {
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "interest_expense",
                "description": "Interest accrual month 1 at 4.5% APR",
                "computation_method": "Calculated",
                "formula_id": "sha256:interest_calc...",
                "inputs": { "principal": 25000.00, "annual_rate": 0.045, "days_in_month": 31 },
                "output": 95.89,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "7100-Interest Expense", "amount": 95.89 }, "credit": { "account": "2200-Interest Payable", "amount": 95.89 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_AUTO_LOAN_AGREEMENT"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_PAYMENT_1",
              "foray_core": {
                "accrual_refs": ["ACC_INTEREST_MONTH_1"],
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "scheduled_payment",
                "description": "Expected payment 1: $466.08",
                "expected_amount": 466.08,
                "currency": "USD",
                "expected_date": "2026-02-23",
                "probability_factor": 0.95,
                "assumptions": { "principal_portion": 370.19, "interest_portion": 95.89 },
                "dependencies": ["ACC_INTEREST_MONTH_1"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_LOAN_ORIGINATION",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "loan_disbursement",
                "description": "Initial loan disbursement",
                "amount_settled": 25000.00,
                "currency": "USD",
                "settlement_date": "2026-01-23T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "John Doe",
                "allocations": [],
                "details": { "vehicle_vin": "1HGBH41JXMN109186", "vehicle_year": 2024, "vehicle_make": "Honda", "vehicle_model": "Accord" },
                "dependencies": ["ARR_AUTO_LOAN_AGREEMENT"]
              }
            },
            {
              "id": "ACT_PAYMENT_1",
              "foray_core": {
                "anticipation_refs": ["ANT_PAYMENT_1"],
                "accrual_refs": ["ACC_INTEREST_MONTH_1"],
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "loan_payment",
                "description": "First monthly payment received",
                "amount_settled": 466.08,
                "currency": "USD",
                "settlement_date": "2026-02-23T09:15:00Z",
                "settlement_status": "completed",
                "payment_method": "ach",
                "counterparty": "John Doe",
                "allocations": [
                  { "ref": "ANT_PAYMENT_1", "ref_type": "anticipation", "amount": 466.08, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 466.08, "actual": 466.08, "difference": 0.00 },
                "breakdown": { "principal_applied": 370.19, "interest_applied": 95.89 },
                "dependencies": ["ANT_PAYMENT_1", "ACC_INTEREST_MONTH_1"]
              }
            }
          ],
          "merkle_root": "sha256:autoloan...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrauto123...", "block_height": 2849000, "confirmation_time_ms": 1050, "anchored_at": "2026-01-23T15:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:loanaudit...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/AUTO_LOAN_JOHN_DOE"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 5, "attack_complexity": "2^96 operations" }
        }
      },
      
      energyPPA: {
        name: "Energy PPA (Solar)",
        description: "Power Purchase Agreement with generation, delivery, and settlement",
        data: {
          "transaction_id": "ENERGY_PPA_2026_Q1_SOLAR_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-25T06:00:00Z",
          "foray_core": {
            "entity": "SunPower Utilities",
            "entity_hash": "sha256:sunpower...",
            "transaction_type": "power_purchase_agreement",
            "total_value": 156000.00,
            "currency": "USD",
            "status": "active",
            "compliance_flags": ["FERC", "NERC", "REC_Tracking", "ISO_NE"]
          },
          "component_hashes": { "arrangements": "sha256:ppa1...", "accruals": "sha256:gen1...", "anticipations": "sha256:del1...", "actions": "sha256:set1..." },
          "arrangements": [
            {
              "id": "ARR_PPA_SOLAR_FARM",
              "foray_core": {
                "type": "power_purchase_agreement",
                "effective_date": "2025-01-01T00:00:00Z",
                "termination_date": "2045-01-01T00:00:00Z",
                "parties": [
                  { "role": "generator", "name": "Desert Sun Solar LLC", "jurisdiction": "US-AZ" },
                  { "role": "offtaker", "name": "SunPower Utilities", "jurisdiction": "US-CA" },
                  { "role": "grid_operator", "name": "CAISO", "jurisdiction": "US-CA" }
                ],
                "description": "20-year solar PPA - 50MW facility in Arizona",
                "total_value": 180000000.00,
                "currency": "USD",
                "terms": {
                  "capacity_mw": 50,
                  "price_per_mwh": 35.00,
                  "annual_escalation": 0.02,
                  "curtailment_provisions": "Buyer pays 80% for curtailed energy",
                  "rec_transfer": "included"
                },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_GENERATION_JAN_2026",
              "foray_core": {
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "energy_generation",
                "description": "January 2026 solar generation - metered output",
                "computation_method": "Calculated",
                "formula_id": "sha256:energy_gen...",
                "inputs": { "meter_reading_start_mwh": 1250000, "meter_reading_end_mwh": 1254500, "capacity_factor": 0.28 },
                "output": 4500.00,
                "unit": "MWh",
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1400-Energy Inventory", "amount": 157500.00 },
                  "credit": { "account": "2100-Energy Payable", "amount": 157500.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_PPA_SOLAR_FARM"]
              }
            },
            {
              "id": "ACC_REC_JAN_2026",
              "foray_core": {
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "renewable_energy_credit",
                "description": "January 2026 RECs generated",
                "computation_method": "Calculated",
                "formula_id": "sha256:rec_calc...",
                "inputs": { "mwh_generated": 4500, "rec_per_mwh": 1, "rec_value": 15.00 },
                "output": 4500,
                "unit": "RECs",
                "currency": "USD",
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ACC_GENERATION_JAN_2026"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_ENERGY_DELIVERY_JAN",
              "foray_core": {
                "accrual_refs": ["ACC_GENERATION_JAN_2026"],
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "scheduled_delivery",
                "description": "Expected energy delivery and payment for January",
                "expected_amount": 157500.00,
                "currency": "USD",
                "expected_date": "2026-02-15",
                "probability_factor": 0.98,
                "assumptions": { "mwh_expected": 4500, "price_per_mwh": 35.00, "curtailment_risk": 0.02 },
                "dependencies": ["ACC_GENERATION_JAN_2026"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_ENERGY_SETTLEMENT_JAN",
              "foray_core": {
                "anticipation_refs": ["ANT_ENERGY_DELIVERY_JAN"],
                "accrual_refs": ["ACC_GENERATION_JAN_2026", "ACC_REC_JAN_2026"],
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "energy_settlement",
                "description": "January energy delivery settlement with curtailment adjustment",
                "amount_settled": 156000.00,
                "currency": "USD",
                "settlement_date": "2026-02-15T14:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "Desert Sun Solar LLC",
                "allocations": [
                  { "ref": "ANT_ENERGY_DELIVERY_JAN", "ref_type": "anticipation", "amount": 156000.00, "currency": "USD", "allocation_type": "partial", "remaining_balance": 1500.00 }
                ],
                "variance": { "expected": 157500.00, "actual": 156000.00, "difference": -1500.00, "explanation": "Grid curtailment event Jan 15-16 (42.86 MWh)" },
                "details": {
                  "mwh_delivered": 4457.14,
                  "mwh_curtailed": 42.86,
                  "curtailment_credit": 1200.00,
                  "grid_interconnection_point": "Palo Verde Hub",
                  "caiso_settlement_id": "CAISO-2026-01-4521"
                },
                "dependencies": ["ANT_ENERGY_DELIVERY_JAN"]
              }
            }
          ],
          "merkle_root": "sha256:energy123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrenergy...", "block_height": 2851500, "confirmation_time_ms": 1100, "anchored_at": "2026-02-15T14:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:energyaudit...", "audit_profile": "energy_compliance", "storage_locations": ["s3://foray-audit/2026/Q1/ENERGY_PPA_SOLAR_001"] },
          "privacy_metadata": { "formulas_obfuscated": 2, "instance_pools": 4, "attack_complexity": "2^96 operations" }
        }
      },
      
      manufacturing: {
        name: "Manufacturing (Work Order)",
        description: "Production work order with BOM, labor, overhead allocation",
        data: {
          "transaction_id": "MFG_WO_2026_Q1_WIDGET_500",
          "schema_version": "4.1",
          "timestamp": "2026-01-20T08:00:00Z",
          "foray_core": {
            "entity": "Precision Parts Manufacturing",
            "entity_hash": "sha256:precision...",
            "transaction_type": "work_order",
            "total_value": 47500.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["ISO_9001", "GAAP", "Cost_Accounting_Standards"]
          },
          "component_hashes": { "arrangements": "sha256:wo1...", "accruals": "sha256:cost1...", "anticipations": "sha256:prod1...", "actions": "sha256:inv1..." },
          "arrangements": [
            {
              "id": "ARR_WORK_ORDER_500",
              "foray_core": {
                "type": "production_work_order",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "manufacturer", "name": "Precision Parts Manufacturing", "jurisdiction": "US-MI" },
                  { "role": "customer", "name": "AutoTech Industries", "jurisdiction": "US-OH" }
                ],
                "description": "Work Order #WO-2026-500: Premium Widget Assembly (500 units)",
                "total_value": 50000.00,
                "currency": "USD",
                "terms": {
                  "product_code": "PWA-1000",
                  "quantity_ordered": 500,
                  "unit_price": 100.00,
                  "delivery_date": "2026-01-25",
                  "quality_standard": "ISO 9001"
                },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_DIRECT_MATERIALS",
              "foray_core": {
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "direct_material_cost",
                "description": "BOM materials consumed - aluminum, electronics, fasteners",
                "computation_method": "Calculated",
                "formula_id": "sha256:bom_cost...",
                "inputs": { "aluminum_kg": 250, "aluminum_cost_per_kg": 45.00, "electronics_units": 500, "electronics_cost": 25.00, "fasteners_sets": 500, "fasteners_cost": 2.50 },
                "output": 25000.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1310-WIP Inventory", "amount": 25000.00 },
                  "credit": { "account": "1200-Raw Materials", "amount": 25000.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_WORK_ORDER_500"]
              }
            },
            {
              "id": "ACC_DIRECT_LABOR",
              "foray_core": {
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "direct_labor_cost",
                "description": "Production labor - assembly line workers",
                "computation_method": "Calculated",
                "formula_id": "sha256:labor_cost...",
                "inputs": { "labor_hours": 400, "avg_hourly_rate": 35.00, "benefits_rate": 0.30 },
                "output": 18200.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1310-WIP Inventory", "amount": 18200.00 },
                  "credit": { "account": "2300-Wages Payable", "amount": 14000.00 },
                  "credit2": { "account": "2310-Benefits Payable", "amount": 4200.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_WORK_ORDER_500"]
              }
            },
            {
              "id": "ACC_MANUFACTURING_OVERHEAD",
              "foray_core": {
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "manufacturing_overhead",
                "description": "Applied overhead - machine hours basis",
                "computation_method": "Calculated",
                "formula_id": "sha256:overhead_alloc...",
                "inputs": { "machine_hours": 200, "overhead_rate_per_hour": 21.50 },
                "output": 4300.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1310-WIP Inventory", "amount": 4300.00 },
                  "credit": { "account": "5100-Applied Overhead", "amount": 4300.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ACC_DIRECT_LABOR"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_PRODUCTION_COMPLETE",
              "foray_core": {
                "accrual_refs": ["ACC_DIRECT_MATERIALS", "ACC_DIRECT_LABOR", "ACC_MANUFACTURING_OVERHEAD"],
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "production_completion",
                "description": "Expected completion and transfer to finished goods",
                "expected_amount": 47500.00,
                "currency": "USD",
                "expected_date": "2026-01-24",
                "probability_factor": 0.95,
                "assumptions": { "yield_rate": 0.98, "expected_good_units": 490, "cost_per_unit": 95.00 },
                "dependencies": ["ACC_DIRECT_MATERIALS", "ACC_DIRECT_LABOR", "ACC_MANUFACTURING_OVERHEAD"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_PRODUCTION_COMPLETE",
              "foray_core": {
                "anticipation_refs": ["ANT_PRODUCTION_COMPLETE"],
                "accrual_refs": ["ACC_DIRECT_MATERIALS", "ACC_DIRECT_LABOR", "ACC_MANUFACTURING_OVERHEAD"],
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "inventory_transfer",
                "description": "Transfer completed units to finished goods inventory",
                "amount_settled": 47500.00,
                "currency": "USD",
                "settlement_date": "2026-01-24T16:00:00Z",
                "settlement_status": "completed",
                "allocations": [
                  { "ref": "ANT_PRODUCTION_COMPLETE", "ref_type": "anticipation", "amount": 47500.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 47500.00, "actual": 47500.00, "difference": 0.00 },
                "details": {
                  "units_completed": 497,
                  "units_scrapped": 3,
                  "scrap_value": 45.00,
                  "unit_cost": 95.52,
                  "lot_number": "LOT-2026-01-500",
                  "quality_inspection": "passed"
                },
                "dependencies": ["ANT_PRODUCTION_COMPLETE"]
              }
            },
            {
              "id": "ACT_CUSTOMER_SHIPMENT",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "shipment",
                "description": "Ship completed order to customer",
                "amount_settled": 50000.00,
                "currency": "USD",
                "settlement_date": "2026-01-25T09:00:00Z",
                "settlement_status": "completed",
                "allocations": [],
                "details": {
                  "units_shipped": 497,
                  "carrier": "FedEx Freight",
                  "tracking_number": "FX-789456123",
                  "revenue_recognized": 49700.00
                },
                "dependencies": ["ACT_PRODUCTION_COMPLETE"]
              }
            }
          ],
          "merkle_root": "sha256:mfg123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrmfg...", "block_height": 2850800, "confirmation_time_ms": 980, "anchored_at": "2026-01-25T09:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:mfgaudit...", "audit_profile": "manufacturing", "storage_locations": ["s3://foray-audit/2026/Q1/MFG_WO_500"] },
          "privacy_metadata": { "formulas_obfuscated": 3, "instance_pools": 4, "attack_complexity": "2^96 operations" }
        }
      },
      
      salesforceOpportunity: {
        name: "Salesforce Opportunity",
        description: "CRM opportunity &rarr; quote &rarr; order &rarr; invoice &rarr; payment",
        data: {
          "transaction_id": "SF_OPP_2026_Q1_ACME_ENTERPRISE",
          "schema_version": "4.1",
          "timestamp": "2026-01-22T10:00:00Z",
          "foray_core": {
            "entity": "CloudTech Solutions",
            "entity_hash": "sha256:cloudtech...",
            "transaction_type": "salesforce_opportunity",
            "total_value": 125000.00,
            "currency": "USD",
            "status": "closed_won",
            "compliance_flags": ["ASC_606", "SOX_404", "Revenue_Recognition"]
          },
          "source_system": {
            "type": "Salesforce",
            "instance": "cloudtech.salesforce.com",
            "api_version": "v59.0"
          },
          "component_hashes": { "arrangements": "sha256:opp1...", "accruals": "sha256:rev1...", "anticipations": "sha256:pay1...", "actions": "sha256:close1..." },
          "arrangements": [
            {
              "id": "ARR_SF_OPPORTUNITY",
              "foray_core": {
                "type": "sales_opportunity",
                "effective_date": "2025-11-15T00:00:00Z",
                "parties": [
                  { "role": "seller", "name": "CloudTech Solutions", "jurisdiction": "US-CA" },
                  { "role": "buyer", "name": "Acme Corporation", "jurisdiction": "US-NY" }
                ],
                "description": "Enterprise Cloud Platform - 3 Year Agreement",
                "total_value": 125000.00,
                "currency": "USD",
                "terms": {
                  "contract_term_years": 3,
                  "annual_value": 41666.67,
                  "payment_terms": "Annual in advance",
                  "renewal_type": "auto_renewal"
                },
                "salesforce_refs": {
                  "opportunity_id": "006Dn000004XyZ1ABC",
                  "account_id": "001Dn000003ABC1DEF",
                  "owner_id": "005Dn000001XYZ9ABC",
                  "opportunity_name": "Acme Corp - Enterprise Platform",
                  "stage": "Closed Won",
                  "close_date": "2026-01-20"
                },
                "dependencies": []
              }
            },
            {
              "id": "ARR_SF_QUOTE",
              "foray_core": {
                "type": "sales_quote",
                "effective_date": "2026-01-10T00:00:00Z",
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "parties": [
                  { "role": "seller", "name": "CloudTech Solutions" },
                  { "role": "buyer", "name": "Acme Corporation" }
                ],
                "description": "Quote Q-2026-0142: Enterprise Cloud Platform",
                "total_value": 125000.00,
                "currency": "USD",
                "salesforce_refs": {
                  "quote_id": "0Q0Dn000000ABC1DEF",
                  "quote_number": "Q-2026-0142",
                  "status": "Accepted"
                },
                "line_items": [
                  { "product": "Enterprise Platform License", "quantity": 500, "unit_price": 200.00, "total": 100000.00 },
                  { "product": "Premium Support", "quantity": 1, "unit_price": 15000.00, "total": 15000.00 },
                  { "product": "Implementation Services", "quantity": 1, "unit_price": 10000.00, "total": 10000.00 }
                ],
                "dependencies": ["ARR_SF_OPPORTUNITY"]
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_REVENUE_RECOGNITION_Y1",
              "foray_core": {
                "arrangement_refs": ["ARR_SF_OPPORTUNITY", "ARR_SF_QUOTE"],
                "type": "revenue_recognition",
                "description": "Year 1 revenue recognition - ASC 606 compliant",
                "computation_method": "Calculated",
                "formula_id": "sha256:asc606_rev...",
                "inputs": { "total_contract_value": 125000.00, "performance_obligations": 3, "license_ssp": 100000, "support_ssp": 15000, "services_ssp": 10000 },
                "output": 41666.67,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1200-Accounts Receivable", "amount": 125000.00 },
                  "credit": { "account": "2400-Deferred Revenue", "amount": 83333.33 },
                  "credit2": { "account": "4100-License Revenue", "amount": 33333.33 },
                  "credit3": { "account": "4200-Service Revenue", "amount": 8333.34 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "salesforce_refs": {
                  "revenue_schedule_id": "0RSxxxxxxx"
                },
                "dependencies": ["ARR_SF_QUOTE"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_CUSTOMER_PAYMENT",
              "foray_core": {
                "accrual_refs": ["ACC_REVENUE_RECOGNITION_Y1"],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "type": "scheduled_payment",
                "description": "Expected Year 1 payment upon contract signing",
                "expected_amount": 125000.00,
                "currency": "USD",
                "expected_date": "2026-01-25",
                "probability_factor": 0.99,
                "assumptions": { "payment_method": "wire", "payment_terms": "due_on_signing" },
                "dependencies": ["ACC_REVENUE_RECOGNITION_Y1"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_CONTRACT_EXECUTION",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY", "ARR_SF_QUOTE"],
                "type": "contract_execution",
                "description": "Contract signed via DocuSign",
                "amount_settled": 0,
                "currency": "USD",
                "settlement_date": "2026-01-20T14:30:00Z",
                "settlement_status": "completed",
                "allocations": [],
                "details": {
                  "contract_id": "800Dn000001ABC1DEF",
                  "docusign_envelope_id": "12345-abcde-67890",
                  "signed_by": "Jane Smith, VP Operations"
                },
                "dependencies": ["ARR_SF_QUOTE"]
              }
            },
            {
              "id": "ACT_INVOICE_GENERATED",
              "foray_core": {
                "anticipation_refs": ["ANT_CUSTOMER_PAYMENT"],
                "accrual_refs": ["ACC_REVENUE_RECOGNITION_Y1"],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "type": "invoice",
                "description": "Invoice generated from Salesforce CPQ",
                "amount_settled": 125000.00,
                "currency": "USD",
                "settlement_date": "2026-01-21T09:00:00Z",
                "settlement_status": "issued",
                "allocations": [],
                "details": {
                  "invoice_id": "a0BDn000001ABC1DEF",
                  "invoice_number": "INV-2026-00089",
                  "due_date": "2026-02-20"
                },
                "salesforce_refs": {
                  "invoice_id": "a0BDn000001ABC1DEF"
                },
                "dependencies": ["ACT_CONTRACT_EXECUTION"]
              }
            },
            {
              "id": "ACT_PAYMENT_RECEIVED",
              "foray_core": {
                "anticipation_refs": ["ANT_CUSTOMER_PAYMENT"],
                "accrual_refs": ["ACC_REVENUE_RECOGNITION_Y1"],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "type": "payment_receipt",
                "description": "Wire payment received from Acme Corporation",
                "amount_settled": 125000.00,
                "currency": "USD",
                "settlement_date": "2026-01-22T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "Acme Corporation",
                "allocations": [
                  { "ref": "ANT_CUSTOMER_PAYMENT", "ref_type": "anticipation", "amount": 125000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 125000.00, "actual": 125000.00, "difference": 0.00 },
                "details": {
                  "bank_reference": "WIR-2026012200145",
                  "payment_id": "a1CDn000002ABC1DEF"
                },
                "salesforce_refs": {
                  "payment_id": "a1CDn000002ABC1DEF"
                },
                "dependencies": ["ACT_INVOICE_GENERATED", "ANT_CUSTOMER_PAYMENT"]
              }
            }
          ],
          "merkle_root": "sha256:sfopp123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrsf...", "block_height": 2850600, "confirmation_time_ms": 1020, "anchored_at": "2026-01-22T10:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:sfaudit...", "audit_profile": "revenue_recognition", "storage_locations": ["s3://foray-audit/2026/Q1/SF_OPP_ACME_ENTERPRISE"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 3, "attack_complexity": "2^96 operations" }
        }
      },
      
      rmbs: {
        name: "RMBS Securitization",
        description: "Residential Mortgage-Backed Security with loan pooling, tranches, and waterfall",
        data: {
          "transaction_id": "RMBS_2026_Q1_POOL_ABC123",
          "schema_version": "4.1",
          "timestamp": "2026-01-15T09:00:00Z",
          "foray_core": {
            "entity": "SecureCapital Mortgage Trust",
            "entity_hash": "sha256:securecap...",
            "transaction_type": "rmbs_securitization",
            "total_value": 500000000.00,
            "currency": "USD",
            "status": "active",
            "compliance_flags": ["SEC_Reg_AB", "FASB_ASC_860", "Risk_Retention", "Dodd_Frank"]
          },
          "component_hashes": {
            "arrangements": "sha256:rmbs_arr...",
            "accruals": "sha256:rmbs_acc...",
            "anticipations": "sha256:rmbs_ant...",
            "actions": "sha256:rmbs_act..."
          },
          "arrangements": [
            {
              "id": "ARR_MORTGAGE_POOL_ABC123",
              "foray_core": {
                "type": "mortgage_pool",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "originator", "name": "National Home Lenders", "jurisdiction": "US" },
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" },
                  { "role": "trustee", "name": "Bank of New York Mellon", "jurisdiction": "US-NY" },
                  { "role": "servicer", "name": "LoanServ Inc", "jurisdiction": "US" }
                ],
                "description": "RMBS Pool ABC123 - Prime Conforming Mortgages",
                "total_value": 500000000.00,
                "currency": "USD",
                "terms": {
                  "pool_factor": 1.0,
                  "weighted_avg_coupon": 0.0625,
                  "weighted_avg_maturity_months": 342,
                  "weighted_avg_ltv": 0.72,
                  "weighted_avg_fico": 745,
                  "loan_count": 1847,
                  "geographic_concentration": { "CA": 0.28, "TX": 0.15, "FL": 0.12, "NY": 0.10, "other": 0.35 }
                },
                "legal_documentation": ["Pooling_Service_Agreement", "Trust_Indenture", "Prospectus_Supplement"],
                "dependencies": []
              }
            },
            {
              "id": "ARR_TRANCHE_A1",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" }
                ],
                "description": "Class A-1 Senior Tranche - AAA Rated",
                "total_value": 350000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "A-1",
                  "seniority": "senior",
                  "rating": { "moodys": "Aaa", "sp": "AAA", "fitch": "AAA" },
                  "coupon_rate": 0.045,
                  "payment_frequency": "monthly",
                  "credit_enhancement": 0.30,
                  "subordination_level": 0.30
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123"]
              }
            },
            {
              "id": "ARR_TRANCHE_M1",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" }
                ],
                "description": "Class M-1 Mezzanine Tranche - AA Rated",
                "total_value": 75000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "M-1",
                  "seniority": "mezzanine",
                  "rating": { "moodys": "Aa2", "sp": "AA", "fitch": "AA" },
                  "coupon_rate": 0.055,
                  "payment_frequency": "monthly",
                  "credit_enhancement": 0.15,
                  "subordination_level": 0.15
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1"]
              }
            },
            {
              "id": "ARR_TRANCHE_B1",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" }
                ],
                "description": "Class B-1 Subordinate Tranche - BBB Rated",
                "total_value": 50000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "B-1",
                  "seniority": "subordinate",
                  "rating": { "moodys": "Baa2", "sp": "BBB", "fitch": "BBB" },
                  "coupon_rate": 0.075,
                  "payment_frequency": "monthly",
                  "credit_enhancement": 0.05,
                  "subordination_level": 0.05
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1", "ARR_TRANCHE_M1"]
              }
            },
            {
              "id": "ARR_TRANCHE_R",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" },
                  { "role": "risk_retention_holder", "name": "National Home Lenders", "jurisdiction": "US" }
                ],
                "description": "Class R Residual/First-Loss - Unrated (Risk Retention)",
                "total_value": 25000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "R",
                  "seniority": "residual",
                  "rating": { "moodys": "NR", "sp": "NR", "fitch": "NR" },
                  "risk_retention_compliant": true,
                  "retention_percentage": 0.05,
                  "excess_spread_entitled": true
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1", "ARR_TRANCHE_M1", "ARR_TRANCHE_B1"]
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_POOL_INTEREST_JAN",
              "foray_core": {
                "arrangement_refs": ["ARR_MORTGAGE_POOL_ABC123"],
                "type": "interest_collection",
                "description": "January pool interest collections",
                "computation_method": "Calculated",
                "formula_id": "sha256:pool_interest_calc...",
                "inputs": {
                  "pool_balance": 500000000.00,
                  "weighted_avg_coupon": 0.0625,
                  "days_in_period": 31,
                  "prepayment_rate_cpr": 0.08
                },
                "output": 2604166.67,
                "currency": "USD",
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123"]
              }
            },
            {
              "id": "ACC_POOL_PRINCIPAL_JAN",
              "foray_core": {
                "arrangement_refs": ["ARR_MORTGAGE_POOL_ABC123"],
                "type": "principal_collection",
                "description": "January scheduled principal + prepayments",
                "computation_method": "Calculated",
                "formula_id": "sha256:principal_calc...",
                "inputs": {
                  "scheduled_principal": 1250000.00,
                  "prepayments": 3333333.33,
                  "defaults": 125000.00,
                  "recoveries": 75000.00
                },
                "output": 4533333.33,
                "currency": "USD",
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123"]
              }
            },
            {
              "id": "ACC_TRANCHE_A1_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_TRANCHE_A1"],
                "type": "tranche_interest_due",
                "description": "Class A-1 January interest due",
                "computation_method": "Calculated",
                "formula_id": "sha256:tranche_interest...",
                "inputs": { "tranche_balance": 350000000.00, "coupon_rate": 0.045, "days": 31 },
                "output": 1312500.00,
                "currency": "USD",
                "waterfall_priority": 1,
                "dependencies": ["ACC_POOL_INTEREST_JAN"]
              }
            },
            {
              "id": "ACC_TRANCHE_M1_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_TRANCHE_M1"],
                "type": "tranche_interest_due",
                "description": "Class M-1 January interest due",
                "computation_method": "Calculated",
                "formula_id": "sha256:tranche_interest...",
                "inputs": { "tranche_balance": 75000000.00, "coupon_rate": 0.055, "days": 31 },
                "output": 343750.00,
                "currency": "USD",
                "waterfall_priority": 2,
                "dependencies": ["ACC_POOL_INTEREST_JAN", "ACC_TRANCHE_A1_INTEREST"]
              }
            },
            {
              "id": "ACC_TRANCHE_B1_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_TRANCHE_B1"],
                "type": "tranche_interest_due",
                "description": "Class B-1 January interest due",
                "computation_method": "Calculated",
                "formula_id": "sha256:tranche_interest...",
                "inputs": { "tranche_balance": 50000000.00, "coupon_rate": 0.075, "days": 31 },
                "output": 312500.00,
                "currency": "USD",
                "waterfall_priority": 3,
                "dependencies": ["ACC_POOL_INTEREST_JAN", "ACC_TRANCHE_M1_INTEREST"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_WATERFALL_DISTRIBUTION_JAN",
              "foray_core": {
                "accrual_refs": ["ACC_POOL_INTEREST_JAN", "ACC_POOL_PRINCIPAL_JAN", "ACC_TRANCHE_A1_INTEREST", "ACC_TRANCHE_M1_INTEREST", "ACC_TRANCHE_B1_INTEREST"],
                "arrangement_refs": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1", "ARR_TRANCHE_M1", "ARR_TRANCHE_B1", "ARR_TRANCHE_R"],
                "type": "waterfall_distribution",
                "description": "January payment date waterfall",
                "expected_amount": 7137500.00,
                "currency": "USD",
                "expected_date": "2026-01-25",
                "probability_factor": 0.99,
                "waterfall_sequence": [
                  { "priority": 1, "payee": "Trustee_Fees", "amount": 41666.67 },
                  { "priority": 2, "payee": "Servicer_Fees", "amount": 104166.67 },
                  { "priority": 3, "payee": "Class_A1_Interest", "amount": 1312500.00 },
                  { "priority": 4, "payee": "Class_A1_Principal", "amount": 4533333.33 },
                  { "priority": 5, "payee": "Class_M1_Interest", "amount": 343750.00 },
                  { "priority": 6, "payee": "Class_B1_Interest", "amount": 312500.00 },
                  { "priority": 7, "payee": "Class_R_Residual", "amount": 489583.33 }
                ],
                "dependencies": ["ACC_POOL_INTEREST_JAN", "ACC_POOL_PRINCIPAL_JAN"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_WATERFALL_PAYMENT_JAN",
              "foray_core": {
                "anticipation_refs": ["ANT_WATERFALL_DISTRIBUTION_JAN"],
                "accrual_refs": ["ACC_TRANCHE_A1_INTEREST", "ACC_TRANCHE_M1_INTEREST", "ACC_TRANCHE_B1_INTEREST"],
                "arrangement_refs": ["ARR_TRANCHE_A1", "ARR_TRANCHE_M1", "ARR_TRANCHE_B1", "ARR_TRANCHE_R"],
                "type": "waterfall_settlement",
                "description": "January payment date - all tranches paid per waterfall",
                "amount_settled": 7137500.00,
                "currency": "USD",
                "settlement_date": "2026-01-25T14:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire_dtc",
                "allocations": [
                  { "ref": "ARR_MORTGAGE_POOL_ABC123", "ref_type": "arrangement", "amount": 145833.34, "currency": "USD", "allocation_type": "full", "breakdown": { "trustee_fees": 41666.67, "servicer_fees": 104166.67 } },
                  { "ref": "ARR_TRANCHE_A1", "ref_type": "arrangement", "amount": 5845833.33, "currency": "USD", "allocation_type": "full", "breakdown": { "interest": 1312500.00, "principal": 4533333.33 } },
                  { "ref": "ARR_TRANCHE_M1", "ref_type": "arrangement", "amount": 343750.00, "currency": "USD", "allocation_type": "full", "breakdown": { "interest": 343750.00, "principal": 0 } },
                  { "ref": "ARR_TRANCHE_B1", "ref_type": "arrangement", "amount": 312500.00, "currency": "USD", "allocation_type": "full", "breakdown": { "interest": 312500.00, "principal": 0 } },
                  { "ref": "ARR_TRANCHE_R", "ref_type": "arrangement", "amount": 489583.33, "currency": "USD", "allocation_type": "full", "breakdown": { "excess_spread": 489583.33 } }
                ],
                "variance": { "expected": 7137500.00, "actual": 7137500.00, "difference": 0.00 },
                "pool_metrics_post_payment": {
                  "new_pool_balance": 495466666.67,
                  "new_pool_factor": 0.9909,
                  "cumulative_losses": 50000.00,
                  "delinquency_30_plus": 0.012,
                  "delinquency_60_plus": 0.004
                },
                "dependencies": ["ANT_WATERFALL_DISTRIBUTION_JAN"]
              }
            }
          ],
          "merkle_root": "sha256:rmbs_abc123...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:rmbs_audit...", "audit_profile": "structured_finance", "storage_locations": ["s3://foray-audit/2026/Q1/RMBS_POOL_ABC123"] },
          "privacy_metadata": { "formulas_obfuscated": 5, "instance_pools": 12, "attack_complexity": "2^128 operations" }
        }
      },
      
      fxSpot: {
        name: "FX Spot Trade (USD/JPY)",
        description: "Foreign exchange spot transaction with T+2 settlement",
        data: {
          "transaction_id": "FX_SPOT_2026_USDJPY_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-23T14:30:00Z",
          "foray_core": {
            "entity": "GlobalTrade Capital LLC",
            "entity_hash": "sha256:globaltrade...",
            "transaction_type": "fx_spot",
            "total_value": 10000000.00,
            "currency": "USD",
            "status": "settled",
            "compliance_flags": ["Dodd_Frank", "EMIR", "MiFID_II", "CFTC"]
          },
          "component_hashes": {
            "arrangements": "sha256:fx_arr...",
            "accruals": "sha256:fx_acc...",
            "anticipations": "sha256:fx_ant...",
            "actions": "sha256:fx_act..."
          },
          "arrangements": [
            {
              "id": "ARR_FX_SPOT_USDJPY",
              "foray_core": {
                "type": "fx_spot_contract",
                "effective_date": "2026-01-23T14:30:00Z",
                "parties": [
                  { "role": "buyer_usd", "name": "GlobalTrade Capital LLC", "jurisdiction": "US-NY", "lei": "549300ABCDEFGHIJ1234" },
                  { "role": "seller_usd", "name": "Tokyo Metropolitan Bank", "jurisdiction": "JP", "lei": "353800XYZABCDEFG5678" }
                ],
                "description": "USD/JPY Spot - Buy 10M USD vs JPY",
                "total_value": 10000000.00,
                "currency": "USD",
                "terms": {
                  "currency_pair": "USD/JPY",
                  "direction": "buy_usd_sell_jpy",
                  "notional_usd": 10000000.00,
                  "notional_jpy": 1485000000,
                  "spot_rate": 148.50,
                  "trade_date": "2026-01-23",
                  "value_date": "2026-01-27",
                  "settlement_type": "T+2"
                },
                "execution_details": {
                  "execution_venue": "Reuters_Matching",
                  "execution_timestamp": "2026-01-23T14:30:22.456Z",
                  "dealer_spread": 0.02,
                  "mid_rate": 148.49,
                  "benchmark_fixing": "WMR_4PM_London"
                },
                "legal_documentation": ["ISDA_Master_Agreement", "FX_Definitions_2021"],
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_FX_USD_RECEIVABLE",
              "foray_core": {
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_receivable",
                "description": "USD leg receivable - awaiting T+2 settlement",
                "computation_method": "FixedAmount",
                "output": 10000000.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1150-FX Receivables USD", "amount": 10000000.00 },
                  "credit": { "account": "2150-FX Payables JPY", "amount": 10000000.00, "fx_rate": 148.50 }
                },
                "mark_to_market": {
                  "mtm_rate": 148.65,
                  "unrealized_pnl_usd": 10084.18,
                  "mtm_timestamp": "2026-01-23T21:00:00Z"
                },
                "dependencies": ["ARR_FX_SPOT_USDJPY"]
              }
            },
            {
              "id": "ACC_FX_JPY_PAYABLE",
              "foray_core": {
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_payable",
                "description": "JPY leg payable - awaiting T+2 settlement",
                "computation_method": "FixedAmount",
                "output": 1485000000,
                "currency": "JPY",
                "accounting_entry": {
                  "debit": { "account": "5500-FX Trading Expense", "amount": 1485000000, "currency": "JPY" },
                  "credit": { "account": "2155-FX Payables JPY", "amount": 1485000000, "currency": "JPY" }
                },
                "nostro_account": {
                  "bank": "Tokyo Metropolitan Bank",
                  "account_number": "JPY-NOSTRO-001",
                  "swift": "TMBJPJTT"
                },
                "dependencies": ["ARR_FX_SPOT_USDJPY"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_FX_SETTLEMENT",
              "foray_core": {
                "accrual_refs": ["ACC_FX_USD_RECEIVABLE", "ACC_FX_JPY_PAYABLE"],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_settlement",
                "description": "T+2 settlement of USD/JPY spot",
                "expected_amount": 10000000.00,
                "currency": "USD",
                "expected_date": "2026-01-27",
                "probability_factor": 0.999,
                "settlement_instructions": {
                  "usd_receiving_bank": "JPMorgan Chase",
                  "usd_account": "USD-NOSTRO-001",
                  "usd_swift": "CHASUS33",
                  "jpy_paying_bank": "Tokyo Metropolitan Bank",
                  "jpy_account": "JPY-NOSTRO-001",
                  "jpy_swift": "TMBJPJTT"
                },
                "dependencies": ["ACC_FX_USD_RECEIVABLE", "ACC_FX_JPY_PAYABLE"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_FX_TRADE_EXECUTION",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_trade_execution",
                "description": "Trade executed on Reuters Matching",
                "amount_settled": 10000000.00,
                "currency": "USD",
                "settlement_date": "2026-01-23T14:30:22Z",
                "settlement_status": "executed",
                "execution_details": {
                  "deal_id": "RTR-2026012314302245",
                  "counterparty_deal_id": "TMB-FX-20260123-0892",
                  "execution_price": 148.50,
                  "slippage_bps": 0.5
                },
                "dependencies": ["ARR_FX_SPOT_USDJPY"]
              }
            },
            {
              "id": "ACT_FX_SETTLEMENT_USD",
              "foray_core": {
                "anticipation_refs": ["ANT_FX_SETTLEMENT"],
                "accrual_refs": ["ACC_FX_USD_RECEIVABLE"],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_settlement_leg",
                "description": "USD leg settled via CHIPS",
                "amount_settled": 10000000.00,
                "currency": "USD",
                "settlement_date": "2026-01-27T16:00:00Z",
                "settlement_status": "completed",
                "payment_method": "chips",
                "counterparty": "Tokyo Metropolitan Bank",
                "allocations": [
                  { "ref": "ACC_FX_USD_RECEIVABLE", "ref_type": "accrual", "amount": 10000000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "settlement_details": {
                  "chips_uid": "20260127CHPS1234567",
                  "receiving_bank_confirmation": "JPMC-CONF-789012",
                  "settlement_time_utc": "2026-01-27T16:00:00Z"
                },
                "dependencies": ["ANT_FX_SETTLEMENT"]
              }
            },
            {
              "id": "ACT_FX_SETTLEMENT_JPY",
              "foray_core": {
                "anticipation_refs": ["ANT_FX_SETTLEMENT"],
                "accrual_refs": ["ACC_FX_JPY_PAYABLE"],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_settlement_leg",
                "description": "JPY leg settled via BOJ-NET",
                "amount_settled": 1485000000,
                "currency": "JPY",
                "settlement_date": "2026-01-27T09:00:00Z",
                "settlement_status": "completed",
                "payment_method": "boj_net",
                "counterparty": "Tokyo Metropolitan Bank",
                "allocations": [
                  { "ref": "ACC_FX_JPY_PAYABLE", "ref_type": "accrual", "amount": 1485000000, "currency": "JPY", "allocation_type": "full", "remaining_balance": 0 }
                ],
                "settlement_details": {
                  "boj_reference": "BOJNET-20260127-JP456789",
                  "paying_bank_confirmation": "TMB-PAY-CONF-2345",
                  "settlement_time_jst": "2026-01-27T18:00:00+09:00"
                },
                "dependencies": ["ANT_FX_SETTLEMENT"]
              }
            }
          ],
          "merkle_root": "sha256:fx_usdjpy_001...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:fx_audit...", "audit_profile": "trading_compliance", "storage_locations": ["s3://foray-audit/2026/Q1/FX_SPOT_USDJPY_001"] },
          "privacy_metadata": { "formulas_obfuscated": 2, "instance_pools": 6, "attack_complexity": "2^96 operations" }
        }
      },
      
      overnightRepo: {
        name: "Overnight Repo (Fixed Rate)",
        description: "Secured overnight financing - Treasury collateral with fixed interest",
        data: {
          "transaction_id": "REPO_2026_ON_TREASURY_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-24T15:00:00Z",
          "foray_core": {
            "entity": "Pinnacle Securities LLC",
            "entity_hash": "sha256:pinnacle...",
            "transaction_type": "overnight_repo",
            "total_value": 100000000.00,
            "currency": "USD",
            "status": "settled",
            "compliance_flags": ["SEC_15c3", "FINRA_4210", "Fed_Reg_T", "SOFR_Compliant"]
          },
          "component_hashes": {
            "arrangements": "sha256:repo_arr...",
            "accruals": "sha256:repo_acc...",
            "anticipations": "sha256:repo_ant...",
            "actions": "sha256:repo_act..."
          },
          "arrangements": [
            {
              "id": "ARR_REPO_OVERNIGHT",
              "foray_core": {
                "type": "repurchase_agreement",
                "effective_date": "2026-01-24T00:00:00Z",
                "parties": [
                  { "role": "cash_borrower", "name": "Pinnacle Securities LLC", "jurisdiction": "US-NY", "lei": "549300PINNACLE12345" },
                  { "role": "cash_lender", "name": "Federal Reserve Bank of New York", "jurisdiction": "US-NY", "lei": "254900FEDRESNY67890" }
                ],
                "description": "Overnight RP - US Treasury Collateral",
                "total_value": 100000000.00,
                "currency": "USD",
                "terms": {
                  "repo_type": "overnight",
                  "start_date": "2026-01-24",
                  "end_date": "2026-01-27",
                  "term_days": 3,
                  "repo_rate": 0.0530,
                  "repo_rate_basis": "ACT/360",
                  "haircut_percentage": 0.02,
                  "margin_call_threshold": 0.01
                },
                "collateral": {
                  "type": "US_Treasury",
                  "cusip": "912810SZ3",
                  "isin": "US912810SZ35",
                  "description": "US Treasury 4.25% 11/15/2034",
                  "face_value": 102000000.00,
                  "market_value": 102040000.00,
                  "accrued_interest": 850000.00,
                  "dirty_price": 100.87,
                  "collateral_value_after_haircut": 100000000.00
                },
                "legal_documentation": ["GMRA_2011", "MRA_Annex", "Tri_Party_Agreement"],
                "tri_party_agent": {
                  "name": "Bank of New York Mellon",
                  "account_id": "TPA-PINN-001"
                },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_REPO_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_interest",
                "description": "Overnight repo interest accrual (3 days over weekend)",
                "computation_method": "Calculated",
                "formula_id": "sha256:repo_interest_calc...",
                "inputs": {
                  "principal": 100000000.00,
                  "repo_rate": 0.0530,
                  "day_count_basis": "ACT/360",
                  "days": 3
                },
                "output": 44166.67,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "7200-Interest Expense - Repo", "amount": 44166.67 },
                  "credit": { "account": "2300-Repo Interest Payable", "amount": 44166.67 }
                },
                "rate_benchmark": {
                  "reference_rate": "SOFR",
                  "sofr_rate": 0.0528,
                  "spread_to_sofr": 0.0002
                },
                "dependencies": ["ARR_REPO_OVERNIGHT"]
              }
            },
            {
              "id": "ACC_COLLATERAL_VALUATION",
              "foray_core": {
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "collateral_mark",
                "description": "End of day collateral valuation",
                "computation_method": "Calculated",
                "formula_id": "sha256:collateral_mtm...",
                "inputs": {
                  "cusip": "912810SZ3",
                  "face_value": 102000000.00,
                  "price_source": "Bloomberg_BGN",
                  "closing_price": 100.92,
                  "accrued_interest_per_100": 0.85
                },
                "output": 103806600.00,
                "currency": "USD",
                "margin_status": {
                  "required_collateral": 102000000.00,
                  "actual_collateral": 103806600.00,
                  "excess_margin": 1806600.00,
                  "margin_call_required": false
                },
                "dependencies": ["ARR_REPO_OVERNIGHT"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_REPO_MATURITY",
              "foray_core": {
                "accrual_refs": ["ACC_REPO_INTEREST"],
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_maturity",
                "description": "Repo maturity - return cash + interest, receive collateral",
                "expected_amount": 100044166.67,
                "currency": "USD",
                "expected_date": "2026-01-27",
                "probability_factor": 0.9999,
                "settlement_obligations": {
                  "cash_to_return": 100044166.67,
                  "collateral_to_receive": 102000000.00,
                  "collateral_cusip": "912810SZ3"
                },
                "rollover_intent": "mature_no_roll",
                "dependencies": ["ACC_REPO_INTEREST"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_REPO_OPENING",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_opening_leg",
                "description": "Opening leg - deliver collateral, receive cash",
                "amount_settled": 100000000.00,
                "currency": "USD",
                "settlement_date": "2026-01-24T15:00:00Z",
                "settlement_status": "completed",
                "payment_method": "fedwire",
                "counterparty": "Federal Reserve Bank of New York",
                "settlement_details": {
                  "cash_settlement": {
                    "fedwire_reference": "FW20260124PINN0001",
                    "receiving_account": "Pinnacle Securities LLC",
                    "amount": 100000000.00
                  },
                  "collateral_settlement": {
                    "dtc_reference": "DTC20260124COL0001",
                    "delivering_participant": "0901",
                    "receiving_participant": "0060",
                    "cusip": "912810SZ3",
                    "face_value": 102000000.00
                  }
                },
                "dependencies": ["ARR_REPO_OVERNIGHT"]
              }
            },
            {
              "id": "ACT_REPO_CLOSING",
              "foray_core": {
                "anticipation_refs": ["ANT_REPO_MATURITY"],
                "accrual_refs": ["ACC_REPO_INTEREST"],
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_closing_leg",
                "description": "Closing leg - return cash + interest, receive collateral back",
                "amount_settled": 100044166.67,
                "currency": "USD",
                "settlement_date": "2026-01-27T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "fedwire",
                "counterparty": "Federal Reserve Bank of New York",
                "allocations": [
                  { "ref": "ANT_REPO_MATURITY", "ref_type": "anticipation", "amount": 100044166.67, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 100044166.67, "actual": 100044166.67, "difference": 0.00 },
                "settlement_details": {
                  "cash_settlement": {
                    "fedwire_reference": "FW20260127PINN0002",
                    "paying_account": "Pinnacle Securities LLC",
                    "amount": 100044166.67,
                    "breakdown": { "principal": 100000000.00, "interest": 44166.67 }
                  },
                  "collateral_settlement": {
                    "dtc_reference": "DTC20260127COL0002",
                    "delivering_participant": "0060",
                    "receiving_participant": "0901",
                    "cusip": "912810SZ3",
                    "face_value": 102000000.00
                  }
                },
                "dependencies": ["ANT_REPO_MATURITY"]
              }
            }
          ],
          "merkle_root": "sha256:repo_on_001...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:repo_audit...", "audit_profile": "securities_financing", "storage_locations": ["s3://foray-audit/2026/Q1/REPO_ON_TREASURY_001"] },
          "privacy_metadata": { "formulas_obfuscated": 2, "instance_pools": 5, "attack_complexity": "2^96 operations" }
        }
      }
    };

    // Sample Narratives - Markdown content for each sample
    const sampleNarratives = {
      batchPayment: {
        title: "Batch Payment: Many-to-Many References",
        content: `# Batch Payment: Many-to-Many References

## The Business Scenario

Acme Manufacturing owes GlobalParts Inc for three separate invoices under a Master Service Agreement (MSA):

| Invoice | Description | Amount |
|---------|-------------|--------|
| INV-2026-0142 | Q4 Component Supply | $15,000 |
| INV-2026-0156 | Emergency Parts Order | $22,500 |
| INV-2026-0171 | Maintenance Parts | $10,000 |
| **Total** | | **$47,500** |

Rather than sending three separate payments, Acme's AP team consolidates these into a single ACH batch payment of **$47,500**.

---

## How FORAY Models This Transaction

This is a classic **many-to-many** scenario&mdash;one payment settling multiple obligations. FORAY v4.1's reference arrays handle this elegantly.

### The Arrangement

The MSA governs the relationship:
- Type: Master Service Agreement
- Parties: Acme Manufacturing (buyer) / GlobalParts Inc (vendor)
- Payment Terms: Net 30
- Total Contract Value: $500,000 annually

### The Accruals (3 Invoices)

Each invoice creates an accrual&mdash;a recognized obligation:
- **ACC_INV_0142**: $15,000 (Q4 components)
- **ACC_INV_0156**: $22,500 (Emergency parts)
- **ACC_INV_0171**: $10,000 (Maintenance)

### The Anticipations (3 Payment Expectations)

Each invoice has an expected payment date:
- All three due by January 31, 2026
- Payment terms: Net 30 from invoice date

### The Action (Single Batch Payment)

Here's where v4.1 shines. The action references **all three** anticipations:

\`\`\`json
"anticipation_refs": ["ANT_PAY_0142", "ANT_PAY_0156", "ANT_PAY_0171"],
"allocations": [
  { "ref": "ANT_PAY_0142", "amount": 15000.00 },
  { "ref": "ANT_PAY_0156", "amount": 22500.00 },
  { "ref": "ANT_PAY_0171", "amount": 10000.00 }
]
\`\`\`

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Many-to-many references** | One payment &rarr; three invoices |
| **Allocations array** | Shows exact split per invoice |
| **Dependency chain** | MSA &rarr; Invoices &rarr; Payments &rarr; Settlement |

---

## Try It Yourself

Load this sample in the Transaction Review tool to see how one Action connects to multiple Anticipations through the allocations array.`
      },
      
      cashSale: {
        title: "Cash Sale: Action-Only Entry Point",
        content: `# Cash Sale: Action-Only Entry Point

## The Business Scenario

Main Street Coffee Shop processes a walk-in customer order:

| Item | Price |
|------|-------|
| Large Latte | $5.50 |
| Blueberry Muffin | $4.25 |
| Bag of Coffee Beans | $18.00 |
| **Subtotal** | $27.75 |
| Sales Tax (7.25%) | $2.01 |
| **Total** | **$29.76** |

Customer pays $30.00 cash, receives $0.24 change.

---

## How FORAY Models This Transaction

This demonstrates v4.1's **flexible entry point** feature. Not every transaction needs a contract.

### Why Action-Only Makes Sense

| B2B Invoice | Retail Cash Sale |
|-------------|------------------|
| Contract governs terms | No contract needed |
| Invoice creates obligation | Immediate settlement |
| Payment expected later | Cash received instantly |
| Complex allocation | Simple exchange |

### The Structure

- **Arrangements**: Empty \`[]\` &mdash; no contract
- **Accruals**: Empty \`[]\` &mdash; no obligation created
- **Anticipations**: Empty \`[]\` &mdash; no future payment expected
- **Actions**: Single cash receipt action

### The Action

\`\`\`json
{
  "id": "ACT_CASH_SALE_001",
  "type": "cash_receipt",
  "amount_settled": 29.76,
  "payment_method": "cash",
  "details": {
    "register_id": "REG-001",
    "cashier": "Jane D.",
    "items_sold": 3,
    "payment_tendered": 30.00,
    "change_given": 0.24
  }
}
\`\`\`

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Flexible entry point** | Action-only (no Arrangement) |
| **Minimal obfuscation** | Public retail needs less privacy |
| **Simple structure** | Right-sized for the transaction |

---

## Try It Yourself

Load this sample to see how FORAY handles simple retail transactions without forcing unnecessary complexity.`
      },
      
      autoLoan: {
        title: "Auto Loan: Full 4-Component Chain",
        content: `# Auto Loan: Full 4-Component Chain

## The Business Scenario

John Doe finances a 2024 Tesla Model 3:

| Term | Value |
|------|-------|
| Vehicle Price | $42,000 |
| Down Payment | $7,000 |
| Loan Amount | $35,000 |
| APR | 5.49% |
| Term | 60 months |
| Monthly Payment | $667.33 |

---

## How FORAY Models This Transaction

This demonstrates the **complete 4-component chain**: Arrangement &rarr; Accruals &rarr; Anticipations &rarr; Actions.

### 1. Arrangement (Loan Contract)

The Retail Installment Contract:
- Borrower: John Doe (hashed)
- Lender: First National Auto Finance
- Collateral: 2024 Tesla Model 3 (VIN hashed)
- Principal: $35,000
- Rate: 5.49% APR
- Term: 60 months

### 2. Accruals (Interest Calculations)

Monthly interest accrues on the outstanding balance:
- **February**: $163.25 (on $35,000 balance)
- **March**: $145.32 (on reduced balance)

Formula: \`Principal &times; (APR/12)\`

### 3. Anticipations (Expected Payments)

Each month, a payment is expected:
- Amount: $667.33
- Breakdown: Principal + Interest portions
- Due: 1st of each month

### 4. Actions (Actual Payments)

When payments are received:
- **Disbursement**: $35,000 to dealer
- **Payment 1**: $667.33 received Feb 1
- **Payment 2**: $667.33 received Mar 1

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Full dependency chain** | All 4 components linked |
| **Enhanced privacy** | Borrower name & VIN hashed |
| **Interest calculations** | Formula-based accruals |
| **Amortization tracking** | Principal/interest split |

---

## Try It Yourself

Load this sample to see how consumer credit transactions flow through all four FORAY components with proper privacy protection.`
      },
      
      rmbsWaterfall: {
        title: "RMBS Waterfall: Securitization Distribution",
        content: `# RMBS Waterfall: Securitization Distribution

## The Business Scenario

Structured Finance Trust 2025-1 is a $100 million RMBS with three tranches:

| Tranche | Rating | Balance | Coupon | Priority |
|---------|--------|---------|--------|----------|
| Class A (Senior) | AAA | $72,000,000 | 4.25% | 1st |
| Class B (Mezzanine) | A | $14,250,000 | 5.75% | 2nd |
| Class C (Subordinate) | BBB | $4,750,000 | 8.25% | 3rd |

January 2026's distribution: **$2,492,500** flowing through the waterfall.

---

## How FORAY Models This Transaction

### The Arrangements (3 Tranches)

Each tranche is a separate Arrangement with credit rating, coupon, and subordination level.

### The Accruals (4 Calculations)

**Pool Collections**: $2,492,500 from 450 mortgages
**Tranche Interest**: 
- Class A: $255,000
- Class B: $68,281.25
- Class C: $32,656.25

### The Anticipation (Waterfall Priority)

| Priority | Payment Type | Amount |
|----------|--------------|--------|
| 1 | Trustee Fees | $7,500 |
| 2 | Servicing Fees | $25,000 |
| 3 | Class A Interest | $255,000 |
| 4 | Class A Principal | $1,800,000 |
| 5 | Class B Interest | $68,281.25 |
| 6 | Class B Principal | $225,000 |
| 7 | Class C Interest | $32,656.25 |
| 8 | Class C Principal | $75,000 |
| 9 | Residual | $4,062.50 |

### The Action (Distribution)

Single action with allocations to all three tranches showing interest/principal breakdown.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Many-to-many references** | Pool &rarr; 3 tranches |
| **Complex allocations** | Interest/principal splits |
| **Multiple arrangements** | Parallel tranche structure |
| **Waterfall priority** | Strict payment order |

---

## The 2008 Lesson

The financial crisis revealed no one could trace mortgage payments through securitization structures. FORAY provides the transparency that was missing.`
      },
      
      energyPPA: {
        title: "Energy PPA: Solar Power Purchase Agreement",
        content: `# Energy PPA: Solar Power Purchase Agreement

## The Business Scenario

SunPower Utilities purchases solar electricity from Morocco's Ouarzazate Solar Complex:

- **Facility**: 200 MW solar farm
- **Contract**: 20-year PPA
- **January Delivery**: 38,500 MWh
- **Curtailment**: 1,500 MWh (grid congestion)
- **Price**: &euro;43.18/MWh (Year 2 with escalation)

---

## How FORAY Models This Transaction

### The Arrangement

20-year PPA terms:
- Annual commitment: 420,000 MWh
- Base price: &euro;42.50/MWh
- Escalation: 1.5%/year
- Curtailment compensation: 85%
- RECs included

### The Accruals (3 Types)

**1. Energy Delivery**: &euro;1,662,430 (38,500 MWh)
**2. Curtailment**: &euro;55,054.50 (1,500 MWh @ 85%)
**3. RECs**: &euro;140,000 (40,000 certificates @ &euro;3.50)

### The Actions (2 Settlements)

**Energy Payment**: &euro;1,717,484.50 via SWIFT
**REC Transfer**: 40,000 certificates via EU GO Registry

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Multiple accrual types** | Energy, curtailment, RECs |
| **Non-cash settlements** | Registry transfer for RECs |
| **Cross-border parties** | Morocco &rarr; Spain |
| **Physical delivery** | Meter readings captured |`
      },
      
      manufacturingWO: {
        title: "Manufacturing Work Order: Cost Allocation",
        content: `# Manufacturing Work Order: Cost Allocation

## The Business Scenario

Precision Components Manufacturing produces 100 hydraulic actuators:

| Cost Element | Amount |
|--------------|--------|
| Raw Materials | $26,350 |
| Direct Labor | $12,740 |
| Overhead | $8,758.75 |
| **Total Cost** | **$47,848.75** |

Unit cost: $478.49

---

## How FORAY Models This Transaction

### The Arrangement (Work Order)

- Product: Hydraulic Actuator Assembly (HA-2000-A)
- Quantity: 100 units
- Quality: AS9100D (aerospace)
- BOM Version: HA-2000-A-R3

### Bill of Materials

| Part | Qty/Unit | Cost |
|------|----------|------|
| Cylinder Body | 1 | $85.00 |
| Piston Assembly | 1 | $45.00 |
| Seal Kit | 1 | $12.50 |
| Control Valve | 2 | $28.00 |
| Housing | 1 | $65.00 |

### The Accruals (3 Cost Elements)

**Raw Materials**: BOM explosion &rarr; $26,350
**Direct Labor**: 245 hours &times; $52/hr &rarr; $12,740
**Overhead**: 245 hours &times; $35.75/hr &rarr; $8,758.75

### The Action (FG Receipt)

100 units transferred to Finished Goods with:
- Lot number: LOT-2026-HA2000-0042
- Quality cert: QC-2026-500-PASS
- 100% yield (0 scrap)

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Three cost accruals** | Materials, labor, overhead |
| **BOM explosion** | Component-level tracking |
| **Operation tracking** | Labor by manufacturing step |
| **Yield tracking** | Started vs. completed |`
      },
      
      depreciationEntry: {
        title: "Depreciation Entry: Accrual-Only Transaction",
        content: `# Depreciation Entry: Accrual-Only Transaction

## The Business Scenario

Month-end closing at Precision Manufacturing&mdash;recording depreciation:

| Asset Class | Original Cost | Monthly Depreciation |
|-------------|---------------|---------------------|
| CNC Machinery | $750,000 | $25,000 |
| Delivery Vehicles | $250,000 | $3,750 |
| Building | $8,000,000 | $17,083.33 |
| **Total** | | **$45,833.33** |

---

## How FORAY Models This Transaction

This demonstrates **Accrual-only** entry point&mdash;no contract, no payment, just accounting recognition.

### Why Accrual-Only Makes Sense

| Traditional Transaction | Depreciation |
|------------------------|--------------|
| Contract exists | No contract |
| Cash will flow | No cash flow |
| Counterparty involved | No counterparty |
| Settlement expected | Nothing to settle |

### The Structure

- **Arrangements**: Empty \`[]\`
- **Anticipations**: Empty \`[]\`
- **Actions**: Empty \`[]\`
- **Accruals**: 3 depreciation calculations

### Depreciation Methods

- CNC Machinery: MACRS 5-year
- Vehicles: Straight-line 5-year
- Building: Straight-line 39-year

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Flexible entry point** | Accrual-only |
| **Multiple accruals** | 3 asset classes |
| **Formula hashing** | Methods protected |
| **Accumulated tracking** | Running totals |`
      },
      
      fxSpot: {
        title: "FX Spot Trade: Multi-Currency Settlement",
        content: `# FX Spot Trade: Multi-Currency Settlement

## The Business Scenario

Global Treasury executes a EUR/USD spot trade:

- **Buy**: &euro;1,000,000
- **Sell**: $1,085,000
- **Rate**: 1.0850
- **Settlement**: T+2 (January 27, 2026)

By settlement, EUR/USD moved to 1.0875 &rarr; **$2,500 realized gain**.

---

## How FORAY Models This Transaction

### The Arrangement

FX spot contract:
- Currency pair: EUR/USD
- Settlement: T+2
- EUR Nostro: Deutsche Bank
- USD Nostro: JPMorgan Chase

### The Accruals (Mark-to-Market)

**Trade Date (T+0)**: P&L = $0
**T+1**: Market rate 1.0875 &rarr; Unrealized P&L = $2,500

### The Anticipations (Two Legs)

**EUR Receipt**: &euro;1,000,000 expected
**USD Payment**: $1,085,000 expected

### The Actions (Three Settlements)

**1. EUR Received**: &euro;1,000,000 via SWIFT
**2. USD Paid**: $1,085,000 via Fedwire
**3. P&L Realized**: $2,500 gain booked

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Dual-currency flows** | EUR in, USD out |
| **Mark-to-market** | Daily valuation |
| **Two anticipations** | Separate currency legs |
| **Variance tracking** | Rate movement P&L |`
      },
      
      overnightRepo: {
        title: "Overnight Repo: Collateral and SOFR",
        content: `# Overnight Repo: Collateral and SOFR

## The Business Scenario

Alpha Capital borrows $50M overnight against Treasury collateral:

| Term | Value |
|------|-------|
| Principal | $50,000,000 |
| Rate | SOFR + 5bps (5.30%) |
| Term | 3 days (weekend) |
| Collateral | UST 4.25% 2028 |
| Haircut | 2% |
| Interest | $22,083.33 |

---

## How FORAY Models This Transaction

### The Arrangement

Repo agreement:
- Principal: $50,000,000
- Repurchase price: $50,022,083.33
- Collateral: $51,020,000 market value
- Legal: SIFMA Master Repo Agreement

### The Accruals (3 Components)

**Day 1 Interest**: $7,361.11
**Days 2-3 Interest**: $14,722.22 (weekend at Friday SOFR)
**Collateral Valuation**: $51,020,000 (no margin call needed)

### The Actions (Two Legs)

**Opening Leg** (Friday):
- Cash received: $50,000,000
- Collateral delivered via DTC

**Closing Leg** (Monday):
- Cash returned: $50,022,083.33
- Collateral received via DTC

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Two-leg structure** | Opening and closing |
| **Daily accruals** | SOFR rate tracking |
| **Collateral tracking** | Market value, haircut |
| **DTC settlement** | Securities movement |`
      },
      
      salesforceOpp: {
        title: "Salesforce Opportunity: CRM Integration",
        content: `# Salesforce Opportunity: CRM Integration

## The Business Scenario

CloudTech closes a $285,000 enterprise deal:

| Product | Amount | Recognition |
|---------|--------|-------------|
| 3-Year License | $225,000 | 36 months |
| Implementation | $45,000 | 3 months |
| Training | $15,000 | Immediate |

---

## How FORAY Models This Transaction

### The Arrangement (Salesforce Opportunity)

CRM record IDs captured:
- Opportunity: 006Dn00000ABC123XYZ
- Account: 001Dn00000DEF456UVW
- Quote: 0Q0Dn00000PQR345STU

### The Accruals (ASC 606 Recognition)

**Subscription** (pro-rated January): $2,419.35
**Implementation** (30% milestone): $13,500.00
**Training** (delivered): $15,000.00
**AR Invoice**: $135,000.00

### The Anticipation

Payment expected within 30 days with 2% early-pay discount option.

### The Action

Customer pays early: $132,300 (takes 2% discount)

Variance: Expected $135,000, Actual $132,300, Difference -$2,700

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **CRM integration** | Salesforce IDs in every component |
| **Multiple recognition** | Over-time vs. point-in-time |
| **Milestone tracking** | Implementation percentage |
| **Discount handling** | Early payment variance |`
      }
    };

    // Network Configuration
    const KASPA_NETWORKS = {
      'testnet-10': {
        id: 'testnet-10',
        name: 'Testnet 10',
        description: 'Stable testnet mirroring mainnet (1 BPS)',
        rpcUrl: 'https://api-tn10.kaspa.org',
        explorerUrl: 'https://explorer-tn10.kaspa.org',
        faucetUrl: 'https://faucet-tn10.kaspa.org',
        isTestnet: true,
        bps: 1
      },
      'testnet-11': {
        id: 'testnet-11',
        name: 'Testnet 11',
        description: 'Experimental testnet (10 BPS)',
        rpcUrl: 'https://api-tn11.kaspa.org',
        explorerUrl: 'https://explorer-tn11.kaspa.org',
        faucetUrl: 'https://faucet-tn11.kaspa.org',
        isTestnet: true,
        bps: 10
      },
      'mainnet': {
        id: 'mainnet',
        name: 'Mainnet',
        description: 'Production network (Real KAS)',
        rpcUrl: 'https://api.kaspa.org',
        explorerUrl: 'https://explorer.kaspa.org',
        faucetUrl: null,
        isTestnet: false,
        bps: 10
      }
    };

    // Main Component
    const ForayTransactionReviewV41 = () => {
      const [jsonInput, setJsonInput] = useState('');
      const [transactionData, setTransactionData] = useState(null);
      const [parseError, setParseError] = useState(null);
      const [validationResult, setValidationResult] = useState(null);
      const [originalVersion, setOriginalVersion] = useState(null);
      const [showSampleDropdown, setShowSampleDropdown] = useState(false);
      const [showNotes, setShowNotes] = useState(false);
      const [showJsonModal, setShowJsonModal] = useState(false);
      const [showNarrativeModal, setShowNarrativeModal] = useState(false);
      const [currentSampleKey, setCurrentSampleKey] = useState(null);
      const [showAnchorConfirm, setShowAnchorConfirm] = useState(false);
      const [isAnchoring, setIsAnchoring] = useState(false);
      const [anchorResult, setAnchorResult] = useState(null);
      const [selectedNetwork, setSelectedNetwork] = useState('testnet-10');
      const [showNetworkDropdown, setShowNetworkDropdown] = useState(false);
      const [showMainnetWarning, setShowMainnetWarning] = useState(false);
      const [pendingNetworkSwitch, setPendingNetworkSwitch] = useState(null);
      const [walletConnected, setWalletConnected] = useState(false);
      const [walletAddress, setWalletAddress] = useState(null);
      const [expandedSections, setExpandedSections] = useState({
        metadata: true,
        forayCore: true,
        blockchainAnchor: false,
        auditDataAnchor: false,
        arrangements: false,
        accruals: false,
        anticipations: false,
        actions: false,
        privacy: false
      });

      // Function to scroll to a component by ID
      const scrollToComponent = (componentId) => {
        // First expand the section containing this component
        if (componentId.startsWith('ARR_')) setExpandedSections(prev => ({ ...prev, arrangements: true }));
        else if (componentId.startsWith('ACC_')) setExpandedSections(prev => ({ ...prev, accruals: true }));
        else if (componentId.startsWith('ANT_')) setExpandedSections(prev => ({ ...prev, anticipations: true }));
        else if (componentId.startsWith('ACT_')) setExpandedSections(prev => ({ ...prev, actions: true }));
        
        // Small delay to allow section to expand before scrolling
        setTimeout(() => {
          const el = document.getElementById(`component-${componentId}`);
          if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Flash highlight effect
            el.style.transition = 'box-shadow 0.3s ease';
            el.style.boxShadow = `0 0 0 3px ${forayColors.actionAmber}`;
            setTimeout(() => {
              el.style.boxShadow = 'none';
            }, 2000);
          }
        }, 150);
      };

      // Get current network config
      const currentNetwork = KASPA_NETWORKS[selectedNetwork];

      // Handle network change
      const handleNetworkChange = (networkId) => {
        if (networkId === 'mainnet' && selectedNetwork !== 'mainnet') {
          setPendingNetworkSwitch(networkId);
          setShowMainnetWarning(true);
          setShowNetworkDropdown(false);
        } else {
          setSelectedNetwork(networkId);
          setShowNetworkDropdown(false);
        }
      };

      // Confirm mainnet switch
      const confirmMainnetSwitch = () => {
        setSelectedNetwork(pendingNetworkSwitch);
        setShowMainnetWarning(false);
        setPendingNetworkSwitch(null);
      };

      // Cancel mainnet switch
      const cancelMainnetSwitch = () => {
        setShowMainnetWarning(false);
        setPendingNetworkSwitch(null);
      };

      // Check if KasWare wallet is available
      const isKasWareAvailable = () => {
        return typeof window !== 'undefined' && window.kasware;
      };

      // Get KasWare network name for our network ID
      const getKasWareNetworkName = (networkId) => {
        if (networkId === 'mainnet') return 'mainnet';
        return 'testnet'; // KasWare uses 'testnet' for all testnets
      };

      // Connect to KasWare wallet
      const connectWallet = async () => {
        if (!isKasWareAvailable()) {
          alert('KasWare wallet not detected!\n\nPlease install the KasWare browser extension from:\nhttps://kasware.xyz\n\nThen refresh this page and try again.');
          return;
        }

        try {
          // Request account access
          const accounts = await window.kasware.requestAccounts();
          if (accounts && accounts.length > 0) {
            setWalletAddress(accounts[0]);
            setWalletConnected(true);
            
            // Check and sync network
            const walletNetwork = await window.kasware.getNetwork();
            const expectedNetwork = getKasWareNetworkName(selectedNetwork);
            
            // KasWare returns network as string or number depending on version
            const isTestnet = walletNetwork === 'testnet' || walletNetwork === 1;
            const isMainnet = walletNetwork === 'mainnet' || walletNetwork === 0;
            
            if (selectedNetwork === 'mainnet' && !isMainnet) {
              alert('Note: Your KasWare wallet is on Testnet. Please switch to Mainnet in KasWare settings if you want to anchor to Mainnet.');
            } else if (selectedNetwork !== 'mainnet' && !isTestnet) {
              alert('Note: Your KasWare wallet is on Mainnet. Please switch to Testnet in KasWare settings for testing.');
            }
          }
        } catch (err) {
          console.error('Wallet connection error:', err);
          alert('Failed to connect wallet: ' + (err.message || 'Unknown error'));
        }
      };

      // Disconnect wallet
      const disconnectWallet = async () => {
        if (isKasWareAvailable()) {
          try {
            await window.kasware.disconnect(window.location.origin);
          } catch (err) {
            console.log('Disconnect error (non-critical):', err);
          }
        }
        setWalletConnected(false);
        setWalletAddress(null);
      };

      // Compute a simple hash of the transaction data for anchoring
      const computeTransactionHash = async (txData) => {
        const dataString = JSON.stringify(txData);
        const encoder = new TextEncoder();
        const data = encoder.encode(dataString);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
      };

      // Handle blockchain anchoring - REAL KasWare integration
      const handleAnchorToBlockchain = async () => {
        setShowAnchorConfirm(false);
        setIsAnchoring(true);
        
        try {
          // Check wallet connection
          if (!walletConnected || !walletAddress) {
            throw new Error('Wallet not connected. Please connect your KasWare wallet first.');
          }

          if (!isKasWareAvailable()) {
            throw new Error('KasWare wallet not available.');
          }

          // Compute the merkle root / hash of the transaction
          const merkleRoot = await computeTransactionHash(transactionData);
          const startTime = Date.now();

          // Send a transaction to ourselves that satisfies KIP-9 storage mass requirements
          // KIP-9 penalizes small UTXOs to prevent state bloat - we need ~0.2 KAS minimum
          // The transaction itself serves as the anchor - the tx ID is the proof
          // Note: In production, FORAY uses chunked multi-transaction anchoring for full data
          const txResponse = await window.kasware.sendKaspa(
            walletAddress,  // Send to self
            20000000        // 0.2 KAS in sompi (satisfies KIP-9 storage mass)
          );

          const confirmationTime = Date.now() - startTime;

          if (!txResponse) {
            throw new Error('Transaction failed - no transaction ID returned');
          }

          // Extract the transaction ID - KasWare returns complex object
          // Response structure: {id: "txhash", inputs: [...], outputs: [...], ...}
          let txId;
          if (typeof txResponse === 'string') {
            // If it's already a string, check if it's JSON
            try {
              const parsed = JSON.parse(txResponse);
              txId = parsed.id || parsed.txid || parsed.transactionId || txResponse;
            } catch {
              txId = txResponse;
            }
          } else if (typeof txResponse === 'object') {
            // Direct object - extract the id field
            txId = txResponse.id || txResponse.txid || txResponse.transactionId;
            if (!txId) {
              // Log for debugging
              console.log('KasWare response structure:', Object.keys(txResponse));
              console.log('Full response:', JSON.stringify(txResponse).substring(0, 200));
            }
          }
          
          if (!txId) {
            throw new Error('Could not extract transaction ID from response');
          }

          // Build the result with real transaction ID
          const result = {
            success: true,
            timestamp: new Date().toISOString(),
            kaspa: {
              transaction_id: txId,
              block_height: 'Pending confirmation',
              block_hash: 'Pending confirmation',
              confirmations: 0,
              confirmation_time_ms: confirmationTime,
              explorer_url: `${currentNetwork.explorerUrl}/txs/${txId}`
            },
            foray: {
              transaction_id: transactionData.transaction_id,
              schema_version: transactionData.schema_version,
              merkle_root: `sha256:${merkleRoot.substring(0, 32)}...`,
              entity: transactionData.foray_core?.entity || 'Unknown Entity',
              total_value: transactionData.foray_core?.total_value || 0,
              currency: transactionData.foray_core?.currency || 'USD',
              component_summary: {
                arrangements: transactionData.arrangements?.length || 0,
                accruals: transactionData.accruals?.length || 0,
                anticipations: transactionData.anticipations?.length || 0,
                actions: transactionData.actions?.length || 0
              }
            },
            anchored_by: `Wallet: ${walletAddress.substring(0, 20)}...`,
            network: currentNetwork.name
          };

          setAnchorResult(result);

        } catch (err) {
          console.error('Anchoring error:', err);
          alert('Anchoring failed: ' + (err.message || 'Unknown error') + '\n\nMake sure you have enough test KAS in your wallet.');
        } finally {
          setIsAnchoring(false);
        }
      };

      // Print anchor result
      const handlePrintAnchorResult = () => {
        window.print();
      };

      // Copy anchor details to clipboard
      const copyAnchorDetails = () => {
        const details = `FORAY Blockchain Anchor Verification
=====================================
Timestamp: ${anchorResult.timestamp}

KASPA BLOCKCHAIN
Transaction ID: ${anchorResult.kaspa.transaction_id}
Block Height: ${anchorResult.kaspa.block_height}
Block Hash: ${anchorResult.kaspa.block_hash}
Confirmations: ${anchorResult.kaspa.confirmations}
Confirmation Time: ${anchorResult.kaspa.confirmation_time_ms}ms
Explorer: ${anchorResult.kaspa.explorer_url}

FORAY TRANSACTION
Transaction ID: ${anchorResult.foray.transaction_id}
Schema Version: ${anchorResult.foray.schema_version}
Merkle Root: ${anchorResult.foray.merkle_root}
Entity: ${anchorResult.foray.entity}
Total Value: ${anchorResult.foray.total_value} ${anchorResult.foray.currency}
Components: ${anchorResult.foray.component_summary.arrangements} Arrangements, ${anchorResult.foray.component_summary.accruals} Accruals, ${anchorResult.foray.component_summary.anticipations} Anticipations, ${anchorResult.foray.component_summary.actions} Actions

Network: ${anchorResult.network}
Anchored By: ${anchorResult.anchored_by}`;
        
        navigator.clipboard.writeText(details);
        alert('Anchor details copied to clipboard!');
      };

      const formatCurrency = (amount, currency = 'USD') => {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount || 0);
      };

      const parseJSON = () => {
        try {
          setParseError(null);
          const parsed = JSON.parse(jsonInput);
          const origVersion = parsed.schema_version || parsed._v || '3.0';
          setOriginalVersion(origVersion);
          const migrated = migrateToV41(parsed);
          const validation = validateV41Transaction(migrated);
          setValidationResult(validation);
          setTransactionData(migrated);
        } catch (error) {
          setParseError(`Invalid JSON: ${error.message}`);
          setTransactionData(null);
          setValidationResult(null);
        }
      };

      const loadSampleTransaction = (sampleKey) => {
        const sample = sampleTransactions[sampleKey];
        if (sample) {
          setJsonInput(JSON.stringify(sample.data, null, 2));
          setCurrentSampleKey(sampleKey);
          setShowSampleDropdown(false);
        }
      };

      const clearTransaction = () => {
        setTransactionData(null);
        setJsonInput('');
        setParseError(null);
        setValidationResult(null);
        setOriginalVersion(null);
        setCurrentSampleKey(null);
      };

      const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
      };

      const expandAll = () => {
        setExpandedSections(Object.keys(expandedSections).reduce((acc, key) => ({ ...acc, [key]: true }), {}));
      };

      const collapseAll = () => {
        setExpandedSections(Object.keys(expandedSections).reduce((acc, key) => ({ ...acc, [key]: false }), {}));
      };

      const handlePrint = () => {
        // Expand all sections before printing
        expandAll();
        // Wait for state update, then print
        setTimeout(() => {
          window.print();
        }, 100);
      };

      const getForayCore = (component) => component.foray_core || component;

      return (
        <div className="min-h-screen p-6" style={{ background: `linear-gradient(to bottom right, ${forayColors.bgLight}, #E8F4F5)` }}>
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="mb-8">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-3">
                  <h1 className="text-3xl font-bold">
                    <span style={{ color: forayColors.primaryTeal }}>FORAY</span>{' '}
                    <span style={{ color: forayColors.highlightMint }}>Protocol</span>{' '}
                    <span style={{ color: forayColors.secondaryNavy }}>Transaction Review</span>
                  </h1>
                  <span className="px-2 py-1 text-xs font-bold rounded" style={{ backgroundColor: forayColors.actionAmber, color: 'white' }}>v4.1</span>
                </div>
                
                {/* Network & Wallet Controls */}
                <div className="flex items-center gap-3">
                  {/* Network Selector */}
                  <div className="relative">
                    <button 
                      onClick={() => setShowNetworkDropdown(!showNetworkDropdown)}
                      className="px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2"
                      style={{ 
                        backgroundColor: currentNetwork.isTestnet ? `${forayColors.actionAmber}20` : `${forayColors.errorRed}20`,
                        color: currentNetwork.isTestnet ? forayColors.actionAmber : forayColors.errorRed,
                        border: `1px solid ${currentNetwork.isTestnet ? forayColors.actionAmber : forayColors.errorRed}`
                      }}
                    >
                      <GitBranch className="w-4 h-4" />
                      {currentNetwork.name}
                      {currentNetwork.isTestnet && <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: forayColors.actionAmber, color: 'white' }}>TEST</span>}
                      {!currentNetwork.isTestnet && <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: forayColors.errorRed, color: 'white' }}>LIVE</span>}
                      <ChevronDown className="w-3 h-3" style={{ transform: showNetworkDropdown ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                    </button>
                    {showNetworkDropdown && (
                      <div className="absolute top-full right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border z-50" style={{ borderColor: forayColors.gray400 }}>
                        <div className="p-2 border-b text-xs font-medium" style={{ borderColor: forayColors.gray400, color: forayColors.gray600 }}>
                          Select Kaspa Network
                        </div>
                        {Object.values(KASPA_NETWORKS).map((network) => (
                          <button
                            key={network.id}
                            onClick={() => handleNetworkChange(network.id)}
                            className={`w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center justify-between ${selectedNetwork === network.id ? 'bg-gray-50' : ''}`}
                          >
                            <div>
                              <div className="flex items-center gap-2">
                                <p className="font-medium" style={{ color: forayColors.secondaryNavy }}>{network.name}</p>
                                {network.isTestnet ? (
                                  <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: `${forayColors.actionAmber}20`, color: forayColors.actionAmber }}>Testnet</span>
                                ) : (
                                  <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: `${forayColors.errorRed}20`, color: forayColors.errorRed }}>Mainnet</span>
                                )}
                              </div>
                              <p className="text-xs mt-0.5" style={{ color: forayColors.gray600 }}>{network.description}</p>
                            </div>
                            {selectedNetwork === network.id && (
                              <CheckCircle className="w-4 h-4" style={{ color: forayColors.successGreen }} />
                            )}
                          </button>
                        ))}
                        {currentNetwork.faucetUrl && (
                          <div className="p-3 border-t" style={{ borderColor: forayColors.gray400 }}>
                            <a 
                              href={currentNetwork.faucetUrl} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="text-xs flex items-center gap-1"
                              style={{ color: forayColors.primaryTeal }}
                            >
                              <DollarSign className="w-3 h-3" /> Get free test KAS from faucet &rarr;
                            </a>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  
                  {/* Wallet Connection */}
                  {!walletConnected ? (
                    <button 
                      onClick={connectWallet}
                      className="px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2"
                      style={{ backgroundColor: forayColors.secondaryNavy, color: 'white' }}
                    >
                      <Link2 className="w-4 h-4" />
                      Connect Wallet
                    </button>
                  ) : (
                    <div className="flex items-center gap-2">
                      <div className="px-3 py-2 rounded-lg text-sm flex items-center gap-2" style={{ backgroundColor: `${forayColors.successGreen}20`, color: forayColors.successGreen }}>
                        <CheckCircle className="w-4 h-4" />
                        <span className="font-mono text-xs">{walletAddress?.substring(0, 15)}...</span>
                      </div>
                      <button 
                        onClick={disconnectWallet}
                        className="p-2 rounded-lg hover:bg-gray-100"
                        title="Disconnect wallet"
                      >
                        <X className="w-4 h-4" style={{ color: forayColors.gray600 }} />
                      </button>
                    </div>
                  )}
                </div>
              </div>
              <p style={{ color: forayColors.gray600 }}>Secure, role-based access to blockchain audit trails with many-to-many reference support</p>
            </div>

            {/* Input Section */}
            {!transactionData && (
              <Card className="mb-6">
                <div className="flex items-center gap-3 mb-4">
                  <Upload className="w-6 h-6" style={{ color: forayColors.primaryTeal }} />
                  <div>
                    <h2 className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Load Transaction JSON</h2>
                    <p className="text-sm" style={{ color: forayColors.gray600 }}>Paste FORAY Protocol JSON (v3.0, v4.0, or v4.1 - auto-migrates to v4.1)</p>
                  </div>
                </div>
                
                <textarea
                  value={jsonInput}
                  onChange={(e) => setJsonInput(e.target.value)}
                  placeholder={`{\n  "transaction_id": "FORAY_TX_001",\n  "schema_version": "4.1",\n  "foray_core": { ... },\n  "arrangements": [...],\n  ...\n}`}
                  className="w-full h-80 p-4 border rounded-lg focus:outline-none focus:ring-2 font-mono text-sm"
                  style={{ borderColor: forayColors.gray400 }}
                />
                
                {parseError && (
                  <div className="mt-3 p-3 rounded-lg flex items-center gap-2" style={{ backgroundColor: '#fee2e2', color: '#b91c1c' }}>
                    <AlertCircle className="w-4 h-4" />
                    <span className="text-sm">{parseError}</span>
                  </div>
                )}
                
                <div className="mt-4 flex gap-3">
                  <button onClick={parseJSON} className="px-6 py-2.5 text-white rounded-lg font-medium" style={{ backgroundColor: forayColors.primaryTeal }}>
                    Parse & Review
                  </button>
                  <div className="relative">
                    <button 
                      onClick={() => setShowSampleDropdown(!showSampleDropdown)} 
                      className="px-6 py-2.5 rounded-lg font-medium flex items-center gap-2" 
                      style={{ backgroundColor: 'transparent', color: forayColors.primaryTeal, border: `2px solid ${forayColors.primaryTeal}` }}
                    >
                      Load V4.1 Sample
                      <ChevronDown className="w-4 h-4" style={{ transform: showSampleDropdown ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                    </button>
                    {showSampleDropdown && (
                      <div className="absolute top-full left-0 mt-2 w-80 bg-white rounded-lg shadow-lg border z-50" style={{ borderColor: forayColors.gray400 }}>
                        {Object.entries(sampleTransactions).map(([key, sample]) => (
                          <button
                            key={key}
                            onClick={() => loadSampleTransaction(key)}
                            className="w-full text-left px-4 py-3 hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg border-b last:border-b-0"
                            style={{ borderColor: `${forayColors.gray400}30` }}
                          >
                            <p className="font-medium" style={{ color: forayColors.secondaryNavy }}>{sample.name}</p>
                            <p className="text-xs mt-0.5" style={{ color: forayColors.gray600 }}>{sample.description}</p>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </Card>
            )}

            {/* Transaction Display */}
            {transactionData && (
              <div className="space-y-4">
                {/* Version & Validation Banner */}
                <Card>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2">
                        <Layers className="w-5 h-5" style={{ color: forayColors.primaryTeal }} />
                        <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Schema Version:</span>
                        <span className="px-2 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.primaryTeal}20`, color: forayColors.primaryTeal }}>
                          {transactionData.schema_version}
                        </span>
                        {originalVersion !== transactionData.schema_version && (
                          <span className="text-xs" style={{ color: forayColors.gray600 }}>(migrated from {originalVersion})</span>
                        )}
                      </div>
                      
                      {validationResult && (
                        <div className="flex items-center gap-2">
                          {validationResult.valid ? (
                            <>
                              <CheckCircle className="w-5 h-5" style={{ color: forayColors.successGreen }} />
                              <span className="text-sm font-medium" style={{ color: forayColors.successGreen }}>Valid Transaction</span>
                            </>
                          ) : (
                            <>
                              <AlertCircle className="w-5 h-5" style={{ color: forayColors.errorRed }} />
                              <span className="text-sm font-medium" style={{ color: forayColors.errorRed }}>{validationResult.errors.length} Validation Error(s)</span>
                            </>
                          )}
                        </div>
                      )}
                    </div>
                    
                    <div className="flex gap-2 no-print">
                      <button onClick={clearTransaction} className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}>
                        <Upload className="w-4 h-4" /> Load New Transaction
                      </button>
                      <button onClick={() => { setTransactionData(null); setJsonInput(''); }} className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" style={{ backgroundColor: '#dc2626', color: 'white' }}>
                        <RotateCcw className="w-4 h-4" /> Reset
                      </button>
                      <button onClick={handlePrint} className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" style={{ backgroundColor: forayColors.secondaryNavy, color: 'white' }}>
                        <Printer className="w-4 h-4" /> Print / Save PDF
                      </button>
                      <button onClick={expandAll} className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>
                        <ChevronDown className="w-4 h-4" /> Expand All
                      </button>
                      <button onClick={collapseAll} className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}>
                        <ChevronRight className="w-4 h-4" /> Collapse All
                      </button>
                      <button onClick={() => setShowNotes(true)} className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" style={{ backgroundColor: forayColors.highlightMint, color: forayColors.secondaryNavy }}>
                        <FileText className="w-4 h-4" /> Notes
                      </button>
                      <button onClick={() => setShowJsonModal(true)} className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" style={{ backgroundColor: forayColors.highlightMint, color: forayColors.secondaryNavy }}>
                        <FileText className="w-4 h-4" /> JSON
                      </button>
                      <button 
                        onClick={() => {
                          if (!walletConnected) {
                            alert('Please connect your KasWare wallet first using the "Connect Wallet" button in the header.');
                            return;
                          }
                          setShowAnchorConfirm(true);
                        }} 
                        className="px-4 py-2 text-sm rounded-lg flex items-center gap-2" 
                        style={{ 
                          backgroundColor: walletConnected ? forayColors.secondaryNavy : forayColors.gray400, 
                          color: 'white',
                          cursor: walletConnected ? 'pointer' : 'not-allowed'
                        }}
                        title={walletConnected ? 'Anchor transaction to blockchain' : 'Connect wallet first'}
                      >
                        <Link2 className="w-4 h-4" /> Anchor to Blockchain
                      </button>
                    </div>
                  </div>
                  
                  {/* Component Counts */}
                  {validationResult && (
                    <div className="mt-4 flex flex-wrap gap-4">
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Arrangements:</span>
                        <span className="font-bold" style={{ color: forayColors.primaryTeal }}>{validationResult.componentCounts.arrangements}</span>
                      </div>
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Accruals:</span>
                        <span className="font-bold" style={{ color: forayColors.accentCyan }}>{validationResult.componentCounts.accruals}</span>
                      </div>
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Anticipations:</span>
                        <span className="font-bold" style={{ color: forayColors.actionAmber }}>{validationResult.componentCounts.anticipations}</span>
                      </div>
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.successGreen}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Actions:</span>
                        <span className="font-bold" style={{ color: forayColors.successGreen }}>{validationResult.componentCounts.actions}</span>
                      </div>
                      {validationResult.entryPointType && (
                        <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: '#f3e8ff' }}>
                          <span className="text-sm" style={{ color: forayColors.gray600 }}>Entry Point:</span>
                          <span className="font-bold capitalize" style={{ color: '#7c3aed' }}>{validationResult.entryPointType}</span>
                        </div>
                      )}
                    </div>
                  )}
                  
                  {validationResult?.errors?.length > 0 && (
                    <div className="mt-4 p-3 rounded-lg" style={{ backgroundColor: '#fee2e2' }}>
                      <p className="font-medium text-sm mb-2" style={{ color: '#b91c1c' }}>Validation Errors:</p>
                      <ul className="text-sm space-y-1" style={{ color: '#b91c1c' }}>
                        {validationResult.errors.map((err, idx) => <li key={idx}>&bull; {err}</li>)}
                      </ul>
                    </div>
                  )}
                </Card>

                {/* Transaction Metadata */}
                <div>
                  <SectionHeader 
                    title="Transaction Metadata" 
                    icon={FileText} 
                    isExpanded={expandedSections.metadata} 
                    onToggle={() => toggleSection('metadata')}
                    action={currentSampleKey && sampleNarratives[currentSampleKey] && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowNarrativeModal(true);
                        }}
                        className="px-3 py-1.5 text-xs rounded-lg flex items-center gap-1.5 no-print"
                        style={{ 
                          backgroundColor: forayColors.actionAmber,
                          color: forayColors.textDark
                        }}
                        title="View narrative explanation for this sample"
                      >
                        <BookOpen className="w-4 h-4" />
                        View Narrative
                      </button>
                    )}
                  />
                  {expandedSections.metadata && (
                    <Card className="mt-2">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                          <KeyValue label="Transaction ID" value={transactionData.transaction_id} mono />
                          <KeyValue label="Timestamp" value={transactionData.timestamp} />
                          <KeyValue label="Schema Version" value={transactionData.schema_version} />
                        </div>
                        <div>
                          <KeyValue label="Merkle Root" value={transactionData.merkle_root?.substring(0, 24) + '...'} mono />
                        </div>
                      </div>
                    </Card>
                  )}
                </div>

                {/* FORAY Core */}
                {transactionData.foray_core && (
                  <div>
                    <SectionHeader title="FORAY Core" icon={Layers} isExpanded={expandedSections.forayCore} onToggle={() => toggleSection('forayCore')} badge="v4.1" />
                    {expandedSections.forayCore && (
                      <Card className="mt-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <KeyValue label="Entity" value={transactionData.foray_core.entity} />
                            <KeyValue label="Entity Hash" value={transactionData.foray_core.entity_hash?.substring(0, 20) + '...'} mono />
                            <KeyValue label="Transaction Type" value={transactionData.foray_core.transaction_type} />
                          </div>
                          <div>
                            <KeyValue label="Total Value" value={formatCurrency(transactionData.foray_core.total_value, transactionData.foray_core.currency)} />
                            <KeyValue label="Currency" value={transactionData.foray_core.currency} />
                            <div className="flex justify-between items-center py-2">
                              <span className="text-sm" style={{ color: forayColors.gray600 }}>Status</span>
                              <StatusBadge status={transactionData.foray_core.status} />
                            </div>
                          </div>
                        </div>
                        {transactionData.foray_core.compliance_flags?.length > 0 && (
                          <div className="mt-4 pt-4" style={{ borderTop: `1px solid ${forayColors.gray400}30` }}>
                            <p className="text-sm font-medium mb-2" style={{ color: forayColors.gray600 }}>Compliance Flags</p>
                            <div className="flex flex-wrap gap-2">
                              {transactionData.foray_core.compliance_flags.map((flag, idx) => (
                                <span key={idx} className="px-2 py-1 text-xs rounded" style={{ backgroundColor: `${forayColors.secondaryNavy}15`, color: forayColors.secondaryNavy }}>{flag}</span>
                              ))}
                            </div>
                          </div>
                        )}
                      </Card>
                    )}
                  </div>
                )}

                {/* Blockchain Anchor */}
                {transactionData.blockchain_anchor && (
                  <div>
                    <SectionHeader title="Blockchain Anchor" icon={Lock} isExpanded={expandedSections.blockchainAnchor} onToggle={() => toggleSection('blockchainAnchor')} />
                    {expandedSections.blockchainAnchor && (
                      <Card className="mt-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <KeyValue label="Kaspa TX ID" value={transactionData.blockchain_anchor.kaspa_tx_id?.substring(0, 30) + '...'} mono />
                            <KeyValue label="Block Height" value={transactionData.blockchain_anchor.block_height?.toLocaleString()} />
                          </div>
                          <div>
                            <KeyValue label="Confirmation Time" value={`${transactionData.blockchain_anchor.confirmation_time_ms || 'N/A'} ms`} />
                            <KeyValue label="Anchored At" value={transactionData.blockchain_anchor.anchored_at} />
                          </div>
                        </div>
                      </Card>
                    )}
                  </div>
                )}

                {/* Arrangements */}
                {transactionData.arrangements?.length > 0 && (
                  <div>
                    <SectionHeader title="Arrangements" icon={Users} isExpanded={expandedSections.arrangements} onToggle={() => toggleSection('arrangements')} count={transactionData.arrangements.length} />
                    {expandedSections.arrangements && (
                      <div className="mt-2 space-y-3">
                        {transactionData.arrangements.map((arr, idx) => {
                          const core = getForayCore(arr);
                          return (
                            <Card key={idx} id={`component-${arr.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.primaryTeal}15`, color: forayColors.primaryTeal }}>{arr.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                </div>
                                {core.effective_date && (
                                  <span className="text-sm" style={{ color: forayColors.gray600 }}>Effective: {new Date(core.effective_date).toLocaleDateString()}</span>
                                )}
                              </div>
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.total_value && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Total Value</p>
                                  <p className="text-xl font-bold" style={{ color: forayColors.primaryTeal }}>{formatCurrency(core.total_value, core.currency)}</p>
                                </div>
                              )}
                              {core.parties?.length > 0 && (
                                <div className="mb-4">
                                  <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>Parties</p>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {core.parties.map((party, pIdx) => (
                                      <div key={pIdx} className="p-2 rounded text-sm" style={{ backgroundColor: forayColors.bgLight }}>
                                        <span className="font-medium capitalize">{party.role}: </span>
                                        <span style={{ color: forayColors.gray600 }}>{party.name}</span>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                              {renderObjectAsTable(core.terms, 'Terms')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Accruals */}
                {transactionData.accruals?.length > 0 && (
                  <div>
                    <SectionHeader title="Accruals" icon={TrendingUp} isExpanded={expandedSections.accruals} onToggle={() => toggleSection('accruals')} count={transactionData.accruals.length} />
                    {expandedSections.accruals && (
                      <div className="mt-2 space-y-3">
                        {transactionData.accruals.map((acc, idx) => {
                          const core = getForayCore(acc);
                          return (
                            <Card key={idx} id={`component-${acc.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.accentCyan}15`, color: forayColors.accentCyan }}>{acc.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                  {core.computation_method && <span className="px-2 py-0.5 text-xs rounded" style={{ backgroundColor: '#f3e8ff', color: '#7c3aed' }}>{core.computation_method}</span>}
                                </div>
                              </div>
                              <ReferencesDisplay refs={core.arrangement_refs} refType="arrangement" label="Arrangement References" onNavigate={scrollToComponent} />
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.output !== undefined && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Computed Output</p>
                                  <p className="text-xl font-bold" style={{ color: forayColors.accentCyan }}>{formatCurrency(core.output, core.currency)}</p>
                                </div>
                              )}
                              {core.accounting_entry && (
                                <div className="mt-4 p-3 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                                  <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>Accounting Entry</p>
                                  <div className="grid grid-cols-2 gap-4">
                                    <div className="p-2 rounded" style={{ backgroundColor: '#fef3c7' }}>
                                      <p className="text-xs" style={{ color: '#b45309' }}>Debit</p>
                                      <p className="font-medium text-sm">{core.accounting_entry.debit?.account}</p>
                                      <p className="font-mono">{formatCurrency(core.accounting_entry.debit?.amount)}</p>
                                    </div>
                                    <div className="p-2 rounded" style={{ backgroundColor: '#d1fae5' }}>
                                      <p className="text-xs" style={{ color: '#047857' }}>Credit</p>
                                      <p className="font-medium text-sm">{core.accounting_entry.credit?.account}</p>
                                      <p className="font-mono">{formatCurrency(core.accounting_entry.credit?.amount)}</p>
                                    </div>
                                  </div>
                                </div>
                              )}
                              {renderObjectAsTable(core.inputs, 'Computation Inputs')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Anticipations */}
                {transactionData.anticipations?.length > 0 && (
                  <div>
                    <SectionHeader title="Anticipations" icon={TrendingUp} isExpanded={expandedSections.anticipations} onToggle={() => toggleSection('anticipations')} count={transactionData.anticipations.length} />
                    {expandedSections.anticipations && (
                      <div className="mt-2 space-y-3">
                        {transactionData.anticipations.map((ant, idx) => {
                          const core = getForayCore(ant);
                          return (
                            <Card key={idx} id={`component-${ant.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.actionAmber}15`, color: forayColors.actionAmber }}>{ant.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                  {core.probability_factor !== undefined && (
                                    <span className="px-2 py-0.5 text-xs rounded" style={{ backgroundColor: core.probability_factor >= 0.9 ? '#d1fae5' : '#fef3c7', color: core.probability_factor >= 0.9 ? '#047857' : '#b45309' }}>
                                      {(core.probability_factor * 100).toFixed(0)}% probability
                                    </span>
                                  )}
                                </div>
                              </div>
                              <ReferencesDisplay refs={core.accrual_refs} refType="accrual" label="Accrual References" onNavigate={scrollToComponent} />
                              <ReferencesDisplay refs={core.arrangement_refs} refType="arrangement" label="Arrangement References" onNavigate={scrollToComponent} />
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.expected_amount !== undefined && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Expected Amount</p>
                                  <p className="text-xl font-bold" style={{ color: forayColors.actionAmber }}>{formatCurrency(core.expected_amount, core.currency)}</p>
                                  {core.expected_date && <p className="text-xs mt-1" style={{ color: forayColors.gray600 }}>Expected: {new Date(core.expected_date).toLocaleDateString()}</p>}
                                </div>
                              )}
                              {renderObjectAsTable(core.assumptions, 'Assumptions')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Actions */}
                {transactionData.actions?.length > 0 && (
                  <div>
                    <SectionHeader title="Actions" icon={Activity} isExpanded={expandedSections.actions} onToggle={() => toggleSection('actions')} count={transactionData.actions.length} />
                    {expandedSections.actions && (
                      <div className="mt-2 space-y-3">
                        {transactionData.actions.map((act, idx) => {
                          const core = getForayCore(act);
                          return (
                            <Card key={idx} id={`component-${act.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.successGreen}15`, color: forayColors.successGreen }}>{act.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                  <StatusBadge status={core.settlement_status} />
                                </div>
                                {core.settlement_date && <span className="text-sm" style={{ color: forayColors.gray600 }}>{new Date(core.settlement_date).toLocaleString()}</span>}
                              </div>
                              <ReferencesDisplay refs={core.anticipation_refs} refType="anticipation" label="Anticipation References" onNavigate={scrollToComponent} />
                              <ReferencesDisplay refs={core.accrual_refs} refType="accrual" label="Accrual References" onNavigate={scrollToComponent} />
                              <ReferencesDisplay refs={core.arrangement_refs} refType="arrangement" label="Arrangement References" onNavigate={scrollToComponent} />
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.amount_settled !== undefined && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: '#d1fae5' }}>
                                  <p className="text-xs" style={{ color: '#047857' }}>Amount Settled</p>
                                  <p className="text-xl font-bold" style={{ color: '#047857' }}>{formatCurrency(core.amount_settled, core.currency)}</p>
                                  {core.payment_method && <p className="text-xs mt-1" style={{ color: '#047857' }}>Method: {core.payment_method.toUpperCase()}</p>}
                                </div>
                              )}
                              {core.counterparty && (
                                <div className="mb-3">
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Counterparty</p>
                                  <p className="text-sm font-medium" style={{ color: forayColors.textDark }}>{core.counterparty}</p>
                                </div>
                              )}
                              <AllocationsDisplay allocations={core.allocations} currency={core.currency} onNavigate={scrollToComponent} />
                              {core.variance && (
                                <div className="mt-4 p-3 rounded" style={{ backgroundColor: '#fef3c7' }}>
                                  <p className="text-xs font-medium mb-2" style={{ color: '#b45309' }}>Variance Analysis</p>
                                  <div className="grid grid-cols-3 gap-3 text-sm">
                                    <div>
                                      <p className="text-xs" style={{ color: forayColors.gray600 }}>Expected</p>
                                      <p className="font-mono font-medium">{formatCurrency(core.variance.expected)}</p>
                                    </div>
                                    <div>
                                      <p className="text-xs" style={{ color: forayColors.gray600 }}>Actual</p>
                                      <p className="font-mono font-medium">{formatCurrency(core.variance.actual)}</p>
                                    </div>
                                    <div>
                                      <p className="text-xs" style={{ color: forayColors.gray600 }}>Difference</p>
                                      <p className="font-mono font-medium" style={{ color: core.variance.difference >= 0 ? '#047857' : '#b91c1c' }}>
                                        {core.variance.difference >= 0 ? '+' : ''}{formatCurrency(core.variance.difference)}
                                      </p>
                                    </div>
                                  </div>
                                  {core.variance.explanation && <p className="mt-2 text-xs" style={{ color: '#b45309' }}>{core.variance.explanation}</p>}
                                </div>
                              )}
                              {renderObjectAsTable(core.details, 'Details')}
                              {renderObjectAsTable(core.breakdown, 'Breakdown')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Privacy & Security */}
                {transactionData.privacy_metadata && (
                  <div>
                    <SectionHeader title="Privacy & Security" icon={Lock} isExpanded={expandedSections.privacy} onToggle={() => toggleSection('privacy')} />
                    {expandedSections.privacy && (
                      <Card className="mt-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <KeyValue label="Formulas Obfuscated" value={transactionData.privacy_metadata.formulas_obfuscated} />
                            <KeyValue label="Instance Pools" value={transactionData.privacy_metadata.instance_pools} />
                            <KeyValue label="Attack Complexity" value={transactionData.privacy_metadata.attack_complexity} />
                          </div>
                        </div>
                        <div className="mt-4 p-3 rounded" style={{ backgroundColor: '#f3e5f5', borderLeft: '4px solid #6a1b9a' }}>
                          <p className="text-xs" style={{ color: '#6a1b9a' }}>
                            <strong>Privacy Protection:</strong> Sensitive formulas are protected using salted identifiers and instance pooling, enabling hash-based verification without exposing proprietary business logic. Full auditability is maintained while protecting competitive intelligence.
                          </p>
                        </div>
                      </Card>
                    )}
                  </div>
                )}

                {/* Control Bar */}
                <Card>
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Navigation Controls</h2>
                      <p className="text-sm" style={{ color: forayColors.gray600 }}>Expand or collapse all sections</p>
                    </div>
                    <div className="flex gap-3">
                      <button onClick={expandAll} className="px-4 py-2 text-white rounded-lg text-sm font-medium flex items-center gap-2" style={{ backgroundColor: forayColors.primaryTeal }}>
                        <ChevronDown className="w-4 h-4" /> Expand All
                      </button>
                      <button onClick={collapseAll} className="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2" style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}>
                        <ChevronRight className="w-4 h-4" /> Collapse All
                      </button>
                    </div>
                  </div>
                </Card>
              </div>
            )}
            
            {/* Notes Modal */}
            {showNotes && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <FileText className="w-6 h-6" style={{ color: forayColors.primaryTeal }} />
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>FORAY Protocol Version Guide</h2>
                    </div>
                    <button onClick={() => setShowNotes(false)} className="p-2 rounded-lg hover:bg-gray-100">
                      <X className="w-5 h-5" style={{ color: forayColors.gray600 }} />
                    </button>
                  </div>
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 100px)' }}>
                    <div className="space-y-6">
                      
                      {/* Introduction */}
                      <div className="p-4 rounded-lg" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                        <p className="text-sm" style={{ color: forayColors.secondaryNavy }}>
                          <strong>FORAY Protocol</strong> creates immutable, tamper-proof audit trails of your ERP transactions that regulators, auditors, and forensic investigators can trust&mdash;without exposing your competitive secrets. Each version adds capabilities while maintaining backward compatibility.
                        </p>
                      </div>
                      
                      {/* Version Cards */}
                      <div className="space-y-4">
                        
                        {/* V1.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-gray-500 text-white">v1.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Foundation</span>
                            <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: '#e5e7eb', color: '#6b7280' }}>Legacy</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Introduced the core 4-component transaction model that forms the foundation of all FORAY transactions.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>4-Component Model (A&rarr;A&rarr;A&rarr;A)</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Basic blockchain anchoring</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Simple hash verification</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Transaction dependency tracking</span></div>
                            </div>
                          </div>
                        </div>
                        
                        {/* V2.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-blue-500 text-white">v2.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Privacy & Adapters</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Added privacy-preserving features and ERP integration adapters for enterprise deployment.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Salted formula IDs</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Zero-knowledge proof support</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>SAP, QuickBooks adapters</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Selective disclosure</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: '#dbeafe', color: '#1e40af' }}>
                              <strong>Best for:</strong> Organizations needing ERP integration with basic privacy controls
                            </div>
                          </div>
                        </div>
                        
                        {/* V3.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-purple-500 text-white">v3.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Storage & Encryption</span>
                            <span className="text-xs px-2 py-0.5 rounded cursor-help" style={{ backgroundColor: '#fef3c7', color: '#b45309' }} title="Breaking Change: This version introduced changes that are not backward compatible. Existing implementations require updates to work with this version.">Breaking</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Introduced tier-based storage architecture and encrypted envelope for cost-effective, secure data management.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Compressed key mapping</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Tier-based storage (hot/warm/cold)</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Encrypted envelope</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Instance pooling for privacy</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: '#f3e8ff', color: '#7c3aed' }}>
                              <strong>Best for:</strong> Enterprises with high-volume transactions needing cost optimization
                            </div>
                          </div>
                        </div>
                        
                        {/* V4.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-orange-500 text-white">v4.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Enterprise Compliance</span>
                            <span className="text-xs px-2 py-0.5 rounded cursor-help" style={{ backgroundColor: '#fef3c7', color: '#b45309' }} title="Breaking Change: This version introduced changes that are not backward compatible. Existing implementations require updates to work with this version.">Breaking</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Separated core protocol from audit metadata with 3-layer architecture for full enterprise compliance (SOX, DCAA, Big 4).
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>foray_core / audit_data separation</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>3-layer storage architecture</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Sealed archive specification</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>~85% audit completeness</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: '#ffedd5', color: '#c2410c' }}>
                              <strong>Best for:</strong> Regulated industries requiring full audit trail with Big 4 / SOX compliance
                            </div>
                          </div>
                        </div>
                        
                        {/* V4.1 - Current */}
                        <div className="border-2 rounded-lg overflow-hidden" style={{ borderColor: forayColors.primaryTeal }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: `${forayColors.primaryTeal}20` }}>
                            <span className="px-2 py-1 text-xs font-bold rounded text-white" style={{ backgroundColor: forayColors.primaryTeal }}>v4.1</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Flexible Modeling</span>
                            <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>Current</span>
                            <span className="text-xs px-2 py-0.5 rounded cursor-help" style={{ backgroundColor: '#fef3c7', color: '#b45309' }} title="Breaking Change: This version introduced changes that are not backward compatible. Existing implementations require updates to work with this version. This tool auto-migrates older formats.">Breaking</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Enables flexible entry points and many-to-many relationships for accurate transaction modeling. This viewer auto-migrates v3.0 and v4.0 transactions to v4.1 format.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Flexible entry points (any component)</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Many-to-many references (*_refs[])</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Allocation tracking</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>RMBS/structured finance support</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: `${forayColors.primaryTeal}20`, color: forayColors.secondaryNavy }}>
                              <strong>Best for:</strong> Complex transactions including batch payments, structured finance, and SMB cash transactions
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* Key Changes Summary Table */}
                      <div className="mt-6">
                        <h3 className="font-semibold mb-3" style={{ color: forayColors.secondaryNavy }}>Version Comparison</h3>
                        <div className="overflow-x-auto">
                          <table className="w-full text-xs border-collapse">
                            <thead>
                              <tr style={{ backgroundColor: forayColors.bgLight }}>
                                <th className="border p-2 text-left" style={{ borderColor: forayColors.gray400 }}>Feature</th>
                                <th className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>v3.0</th>
                                <th className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>v4.0</th>
                                <th className="border p-2 text-center" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10` }}>v4.1</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Arrangements Required</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&#x2714;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&#x2714;</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>Optional</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Reference Type</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>_ref (1:1)</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>_ref (1:1)</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>_refs[] (N:N)</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>foray_core Separation</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&mdash;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&#x2714;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10` }}>&#x2714;</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Allocation Tracking</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&mdash;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&mdash;</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>&#x2714;</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Entry Points</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>Arrangement</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>Arrangement</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>Any</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                      
                      {/* Use Cases */}
                      <div className="mt-6 p-4 rounded-lg" style={{ backgroundColor: forayColors.bgLight }}>
                        <h3 className="font-semibold mb-3" style={{ color: forayColors.secondaryNavy }}>When to Use Each Version</h3>
                        <div className="space-y-2 text-sm">
                          <p><strong style={{ color: forayColors.primaryTeal }}>v4.1 (Recommended):</strong> Most new implementations, especially if you have batch payments, cash sales, adjusting entries, or structured finance.</p>
                          <p><strong style={{ color: '#f97316' }}>v4.0:</strong> If you need maximum audit completeness but don't require many-to-many relationships.</p>
                          <p><strong style={{ color: '#8b5cf6' }}>v3.0:</strong> Simpler implementations where storage cost optimization is the priority.</p>
                        </div>
                      </div>
                      
                      {/* Blockchain Anchoring Section */}
                      <div className="mt-6 border-t pt-6" style={{ borderColor: forayColors.gray400 }}>
                        <h3 className="font-semibold mb-4 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                          <Link2 className="w-5 h-5" style={{ color: forayColors.primaryTeal }} />
                          Blockchain Anchoring (Kaspa)
                        </h3>
                        
                        <div className="space-y-4">
                          {/* Overview */}
                          <div className="p-4 rounded-lg" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                            <p className="text-sm" style={{ color: forayColors.secondaryNavy }}>
                              <strong>How It Works:</strong> FORAY transactions are anchored to the Kaspa blockchain to create an immutable, timestamped proof of existence. The Kaspa transaction ID serves as cryptographic evidence that your FORAY transaction existed at a specific point in time.
                            </p>
                          </div>
                          
                          {/* Technical Approach */}
                          <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.gray400 }}>
                            <h4 className="font-medium mb-3" style={{ color: forayColors.secondaryNavy }}>Technical Approach</h4>
                            <div className="space-y-3 text-sm" style={{ color: forayColors.gray600 }}>
                              <div className="flex gap-3">
                                <span className="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>1</span>
                                <div>
                                  <strong>Hash Computation:</strong> A SHA-256 hash of your complete FORAY transaction JSON is computed locally in your browser.
                                </div>
                              </div>
                              <div className="flex gap-3">
                                <span className="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>2</span>
                                <div>
                                  <strong>Blockchain Transaction:</strong> A Kaspa transaction (0.2 KAS) is submitted to create an on-chain timestamp. The amount satisfies KIP-9 storage mass requirements. The transaction is sent to your own wallet address, so funds are not lost.
                                </div>
                              </div>
                              <div className="flex gap-3">
                                <span className="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>3</span>
                                <div>
                                  <strong>Proof Linkage:</strong> The Kaspa Transaction ID is linked to your FORAY transaction hash. This creates an unbreakable chain: <code className="px-1 rounded" style={{ backgroundColor: forayColors.bgLight }}>Kaspa TX ID &rarr; FORAY Hash &rarr; Original Transaction</code>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          {/* What's Stored Where */}
                          <div className="grid grid-cols-2 gap-4">
                            <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.primaryTeal, backgroundColor: `${forayColors.primaryTeal}05` }}>
                              <h4 className="font-medium mb-2 flex items-center gap-2" style={{ color: forayColors.primaryTeal }}>
                                <Database className="w-4 h-4" /> On Blockchain
                              </h4>
                              <ul className="text-xs space-y-1" style={{ color: forayColors.gray600 }}>
                                <li>&bull; Kaspa Transaction ID</li>
                                <li>&bull; Timestamp (block time)</li>
                                <li>&bull; Wallet address</li>
                                <li>&bull; Block height & hash</li>
                              </ul>
                            </div>
                            <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.secondaryNavy, backgroundColor: `${forayColors.secondaryNavy}05` }}>
                              <h4 className="font-medium mb-2 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                                <FileText className="w-4 h-4" /> In Your System
                              </h4>
                              <ul className="text-xs space-y-1" style={{ color: forayColors.gray600 }}>
                                <li>&bull; Complete FORAY JSON</li>
                                <li>&bull; Transaction hash (SHA-256)</li>
                                <li>&bull; Kaspa TX ID reference</li>
                                <li>&bull; Anchor metadata</li>
                              </ul>
                            </div>
                          </div>
                          
                          {/* Demo Mode Notice */}
                          <div className="p-4 rounded-lg" style={{ backgroundColor: `${forayColors.actionAmber}15` }}>
                            <h4 className="font-medium mb-2 flex items-center gap-2" style={{ color: '#b45309' }}>
                              <AlertCircle className="w-4 h-4" /> Transaction Review Demo Mode
                            </h4>
                            <p className="text-sm" style={{ color: forayColors.gray600 }}>
                              This Transaction Review tool demonstrates blockchain anchoring using actual Kaspa testnet transactions. When you anchor a transaction:
                            </p>
                            <ul className="text-sm mt-2 space-y-1" style={{ color: forayColors.gray600 }}>
                              <li>&bull; <strong>Real Kaspa TX:</strong> A real transaction is submitted to Kaspa Testnet 10 or 11</li>
                              <li>&bull; <strong>Explorer Verification:</strong> Click "View on Explorer" to see the actual blockchain record</li>
                              <li>&bull; <strong>Test Funds Required:</strong> Get free test KAS from the faucet (link in network dropdown)</li>
                              <li>&bull; <strong>No FORAY Data in TX:</strong> The FORAY data itself is NOT embedded in the blockchain transaction&mdash;only the timestamp proof is on-chain</li>
                            </ul>
                            <p className="text-xs mt-3" style={{ color: '#b45309' }}>
                              <strong>Note:</strong> In production, you would store the Kaspa TX ID alongside your FORAY transaction in your audit system. The hash links them cryptographically.
                            </p>
                          </div>
                          
                          {/* Network Information */}
                          <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.gray400 }}>
                            <h4 className="font-medium mb-3" style={{ color: forayColors.secondaryNavy }}>Kaspa Networks</h4>
                            <div className="grid grid-cols-3 gap-3 text-xs">
                              <div className="p-3 rounded" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                                <p className="font-semibold" style={{ color: forayColors.actionAmber }}>Testnet 10</p>
                                <p style={{ color: forayColors.gray600 }}>Stable, mirrors mainnet (1 BPS)</p>
                                <p className="mt-1"><strong>Recommended for testing</strong></p>
                              </div>
                              <div className="p-3 rounded" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                                <p className="font-semibold" style={{ color: forayColors.actionAmber }}>Testnet 11</p>
                                <p style={{ color: forayColors.gray600 }}>Experimental (10 BPS)</p>
                                <p className="mt-1">Faster confirmations</p>
                              </div>
                              <div className="p-3 rounded" style={{ backgroundColor: `${forayColors.errorRed}10` }}>
                                <p className="font-semibold" style={{ color: forayColors.errorRed }}>Mainnet</p>
                                <p style={{ color: forayColors.gray600 }}>Production (real KAS)</p>
                                <p className="mt-1">Use for production only</p>
                              </div>
                            </div>
                          </div>
                          
                          {/* Wallet Requirement */}
                          <div className="p-4 rounded-lg flex items-start gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <div className="p-2 rounded" style={{ backgroundColor: forayColors.secondaryNavy }}>
                              <Link2 className="w-4 h-4 text-white" />
                            </div>
                            <div>
                              <h4 className="font-medium mb-1" style={{ color: forayColors.secondaryNavy }}>KasWare Wallet Required</h4>
                              <p className="text-sm" style={{ color: forayColors.gray600 }}>
                                To anchor transactions, install the <a href="https://kasware.xyz" target="_blank" rel="noopener noreferrer" style={{ color: forayColors.primaryTeal, textDecoration: 'underline' }}>KasWare browser extension</a>. 
                                Switch to Testnet in wallet settings and get free test KAS from the faucet.
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* JSON Modal */}
            {showJsonModal && transactionData && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <FileText className="w-6 h-6" style={{ color: forayColors.primaryTeal }} />
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>Transaction JSON</h2>
                      <span className="px-2 py-1 text-xs font-bold rounded" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>v{transactionData.schema_version}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => { navigator.clipboard.writeText(JSON.stringify(transactionData, null, 2)); alert('JSON copied to clipboard!'); }}
                        className="px-3 py-1.5 text-sm rounded-lg flex items-center gap-2"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Copy
                      </button>
                      <button onClick={() => setShowJsonModal(false)} className="p-2 rounded-lg hover:bg-gray-100">
                        <X className="w-5 h-5" style={{ color: forayColors.gray600 }} />
                      </button>
                    </div>
                  </div>
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 100px)' }}>
                    <pre className="text-xs font-mono p-4 rounded-lg overflow-x-auto" style={{ backgroundColor: forayColors.bgLight, color: forayColors.textDark }}>
                      {JSON.stringify(transactionData, null, 2)}
                    </pre>
                  </div>
                </div>
              </div>
            )}
            
            {/* Narrative Modal */}
            {showNarrativeModal && currentSampleKey && sampleNarratives[currentSampleKey] && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <BookOpen className="w-6 h-6" style={{ color: forayColors.actionAmber }} />
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>{sampleNarratives[currentSampleKey].title}</h2>
                    </div>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => { navigator.clipboard.writeText(sampleNarratives[currentSampleKey].content); alert('Narrative copied to clipboard!'); }}
                        className="px-3 py-1.5 text-sm rounded-lg flex items-center gap-2"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Copy
                      </button>
                      <button onClick={() => setShowNarrativeModal(false)} className="p-2 rounded-lg hover:bg-gray-100">
                        <X className="w-5 h-5" style={{ color: forayColors.gray600 }} />
                      </button>
                    </div>
                  </div>
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 100px)' }}>
                    <div className="prose prose-sm max-w-none">
                      {sampleNarratives[currentSampleKey].content.split('\n').map((line, idx) => {
                        // Handle headers
                        if (line.startsWith('# ')) return <h1 key={idx} className="text-2xl font-bold mt-6 mb-4" style={{ color: forayColors.secondaryNavy }}>{line.slice(2)}</h1>;
                        if (line.startsWith('## ')) return <h2 key={idx} className="text-xl font-semibold mt-6 mb-3" style={{ color: forayColors.primaryTeal }}>{line.slice(3)}</h2>;
                        if (line.startsWith('### ')) return <h3 key={idx} className="text-lg font-medium mt-4 mb-2" style={{ color: forayColors.secondaryNavy }}>{line.slice(4)}</h3>;
                        
                        // Handle horizontal rules
                        if (line.startsWith('---')) return <hr key={idx} className="my-6" style={{ borderColor: forayColors.gray400 + '40' }} />;
                        
                        // Handle code blocks
                        if (line.startsWith('\`\`\`')) return null;
                        
                        // Handle tables (simplified - just show as text)
                        if (line.startsWith('|')) {
                          const cells = line.split('|').filter(c => c.trim());
                          if (line.includes('---')) return null; // Skip table separator
                          return (
                            <div key={idx} className="flex gap-4 py-1 text-sm font-mono" style={{ backgroundColor: forayColors.bgLight, padding: '4px 8px', marginBottom: '2px' }}>
                              {cells.map((cell, cidx) => (
                                <span key={cidx} style={{ flex: 1, color: forayColors.textDark }}>{cell.trim()}</span>
                              ))}
                            </div>
                          );
                        }
                        
                        // Handle bullet points
                        if (line.startsWith('- ')) return <li key={idx} className="text-sm ml-4 mb-1" style={{ color: forayColors.gray600 }}>{line.slice(2)}</li>;
                        
                        // Handle bold text
                        if (line.includes('**')) {
                          const parts = line.split(/\*\*(.*?)\*\*/g);
                          return (
                            <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>
                              {parts.map((part, pidx) => pidx % 2 === 1 ? <strong key={pidx}>{part}</strong> : part)}
                            </p>
                          );
                        }
                        
                        // Handle inline code
                        if (line.includes('\`')) {
                          const parts = line.split(/\`(.*?)\`/g);
                          return (
                            <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>
                              {parts.map((part, pidx) => pidx % 2 === 1 ? 
                                <code key={pidx} className="px-1 py-0.5 rounded text-xs" style={{ backgroundColor: forayColors.bgLight, color: forayColors.primaryTeal }}>{part}</code> : part
                              )}
                            </p>
                          );
                        }
                        
                        // Empty lines
                        if (line.trim() === '') return <div key={idx} className="h-2" />;
                        
                        // Regular paragraphs
                        return <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>{line}</p>;
                      })}
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Mainnet Warning Dialog */}
            {showMainnetWarning && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
                  <div className="p-6">
                    <div className="flex items-center gap-3 mb-4">
                      <div className="p-3 rounded-full" style={{ backgroundColor: `${forayColors.errorRed}20` }}>
                        <AlertCircle className="w-6 h-6" style={{ color: forayColors.errorRed }} />
                      </div>
                      <h2 className="text-xl font-bold" style={{ color: forayColors.errorRed }}>Switch to Mainnet?</h2>
                    </div>
                    <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>
                      You are about to switch to <strong>Kaspa Mainnet</strong>. This is the production network where transactions use <strong>real KAS tokens</strong> with actual monetary value.
                    </p>
                    <div className="p-3 rounded-lg mb-4" style={{ backgroundColor: `${forayColors.errorRed}10` }}>
                      <p className="text-xs font-medium" style={{ color: forayColors.errorRed }}>
                        &#x26A0;&#xFE0F; <strong>Warning:</strong> Any blockchain anchoring on Mainnet will cost real KAS and create permanent, irreversible records.
                      </p>
                    </div>
                    <div className="p-3 rounded-lg mb-6" style={{ backgroundColor: forayColors.bgLight }}>
                      <p className="text-xs" style={{ color: forayColors.gray600 }}>
                        <strong>Recommendation:</strong> Use Testnet 10 or Testnet 11 for development and testing. Only switch to Mainnet for production transactions.
                      </p>
                    </div>
                    <div className="flex gap-3">
                      <button 
                        onClick={cancelMainnetSwitch}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Stay on Testnet
                      </button>
                      <button 
                        onClick={confirmMainnetSwitch}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium text-white"
                        style={{ backgroundColor: forayColors.errorRed }}
                      >
                        Switch to Mainnet
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Anchor Confirmation Dialog */}
            {showAnchorConfirm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
                  <div className="p-6">
                    <div className="flex items-center gap-3 mb-4">
                      <div className="p-3 rounded-full" style={{ backgroundColor: `${forayColors.secondaryNavy}20` }}>
                        <Link2 className="w-6 h-6" style={{ color: forayColors.secondaryNavy }} />
                      </div>
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>Anchor to Blockchain</h2>
                    </div>
                    
                    {/* Network Badge */}
                    <div className="flex items-center gap-2 mb-4 p-2 rounded-lg" style={{ backgroundColor: currentNetwork.isTestnet ? `${forayColors.actionAmber}10` : `${forayColors.errorRed}10` }}>
                      <GitBranch className="w-4 h-4" style={{ color: currentNetwork.isTestnet ? forayColors.actionAmber : forayColors.errorRed }} />
                      <span className="text-sm font-medium" style={{ color: currentNetwork.isTestnet ? forayColors.actionAmber : forayColors.errorRed }}>
                        {currentNetwork.name}
                      </span>
                      {currentNetwork.isTestnet ? (
                        <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: forayColors.actionAmber, color: 'white' }}>TEST</span>
                      ) : (
                        <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: forayColors.errorRed, color: 'white' }}>REAL KAS</span>
                      )}
                    </div>
                    
                    <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>
                      You are about to anchor this FORAY transaction to <strong>{currentNetwork.name}</strong>. This action creates a permanent, immutable record that cannot be modified or deleted.
                    </p>
                    
                    {!currentNetwork.isTestnet && (
                      <div className="p-3 rounded-lg mb-4" style={{ backgroundColor: `${forayColors.errorRed}10` }}>
                        <p className="text-xs font-medium" style={{ color: forayColors.errorRed }}>
                          &#x26A0;&#xFE0F; <strong>Mainnet Transaction:</strong> This will use real KAS tokens and incur actual transaction fees.
                        </p>
                      </div>
                    )}
                    
                    <div className="p-3 rounded-lg mb-4" style={{ backgroundColor: `${forayColors.actionAmber}20` }}>
                      <p className="text-xs font-medium" style={{ color: '#b45309' }}>
                        &#x26A0;&#xFE0F; This action is <strong>permanent and irreversible</strong>. Ensure the transaction data is correct before proceeding.
                      </p>
                    </div>
                    
                    <div className="text-xs space-y-1 mb-6" style={{ color: forayColors.gray600 }}>
                      <p><strong>Transaction:</strong> {transactionData?.transaction_id}</p>
                      <p><strong>Entity:</strong> {transactionData?.foray_core?.entity}</p>
                      <p><strong>Value:</strong> {formatCurrency(transactionData?.foray_core?.total_value, transactionData?.foray_core?.currency)}</p>
                      <p><strong>Network:</strong> {currentNetwork.name} ({currentNetwork.bps} BPS)</p>
                      {walletConnected && <p><strong>Wallet:</strong> {walletAddress?.substring(0, 25)}...</p>}
                    </div>
                    
                    <div className="flex gap-3">
                      <button 
                        onClick={() => setShowAnchorConfirm(false)}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={handleAnchorToBlockchain}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium text-white"
                        style={{ backgroundColor: currentNetwork.isTestnet ? forayColors.secondaryNavy : forayColors.errorRed }}
                      >
                        {currentNetwork.isTestnet ? 'Confirm & Anchor' : 'Anchor (Mainnet)'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Anchoring In Progress */}
            {isAnchoring && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 text-center">
                  <div className="animate-spin w-12 h-12 border-4 rounded-full mx-auto mb-4" style={{ borderColor: `${forayColors.primaryTeal}30`, borderTopColor: forayColors.primaryTeal }}></div>
                  <h2 className="text-xl font-bold mb-2" style={{ color: forayColors.secondaryNavy }}>Anchoring to {currentNetwork.name}...</h2>
                  <p className="text-sm" style={{ color: forayColors.gray600 }}>Creating immutable blockchain record</p>
                  <p className="text-xs mt-2" style={{ color: forayColors.gray600 }}>Expected confirmation: ~{Math.round(1000 / currentNetwork.bps)}ms</p>
                </div>
              </div>
            )}
            
            {/* Anchor Result Modal */}
            {anchorResult && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 anchor-result-modal">
                <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full" style={{ backgroundColor: `${forayColors.successGreen}20` }}>
                        <CheckCircle className="w-6 h-6" style={{ color: forayColors.successGreen }} />
                      </div>
                      <div>
                        <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>Transaction Anchored Successfully</h2>
                        <p className="text-xs" style={{ color: forayColors.gray600 }}>{anchorResult.timestamp}</p>
                      </div>
                    </div>
                    <button onClick={() => setAnchorResult(null)} className="p-2 rounded-lg hover:bg-gray-100 no-print">
                      <X className="w-5 h-5" style={{ color: forayColors.gray600 }} />
                    </button>
                  </div>
                  
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 180px)' }}>
                    {/* Kaspa Blockchain Section */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold mb-3 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                        <GitBranch className="w-4 h-4" /> Kaspa Blockchain Verification
                      </h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Transaction ID:</span>
                          <span className="font-mono text-xs" style={{ color: forayColors.primaryTeal }}>{anchorResult.kaspa.transaction_id}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Block Height:</span>
                          <span className="font-mono font-bold" style={{ color: forayColors.textDark }}>{anchorResult.kaspa.block_height.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Block Hash:</span>
                          <span className="font-mono text-xs truncate ml-4" style={{ color: forayColors.textDark, maxWidth: '300px' }}>{anchorResult.kaspa.block_hash}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Confirmations:</span>
                          <span className="font-bold" style={{ color: forayColors.successGreen }}>{anchorResult.kaspa.confirmations}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Confirmation Time:</span>
                          <span className="font-mono" style={{ color: forayColors.textDark }}>{anchorResult.kaspa.confirmation_time_ms}ms</span>
                        </div>
                      </div>
                      <a 
                        href={anchorResult.kaspa.explorer_url} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="mt-3 inline-flex items-center gap-2 text-sm px-4 py-2 rounded-lg no-print"
                        style={{ backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}
                      >
                        <Link2 className="w-4 h-4" /> View on Kaspa Explorer &rarr;
                      </a>
                    </div>
                    
                    {/* FORAY Transaction Section */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold mb-3 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                        <FileText className="w-4 h-4" /> FORAY Transaction Details
                      </h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Transaction ID:</span>
                          <span className="font-mono text-xs" style={{ color: forayColors.textDark }}>{anchorResult.foray.transaction_id}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Schema Version:</span>
                          <span className="px-2 py-0.5 text-xs font-bold rounded" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>v{anchorResult.foray.schema_version}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Merkle Root:</span>
                          <span className="font-mono text-xs" style={{ color: forayColors.textDark }}>{anchorResult.foray.merkle_root}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Entity:</span>
                          <span className="font-semibold" style={{ color: forayColors.textDark }}>{anchorResult.foray.entity}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Total Value:</span>
                          <span className="font-bold" style={{ color: forayColors.primaryTeal }}>{formatCurrency(anchorResult.foray.total_value, anchorResult.foray.currency)}</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Component Summary */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold mb-3" style={{ color: forayColors.secondaryNavy }}>Components Anchored</h3>
                      <div className="grid grid-cols-4 gap-2">
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.primaryTeal }}>{anchorResult.foray.component_summary.arrangements}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Arrangements</p>
                        </div>
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.accentCyan }}>{anchorResult.foray.component_summary.accruals}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Accruals</p>
                        </div>
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.actionAmber }}>{anchorResult.foray.component_summary.anticipations}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Anticipations</p>
                        </div>
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.successGreen}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.successGreen }}>{anchorResult.foray.component_summary.actions}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Actions</p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Metadata */}
                    <div className="p-3 rounded-lg text-xs" style={{ backgroundColor: forayColors.bgLight }}>
                      <div className="flex justify-between">
                        <span style={{ color: forayColors.gray600 }}>Network:</span>
                        <span className="font-medium">{anchorResult.network}</span>
                      </div>
                      <div className="flex justify-between mt-1">
                        <span style={{ color: forayColors.gray600 }}>Anchored By:</span>
                        <span className="font-medium">{anchorResult.anchored_by}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Footer Actions */}
                  <div className="p-4 border-t flex gap-3 no-print" style={{ borderColor: forayColors.gray400 }}>
                    <a 
                      href={anchorResult.kaspa.explorer_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex-1 px-4 py-2.5 rounded-lg font-medium flex items-center justify-center gap-2"
                      style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}
                    >
                      <Link2 className="w-4 h-4" /> View on Explorer
                    </a>
                    <button 
                      onClick={copyAnchorDetails}
                      className="flex-1 px-4 py-2.5 rounded-lg font-medium flex items-center justify-center gap-2"
                      style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                    >
                      Copy Details
                    </button>
                    <button 
                      onClick={handlePrintAnchorResult}
                      className="flex-1 px-4 py-2.5 rounded-lg font-medium text-white flex items-center justify-center gap-2"
                      style={{ backgroundColor: forayColors.secondaryNavy }}
                    >
                      <Printer className="w-4 h-4" /> Print / Save PDF
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Render
    ReactDOM.render(<ForayTransactionReviewV41 />, document.getElementById('root'));
  </script>
</body>
</html>
