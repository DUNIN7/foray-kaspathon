<!DOCTYPE html>
<!--
  ============================================================================
  FORAY Protocol Transaction Review Tool
  ============================================================================
  Version:       4.1.5
  Created:       2026-01-26T23:43:00Z
  Last Modified: 2026-02-01T12:00:00Z
  
  Author:        Marvin Percival
  Email:         marvinp@dunin7.com
  GitHub:        github.com/DUNIN7/foray-kaspathon
  
  License:       Business Source License 1.1
  Copyright (c) 2026 Marvin Percival. All rights reserved.
  
  Description:   Interactive transaction review tool for FORAY Protocol v4.1
                 Supports all 13 sample transaction types with full and
                 summary narratives, blockchain anchoring simulation,
                 and print/PDF export.
  
  Changelog:
    v4.1.5 (2026-02-01)
      - Added full Attestations UI section with expandable cards
      - Attestations display: attestor info, credentials, subject refs, 
        validity periods, evidence hashes, and type-specific details
      - Added Shield and Award icons for attestation visuals
      - Added 'attestations' to expandedSections state
      - Updated scrollToComponent to handle ATT_ prefixes
      - Added attestation color (#8B5CF6 purple) to RefBadge
      - Updated DependencyGraph to recognize attestation refs
      - Added manukaHoneyProvenance componentTips with attestations explanation
      - Component summary now includes attestations count (5-column grid when present)
      - Copy anchor details includes attestations count when applicable
    
    v4.1.4 (2026-02-01)
      - Changed Olive Oil example to Manuka Honey (UMF certified, NZ origin)
      - Added Attestations component (3 attestations: Lab, UMF, MPI Export)
      - First example to demonstrate 4A + Attestations extension
    
    v4.1.3 (2026-01-29)
      - Added Supply Chain/Provenance samples: Olive Oil, Luxury Watch, Template
      - Now 13 sample transaction types
    
    v4.1.2 (2026-01-28)
      - Enhanced migrateToV41() to handle alternate JSON schema formats
      - Auto-detects: transaction_metadata wrapper, *_id field naming,
        flat vs foray_core structure, singular vs array refs
      - Generates merkle_root if missing
      - Added sessionStorage integration for generator page
      - Auto-loads transactions passed from demo.html generator
    
    v4.1.0 (2026-01-26)
      - Initial release with full/summary narratives
      - 10 sample transaction types
      - Expand/Collapse all sections
      - Print/PDF export
      - Simulated Kaspa blockchain anchoring
  ============================================================================
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FORAY Protocol Transaction Review v4.1</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'IBM Plex Sans', sans-serif; }
    .font-mono { font-family: 'IBM Plex Mono', monospace; }
    
    /* Fast tooltips */
    [data-tooltip] {
      position: relative;
    }
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1A1D21;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 6px;
      animation: tooltipFadeIn 0.3s ease-out;
    }
    [data-tooltip]:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1A1D21;
      margin-bottom: -6px;
      z-index: 1000;
      animation: tooltipFadeIn 0.3s ease-out;
    }
    @keyframes tooltipFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @media print {
      .no-print { display: none !important; }
      body { 
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        background: white !important;
      }
      .print-break-inside-avoid { break-inside: avoid; }
    }
    
    /* === BULLETPROOF NAV CSS v4.0 - FULLY SELF-CONTAINED === */
    .nav { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; background: rgba(26, 29, 33, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(125, 211, 214, 0.1); font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px; line-height: 1.5; box-sizing: border-box; }
    .nav * { box-sizing: border-box; }
    .nav-logo { display: flex; align-items: center; gap: 0.5rem; text-decoration: none; font-family: inherit; font-size: inherit; line-height: inherit; }
    .nav-logo-text { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; line-height: 1; display: flex; align-items: center; }
    .nav-logo-foray { color: #0D7377; }
    .nav-logo-protocol { color: #F7F9FA; font-weight: 400; }
    .nav-badge { font-size: 0.65rem; padding: 0.2rem 0.5rem; background: #E6A817; color: #1A1D21; border-radius: 4px; font-weight: 600; line-height: 1; display: inline-block; vertical-align: middle; font-family: inherit; }
    .nav-links { display: flex; gap: 2rem; align-items: center; }
    .nav-link { color: #94A3A8; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: color 0.2s; font-family: inherit; line-height: 1; }
    .nav-link:hover, .nav-link.active { color: #14B8B8; }
    .nav-hamburger { display: none; flex-direction: column; justify-content: center; align-items: center; width: 40px; height: 40px; background: transparent; border: none; cursor: pointer; z-index: 1001; padding: 8px; }
    .nav-hamburger span { display: block; width: 24px; height: 2px; background: #F7F9FA; margin: 3px 0; transition: all 0.3s ease; border-radius: 2px; }
    .nav-hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .nav-hamburger.active span:nth-child(2) { opacity: 0; }
    .nav-hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
    .nav-mobile-menu { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 29, 33, 0.98); backdrop-filter: blur(20px); z-index: 999; flex-direction: column; justify-content: center; align-items: center; gap: 2rem; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
    .nav-mobile-menu.active { opacity: 1; visibility: visible; }
    .nav-mobile-menu .nav-link { font-size: 1.5rem; font-weight: 500; color: #F7F9FA; line-height: 1; }
    .nav-mobile-menu .nav-link:hover { color: #14B8B8; }
    @media (max-width: 768px) { .nav-links { display: none; } .nav-hamburger { display: flex; } .nav-mobile-menu { display: flex; } }
    /* === END BULLETPROOF NAV CSS === */
  </style>
</head>
<body>
  <nav class="nav no-print">
    <a href="index.html" class="nav-logo">
      <span class="nav-logo-text">
        <span class="nav-logo-foray">FORAY</span> <span class="nav-logo-protocol">Protocol</span>
      </span>
      <span class="nav-badge">v4.1</span>
    </a>
    <div class="nav-links">
      <a href="demo.html" class="nav-link active">Demo</a>
      <a href="docs.html" class="nav-link">Documentation</a>
      <a href="examples.html" class="nav-link">Examples</a>
      <a href="about.html" class="nav-link">About</a>
      <a href="https://github.com/DUNIN7/foray-kaspathon" class="nav-link" target="_blank">GitHub</a>
    </div>
    <button class="nav-hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </nav>
  
  <!-- Mobile Menu -->
  <div class="nav-mobile-menu no-print" id="mobileMenu">
    <a href="demo.html" class="nav-link" onclick="closeMobileMenu()">Demo</a>
    <a href="docs.html" class="nav-link" onclick="closeMobileMenu()">Documentation</a>
    <a href="examples.html" class="nav-link" onclick="closeMobileMenu()">Examples</a>
    <a href="about.html" class="nav-link" onclick="closeMobileMenu()">About</a>
    <a href="https://github.com/DUNIN7/foray-kaspathon" class="nav-link" target="_blank" onclick="closeMobileMenu()">GitHub</a>
  </div>

  <script>
    // Mobile Menu Toggle
    function toggleMobileMenu() {
      const hamburger = document.querySelector('.nav-hamburger');
      const mobileMenu = document.getElementById('mobileMenu');
      hamburger.classList.toggle('active');
      mobileMenu.classList.toggle('active');
      document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
    }
    
    function closeMobileMenu() {
      const hamburger = document.querySelector('.nav-hamburger');
      const mobileMenu = document.getElementById('mobileMenu');
      hamburger.classList.remove('active');
      mobileMenu.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeMobileMenu();
    });
  </script>
  
  <div id="root" style="padding-top: 60px;"></div>
  
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // FORAY Brand Colors
    const forayColors = {
      primaryTeal: '#0D7377',
      secondaryNavy: '#1B365D',
      accentCyan: '#14B8B8',
      highlightMint: '#7DD3D6',
      actionAmber: '#E6A817',
      textDark: '#1A1D21',
      textLight: '#F7F9FA',
      bgLight: '#F7F9FA',
      bgDark: '#1A1D21',
      gray600: '#636E72',
      gray400: '#94A3A8',
      successGreen: '#10B981',
      warningOrange: '#F59E0B',
      errorRed: '#EF4444'
    };

    // Icons as SVG components
    const ChevronDown = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M6 9l6 6 6-6"/>
      </svg>
    );
    
    const ChevronRight = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    );
    
    const ArrowLeft = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
      </svg>
    );
    
    const Lock = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
    );
    
    const Unlock = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>
      </svg>
    );
    
    const X = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );
    
    const FileText = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
      </svg>
    );
    
    const BookOpen = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
      </svg>
    );
    
    const Info = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
      </svg>
    );
    
    const Wallet = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"/>
      </svg>
    );
    
    const TrendingUp = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
      </svg>
    );
    
    const DollarSign = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
    );
    
    const Users = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    );
    
    const Activity = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
    );
    
    const Upload = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    );
    
    const AlertCircle = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    );
    
    const CheckCircle = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
    );
    
    const Link2 = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"/><line x1="8" y1="12" x2="16" y2="12"/>
      </svg>
    );
    
    const GitBranch = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/>
      </svg>
    );
    
    const ArrowRight = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
      </svg>
    );
    
    const Layers = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>
      </svg>
    );
    
    const Printer = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>
      </svg>
    );
    
    const RotateCcw = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
      </svg>
    );
    
    const Database = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
      </svg>
    );
    
    const Shield = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
    );
    
    const Award = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
      </svg>
    );
    
    const Server = ({ className, style }) => (
      <svg className={className} style={style} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/>
      </svg>
    );

    // V4.1 Migration Utility
    function migrateToV41(transaction) {
      // Deep clone to avoid mutating original
      const v41 = JSON.parse(JSON.stringify(transaction));
      
      // ============================================================
      // PHASE 1: Detect and normalize alternate schema formats
      // ============================================================
      
      // Handle transaction_metadata wrapper (alternate format)
      if (v41.transaction_metadata) {
        v41.transaction_id = v41.transaction_id || v41.transaction_metadata.transaction_id;
        v41.timestamp = v41.timestamp || v41.transaction_metadata.timestamp;
        v41.transaction_type = v41.transaction_type || v41.transaction_metadata.transaction_type;
        v41.description = v41.description || v41.transaction_metadata.description;
      }
      
      // Handle foray_version vs schema_version
      if (v41.foray_version && !v41.schema_version) {
        v41.schema_version = v41.foray_version;
      }
      
      const version = v41.schema_version || v41._v || '3.0';
      v41.schema_version = '4.1';
      
      // Generate merkle_root if missing
      if (!v41.merkle_root) {
        v41.merkle_root = 'sha256:' + Array.from({length: 16}, () => 
          Math.floor(Math.random() * 16).toString(16)).join('') + '...';
      }
      
      // ============================================================
      // PHASE 2: Normalize Arrangements
      // ============================================================
      
      // Helper to normalize parties (convert string arrays to object arrays)
      const normalizeParties = (parties) => {
        if (!parties || !Array.isArray(parties)) return [];
        return parties.map((party, idx) => {
          if (typeof party === 'string') {
            // Convert string to object with role based on index or ID pattern
            const role = party.includes('employer') ? 'employer' :
                        party.includes('employee') ? 'employee' :
                        party.includes('lender') ? 'lender' :
                        party.includes('borrower') ? 'borrower' :
                        party.includes('buyer') ? 'buyer' :
                        party.includes('seller') ? 'seller' :
                        party.includes('vendor') ? 'vendor' :
                        party.includes('tax') || party.includes('authority') ? 'authority' :
                        party.includes('admin') ? 'administrator' :
                        idx === 0 ? 'party_1' : `party_${idx + 1}`;
            return { role, name: party };
          }
          return party; // Already an object
        });
      };
      
      v41.arrangements = (v41.arrangements || []).map(arr => {
        // Handle arrangement_id vs id
        const id = arr.id || arr.arrangement_id;
        
        // If already has foray_core, normalize parties and ensure id is set
        if (arr.foray_core) {
          const core = arr.foray_core;
          core.parties = normalizeParties(core.parties);
          return { id, foray_core: core };
        }
        
        // Build foray_core from flat structure
        const { id: _id, arrangement_id: _aid, ...rest } = arr;
        return {
          id,
          foray_core: {
            type: rest.type || rest.arrangement_type || 'unknown',
            effective_date: rest.effective_date,
            parties: normalizeParties(rest.parties),
            terms: rest.terms || {},
            description: rest.description,
            total_value: rest.total_value,
            currency: rest.currency || 'USD',
            ...rest
          }
        };
      });
      
      // ============================================================
      // PHASE 3: Normalize Accruals
      // ============================================================
      v41.accruals = (v41.accruals || []).map(acc => {
        // Handle accrual_id vs id
        const id = acc.id || acc.accrual_id;
        
        // If already has foray_core, ensure refs are arrays and normalize fields
        if (acc.foray_core) {
          const core = acc.foray_core;
          if (core.arrangement_ref !== undefined) {
            core.arrangement_refs = core.arrangement_ref ? [core.arrangement_ref] : [];
            delete core.arrangement_ref;
          }
          if (!core.arrangement_refs) core.arrangement_refs = [];
          // Map accrued_amount to output if output is missing
          if (core.output === undefined && core.accrued_amount !== undefined) {
            core.output = core.accrued_amount;
          }
          return { id, foray_core: core };
        }
        
        // Build foray_core from flat structure
        const { id: _id, accrual_id: _aid, ...rest } = acc;
        
        // Handle arrangement_id -> arrangement_refs
        let arrangement_refs = rest.arrangement_refs || [];
        if (rest.arrangement_id) {
          arrangement_refs = [rest.arrangement_id];
        }
        if (rest.arrangement_ref) {
          arrangement_refs = [rest.arrangement_ref];
        }
        if (rest.reference_arrangement) {
          arrangement_refs = [rest.reference_arrangement];
        }
        
        return {
          id,
          foray_core: {
            type: rest.type || rest.accrual_type || 'unknown',
            arrangement_refs,
            description: rest.description || rest.formula_description,
            computation_method: rest.computation_method || (rest.formula_hash ? 'Calculated' : 'FixedAmount'),
            formula_id: rest.formula_id || (rest.formula_hash ? `sha256:${rest.formula_hash}` : null),
            output: rest.output ?? rest.accrued_amount ?? rest.amount,
            currency: rest.currency || 'USD',
            accrual_date: rest.accrual_date,
            ...rest
          }
        };
      });
      
      // ============================================================
      // PHASE 4: Normalize Anticipations
      // ============================================================
      v41.anticipations = (v41.anticipations || []).map(ant => {
        // Handle anticipation_id vs id
        const id = ant.id || ant.anticipation_id;
        
        // If already has foray_core, ensure refs are arrays
        if (ant.foray_core) {
          const core = ant.foray_core;
          if (core.accrual_ref !== undefined) {
            core.accrual_refs = core.accrual_ref ? [core.accrual_ref] : [];
            delete core.accrual_ref;
          }
          if (!core.accrual_refs) core.accrual_refs = [];
          if (!core.arrangement_refs) core.arrangement_refs = [];
          return { id, foray_core: core };
        }
        
        // Build foray_core from flat structure
        const { id: _id, anticipation_id: _aid, ...rest } = ant;
        
        // Handle singular refs -> arrays
        let arrangement_refs = rest.arrangement_refs || [];
        if (rest.arrangement_id) arrangement_refs = [rest.arrangement_id];
        if (rest.arrangement_ref) arrangement_refs = [rest.arrangement_ref];
        
        let accrual_refs = rest.accrual_refs || [];
        if (rest.accrual_id) accrual_refs = [rest.accrual_id];
        if (rest.accrual_ref) accrual_refs = [rest.accrual_ref];
        
        return {
          id,
          foray_core: {
            type: rest.type || rest.anticipation_type || 'unknown',
            arrangement_refs,
            accrual_refs,
            description: rest.description || rest.purpose,
            expected_amount: rest.expected_amount ?? rest.amount,
            currency: rest.currency || 'USD',
            expected_date: rest.expected_date,
            probability_factor: rest.probability_factor ?? 1.0,
            from_party: rest.from_party,
            to_party: rest.to_party,
            ...rest
          }
        };
      });
      
      // ============================================================
      // PHASE 5: Normalize Actions
      // ============================================================
      v41.actions = (v41.actions || []).map(act => {
        // Handle action_id vs id
        const id = act.id || act.action_id;
        
        // If already has foray_core, ensure refs are arrays
        if (act.foray_core) {
          const core = act.foray_core;
          if (core.anticipation_ref !== undefined) {
            core.anticipation_refs = core.anticipation_ref ? [core.anticipation_ref] : [];
            delete core.anticipation_ref;
          }
          if (!core.anticipation_refs) core.anticipation_refs = [];
          if (!core.accrual_refs) core.accrual_refs = [];
          if (!core.arrangement_refs) core.arrangement_refs = [];
          if (!core.allocations) core.allocations = [];
          return { id, foray_core: core };
        }
        
        // Build foray_core from flat structure
        const { id: _id, action_id: _aid, ...rest } = act;
        
        // Handle singular refs -> arrays
        let arrangement_refs = rest.arrangement_refs || [];
        if (rest.arrangement_id) arrangement_refs = [rest.arrangement_id];
        if (rest.related_arrangement) arrangement_refs = [rest.related_arrangement];
        
        let anticipation_refs = rest.anticipation_refs || [];
        if (rest.anticipation_id) anticipation_refs = [rest.anticipation_id];
        if (rest.anticipation_ref) anticipation_refs = [rest.anticipation_ref];
        
        let accrual_refs = rest.accrual_refs || [];
        if (rest.accrual_id) accrual_refs = [rest.accrual_id];
        if (rest.accrual_ref) accrual_refs = [rest.accrual_ref];
        
        return {
          id,
          foray_core: {
            type: rest.type || rest.action_type || 'unknown',
            arrangement_refs,
            anticipation_refs,
            accrual_refs,
            description: rest.description || rest.purpose,
            amount_settled: rest.amount_settled ?? rest.amount,
            currency: rest.currency || 'USD',
            settlement_date: rest.settlement_date || rest.timestamp,
            settlement_status: rest.settlement_status || 'completed',
            payment_method: rest.payment_method,
            from_party: rest.from_party,
            to_party: rest.to_party,
            counterparty: rest.counterparty || rest.to_party,
            allocations: rest.allocations || [],
            ...rest
          }
        };
      });
      
      // ============================================================
      // PHASE 6: Build/update foray_core at transaction level
      // ============================================================
      if (!v41.foray_core) {
        // Calculate total value from actions or anticipations
        let totalValue = v41.total_value || v41.tv || 0;
        if (!totalValue && v41.actions?.length > 0) {
          totalValue = v41.actions.reduce((sum, a) => {
            const core = a.foray_core || a;
            return sum + (core.amount_settled || core.amount || 0);
          }, 0);
        }
        
        v41.foray_core = {
          entity: v41.entity || v41.e || 'Unknown',
          entity_hash: v41.entity_hash || null,
          transaction_type: v41.transaction_type || v41.ty || 'unknown',
          total_value: totalValue,
          currency: v41.currency || v41.cu || 'USD',
          status: v41.status || 'active',
          compliance_flags: v41.compliance_flags || v41.rc || []
        };
      }
      
      // ============================================================
      // PHASE 7: Migrate blockchain_anchor from V3 kaspa_commitment
      // ============================================================
      if (!v41.blockchain_anchor && (v41.kaspa_commitment || v41._kc)) {
        v41.blockchain_anchor = {
          kaspa_tx_id: v41.kaspa_commitment || v41._kc || null,
          block_height: v41.block_height || v41.bh || null,
          confirmation_time_ms: null,
          anchored_at: v41.timestamp || v41.ts || null
        };
      }
      
      return v41;
    }

    // V4.1 Validation
    function validateV41Transaction(transaction) {
      const errors = [];
      const warnings = [];
      
      const totalComponents = 
        (transaction.arrangements?.length || 0) +
        (transaction.accruals?.length || 0) +
        (transaction.anticipations?.length || 0) +
        (transaction.actions?.length || 0);
      
      if (totalComponents === 0) {
        errors.push('At least one component required');
      }
      
      const allIds = new Set();
      for (const arr of transaction.arrangements || []) allIds.add(arr.id);
      for (const acc of transaction.accruals || []) allIds.add(acc.id);
      for (const ant of transaction.anticipations || []) allIds.add(ant.id);
      for (const act of transaction.actions || []) allIds.add(act.id);
      for (const att of transaction.attestations || []) allIds.add(att.id);
      
      const validateRefs = (refs, componentId, refType) => {
        for (const ref of refs || []) {
          if (!allIds.has(ref)) {
            errors.push(`${componentId}: Referenced ${refType} '${ref}' does not exist`);
          }
        }
      };
      
      for (const acc of transaction.accruals || []) {
        const core = acc.foray_core || acc;
        validateRefs(core.arrangement_refs, acc.id, 'arrangement');
      }
      
      for (const ant of transaction.anticipations || []) {
        const core = ant.foray_core || ant;
        validateRefs(core.accrual_refs, ant.id, 'accrual');
        validateRefs(core.arrangement_refs, ant.id, 'arrangement');
      }
      
      for (const act of transaction.actions || []) {
        const core = act.foray_core || act;
        validateRefs(core.anticipation_refs, act.id, 'anticipation');
        validateRefs(core.accrual_refs, act.id, 'accrual');
        validateRefs(core.arrangement_refs, act.id, 'arrangement');
        
        if (core.allocations?.length > 0) {
          const sum = core.allocations.reduce((acc, a) => acc + (a.amount || 0), 0);
          const settled = core.amount_settled || 0;
          if (Math.abs(sum - settled) > 0.01) {
            errors.push(`${act.id}: Allocation sum (${sum}) != amount_settled (${settled})`);
          }
        }
      }
      
      // Validate attestation subject_refs
      for (const att of transaction.attestations || []) {
        const core = att.foray_core || att;
        validateRefs(core.subject_refs, att.id, 'subject');
        validateRefs(core.dependencies, att.id, 'dependency');
      }
      
      let entryPointType = null;
      if (transaction.arrangements?.length > 0) entryPointType = 'arrangement';
      else if (transaction.accruals?.length > 0) entryPointType = 'accrual';
      else if (transaction.anticipations?.length > 0) entryPointType = 'anticipation';
      else if (transaction.actions?.length > 0) entryPointType = 'action';
      
      return {
        valid: errors.length === 0,
        errors,
        warnings,
        entryPointType,
        componentCounts: {
          arrangements: transaction.arrangements?.length || 0,
          accruals: transaction.accruals?.length || 0,
          anticipations: transaction.anticipations?.length || 0,
          actions: transaction.actions?.length || 0,
          attestations: transaction.attestations?.length || 0
        }
      };
    }

    // Shared Components
    const Card = ({ children, className = '', style = {}, id }) => (
      <div 
        id={id}
        className={`rounded-xl shadow-sm p-6 ${className}`}
        style={{ backgroundColor: 'white', border: `1px solid ${forayColors.gray400}20`, ...style }}
      >
        {children}
      </div>
    );

    const SectionHeader = ({ title, icon: Icon, isExpanded, onToggle, count, badge, action }) => (
      <div 
        className="w-full flex items-center justify-between p-4 rounded-lg transition-colors"
        style={{ 
          backgroundColor: isExpanded ? `${forayColors.primaryTeal}10` : 'transparent',
          border: `1px solid ${isExpanded ? forayColors.primaryTeal : forayColors.gray400}40`
        }}
      >
        <button onClick={onToggle} className="flex items-center gap-3 flex-grow text-left">
          {Icon && <Icon className="w-5 h-5" style={{ color: forayColors.primaryTeal }} />}
          <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>{title}</span>
          {count !== undefined && (
            <span className="px-2 py-0.5 text-xs rounded-full" style={{ backgroundColor: `${forayColors.primaryTeal}20`, color: forayColors.primaryTeal }}>
              {count}
            </span>
          )}
          {badge && (
            <span className="px-2 py-0.5 text-xs rounded-full" style={{ backgroundColor: `${forayColors.actionAmber}20`, color: forayColors.actionAmber }}>
              {badge}
            </span>
          )}
        </button>
        <div className="flex items-center gap-2">
          {action}
          <button onClick={onToggle}>
            {isExpanded ? (
              <ChevronDown className="w-5 h-5" style={{ color: forayColors.gray600 }} />
            ) : (
              <ChevronRight className="w-5 h-5" style={{ color: forayColors.gray600 }} />
            )}
          </button>
        </div>
      </div>
    );

    const KeyValue = ({ label, value, mono = false }) => (
      <div className="flex justify-between items-center py-2 border-b" style={{ borderColor: `${forayColors.gray400}30` }}>
        <span className="text-sm" style={{ color: forayColors.gray600 }}>{label}</span>
        <span className={`text-sm font-medium ${mono ? 'font-mono' : ''}`} style={{ color: forayColors.textDark }}>
          {value ?? 'N/A'}
        </span>
      </div>
    );

    const StatusBadge = ({ status }) => {
      const statusColors = {
        active: { bg: '#dbeafe', text: '#1d4ed8' },
        completed: { bg: '#d1fae5', text: '#047857' },
        pending: { bg: '#fef3c7', text: '#b45309' },
        failed: { bg: '#fee2e2', text: '#b91c1c' },
        reversed: { bg: '#f3e8ff', text: '#7c3aed' }
      };
      const colors = statusColors[status?.toLowerCase()] || statusColors.active;
      return (
        <span className="px-3 py-1 text-xs font-medium rounded-full" style={{ backgroundColor: colors.bg, color: colors.text }}>
          {status || 'Unknown'}
        </span>
      );
    };

    const RefBadge = ({ refId, refType, clickable = true, onNavigate }) => {
      const typeColors = {
        arrangement: forayColors.primaryTeal,
        accrual: forayColors.accentCyan,
        anticipation: forayColors.actionAmber,
        action: forayColors.successGreen,
        attestation: '#8B5CF6'  // Purple for attestations
      };
      const color = typeColors[refType] || forayColors.gray600;
      
      if (clickable && onNavigate) {
        return (
          <button 
            onClick={() => onNavigate(refId)}
            className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-mono rounded cursor-pointer hover:opacity-80 transition-opacity" 
            style={{ backgroundColor: `${color}20`, color: color, border: `1px solid ${color}40` }}
            data-tooltip={`Jump to ${refId}`}
          >
            <Link2 className="w-3 h-3" />
            {refId}
          </button>
        );
      }
      
      return (
        <span className="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-mono rounded" style={{ backgroundColor: `${color}20`, color: color, border: `1px solid ${color}40` }}>
          <Link2 className="w-3 h-3" />
          {refId}
        </span>
      );
    };

    const ReferencesDisplay = ({ refs, refType, label, onNavigate }) => {
      if (!refs || refs.length === 0) return null;
      return (
        <div className="mb-3">
          <p className="text-xs font-medium mb-1.5" style={{ color: forayColors.gray600 }}>{label} ({refs.length})</p>
          <div className="flex flex-wrap gap-1.5">
            {refs.map((ref, idx) => <RefBadge key={idx} refId={ref} refType={refType} onNavigate={onNavigate} />)}
          </div>
        </div>
      );
    };

    const AllocationsDisplay = ({ allocations, currency = 'USD', onNavigate }) => {
      if (!allocations || allocations.length === 0) return null;
      
      const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount || 0);
      const total = allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
      
      return (
        <div className="mt-4 p-3 rounded-lg" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
          <div className="flex items-center gap-2 mb-3">
            <GitBranch className="w-4 h-4" style={{ color: forayColors.accentCyan }} />
            <p className="text-sm font-semibold" style={{ color: forayColors.secondaryNavy }}>Payment Allocations ({allocations.length})</p>
          </div>
          <div className="space-y-2">
            {allocations.map((alloc, idx) => (
              <div key={idx} className="flex items-center justify-between p-2 rounded" style={{ backgroundColor: 'white' }}>
                <div className="flex items-center gap-2">
                  <ArrowRight className="w-3 h-3" style={{ color: forayColors.gray400 }} />
                  <RefBadge refId={alloc.ref} refType={alloc.ref_type} onNavigate={onNavigate} />
                  {alloc.allocation_type && (
                    <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: alloc.allocation_type === 'full' ? '#d1fae5' : '#fef3c7', color: alloc.allocation_type === 'full' ? '#047857' : '#b45309' }}>
                      {alloc.allocation_type}
                    </span>
                  )}
                </div>
                <div className="text-right">
                  <span className="font-mono text-sm font-semibold" style={{ color: forayColors.textDark }}>{formatCurrency(alloc.amount)}</span>
                  {alloc.remaining_balance !== undefined && alloc.remaining_balance > 0 && (
                    <p className="text-xs" style={{ color: forayColors.gray600 }}>Remaining: {formatCurrency(alloc.remaining_balance)}</p>
                  )}
                </div>
              </div>
            ))}
          </div>
          <div className="mt-2 pt-2 flex justify-between items-center" style={{ borderTop: `1px solid ${forayColors.gray400}30` }}>
            <span className="text-sm font-medium" style={{ color: forayColors.gray600 }}>Total Allocated</span>
            <span className="font-mono font-bold" style={{ color: forayColors.primaryTeal }}>{formatCurrency(total)}</span>
          </div>
        </div>
      );
    };

    const DependencyGraph = ({ dependencies, onNavigate }) => {
      if (!dependencies || dependencies.length === 0) return null;
      return (
        <div className="mt-3">
          <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>Dependencies</p>
          <div className="flex flex-wrap gap-1.5">
            {dependencies.map((dep, idx) => {
              let refType = 'arrangement';
              if (dep.startsWith('ACC_')) refType = 'accrual';
              else if (dep.startsWith('ANT_')) refType = 'anticipation';
              else if (dep.startsWith('ACT_')) refType = 'action';
              else if (dep.startsWith('ATT_')) refType = 'attestation';
              return <RefBadge key={idx} refId={dep} refType={refType} onNavigate={onNavigate} />;
            })}
          </div>
        </div>
      );
    };

    const renderObjectAsTable = (obj, title) => {
      if (!obj || Object.keys(obj).length === 0) return null;
      return (
        <div className="mt-3">
          <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>{title}</p>
          <div className="rounded border" style={{ borderColor: `${forayColors.gray400}30` }}>
            {Object.entries(obj).map(([key, value], idx) => (
              <div key={idx} className="flex justify-between p-2 text-sm" style={{ borderBottom: idx < Object.entries(obj).length - 1 ? `1px solid ${forayColors.gray400}20` : 'none', backgroundColor: idx % 2 === 0 ? 'white' : forayColors.bgLight }}>
                <span style={{ color: forayColors.gray600 }}>{key.replace(/_/g, ' ')}</span>
                <span className="font-medium font-mono text-xs" style={{ color: forayColors.textDark }}>
                  {typeof value === 'object' ? JSON.stringify(value) : String(value)}
                </span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Sample V4.1 Transactions
    const sampleTransactions = {
      batchPayment: {
        name: "Batch Payment (3 Invoices)",
        description: "AP batch clearing multiple invoices with allocations",
        data: {
          "transaction_id": "AP_2026_Q1_BATCH_PAYMENT_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-25T10:00:00Z",
          "foray_core": {
            "entity": "Acme Corporation",
            "entity_hash": "sha256:def456abc789...",
            "transaction_type": "batch_payment",
            "total_value": 10000.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["SOX_404", "GAAP"]
          },
          "component_hashes": {
            "arrangements": "sha256:a1b2c3...",
            "accruals": "sha256:d4e5f6...",
            "anticipations": "sha256:g7h8i9...",
            "actions": "sha256:j0k1l2..."
          },
          "arrangements": [
            {
              "id": "ARR_VENDOR_MSA_001",
              "foray_core": {
                "type": "master_service_agreement",
                "effective_date": "2025-01-01T00:00:00Z",
                "parties": [
                  { "role": "buyer", "name": "Acme Corporation", "jurisdiction": "US" },
                  { "role": "vendor", "name": "TechSupply Inc", "jurisdiction": "US" }
                ],
                "description": "Master agreement for IT supplies",
                "total_value": 100000.00,
                "currency": "USD",
                "terms": { "payment_terms": "Net 30", "auto_renewal": true },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            { "id": "ACC_INVOICE_001", "foray_core": { "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "accounts_payable", "description": "Server hardware invoice", "computation_method": "FixedAmount", "output": 3000.00, "currency": "USD", "dependencies": ["ARR_VENDOR_MSA_001"] } },
            { "id": "ACC_INVOICE_002", "foray_core": { "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "accounts_payable", "description": "Software licenses", "computation_method": "FixedAmount", "output": 4000.00, "currency": "USD", "dependencies": ["ARR_VENDOR_MSA_001"] } },
            { "id": "ACC_INVOICE_003", "foray_core": { "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "accounts_payable", "description": "Cloud services", "computation_method": "Calculated", "formula_id": "sha256:usage...", "output": 3500.00, "currency": "USD", "dependencies": ["ARR_VENDOR_MSA_001"] } }
          ],
          "anticipations": [
            { "id": "ANT_PAYMENT_DUE_001", "foray_core": { "accrual_refs": ["ACC_INVOICE_001"], "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "scheduled_payment", "description": "Payment due for hardware", "expected_amount": 3000.00, "currency": "USD", "expected_date": "2026-01-31", "probability_factor": 1.0, "dependencies": ["ACC_INVOICE_001"] } },
            { "id": "ANT_PAYMENT_DUE_002", "foray_core": { "accrual_refs": ["ACC_INVOICE_002"], "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "scheduled_payment", "description": "Payment due for software", "expected_amount": 4000.00, "currency": "USD", "expected_date": "2026-01-31", "probability_factor": 1.0, "dependencies": ["ACC_INVOICE_002"] } },
            { "id": "ANT_PAYMENT_DUE_003", "foray_core": { "accrual_refs": ["ACC_INVOICE_003"], "arrangement_refs": ["ARR_VENDOR_MSA_001"], "type": "scheduled_payment", "description": "Payment due for cloud", "expected_amount": 3500.00, "currency": "USD", "expected_date": "2026-01-31", "probability_factor": 1.0, "dependencies": ["ACC_INVOICE_003"] } }
          ],
          "actions": [
            {
              "id": "ACT_BATCH_PAYMENT_001",
              "foray_core": {
                "anticipation_refs": ["ANT_PAYMENT_DUE_001", "ANT_PAYMENT_DUE_002", "ANT_PAYMENT_DUE_003"],
                "accrual_refs": ["ACC_INVOICE_001", "ACC_INVOICE_002", "ACC_INVOICE_003"],
                "arrangement_refs": ["ARR_VENDOR_MSA_001"],
                "type": "batch_payment",
                "description": "Consolidated payment clearing 3 invoices",
                "amount_settled": 10000.00,
                "currency": "USD",
                "settlement_date": "2026-01-25T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "TechSupply Inc",
                "allocations": [
                  { "ref": "ANT_PAYMENT_DUE_001", "ref_type": "anticipation", "amount": 3000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 },
                  { "ref": "ANT_PAYMENT_DUE_002", "ref_type": "anticipation", "amount": 4000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 },
                  { "ref": "ANT_PAYMENT_DUE_003", "ref_type": "anticipation", "amount": 3000.00, "currency": "USD", "allocation_type": "partial", "remaining_balance": 500.00 }
                ],
                "variance": { "expected": 10500.00, "actual": 10000.00, "difference": -500.00, "explanation": "Partial payment on cloud services" },
                "dependencies": ["ANT_PAYMENT_DUE_001", "ANT_PAYMENT_DUE_002", "ANT_PAYMENT_DUE_003"]
              }
            }
          ],
          "merkle_root": "sha256:9f8e7d6c5b4a3210...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qr7f3a2b9d8e...", "block_height": 2850123, "confirmation_time_ms": 1150, "anchored_at": "2026-01-25T10:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:audit123...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/AP_2026_Q1_BATCH_PAYMENT_001"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 3, "attack_complexity": "2^96 operations" }
        }
      },
      
      cashSale: {
        name: "Cash Sale (Action Only)",
        description: "Simple retail transaction - no arrangements needed",
        data: {
          "transaction_id": "RETAIL_2026_CASH_SALE_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-25T14:30:00Z",
          "foray_core": {
            "entity": "Main Street Coffee Shop",
            "entity_hash": "sha256:coffee123...",
            "transaction_type": "cash_sale",
            "total_value": 47.50,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["PCI_DSS", "Sales_Tax"]
          },
          "component_hashes": { "arrangements": "sha256:empty...", "accruals": "sha256:empty...", "anticipations": "sha256:empty...", "actions": "sha256:act123..." },
          "arrangements": [],
          "accruals": [],
          "anticipations": [],
          "actions": [
            {
              "id": "ACT_CASH_SALE_001",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": [],
                "type": "cash_receipt",
                "description": "Walk-in cash sale - coffee, pastry, merchandise",
                "amount_settled": 47.50,
                "currency": "USD",
                "settlement_date": "2026-01-25T14:30:00Z",
                "settlement_status": "completed",
                "payment_method": "cash",
                "counterparty": "Walk-in Customer",
                "allocations": [],
                "details": { "register_id": "REG-001", "items_sold": 3, "payment_tendered": 50.00, "change_given": 2.50 },
                "breakdown": { "subtotal": 43.18, "sales_tax_rate": 0.10, "sales_tax": 4.32, "total": 47.50 },
                "dependencies": []
              }
            }
          ],
          "merkle_root": "sha256:cashsale123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrcash123...", "block_height": 2850000, "confirmation_time_ms": 1100, "anchored_at": "2026-01-25T14:30:02Z" },
          "privacy_metadata": { "formulas_obfuscated": 0, "instance_pools": 0, "attack_complexity": "N/A" }
        }
      },
      
      depreciation: {
        name: "Depreciation (Accrual Only)",
        description: "Month-end adjusting entry - no cash movement",
        data: {
          "transaction_id": "ACCT_2026_Q1_DEPRECIATION_JAN",
          "schema_version": "4.1",
          "timestamp": "2026-01-31T23:59:00Z",
          "foray_core": {
            "entity": "Acme Corporation",
            "entity_hash": "sha256:acme123...",
            "transaction_type": "adjusting_entry",
            "total_value": 12500.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["GAAP", "SOX_404", "ASC_360"]
          },
          "component_hashes": { "arrangements": "sha256:empty...", "accruals": "sha256:depr123...", "anticipations": "sha256:empty...", "actions": "sha256:empty..." },
          "arrangements": [],
          "accruals": [
            {
              "id": "ACC_DEPRECIATION_EQUIPMENT",
              "foray_core": {
                "arrangement_refs": [],
                "type": "depreciation_expense",
                "description": "January equipment depreciation - straight line",
                "computation_method": "Calculated",
                "formula_id": "sha256:straightline...",
                "inputs": { "asset_cost": 600000.00, "salvage_value": 0, "useful_life_months": 120 },
                "output": 5000.00,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "6100-Depreciation Expense", "amount": 5000.00 }, "credit": { "account": "1510-Accumulated Depreciation", "amount": 5000.00 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": []
              }
            },
            {
              "id": "ACC_DEPRECIATION_VEHICLES",
              "foray_core": {
                "arrangement_refs": [],
                "type": "depreciation_expense",
                "description": "January vehicle fleet depreciation",
                "computation_method": "Calculated",
                "formula_id": "sha256:straightline...",
                "inputs": { "asset_cost": 300000.00, "salvage_value": 30000, "useful_life_months": 60 },
                "output": 4500.00,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "6110-Depreciation Expense - Vehicles", "amount": 4500.00 }, "credit": { "account": "1520-Accumulated Depreciation - Vehicles", "amount": 4500.00 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": []
              }
            },
            {
              "id": "ACC_DEPRECIATION_BUILDING",
              "foray_core": {
                "arrangement_refs": [],
                "type": "depreciation_expense",
                "description": "January building depreciation",
                "computation_method": "Calculated",
                "formula_id": "sha256:straightline...",
                "inputs": { "asset_cost": 1440000.00, "salvage_value": 0, "useful_life_months": 480 },
                "output": 3000.00,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "6120-Depreciation Expense - Building", "amount": 3000.00 }, "credit": { "account": "1530-Accumulated Depreciation - Building", "amount": 3000.00 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": []
              }
            }
          ],
          "anticipations": [],
          "actions": [],
          "merkle_root": "sha256:depr789...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrdepr123...", "block_height": 2852000, "confirmation_time_ms": 980, "anchored_at": "2026-01-31T23:59:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:depaudit...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/DEPRECIATION_JAN"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 3, "attack_complexity": "2^96 operations" }
        }
      },
      
      autoLoan: {
        name: "Auto Loan (Full Chain)",
        description: "Consumer loan with arrangement &rarr; accruals &rarr; anticipations &rarr; actions",
        data: {
          "transaction_id": "AUTO_LOAN_2026_Q1_JOHN_DOE",
          "schema_version": "4.1",
          "timestamp": "2026-01-23T15:00:00Z",
          "foray_core": {
            "entity": "Auto Finance Co",
            "entity_hash": "sha256:autofinance...",
            "transaction_type": "auto_loan",
            "total_value": 25000.00,
            "currency": "USD",
            "status": "active",
            "compliance_flags": ["Consumer_Credit", "Truth_in_Lending_Act", "Reg_Z"]
          },
          "component_hashes": { "arrangements": "sha256:arr1...", "accruals": "sha256:acc2...", "anticipations": "sha256:ant3...", "actions": "sha256:act4..." },
          "arrangements": [
            {
              "id": "ARR_AUTO_LOAN_AGREEMENT",
              "foray_core": {
                "type": "auto_loan",
                "effective_date": "2026-01-23T00:00:00Z",
                "parties": [
                  { "role": "lender", "name": "Auto Finance Co", "jurisdiction": "US" },
                  { "role": "borrower", "name": "John Doe", "jurisdiction": "US" }
                ],
                "description": "60-month auto loan at 4.5% APR",
                "total_value": 25000.00,
                "currency": "USD",
                "terms": { "principal_amount": 25000, "interest_rate": 0.045, "term_months": 60, "monthly_payment": 466.08 },
                "legal_documentation": ["Auto Loan Agreement", "Truth in Lending Disclosure"],
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_INTEREST_MONTH_1",
              "foray_core": {
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "interest_expense",
                "description": "Interest accrual month 1 at 4.5% APR",
                "computation_method": "Calculated",
                "formula_id": "sha256:interest_calc...",
                "inputs": { "principal": 25000.00, "annual_rate": 0.045, "days_in_month": 31 },
                "output": 95.89,
                "currency": "USD",
                "accounting_entry": { "debit": { "account": "7100-Interest Expense", "amount": 95.89 }, "credit": { "account": "2200-Interest Payable", "amount": 95.89 } },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_AUTO_LOAN_AGREEMENT"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_PAYMENT_1",
              "foray_core": {
                "accrual_refs": ["ACC_INTEREST_MONTH_1"],
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "scheduled_payment",
                "description": "Expected payment 1: $466.08",
                "expected_amount": 466.08,
                "currency": "USD",
                "expected_date": "2026-02-23",
                "probability_factor": 0.95,
                "assumptions": { "principal_portion": 370.19, "interest_portion": 95.89 },
                "dependencies": ["ACC_INTEREST_MONTH_1"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_LOAN_ORIGINATION",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "loan_disbursement",
                "description": "Initial loan disbursement",
                "amount_settled": 25000.00,
                "currency": "USD",
                "settlement_date": "2026-01-23T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "John Doe",
                "allocations": [],
                "details": { "vehicle_vin": "1HGBH41JXMN109186", "vehicle_year": 2024, "vehicle_make": "Honda", "vehicle_model": "Accord" },
                "dependencies": ["ARR_AUTO_LOAN_AGREEMENT"]
              }
            },
            {
              "id": "ACT_PAYMENT_1",
              "foray_core": {
                "anticipation_refs": ["ANT_PAYMENT_1"],
                "accrual_refs": ["ACC_INTEREST_MONTH_1"],
                "arrangement_refs": ["ARR_AUTO_LOAN_AGREEMENT"],
                "type": "loan_payment",
                "description": "First monthly payment received",
                "amount_settled": 466.08,
                "currency": "USD",
                "settlement_date": "2026-02-23T09:15:00Z",
                "settlement_status": "completed",
                "payment_method": "ach",
                "counterparty": "John Doe",
                "allocations": [
                  { "ref": "ANT_PAYMENT_1", "ref_type": "anticipation", "amount": 466.08, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 466.08, "actual": 466.08, "difference": 0.00 },
                "breakdown": { "principal_applied": 370.19, "interest_applied": 95.89 },
                "dependencies": ["ANT_PAYMENT_1", "ACC_INTEREST_MONTH_1"]
              }
            }
          ],
          "merkle_root": "sha256:autoloan...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrauto123...", "block_height": 2849000, "confirmation_time_ms": 1050, "anchored_at": "2026-01-23T15:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:loanaudit...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/AUTO_LOAN_JOHN_DOE"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 5, "attack_complexity": "2^96 operations" }
        }
      },
      
      energyPPA: {
        name: "Energy PPA (Solar)",
        description: "Power Purchase Agreement with generation, delivery, and settlement",
        data: {
          "transaction_id": "ENERGY_PPA_2026_Q1_SOLAR_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-25T06:00:00Z",
          "foray_core": {
            "entity": "SunPower Utilities",
            "entity_hash": "sha256:sunpower...",
            "transaction_type": "power_purchase_agreement",
            "total_value": 156000.00,
            "currency": "USD",
            "status": "active",
            "compliance_flags": ["FERC", "NERC", "REC_Tracking", "ISO_NE"]
          },
          "component_hashes": { "arrangements": "sha256:ppa1...", "accruals": "sha256:gen1...", "anticipations": "sha256:del1...", "actions": "sha256:set1..." },
          "arrangements": [
            {
              "id": "ARR_PPA_SOLAR_FARM",
              "foray_core": {
                "type": "power_purchase_agreement",
                "effective_date": "2025-01-01T00:00:00Z",
                "termination_date": "2045-01-01T00:00:00Z",
                "parties": [
                  { "role": "generator", "name": "Desert Sun Solar LLC", "jurisdiction": "US-AZ" },
                  { "role": "offtaker", "name": "SunPower Utilities", "jurisdiction": "US-CA" },
                  { "role": "grid_operator", "name": "CAISO", "jurisdiction": "US-CA" }
                ],
                "description": "20-year solar PPA - 50MW facility in Arizona",
                "total_value": 180000000.00,
                "currency": "USD",
                "terms": {
                  "capacity_mw": 50,
                  "price_per_mwh": 35.00,
                  "annual_escalation": 0.02,
                  "curtailment_provisions": "Buyer pays 80% for curtailed energy",
                  "rec_transfer": "included"
                },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_GENERATION_JAN_2026",
              "foray_core": {
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "energy_generation",
                "description": "January 2026 solar generation - metered output",
                "computation_method": "Calculated",
                "formula_id": "sha256:energy_gen...",
                "inputs": { "meter_reading_start_mwh": 1250000, "meter_reading_end_mwh": 1254500, "capacity_factor": 0.28 },
                "output": 4500.00,
                "unit": "MWh",
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1400-Energy Inventory", "amount": 157500.00 },
                  "credit": { "account": "2100-Energy Payable", "amount": 157500.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_PPA_SOLAR_FARM"]
              }
            },
            {
              "id": "ACC_REC_JAN_2026",
              "foray_core": {
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "renewable_energy_credit",
                "description": "January 2026 RECs generated",
                "computation_method": "Calculated",
                "formula_id": "sha256:rec_calc...",
                "inputs": { "mwh_generated": 4500, "rec_per_mwh": 1, "rec_value": 15.00 },
                "output": 4500,
                "unit": "RECs",
                "currency": "USD",
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ACC_GENERATION_JAN_2026"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_ENERGY_DELIVERY_JAN",
              "foray_core": {
                "accrual_refs": ["ACC_GENERATION_JAN_2026"],
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "scheduled_delivery",
                "description": "Expected energy delivery and payment for January",
                "expected_amount": 157500.00,
                "currency": "USD",
                "expected_date": "2026-02-15",
                "probability_factor": 0.98,
                "assumptions": { "mwh_expected": 4500, "price_per_mwh": 35.00, "curtailment_risk": 0.02 },
                "dependencies": ["ACC_GENERATION_JAN_2026"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_ENERGY_SETTLEMENT_JAN",
              "foray_core": {
                "anticipation_refs": ["ANT_ENERGY_DELIVERY_JAN"],
                "accrual_refs": ["ACC_GENERATION_JAN_2026", "ACC_REC_JAN_2026"],
                "arrangement_refs": ["ARR_PPA_SOLAR_FARM"],
                "type": "energy_settlement",
                "description": "January energy delivery settlement with curtailment adjustment",
                "amount_settled": 156000.00,
                "currency": "USD",
                "settlement_date": "2026-02-15T14:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "Desert Sun Solar LLC",
                "allocations": [
                  { "ref": "ANT_ENERGY_DELIVERY_JAN", "ref_type": "anticipation", "amount": 156000.00, "currency": "USD", "allocation_type": "partial", "remaining_balance": 1500.00 }
                ],
                "variance": { "expected": 157500.00, "actual": 156000.00, "difference": -1500.00, "explanation": "Grid curtailment event Jan 15-16 (42.86 MWh)" },
                "details": {
                  "mwh_delivered": 4457.14,
                  "mwh_curtailed": 42.86,
                  "curtailment_credit": 1200.00,
                  "grid_interconnection_point": "Palo Verde Hub",
                  "caiso_settlement_id": "CAISO-2026-01-4521"
                },
                "dependencies": ["ANT_ENERGY_DELIVERY_JAN"]
              }
            }
          ],
          "merkle_root": "sha256:energy123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrenergy...", "block_height": 2851500, "confirmation_time_ms": 1100, "anchored_at": "2026-02-15T14:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:energyaudit...", "audit_profile": "energy_compliance", "storage_locations": ["s3://foray-audit/2026/Q1/ENERGY_PPA_SOLAR_001"] },
          "privacy_metadata": { "formulas_obfuscated": 2, "instance_pools": 4, "attack_complexity": "2^96 operations" }
        }
      },
      
      manufacturing: {
        name: "Manufacturing (Work Order)",
        description: "Production work order with BOM, labor, overhead allocation",
        data: {
          "transaction_id": "MFG_WO_2026_Q1_WIDGET_500",
          "schema_version": "4.1",
          "timestamp": "2026-01-20T08:00:00Z",
          "foray_core": {
            "entity": "Precision Parts Manufacturing",
            "entity_hash": "sha256:precision...",
            "transaction_type": "work_order",
            "total_value": 47500.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["ISO_9001", "GAAP", "Cost_Accounting_Standards"]
          },
          "component_hashes": { "arrangements": "sha256:wo1...", "accruals": "sha256:cost1...", "anticipations": "sha256:prod1...", "actions": "sha256:inv1..." },
          "arrangements": [
            {
              "id": "ARR_WORK_ORDER_500",
              "foray_core": {
                "type": "production_work_order",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "manufacturer", "name": "Precision Parts Manufacturing", "jurisdiction": "US-MI" },
                  { "role": "customer", "name": "AutoTech Industries", "jurisdiction": "US-OH" }
                ],
                "description": "Work Order #WO-2026-500: Premium Widget Assembly (500 units)",
                "total_value": 50000.00,
                "currency": "USD",
                "terms": {
                  "product_code": "PWA-1000",
                  "quantity_ordered": 500,
                  "unit_price": 100.00,
                  "delivery_date": "2026-01-25",
                  "quality_standard": "ISO 9001"
                },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_DIRECT_MATERIALS",
              "foray_core": {
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "direct_material_cost",
                "description": "BOM materials consumed - aluminum, electronics, fasteners",
                "computation_method": "Calculated",
                "formula_id": "sha256:bom_cost...",
                "inputs": { "aluminum_kg": 250, "aluminum_cost_per_kg": 45.00, "electronics_units": 500, "electronics_cost": 25.00, "fasteners_sets": 500, "fasteners_cost": 2.50 },
                "output": 25000.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1310-WIP Inventory", "amount": 25000.00 },
                  "credit": { "account": "1200-Raw Materials", "amount": 25000.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_WORK_ORDER_500"]
              }
            },
            {
              "id": "ACC_DIRECT_LABOR",
              "foray_core": {
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "direct_labor_cost",
                "description": "Production labor - assembly line workers",
                "computation_method": "Calculated",
                "formula_id": "sha256:labor_cost...",
                "inputs": { "labor_hours": 400, "avg_hourly_rate": 35.00, "benefits_rate": 0.30 },
                "output": 18200.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1310-WIP Inventory", "amount": 18200.00 },
                  "credit": { "account": "2300-Wages Payable", "amount": 14000.00 },
                  "credit2": { "account": "2310-Benefits Payable", "amount": 4200.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_WORK_ORDER_500"]
              }
            },
            {
              "id": "ACC_MANUFACTURING_OVERHEAD",
              "foray_core": {
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "manufacturing_overhead",
                "description": "Applied overhead - machine hours basis",
                "computation_method": "Calculated",
                "formula_id": "sha256:overhead_alloc...",
                "inputs": { "machine_hours": 200, "overhead_rate_per_hour": 21.50 },
                "output": 4300.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1310-WIP Inventory", "amount": 4300.00 },
                  "credit": { "account": "5100-Applied Overhead", "amount": 4300.00 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ACC_DIRECT_LABOR"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_PRODUCTION_COMPLETE",
              "foray_core": {
                "accrual_refs": ["ACC_DIRECT_MATERIALS", "ACC_DIRECT_LABOR", "ACC_MANUFACTURING_OVERHEAD"],
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "production_completion",
                "description": "Expected completion and transfer to finished goods",
                "expected_amount": 47500.00,
                "currency": "USD",
                "expected_date": "2026-01-24",
                "probability_factor": 0.95,
                "assumptions": { "yield_rate": 0.98, "expected_good_units": 490, "cost_per_unit": 95.00 },
                "dependencies": ["ACC_DIRECT_MATERIALS", "ACC_DIRECT_LABOR", "ACC_MANUFACTURING_OVERHEAD"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_PRODUCTION_COMPLETE",
              "foray_core": {
                "anticipation_refs": ["ANT_PRODUCTION_COMPLETE"],
                "accrual_refs": ["ACC_DIRECT_MATERIALS", "ACC_DIRECT_LABOR", "ACC_MANUFACTURING_OVERHEAD"],
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "inventory_transfer",
                "description": "Transfer completed units to finished goods inventory",
                "amount_settled": 47500.00,
                "currency": "USD",
                "settlement_date": "2026-01-24T16:00:00Z",
                "settlement_status": "completed",
                "allocations": [
                  { "ref": "ANT_PRODUCTION_COMPLETE", "ref_type": "anticipation", "amount": 47500.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 47500.00, "actual": 47500.00, "difference": 0.00 },
                "details": {
                  "units_completed": 497,
                  "units_scrapped": 3,
                  "scrap_value": 45.00,
                  "unit_cost": 95.52,
                  "lot_number": "LOT-2026-01-500",
                  "quality_inspection": "passed"
                },
                "dependencies": ["ANT_PRODUCTION_COMPLETE"]
              }
            },
            {
              "id": "ACT_CUSTOMER_SHIPMENT",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_WORK_ORDER_500"],
                "type": "shipment",
                "description": "Ship completed order to customer",
                "amount_settled": 50000.00,
                "currency": "USD",
                "settlement_date": "2026-01-25T09:00:00Z",
                "settlement_status": "completed",
                "allocations": [],
                "details": {
                  "units_shipped": 497,
                  "carrier": "FedEx Freight",
                  "tracking_number": "FX-789456123",
                  "revenue_recognized": 49700.00
                },
                "dependencies": ["ACT_PRODUCTION_COMPLETE"]
              }
            }
          ],
          "merkle_root": "sha256:mfg123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrmfg...", "block_height": 2850800, "confirmation_time_ms": 980, "anchored_at": "2026-01-25T09:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:mfgaudit...", "audit_profile": "manufacturing", "storage_locations": ["s3://foray-audit/2026/Q1/MFG_WO_500"] },
          "privacy_metadata": { "formulas_obfuscated": 3, "instance_pools": 4, "attack_complexity": "2^96 operations" }
        }
      },
      
      salesforceOpportunity: {
        name: "Salesforce Opportunity",
        description: "CRM opportunity &rarr; quote &rarr; order &rarr; invoice &rarr; payment",
        data: {
          "transaction_id": "SF_OPP_2026_Q1_ACME_ENTERPRISE",
          "schema_version": "4.1",
          "timestamp": "2026-01-22T10:00:00Z",
          "foray_core": {
            "entity": "CloudTech Solutions",
            "entity_hash": "sha256:cloudtech...",
            "transaction_type": "salesforce_opportunity",
            "total_value": 125000.00,
            "currency": "USD",
            "status": "closed_won",
            "compliance_flags": ["ASC_606", "SOX_404", "Revenue_Recognition"]
          },
          "source_system": {
            "type": "Salesforce",
            "instance": "cloudtech.salesforce.com",
            "api_version": "v59.0"
          },
          "component_hashes": { "arrangements": "sha256:opp1...", "accruals": "sha256:rev1...", "anticipations": "sha256:pay1...", "actions": "sha256:close1..." },
          "arrangements": [
            {
              "id": "ARR_SF_OPPORTUNITY",
              "foray_core": {
                "type": "sales_opportunity",
                "effective_date": "2025-11-15T00:00:00Z",
                "parties": [
                  { "role": "seller", "name": "CloudTech Solutions", "jurisdiction": "US-CA" },
                  { "role": "buyer", "name": "Acme Corporation", "jurisdiction": "US-NY" }
                ],
                "description": "Enterprise Cloud Platform - 3 Year Agreement",
                "total_value": 125000.00,
                "currency": "USD",
                "terms": {
                  "contract_term_years": 3,
                  "annual_value": 41666.67,
                  "payment_terms": "Annual in advance",
                  "renewal_type": "auto_renewal"
                },
                "salesforce_refs": {
                  "opportunity_id": "006Dn000004XyZ1ABC",
                  "account_id": "001Dn000003ABC1DEF",
                  "owner_id": "005Dn000001XYZ9ABC",
                  "opportunity_name": "Acme Corp - Enterprise Platform",
                  "stage": "Closed Won",
                  "close_date": "2026-01-20"
                },
                "dependencies": []
              }
            },
            {
              "id": "ARR_SF_QUOTE",
              "foray_core": {
                "type": "sales_quote",
                "effective_date": "2026-01-10T00:00:00Z",
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "parties": [
                  { "role": "seller", "name": "CloudTech Solutions" },
                  { "role": "buyer", "name": "Acme Corporation" }
                ],
                "description": "Quote Q-2026-0142: Enterprise Cloud Platform",
                "total_value": 125000.00,
                "currency": "USD",
                "salesforce_refs": {
                  "quote_id": "0Q0Dn000000ABC1DEF",
                  "quote_number": "Q-2026-0142",
                  "status": "Accepted"
                },
                "line_items": [
                  { "product": "Enterprise Platform License", "quantity": 500, "unit_price": 200.00, "total": 100000.00 },
                  { "product": "Premium Support", "quantity": 1, "unit_price": 15000.00, "total": 15000.00 },
                  { "product": "Implementation Services", "quantity": 1, "unit_price": 10000.00, "total": 10000.00 }
                ],
                "dependencies": ["ARR_SF_OPPORTUNITY"]
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_REVENUE_RECOGNITION_Y1",
              "foray_core": {
                "arrangement_refs": ["ARR_SF_OPPORTUNITY", "ARR_SF_QUOTE"],
                "type": "revenue_recognition",
                "description": "Year 1 revenue recognition - ASC 606 compliant",
                "computation_method": "Calculated",
                "formula_id": "sha256:asc606_rev...",
                "inputs": { "total_contract_value": 125000.00, "performance_obligations": 3, "license_ssp": 100000, "support_ssp": 15000, "services_ssp": 10000 },
                "output": 41666.67,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1200-Accounts Receivable", "amount": 125000.00 },
                  "credit": { "account": "2400-Deferred Revenue", "amount": 83333.33 },
                  "credit2": { "account": "4100-License Revenue", "amount": 33333.33 },
                  "credit3": { "account": "4200-Service Revenue", "amount": 8333.34 }
                },
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "salesforce_refs": {
                  "revenue_schedule_id": "0RSxxxxxxx"
                },
                "dependencies": ["ARR_SF_QUOTE"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_CUSTOMER_PAYMENT",
              "foray_core": {
                "accrual_refs": ["ACC_REVENUE_RECOGNITION_Y1"],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "type": "scheduled_payment",
                "description": "Expected Year 1 payment upon contract signing",
                "expected_amount": 125000.00,
                "currency": "USD",
                "expected_date": "2026-01-25",
                "probability_factor": 0.99,
                "assumptions": { "payment_method": "wire", "payment_terms": "due_on_signing" },
                "dependencies": ["ACC_REVENUE_RECOGNITION_Y1"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_CONTRACT_EXECUTION",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY", "ARR_SF_QUOTE"],
                "type": "contract_execution",
                "description": "Contract signed via DocuSign",
                "amount_settled": 0,
                "currency": "USD",
                "settlement_date": "2026-01-20T14:30:00Z",
                "settlement_status": "completed",
                "allocations": [],
                "details": {
                  "contract_id": "800Dn000001ABC1DEF",
                  "docusign_envelope_id": "12345-abcde-67890",
                  "signed_by": "Jane Smith, VP Operations"
                },
                "dependencies": ["ARR_SF_QUOTE"]
              }
            },
            {
              "id": "ACT_INVOICE_GENERATED",
              "foray_core": {
                "anticipation_refs": ["ANT_CUSTOMER_PAYMENT"],
                "accrual_refs": ["ACC_REVENUE_RECOGNITION_Y1"],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "type": "invoice",
                "description": "Invoice generated from Salesforce CPQ",
                "amount_settled": 125000.00,
                "currency": "USD",
                "settlement_date": "2026-01-21T09:00:00Z",
                "settlement_status": "issued",
                "allocations": [],
                "details": {
                  "invoice_id": "a0BDn000001ABC1DEF",
                  "invoice_number": "INV-2026-00089",
                  "due_date": "2026-02-20"
                },
                "salesforce_refs": {
                  "invoice_id": "a0BDn000001ABC1DEF"
                },
                "dependencies": ["ACT_CONTRACT_EXECUTION"]
              }
            },
            {
              "id": "ACT_PAYMENT_RECEIVED",
              "foray_core": {
                "anticipation_refs": ["ANT_CUSTOMER_PAYMENT"],
                "accrual_refs": ["ACC_REVENUE_RECOGNITION_Y1"],
                "arrangement_refs": ["ARR_SF_OPPORTUNITY"],
                "type": "payment_receipt",
                "description": "Wire payment received from Acme Corporation",
                "amount_settled": 125000.00,
                "currency": "USD",
                "settlement_date": "2026-01-22T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "Acme Corporation",
                "allocations": [
                  { "ref": "ANT_CUSTOMER_PAYMENT", "ref_type": "anticipation", "amount": 125000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 125000.00, "actual": 125000.00, "difference": 0.00 },
                "details": {
                  "bank_reference": "WIR-2026012200145",
                  "payment_id": "a1CDn000002ABC1DEF"
                },
                "salesforce_refs": {
                  "payment_id": "a1CDn000002ABC1DEF"
                },
                "dependencies": ["ACT_INVOICE_GENERATED", "ANT_CUSTOMER_PAYMENT"]
              }
            }
          ],
          "merkle_root": "sha256:sfopp123...",
          "blockchain_anchor": { "kaspa_tx_id": "kaspa:qrsf...", "block_height": 2850600, "confirmation_time_ms": 1020, "anchored_at": "2026-01-22T10:00:02Z" },
          "audit_data_anchor": { "audit_data_hash": "sha256:sfaudit...", "audit_profile": "revenue_recognition", "storage_locations": ["s3://foray-audit/2026/Q1/SF_OPP_ACME_ENTERPRISE"] },
          "privacy_metadata": { "formulas_obfuscated": 1, "instance_pools": 3, "attack_complexity": "2^96 operations" }
        }
      },
      
      rmbs: {
        name: "RMBS Securitization",
        description: "Residential Mortgage-Backed Security with loan pooling, tranches, and waterfall",
        data: {
          "transaction_id": "RMBS_2026_Q1_POOL_ABC123",
          "schema_version": "4.1",
          "timestamp": "2026-01-15T09:00:00Z",
          "foray_core": {
            "entity": "SecureCapital Mortgage Trust",
            "entity_hash": "sha256:securecap...",
            "transaction_type": "rmbs_securitization",
            "total_value": 500000000.00,
            "currency": "USD",
            "status": "active",
            "compliance_flags": ["SEC_Reg_AB", "FASB_ASC_860", "Risk_Retention", "Dodd_Frank"]
          },
          "component_hashes": {
            "arrangements": "sha256:rmbs_arr...",
            "accruals": "sha256:rmbs_acc...",
            "anticipations": "sha256:rmbs_ant...",
            "actions": "sha256:rmbs_act..."
          },
          "arrangements": [
            {
              "id": "ARR_MORTGAGE_POOL_ABC123",
              "foray_core": {
                "type": "mortgage_pool",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "originator", "name": "National Home Lenders", "jurisdiction": "US" },
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" },
                  { "role": "trustee", "name": "Bank of New York Mellon", "jurisdiction": "US-NY" },
                  { "role": "servicer", "name": "LoanServ Inc", "jurisdiction": "US" }
                ],
                "description": "RMBS Pool ABC123 - Prime Conforming Mortgages",
                "total_value": 500000000.00,
                "currency": "USD",
                "terms": {
                  "pool_factor": 1.0,
                  "weighted_avg_coupon": 0.0625,
                  "weighted_avg_maturity_months": 342,
                  "weighted_avg_ltv": 0.72,
                  "weighted_avg_fico": 745,
                  "loan_count": 1847,
                  "geographic_concentration": { "CA": 0.28, "TX": 0.15, "FL": 0.12, "NY": 0.10, "other": 0.35 }
                },
                "legal_documentation": ["Pooling_Service_Agreement", "Trust_Indenture", "Prospectus_Supplement"],
                "dependencies": []
              }
            },
            {
              "id": "ARR_TRANCHE_A1",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" }
                ],
                "description": "Class A-1 Senior Tranche - AAA Rated",
                "total_value": 350000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "A-1",
                  "seniority": "senior",
                  "rating": { "moodys": "Aaa", "sp": "AAA", "fitch": "AAA" },
                  "coupon_rate": 0.045,
                  "payment_frequency": "monthly",
                  "credit_enhancement": 0.30,
                  "subordination_level": 0.30
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123"]
              }
            },
            {
              "id": "ARR_TRANCHE_M1",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" }
                ],
                "description": "Class M-1 Mezzanine Tranche - AA Rated",
                "total_value": 75000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "M-1",
                  "seniority": "mezzanine",
                  "rating": { "moodys": "Aa2", "sp": "AA", "fitch": "AA" },
                  "coupon_rate": 0.055,
                  "payment_frequency": "monthly",
                  "credit_enhancement": 0.15,
                  "subordination_level": 0.15
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1"]
              }
            },
            {
              "id": "ARR_TRANCHE_B1",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" }
                ],
                "description": "Class B-1 Subordinate Tranche - BBB Rated",
                "total_value": 50000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "B-1",
                  "seniority": "subordinate",
                  "rating": { "moodys": "Baa2", "sp": "BBB", "fitch": "BBB" },
                  "coupon_rate": 0.075,
                  "payment_frequency": "monthly",
                  "credit_enhancement": 0.05,
                  "subordination_level": 0.05
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1", "ARR_TRANCHE_M1"]
              }
            },
            {
              "id": "ARR_TRANCHE_R",
              "foray_core": {
                "type": "rmbs_tranche",
                "effective_date": "2026-01-15T00:00:00Z",
                "parties": [
                  { "role": "issuer", "name": "SecureCapital Mortgage Trust", "jurisdiction": "US-DE" },
                  { "role": "risk_retention_holder", "name": "National Home Lenders", "jurisdiction": "US" }
                ],
                "description": "Class R Residual/First-Loss - Unrated (Risk Retention)",
                "total_value": 25000000.00,
                "currency": "USD",
                "terms": {
                  "tranche_class": "R",
                  "seniority": "residual",
                  "rating": { "moodys": "NR", "sp": "NR", "fitch": "NR" },
                  "risk_retention_compliant": true,
                  "retention_percentage": 0.05,
                  "excess_spread_entitled": true
                },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1", "ARR_TRANCHE_M1", "ARR_TRANCHE_B1"]
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_POOL_INTEREST_JAN",
              "foray_core": {
                "arrangement_refs": ["ARR_MORTGAGE_POOL_ABC123"],
                "type": "interest_collection",
                "description": "January pool interest collections",
                "computation_method": "Calculated",
                "formula_id": "sha256:pool_interest_calc...",
                "inputs": {
                  "pool_balance": 500000000.00,
                  "weighted_avg_coupon": 0.0625,
                  "days_in_period": 31,
                  "prepayment_rate_cpr": 0.08
                },
                "output": 2604166.67,
                "currency": "USD",
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123"]
              }
            },
            {
              "id": "ACC_POOL_PRINCIPAL_JAN",
              "foray_core": {
                "arrangement_refs": ["ARR_MORTGAGE_POOL_ABC123"],
                "type": "principal_collection",
                "description": "January scheduled principal + prepayments",
                "computation_method": "Calculated",
                "formula_id": "sha256:principal_calc...",
                "inputs": {
                  "scheduled_principal": 1250000.00,
                  "prepayments": 3333333.33,
                  "defaults": 125000.00,
                  "recoveries": 75000.00
                },
                "output": 4533333.33,
                "currency": "USD",
                "fiscal_period": { "year": 2026, "quarter": 1, "month": 1 },
                "dependencies": ["ARR_MORTGAGE_POOL_ABC123"]
              }
            },
            {
              "id": "ACC_TRANCHE_A1_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_TRANCHE_A1"],
                "type": "tranche_interest_due",
                "description": "Class A-1 January interest due",
                "computation_method": "Calculated",
                "formula_id": "sha256:tranche_interest...",
                "inputs": { "tranche_balance": 350000000.00, "coupon_rate": 0.045, "days": 31 },
                "output": 1312500.00,
                "currency": "USD",
                "waterfall_priority": 1,
                "dependencies": ["ACC_POOL_INTEREST_JAN"]
              }
            },
            {
              "id": "ACC_TRANCHE_M1_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_TRANCHE_M1"],
                "type": "tranche_interest_due",
                "description": "Class M-1 January interest due",
                "computation_method": "Calculated",
                "formula_id": "sha256:tranche_interest...",
                "inputs": { "tranche_balance": 75000000.00, "coupon_rate": 0.055, "days": 31 },
                "output": 343750.00,
                "currency": "USD",
                "waterfall_priority": 2,
                "dependencies": ["ACC_POOL_INTEREST_JAN", "ACC_TRANCHE_A1_INTEREST"]
              }
            },
            {
              "id": "ACC_TRANCHE_B1_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_TRANCHE_B1"],
                "type": "tranche_interest_due",
                "description": "Class B-1 January interest due",
                "computation_method": "Calculated",
                "formula_id": "sha256:tranche_interest...",
                "inputs": { "tranche_balance": 50000000.00, "coupon_rate": 0.075, "days": 31 },
                "output": 312500.00,
                "currency": "USD",
                "waterfall_priority": 3,
                "dependencies": ["ACC_POOL_INTEREST_JAN", "ACC_TRANCHE_M1_INTEREST"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_WATERFALL_DISTRIBUTION_JAN",
              "foray_core": {
                "accrual_refs": ["ACC_POOL_INTEREST_JAN", "ACC_POOL_PRINCIPAL_JAN", "ACC_TRANCHE_A1_INTEREST", "ACC_TRANCHE_M1_INTEREST", "ACC_TRANCHE_B1_INTEREST"],
                "arrangement_refs": ["ARR_MORTGAGE_POOL_ABC123", "ARR_TRANCHE_A1", "ARR_TRANCHE_M1", "ARR_TRANCHE_B1", "ARR_TRANCHE_R"],
                "type": "waterfall_distribution",
                "description": "January payment date waterfall",
                "expected_amount": 7137500.00,
                "currency": "USD",
                "expected_date": "2026-01-25",
                "probability_factor": 0.99,
                "waterfall_sequence": [
                  { "priority": 1, "payee": "Trustee_Fees", "amount": 41666.67 },
                  { "priority": 2, "payee": "Servicer_Fees", "amount": 104166.67 },
                  { "priority": 3, "payee": "Class_A1_Interest", "amount": 1312500.00 },
                  { "priority": 4, "payee": "Class_A1_Principal", "amount": 4533333.33 },
                  { "priority": 5, "payee": "Class_M1_Interest", "amount": 343750.00 },
                  { "priority": 6, "payee": "Class_B1_Interest", "amount": 312500.00 },
                  { "priority": 7, "payee": "Class_R_Residual", "amount": 489583.33 }
                ],
                "dependencies": ["ACC_POOL_INTEREST_JAN", "ACC_POOL_PRINCIPAL_JAN"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_WATERFALL_PAYMENT_JAN",
              "foray_core": {
                "anticipation_refs": ["ANT_WATERFALL_DISTRIBUTION_JAN"],
                "accrual_refs": ["ACC_TRANCHE_A1_INTEREST", "ACC_TRANCHE_M1_INTEREST", "ACC_TRANCHE_B1_INTEREST"],
                "arrangement_refs": ["ARR_TRANCHE_A1", "ARR_TRANCHE_M1", "ARR_TRANCHE_B1", "ARR_TRANCHE_R"],
                "type": "waterfall_settlement",
                "description": "January payment date - all tranches paid per waterfall",
                "amount_settled": 7137500.00,
                "currency": "USD",
                "settlement_date": "2026-01-25T14:00:00Z",
                "settlement_status": "completed",
                "payment_method": "wire_dtc",
                "allocations": [
                  { "ref": "ARR_MORTGAGE_POOL_ABC123", "ref_type": "arrangement", "amount": 145833.34, "currency": "USD", "allocation_type": "full", "breakdown": { "trustee_fees": 41666.67, "servicer_fees": 104166.67 } },
                  { "ref": "ARR_TRANCHE_A1", "ref_type": "arrangement", "amount": 5845833.33, "currency": "USD", "allocation_type": "full", "breakdown": { "interest": 1312500.00, "principal": 4533333.33 } },
                  { "ref": "ARR_TRANCHE_M1", "ref_type": "arrangement", "amount": 343750.00, "currency": "USD", "allocation_type": "full", "breakdown": { "interest": 343750.00, "principal": 0 } },
                  { "ref": "ARR_TRANCHE_B1", "ref_type": "arrangement", "amount": 312500.00, "currency": "USD", "allocation_type": "full", "breakdown": { "interest": 312500.00, "principal": 0 } },
                  { "ref": "ARR_TRANCHE_R", "ref_type": "arrangement", "amount": 489583.33, "currency": "USD", "allocation_type": "full", "breakdown": { "excess_spread": 489583.33 } }
                ],
                "variance": { "expected": 7137500.00, "actual": 7137500.00, "difference": 0.00 },
                "pool_metrics_post_payment": {
                  "new_pool_balance": 495466666.67,
                  "new_pool_factor": 0.9909,
                  "cumulative_losses": 50000.00,
                  "delinquency_30_plus": 0.012,
                  "delinquency_60_plus": 0.004
                },
                "dependencies": ["ANT_WATERFALL_DISTRIBUTION_JAN"]
              }
            }
          ],
          "merkle_root": "sha256:rmbs_abc123...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:rmbs_audit...", "audit_profile": "structured_finance", "storage_locations": ["s3://foray-audit/2026/Q1/RMBS_POOL_ABC123"] },
          "privacy_metadata": { "formulas_obfuscated": 5, "instance_pools": 12, "attack_complexity": "2^128 operations" }
        }
      },
      
      fxSpot: {
        name: "FX Spot Trade (USD/JPY)",
        description: "Foreign exchange spot transaction with T+2 settlement",
        data: {
          "transaction_id": "FX_SPOT_2026_USDJPY_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-23T14:30:00Z",
          "foray_core": {
            "entity": "GlobalTrade Capital LLC",
            "entity_hash": "sha256:globaltrade...",
            "transaction_type": "fx_spot",
            "total_value": 10000000.00,
            "currency": "USD",
            "status": "settled",
            "compliance_flags": ["Dodd_Frank", "EMIR", "MiFID_II", "CFTC"]
          },
          "component_hashes": {
            "arrangements": "sha256:fx_arr...",
            "accruals": "sha256:fx_acc...",
            "anticipations": "sha256:fx_ant...",
            "actions": "sha256:fx_act..."
          },
          "arrangements": [
            {
              "id": "ARR_FX_SPOT_USDJPY",
              "foray_core": {
                "type": "fx_spot_contract",
                "effective_date": "2026-01-23T14:30:00Z",
                "parties": [
                  { "role": "buyer_usd", "name": "GlobalTrade Capital LLC", "jurisdiction": "US-NY", "lei": "549300ABCDEFGHIJ1234" },
                  { "role": "seller_usd", "name": "Tokyo Metropolitan Bank", "jurisdiction": "JP", "lei": "353800XYZABCDEFG5678" }
                ],
                "description": "USD/JPY Spot - Buy 10M USD vs JPY",
                "total_value": 10000000.00,
                "currency": "USD",
                "terms": {
                  "currency_pair": "USD/JPY",
                  "direction": "buy_usd_sell_jpy",
                  "notional_usd": 10000000.00,
                  "notional_jpy": 1485000000,
                  "spot_rate": 148.50,
                  "trade_date": "2026-01-23",
                  "value_date": "2026-01-27",
                  "settlement_type": "T+2"
                },
                "execution_details": {
                  "execution_venue": "Reuters_Matching",
                  "execution_timestamp": "2026-01-23T14:30:22.456Z",
                  "dealer_spread": 0.02,
                  "mid_rate": 148.49,
                  "benchmark_fixing": "WMR_4PM_London"
                },
                "legal_documentation": ["ISDA_Master_Agreement", "FX_Definitions_2021"],
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_FX_USD_RECEIVABLE",
              "foray_core": {
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_receivable",
                "description": "USD leg receivable - awaiting T+2 settlement",
                "computation_method": "FixedAmount",
                "output": 10000000.00,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "1150-FX Receivables USD", "amount": 10000000.00 },
                  "credit": { "account": "2150-FX Payables JPY", "amount": 10000000.00, "fx_rate": 148.50 }
                },
                "mark_to_market": {
                  "mtm_rate": 148.65,
                  "unrealized_pnl_usd": 10084.18,
                  "mtm_timestamp": "2026-01-23T21:00:00Z"
                },
                "dependencies": ["ARR_FX_SPOT_USDJPY"]
              }
            },
            {
              "id": "ACC_FX_JPY_PAYABLE",
              "foray_core": {
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_payable",
                "description": "JPY leg payable - awaiting T+2 settlement",
                "computation_method": "FixedAmount",
                "output": 1485000000,
                "currency": "JPY",
                "accounting_entry": {
                  "debit": { "account": "5500-FX Trading Expense", "amount": 1485000000, "currency": "JPY" },
                  "credit": { "account": "2155-FX Payables JPY", "amount": 1485000000, "currency": "JPY" }
                },
                "nostro_account": {
                  "bank": "Tokyo Metropolitan Bank",
                  "account_number": "JPY-NOSTRO-001",
                  "swift": "TMBJPJTT"
                },
                "dependencies": ["ARR_FX_SPOT_USDJPY"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_FX_SETTLEMENT",
              "foray_core": {
                "accrual_refs": ["ACC_FX_USD_RECEIVABLE", "ACC_FX_JPY_PAYABLE"],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_settlement",
                "description": "T+2 settlement of USD/JPY spot",
                "expected_amount": 10000000.00,
                "currency": "USD",
                "expected_date": "2026-01-27",
                "probability_factor": 0.999,
                "settlement_instructions": {
                  "usd_receiving_bank": "JPMorgan Chase",
                  "usd_account": "USD-NOSTRO-001",
                  "usd_swift": "CHASUS33",
                  "jpy_paying_bank": "Tokyo Metropolitan Bank",
                  "jpy_account": "JPY-NOSTRO-001",
                  "jpy_swift": "TMBJPJTT"
                },
                "dependencies": ["ACC_FX_USD_RECEIVABLE", "ACC_FX_JPY_PAYABLE"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_FX_TRADE_EXECUTION",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_trade_execution",
                "description": "Trade executed on Reuters Matching",
                "amount_settled": 10000000.00,
                "currency": "USD",
                "settlement_date": "2026-01-23T14:30:22Z",
                "settlement_status": "executed",
                "execution_details": {
                  "deal_id": "RTR-2026012314302245",
                  "counterparty_deal_id": "TMB-FX-20260123-0892",
                  "execution_price": 148.50,
                  "slippage_bps": 0.5
                },
                "dependencies": ["ARR_FX_SPOT_USDJPY"]
              }
            },
            {
              "id": "ACT_FX_SETTLEMENT_USD",
              "foray_core": {
                "anticipation_refs": ["ANT_FX_SETTLEMENT"],
                "accrual_refs": ["ACC_FX_USD_RECEIVABLE"],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_settlement_leg",
                "description": "USD leg settled via CHIPS",
                "amount_settled": 10000000.00,
                "currency": "USD",
                "settlement_date": "2026-01-27T16:00:00Z",
                "settlement_status": "completed",
                "payment_method": "chips",
                "counterparty": "Tokyo Metropolitan Bank",
                "allocations": [
                  { "ref": "ACC_FX_USD_RECEIVABLE", "ref_type": "accrual", "amount": 10000000.00, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "settlement_details": {
                  "chips_uid": "20260127CHPS1234567",
                  "receiving_bank_confirmation": "JPMC-CONF-789012",
                  "settlement_time_utc": "2026-01-27T16:00:00Z"
                },
                "dependencies": ["ANT_FX_SETTLEMENT"]
              }
            },
            {
              "id": "ACT_FX_SETTLEMENT_JPY",
              "foray_core": {
                "anticipation_refs": ["ANT_FX_SETTLEMENT"],
                "accrual_refs": ["ACC_FX_JPY_PAYABLE"],
                "arrangement_refs": ["ARR_FX_SPOT_USDJPY"],
                "type": "fx_settlement_leg",
                "description": "JPY leg settled via BOJ-NET",
                "amount_settled": 1485000000,
                "currency": "JPY",
                "settlement_date": "2026-01-27T09:00:00Z",
                "settlement_status": "completed",
                "payment_method": "boj_net",
                "counterparty": "Tokyo Metropolitan Bank",
                "allocations": [
                  { "ref": "ACC_FX_JPY_PAYABLE", "ref_type": "accrual", "amount": 1485000000, "currency": "JPY", "allocation_type": "full", "remaining_balance": 0 }
                ],
                "settlement_details": {
                  "boj_reference": "BOJNET-20260127-JP456789",
                  "paying_bank_confirmation": "TMB-PAY-CONF-2345",
                  "settlement_time_jst": "2026-01-27T18:00:00+09:00"
                },
                "dependencies": ["ANT_FX_SETTLEMENT"]
              }
            }
          ],
          "merkle_root": "sha256:fx_usdjpy_001...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:fx_audit...", "audit_profile": "trading_compliance", "storage_locations": ["s3://foray-audit/2026/Q1/FX_SPOT_USDJPY_001"] },
          "privacy_metadata": { "formulas_obfuscated": 2, "instance_pools": 6, "attack_complexity": "2^96 operations" }
        }
      },
      
      overnightRepo: {
        name: "Overnight Repo (Fixed Rate)",
        description: "Secured overnight financing - Treasury collateral with fixed interest",
        data: {
          "transaction_id": "REPO_2026_ON_TREASURY_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-24T15:00:00Z",
          "foray_core": {
            "entity": "Pinnacle Securities LLC",
            "entity_hash": "sha256:pinnacle...",
            "transaction_type": "overnight_repo",
            "total_value": 100000000.00,
            "currency": "USD",
            "status": "settled",
            "compliance_flags": ["SEC_15c3", "FINRA_4210", "Fed_Reg_T", "SOFR_Compliant"]
          },
          "component_hashes": {
            "arrangements": "sha256:repo_arr...",
            "accruals": "sha256:repo_acc...",
            "anticipations": "sha256:repo_ant...",
            "actions": "sha256:repo_act..."
          },
          "arrangements": [
            {
              "id": "ARR_REPO_OVERNIGHT",
              "foray_core": {
                "type": "repurchase_agreement",
                "effective_date": "2026-01-24T00:00:00Z",
                "parties": [
                  { "role": "cash_borrower", "name": "Pinnacle Securities LLC", "jurisdiction": "US-NY", "lei": "549300PINNACLE12345" },
                  { "role": "cash_lender", "name": "Federal Reserve Bank of New York", "jurisdiction": "US-NY", "lei": "254900FEDRESNY67890" }
                ],
                "description": "Overnight RP - US Treasury Collateral",
                "total_value": 100000000.00,
                "currency": "USD",
                "terms": {
                  "repo_type": "overnight",
                  "start_date": "2026-01-24",
                  "end_date": "2026-01-27",
                  "term_days": 3,
                  "repo_rate": 0.0530,
                  "repo_rate_basis": "ACT/360",
                  "haircut_percentage": 0.02,
                  "margin_call_threshold": 0.01
                },
                "collateral": {
                  "type": "US_Treasury",
                  "cusip": "912810SZ3",
                  "isin": "US912810SZ35",
                  "description": "US Treasury 4.25% 11/15/2034",
                  "face_value": 102000000.00,
                  "market_value": 102040000.00,
                  "accrued_interest": 850000.00,
                  "dirty_price": 100.87,
                  "collateral_value_after_haircut": 100000000.00
                },
                "legal_documentation": ["GMRA_2011", "MRA_Annex", "Tri_Party_Agreement"],
                "tri_party_agent": {
                  "name": "Bank of New York Mellon",
                  "account_id": "TPA-PINN-001"
                },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_REPO_INTEREST",
              "foray_core": {
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_interest",
                "description": "Overnight repo interest accrual (3 days over weekend)",
                "computation_method": "Calculated",
                "formula_id": "sha256:repo_interest_calc...",
                "inputs": {
                  "principal": 100000000.00,
                  "repo_rate": 0.0530,
                  "day_count_basis": "ACT/360",
                  "days": 3
                },
                "output": 44166.67,
                "currency": "USD",
                "accounting_entry": {
                  "debit": { "account": "7200-Interest Expense - Repo", "amount": 44166.67 },
                  "credit": { "account": "2300-Repo Interest Payable", "amount": 44166.67 }
                },
                "rate_benchmark": {
                  "reference_rate": "SOFR",
                  "sofr_rate": 0.0528,
                  "spread_to_sofr": 0.0002
                },
                "dependencies": ["ARR_REPO_OVERNIGHT"]
              }
            },
            {
              "id": "ACC_COLLATERAL_VALUATION",
              "foray_core": {
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "collateral_mark",
                "description": "End of day collateral valuation",
                "computation_method": "Calculated",
                "formula_id": "sha256:collateral_mtm...",
                "inputs": {
                  "cusip": "912810SZ3",
                  "face_value": 102000000.00,
                  "price_source": "Bloomberg_BGN",
                  "closing_price": 100.92,
                  "accrued_interest_per_100": 0.85
                },
                "output": 103806600.00,
                "currency": "USD",
                "margin_status": {
                  "required_collateral": 102000000.00,
                  "actual_collateral": 103806600.00,
                  "excess_margin": 1806600.00,
                  "margin_call_required": false
                },
                "dependencies": ["ARR_REPO_OVERNIGHT"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_REPO_MATURITY",
              "foray_core": {
                "accrual_refs": ["ACC_REPO_INTEREST"],
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_maturity",
                "description": "Repo maturity - return cash + interest, receive collateral",
                "expected_amount": 100044166.67,
                "currency": "USD",
                "expected_date": "2026-01-27",
                "probability_factor": 0.9999,
                "settlement_obligations": {
                  "cash_to_return": 100044166.67,
                  "collateral_to_receive": 102000000.00,
                  "collateral_cusip": "912810SZ3"
                },
                "rollover_intent": "mature_no_roll",
                "dependencies": ["ACC_REPO_INTEREST"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_REPO_OPENING",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": [],
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_opening_leg",
                "description": "Opening leg - deliver collateral, receive cash",
                "amount_settled": 100000000.00,
                "currency": "USD",
                "settlement_date": "2026-01-24T15:00:00Z",
                "settlement_status": "completed",
                "payment_method": "fedwire",
                "counterparty": "Federal Reserve Bank of New York",
                "settlement_details": {
                  "cash_settlement": {
                    "fedwire_reference": "FW20260124PINN0001",
                    "receiving_account": "Pinnacle Securities LLC",
                    "amount": 100000000.00
                  },
                  "collateral_settlement": {
                    "dtc_reference": "DTC20260124COL0001",
                    "delivering_participant": "0901",
                    "receiving_participant": "0060",
                    "cusip": "912810SZ3",
                    "face_value": 102000000.00
                  }
                },
                "dependencies": ["ARR_REPO_OVERNIGHT"]
              }
            },
            {
              "id": "ACT_REPO_CLOSING",
              "foray_core": {
                "anticipation_refs": ["ANT_REPO_MATURITY"],
                "accrual_refs": ["ACC_REPO_INTEREST"],
                "arrangement_refs": ["ARR_REPO_OVERNIGHT"],
                "type": "repo_closing_leg",
                "description": "Closing leg - return cash + interest, receive collateral back",
                "amount_settled": 100044166.67,
                "currency": "USD",
                "settlement_date": "2026-01-27T10:00:00Z",
                "settlement_status": "completed",
                "payment_method": "fedwire",
                "counterparty": "Federal Reserve Bank of New York",
                "allocations": [
                  { "ref": "ANT_REPO_MATURITY", "ref_type": "anticipation", "amount": 100044166.67, "currency": "USD", "allocation_type": "full", "remaining_balance": 0.00 }
                ],
                "variance": { "expected": 100044166.67, "actual": 100044166.67, "difference": 0.00 },
                "settlement_details": {
                  "cash_settlement": {
                    "fedwire_reference": "FW20260127PINN0002",
                    "paying_account": "Pinnacle Securities LLC",
                    "amount": 100044166.67,
                    "breakdown": { "principal": 100000000.00, "interest": 44166.67 }
                  },
                  "collateral_settlement": {
                    "dtc_reference": "DTC20260127COL0002",
                    "delivering_participant": "0060",
                    "receiving_participant": "0901",
                    "cusip": "912810SZ3",
                    "face_value": 102000000.00
                  }
                },
                "dependencies": ["ANT_REPO_MATURITY"]
              }
            }
          ],
          "merkle_root": "sha256:repo_on_001...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:repo_audit...", "audit_profile": "securities_financing", "storage_locations": ["s3://foray-audit/2026/Q1/REPO_ON_TREASURY_001"] },
          "privacy_metadata": { "formulas_obfuscated": 2, "instance_pools": 5, "attack_complexity": "2^96 operations" }
        }
      },

      manukaHoneyProvenance: {
        name: "Manuka Honey Provenance",
        description: "UMF-certified New Zealand Manuka honey with attestation chain",
        data: {
          "transaction_id": "PROV_2026_Q1_MANUKA_HONEY_BATCH_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-15T09:00:00Z",
          "foray_core": {
            "entity": "Waikato Apiaries Ltd",
            "entity_hash": "sha256:wal_2026_abc123...",
            "transaction_type": "product_provenance",
            "total_value": 185000.00,
            "currency": "NZD",
            "status": "completed",
            "compliance_flags": ["MPI_Export_Certified", "UMF_Licensed", "ISO_22000"]
          },
          "component_hashes": {
            "arrangements": "sha256:arr_manuka_a1b2c3...",
            "accruals": "sha256:acc_manuka_d4e5f6...",
            "anticipations": "sha256:ant_manuka_g7h8i9...",
            "actions": "sha256:act_manuka_j0k1l2...",
            "attestations": "sha256:att_manuka_m3n4o5..."
          },
          "arrangements": [
            {
              "id": "ARR_UMF_LICENSE_2026",
              "foray_core": {
                "type": "origin_certification",
                "effective_date": "2026-01-01T00:00:00Z",
                "parties": [
                  { "role": "producer", "name": "Waikato Apiaries Ltd", "jurisdiction": "NZ" },
                  { "role": "certifier", "name": "UMF Honey Association", "jurisdiction": "NZ" },
                  { "role": "laboratory", "name": "Analytica Laboratories", "jurisdiction": "NZ" }
                ],
                "description": "UMF certification license for authentic New Zealand Manuka Honey",
                "total_value": 185000.00,
                "currency": "NZD",
                "terms": { "certification_type": "UMF_Licensed_Producer", "license_number": "UMF-2026-0847", "valid_until": "2026-12-31", "annual_audit_required": true },
                "dependencies": []
              }
            },
            {
              "id": "ARR_BATCH_DEFINITION_2026_001",
              "foray_core": {
                "type": "production_batch",
                "effective_date": "2026-01-10T00:00:00Z",
                "parties": [
                  { "role": "producer", "name": "Waikato Apiaries Ltd", "jurisdiction": "NZ" }
                ],
                "description": "Production batch MH-2026-001 - 500kg UMF 15+ Manuka Honey",
                "total_value": 185000.00,
                "currency": "NZD",
                "terms": { "batch_id": "MH-2026-001", "weight_kg": 500, "jar_count": 1000, "jar_size_g": 500, "harvest_date": "2025-12-20", "apiary_region": "Waikato, North Island" },
                "dependencies": ["ARR_UMF_LICENSE_2026"]
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_LABORATORY_ANALYSIS_001",
              "foray_core": {
                "arrangement_refs": ["ARR_BATCH_DEFINITION_2026_001", "ARR_UMF_LICENSE_2026"],
                "type": "product_analysis",
                "description": "Laboratory analysis results for batch MH-2026-001",
                "computation_method": "Valuation",
                "formula_id": "sha256:umf_analysis_protocol_v2...",
                "inputs": { "sample_id": "SAMPLE-MH-2026-001-A", "analysis_date": "2026-01-12", "methodology": "UMF_Grading_Standard_v4" },
                "output": 185000.00,
                "currency": "NZD",
                "analysis_results": { "mgo_mg_kg": 514, "leptosperin_mg_kg": 185, "umf_rating": 15, "umf_grade": "UMF 15+", "dna_verified": true, "classification": "Authentic Monofloral Manuka", "grade_confirmed": true },
                "dependencies": ["ARR_BATCH_DEFINITION_2026_001"]
              }
            },
            {
              "id": "ACC_BATCH_VALUATION_001",
              "foray_core": {
                "arrangement_refs": ["ARR_BATCH_DEFINITION_2026_001"],
                "type": "inventory_valuation",
                "description": "Batch valuation at export wholesale price",
                "computation_method": "Calculated",
                "formula_id": "sha256:valuation_weight_x_grade_price...",
                "inputs": { "weight_kg": 500, "umf_grade": "UMF 15+", "price_per_kg_nzd": 370.00 },
                "output": 185000.00,
                "currency": "NZD",
                "dependencies": ["ARR_BATCH_DEFINITION_2026_001"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_EXPORT_DISTRIBUTION_2026_001",
              "foray_core": {
                "accrual_refs": ["ACC_BATCH_VALUATION_001"],
                "arrangement_refs": ["ARR_BATCH_DEFINITION_2026_001"],
                "type": "scheduled_distribution",
                "description": "Expected export distribution to international partners",
                "expected_amount": 185000.00,
                "currency": "NZD",
                "expected_date": "2026-02-15",
                "probability_factor": 0.95,
                "distribution_plan": { "export_markets": ["China", "UK", "USA", "Japan"] },
                "dependencies": ["ACC_BATCH_VALUATION_001"]
              }
            },
            {
              "id": "ANT_SHELF_LIFE_WINDOW_001",
              "foray_core": {
                "accrual_refs": ["ACC_LABORATORY_ANALYSIS_001"],
                "arrangement_refs": ["ARR_BATCH_DEFINITION_2026_001"],
                "type": "quality_validity_window",
                "description": "Expected shelf life based on analysis results",
                "expected_amount": 0,
                "currency": "NZD",
                "expected_date": "2031-01-15",
                "probability_factor": 0.95,
                "quality_parameters": { "best_before_date": "2031-01-15", "optimal_storage_temp_c": "below 25", "note": "Honey does not spoil; UMF activity may decrease over time" },
                "dependencies": ["ACC_LABORATORY_ANALYSIS_001"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_JARRING_COMPLETE_001",
              "foray_core": {
                "anticipation_refs": ["ANT_EXPORT_DISTRIBUTION_2026_001"],
                "accrual_refs": ["ACC_LABORATORY_ANALYSIS_001", "ACC_BATCH_VALUATION_001"],
                "arrangement_refs": ["ARR_BATCH_DEFINITION_2026_001"],
                "type": "production_completion",
                "description": "Jarring completed for batch MH-2026-001",
                "amount_settled": 185000.00,
                "currency": "NZD",
                "settlement_date": "2026-01-15T09:00:00Z",
                "settlement_status": "completed",
                "payment_method": "other",
                "counterparty": "Internal",
                "production_details": { "jars_produced": 1000, "jars_passed_qc": 998, "jars_rejected": 2, "tamper_seal_applied": true, "umf_label_applied": true },
                "dependencies": ["ANT_EXPORT_DISTRIBUTION_2026_001"]
              }
            },
            {
              "id": "ACT_UMF_CERTIFICATION_ISSUED_001",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": ["ACC_LABORATORY_ANALYSIS_001"],
                "arrangement_refs": ["ARR_UMF_LICENSE_2026", "ARR_BATCH_DEFINITION_2026_001"],
                "type": "certification_issuance",
                "description": "UMF certificate issued for batch MH-2026-001",
                "amount_settled": 0,
                "currency": "NZD",
                "settlement_date": "2026-01-14T14:00:00Z",
                "settlement_status": "completed",
                "payment_method": "other",
                "counterparty": "UMF Honey Association",
                "certificate_details": { "certificate_number": "UMF-BATCH-2026-00847", "issued_by": "UMF Honey Association", "umf_grade_certified": "UMF 15+", "qr_verification_url": "https://umf.org.nz/verify/UMF-BATCH-2026-00847" },
                "dependencies": ["ACC_LABORATORY_ANALYSIS_001"]
              }
            }
          ],
          "attestations": [
            {
              "id": "ATT_LAB_ANALYSIS_001",
              "foray_core": {
                "attestor": "Analytica Laboratories",
                "attestor_hash": "sha256:analytica_nz_2026...",
                "attestor_type": "laboratory",
                "attestor_credentials": ["IANZ_Accredited", "MPI_Recognized", "ISO_17025"],
                "subject_refs": ["ACC_LABORATORY_ANALYSIS_001"],
                "attestation_type": "analysis",
                "attestation_date": "2026-01-12T16:30:00Z",
                "validity_period": { "start": "2026-01-12", "end": "2027-01-12" },
                "outcome": "certified",
                "evidence_hash": "sha256:lab_report_mh2026001...",
                "evidence_location": "off-chain",
                "analysis_summary": { "mgo_result_mg_kg": 514, "leptosperin_result_mg_kg": 185, "dna_verified": true, "methodology": "UMF_Grading_Standard_v4" },
                "dependencies": []
              }
            },
            {
              "id": "ATT_UMF_CERTIFICATION_001",
              "foray_core": {
                "attestor": "UMF Honey Association",
                "attestor_hash": "sha256:umf_assoc_nz_2026...",
                "attestor_type": "certification_body",
                "attestor_credentials": ["NZ_Govt_Recognized", "Trademark_Owner_UMF", "MPI_Partner"],
                "subject_refs": ["ARR_UMF_LICENSE_2026", "ARR_BATCH_DEFINITION_2026_001", "ATT_LAB_ANALYSIS_001"],
                "attestation_type": "certification",
                "attestation_date": "2026-01-14T14:00:00Z",
                "validity_period": { "start": "2026-01-14", "end": "2026-12-31" },
                "outcome": "certified",
                "evidence_hash": "sha256:umf_certificate_mh2026001...",
                "evidence_location": "off-chain",
                "certificate_details": { "certificate_number": "UMF-BATCH-2026-00847", "umf_grade": "UMF 15+", "qr_verification_url": "https://umf.org.nz/verify/UMF-BATCH-2026-00847" },
                "dependencies": ["ATT_LAB_ANALYSIS_001"]
              }
            },
            {
              "id": "ATT_MPI_EXPORT_001",
              "foray_core": {
                "attestor": "Ministry for Primary Industries",
                "attestor_hash": "sha256:mpi_nz_govt_2026...",
                "attestor_type": "regulator",
                "attestor_credentials": ["NZ_Government_Authority", "Food_Safety_Regulator", "Export_Certification_Authority"],
                "subject_refs": ["ARR_BATCH_DEFINITION_2026_001", "ATT_UMF_CERTIFICATION_001"],
                "attestation_type": "approval",
                "attestation_date": "2026-01-15T08:00:00Z",
                "validity_period": { "start": "2026-01-15", "end": "2026-07-15" },
                "outcome": "approved",
                "evidence_hash": "sha256:mpi_export_cert_mh2026001...",
                "evidence_location": "off-chain",
                "export_details": { "export_certificate_number": "MPI-EXP-2026-NZ-00847", "approved_markets": ["China", "UK", "USA", "Japan"], "health_certificate_included": true },
                "dependencies": ["ATT_UMF_CERTIFICATION_001"]
              }
            }
          ],
          "merkle_root": "sha256:manuka_batch_001_merkle_root...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:manuka_audit_data...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/PROV_2026_Q1_MANUKA_HONEY_BATCH_001"] },
          "privacy_metadata": { "formulas_obfuscated": 2, "instance_pools": 3, "attack_complexity": "2^96 operations" }
        }
      },

      luxuryWatchAuth: {
        name: "Luxury Watch Authentication",
        description: "Product authentication with inspection results",
        data: {
          "transaction_id": "PROV_2026_Q1_WATCH_AUTH_001",
          "schema_version": "4.1",
          "timestamp": "2026-01-20T11:30:00Z",
          "foray_core": {
            "entity": "Authorized Watch Dealer AG",
            "entity_hash": "sha256:awd_2026_xyz789...",
            "transaction_type": "product_authentication",
            "total_value": 29500.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": ["Swiss_Made", "COSC_Certified", "Brand_Authorized"]
          },
          "component_hashes": {
            "arrangements": "sha256:arr_watch_a1b2c3...",
            "accruals": "sha256:acc_watch_d4e5f6...",
            "anticipations": "sha256:ant_watch_g7h8i9...",
            "actions": "sha256:act_watch_j0k1l2..."
          },
          "arrangements": [
            {
              "id": "ARR_MANUFACTURER_CERT_001",
              "foray_core": {
                "type": "product_certification",
                "effective_date": "2025-09-15T00:00:00Z",
                "parties": [
                  { "role": "manufacturer", "name": "Rolex SA", "jurisdiction": "CH" },
                  { "role": "certifier", "name": "COSC", "jurisdiction": "CH" }
                ],
                "description": "Manufacturer certification for Cosmograph Daytona Ref. 126500LN",
                "total_value": 29500.00,
                "currency": "USD",
                "terms": { "model": "Cosmograph Daytona", "reference": "126500LN", "movement_caliber": "4131", "case_material": "Oystersteel" },
                "dependencies": []
              }
            },
            {
              "id": "ARR_DEALER_AUTHORIZATION_001",
              "foray_core": {
                "type": "distribution_agreement",
                "effective_date": "2024-01-01T00:00:00Z",
                "parties": [
                  { "role": "brand", "name": "Rolex SA", "jurisdiction": "CH" },
                  { "role": "dealer", "name": "Authorized Watch Dealer AG", "jurisdiction": "CH" }
                ],
                "description": "Authorized dealer agreement for Rolex distribution",
                "total_value": 0,
                "currency": "USD",
                "terms": { "agreement_type": "authorized_retailer", "territory": "Switzerland", "valid_until": "2026-12-31" },
                "dependencies": []
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_AUTHENTICATION_INSPECTION_001",
              "foray_core": {
                "arrangement_refs": ["ARR_MANUFACTURER_CERT_001"],
                "type": "product_inspection",
                "description": "Physical authentication inspection results",
                "computation_method": "Valuation",
                "formula_id": "sha256:auth_inspection_protocol_v2...",
                "inputs": { "inspection_date": "2026-01-20", "inspector_id": "INSP-2026-0042" },
                "output": 29500.00,
                "currency": "USD",
                "inspection_results": { "case_authentic": true, "movement_authentic": true, "dial_authentic": true, "overall_status": "AUTHENTIC", "confidence_score": 0.99 },
                "dependencies": ["ARR_MANUFACTURER_CERT_001"]
              }
            },
            {
              "id": "ACC_RETAIL_VALUATION_001",
              "foray_core": {
                "arrangement_refs": ["ARR_MANUFACTURER_CERT_001", "ARR_DEALER_AUTHORIZATION_001"],
                "type": "retail_valuation",
                "description": "Current retail valuation",
                "computation_method": "Valuation",
                "formula_id": "sha256:msrp_lookup...",
                "inputs": { "reference": "126500LN", "condition": "new_with_tags", "market": "US" },
                "output": 29500.00,
                "currency": "USD",
                "dependencies": ["ARR_MANUFACTURER_CERT_001"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_WARRANTY_PERIOD_001",
              "foray_core": {
                "accrual_refs": ["ACC_AUTHENTICATION_INSPECTION_001"],
                "arrangement_refs": ["ARR_MANUFACTURER_CERT_001"],
                "type": "warranty_coverage",
                "description": "Expected warranty coverage period",
                "expected_amount": 0,
                "currency": "USD",
                "expected_date": "2031-01-20",
                "probability_factor": 0.95,
                "warranty_terms": { "warranty_years": 5, "coverage_type": "international", "transferable": true },
                "dependencies": ["ACC_AUTHENTICATION_INSPECTION_001"]
              }
            },
            {
              "id": "ANT_SALE_COMPLETION_001",
              "foray_core": {
                "accrual_refs": ["ACC_RETAIL_VALUATION_001"],
                "arrangement_refs": ["ARR_DEALER_AUTHORIZATION_001"],
                "type": "scheduled_sale",
                "description": "Expected sale to customer",
                "expected_amount": 29500.00,
                "currency": "USD",
                "expected_date": "2026-01-20",
                "probability_factor": 1.0,
                "dependencies": ["ACC_RETAIL_VALUATION_001"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_AUTHENTICATION_RECORDED_001",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": ["ACC_AUTHENTICATION_INSPECTION_001"],
                "arrangement_refs": ["ARR_MANUFACTURER_CERT_001"],
                "type": "authentication_record",
                "description": "Authentication record anchored to blockchain",
                "amount_settled": 0,
                "currency": "USD",
                "settlement_date": "2026-01-20T11:00:00Z",
                "settlement_status": "completed",
                "payment_method": "other",
                "counterparty": "Internal",
                "dependencies": ["ACC_AUTHENTICATION_INSPECTION_001"]
              }
            },
            {
              "id": "ACT_SALE_COMPLETED_001",
              "foray_core": {
                "anticipation_refs": ["ANT_SALE_COMPLETION_001"],
                "accrual_refs": ["ACC_RETAIL_VALUATION_001"],
                "arrangement_refs": ["ARR_DEALER_AUTHORIZATION_001", "ARR_MANUFACTURER_CERT_001"],
                "type": "retail_sale",
                "description": "Sale completed to customer",
                "amount_settled": 29500.00,
                "currency": "USD",
                "settlement_date": "2026-01-20T11:30:00Z",
                "settlement_status": "completed",
                "payment_method": "wire",
                "counterparty": "Customer (hash protected)",
                "allocations": [
                  { "ref": "ANT_SALE_COMPLETION_001", "ref_type": "anticipation", "amount": 29500.00, "currency": "USD", "allocation_type": "full" }
                ],
                "dependencies": ["ANT_SALE_COMPLETION_001"]
              }
            }
          ],
          "merkle_root": "sha256:watch_auth_001_merkle_root...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:watch_audit_data...", "audit_profile": "standard", "storage_locations": ["s3://foray-audit/2026/Q1/PROV_2026_Q1_WATCH_AUTH_001"] },
          "privacy_metadata": { "formulas_obfuscated": 3, "instance_pools": 2, "attack_complexity": "2^96 operations" }
        }
      },

      supplyChainTemplate: {
        name: "Supply Chain Template",
        description: "Minimal template for product provenance transactions",
        data: {
          "transaction_id": "PROV_YYYY_QN_PRODUCT_BATCH_NNN",
          "schema_version": "4.1",
          "timestamp": "2026-01-01T00:00:00Z",
          "foray_core": {
            "entity": "Producer Name",
            "entity_hash": "sha256:entity_hash...",
            "transaction_type": "product_provenance",
            "total_value": 0.00,
            "currency": "USD",
            "status": "completed",
            "compliance_flags": []
          },
          "component_hashes": { "arrangements": "sha256:...", "accruals": "sha256:...", "anticipations": "sha256:...", "actions": "sha256:..." },
          "arrangements": [
            {
              "id": "ARR_ORIGIN_CERTIFICATION",
              "foray_core": {
                "type": "origin_certification",
                "effective_date": "2026-01-01T00:00:00Z",
                "parties": [
                  { "role": "producer", "name": "Producer Name", "jurisdiction": "XX" },
                  { "role": "certifier", "name": "Certification Body", "jurisdiction": "XX" }
                ],
                "description": "Product origin certification",
                "total_value": 0.00,
                "currency": "USD",
                "terms": {},
                "dependencies": []
              }
            },
            {
              "id": "ARR_BATCH_DEFINITION",
              "foray_core": {
                "type": "production_batch",
                "effective_date": "2026-01-01T00:00:00Z",
                "parties": [
                  { "role": "producer", "name": "Producer Name", "jurisdiction": "XX" }
                ],
                "description": "Production batch definition",
                "total_value": 0.00,
                "currency": "USD",
                "terms": { "batch_id": "LOT-YYYY-NNN", "quantity": 0, "unit": "units" },
                "dependencies": ["ARR_ORIGIN_CERTIFICATION"]
              }
            }
          ],
          "accruals": [
            {
              "id": "ACC_PRODUCT_ANALYSIS",
              "foray_core": {
                "arrangement_refs": ["ARR_BATCH_DEFINITION"],
                "type": "product_analysis",
                "description": "Product quality analysis results",
                "computation_method": "Valuation",
                "formula_id": "sha256:analysis_protocol...",
                "inputs": { "sample_id": "SAMPLE-NNN", "analysis_date": "2026-01-01" },
                "output": 0.00,
                "currency": "USD",
                "dependencies": ["ARR_BATCH_DEFINITION"]
              }
            }
          ],
          "anticipations": [
            {
              "id": "ANT_DISTRIBUTION_SCHEDULE",
              "foray_core": {
                "accrual_refs": ["ACC_PRODUCT_ANALYSIS"],
                "arrangement_refs": ["ARR_BATCH_DEFINITION"],
                "type": "scheduled_distribution",
                "description": "Expected distribution schedule",
                "expected_amount": 0.00,
                "currency": "USD",
                "expected_date": "2026-02-01",
                "probability_factor": 0.95,
                "dependencies": ["ACC_PRODUCT_ANALYSIS"]
              }
            }
          ],
          "actions": [
            {
              "id": "ACT_VERIFICATION_RECORDED",
              "foray_core": {
                "anticipation_refs": [],
                "accrual_refs": ["ACC_PRODUCT_ANALYSIS"],
                "arrangement_refs": ["ARR_BATCH_DEFINITION"],
                "type": "verification_record",
                "description": "Verification record anchored to blockchain",
                "amount_settled": 0.00,
                "currency": "USD",
                "settlement_date": "2026-01-01T00:00:00Z",
                "settlement_status": "completed",
                "payment_method": "other",
                "counterparty": "Internal",
                "dependencies": ["ACC_PRODUCT_ANALYSIS"]
              }
            }
          ],
          "merkle_root": "sha256:...",
          "blockchain_anchor": { "kaspa_tx_id": null, "block_height": null, "confirmation_time_ms": null, "anchored_at": null },
          "audit_data_anchor": { "audit_data_hash": "sha256:...", "audit_profile": "standard", "storage_locations": [] },
          "privacy_metadata": { "formulas_obfuscated": 0, "instance_pools": 0, "attack_complexity": "2^96 operations" }
        }
      }
    };

    // Sample Narratives - Full Markdown content for each sample
    const sampleNarratives = {
      batchPayment: {
        title: 'Batch Payment: Multi-Invoice Clearing',
        content: `
# Batch Payment: Multi-Invoice Clearing

## The Business Scenario

Acme Manufacturing Corp needs to pay their vendor, GlobalParts Inc, for three outstanding invoices. Rather than issuing three separate payments, the accounts payable team processes them as a single batch payment&mdash;a common practice that reduces transaction fees and simplifies bank reconciliation.

The three invoices are:
- **GP-2026-001**: $15,000 for electronic components (due Jan 27)
- **GP-2026-002**: $22,500 for mechanical assemblies (due Feb 4)
- **GP-2026-003**: $10,000 for fasteners and hardware (due Feb 9)

**Total batch payment: $47,500**

---

## How FORAY Models This Transaction

This transaction demonstrates one of v4.1's key features: **many-to-many relationships**. One payment clears multiple invoices, and the FORAY structure captures this accurately.

### The Arrangement

Everything starts with the Master Service Agreement (MSA) between Acme and GlobalParts. This two-year contract (2025-2027) covers up to $500,000 in purchases and specifies:
- Net 30 payment terms
- 2% early payment discount if paid within 10 days
- 1.5% late payment penalty

The MSA is the contractual foundation that all invoices reference back to.

### The Accruals (3 Invoices)

Each invoice becomes an Accrual in FORAY&mdash;an economic obligation that Acme owes to GlobalParts. Each accrual:
- References the MSA arrangement
- Records the invoice details (number, date, due date, line items)
- Captures the accounting entry (Debit: Raw Materials, Credit: Accounts Payable)
- Uses \`FixedAmount\` computation method since invoice totals are predetermined

### The Anticipation

Before payment execution, the AP team schedules the batch payment. This Anticipation:
- References **all three accruals** (the v4.1 many-to-many feature)
- Specifies the expected payment amount ($47,500)
- Records the planned payment date (January 25, 2026)
- Notes the payment method (ACH)

### The Action

When the payment executes, the Action records:
- The actual settlement amount ($47,500)
- ACH payment reference number
- Timestamp of completion

**Most importantly**, the Action includes an **allocations array** showing exactly how the single payment was distributed:

| Invoice | Amount | Status |
|---------|--------|--------|
| GP-2026-001 | $15,000 | Fully paid |
| GP-2026-002 | $22,500 | Fully paid |
| GP-2026-003 | $10,000 | Fully paid |

This allocation tracking is critical for auditors who need to trace how payments were applied.

---

## Why This Matters for Auditors

In a traditional audit, the auditor would need to:
1. Pull the bank statement showing the $47,500 payment
2. Request the invoice copies from AP
3. Manually match the payment to the three invoices
4. Verify the MSA terms were followed

With FORAY, all of this is captured in a single, cryptographically anchored structure. The auditor can:
- Instantly see which invoices were paid
- Verify the allocations add up to the total
- Trace each invoice back to the governing contract
- Confirm the transaction hasn't been tampered with (via blockchain anchor)

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Many-to-many references** | One Action references three Accruals |
| **Allocation tracking** | Payment split shown in allocations array |
| **Dependency chain** | Arrangement &rarr; Accruals &rarr; Anticipation &rarr; Action |
| **Privacy hashing** | Party names hashed, amounts visible |

---

## Try It Yourself

Load \`batch-payment-v41.json\` in the Transaction Review tool to see:
- Click on any dependency badge to navigate to that component
- Expand the Action to see the allocations breakdown
- Use the JSON button to view the raw structure

---

*This narrative accompanies the \`batch-payment-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      cashSale: {
        title: 'Cash Sale: Action-Only Transaction',
        content: `
# Cash Sale: Action-Only Transaction

## The Business Scenario

It's 9:15 AM at Downtown Coffee House, and the morning rush is in full swing. A customer walks up to the counter and places a large order for their office:
- 3 Large Lattes ($16.50)
- 2 Large Mochas ($12.00)
- 5 Butter Croissants ($21.25)
- 4 Blueberry Muffins ($15.00)
- 10 Large Drip Coffees ($32.50)
- 6 Bagels with Cream Cheese ($27.00)

**Subtotal: $124.25**
**Tax (8.25%): $10.25**
**Total: $134.50**

The customer pays with $140 cash and receives $5.50 in change.

This is a completely ordinary retail transaction&mdash;no contract, no credit terms, no accounts receivable. Just cash across the counter.

---

## How FORAY Models This Transaction

This transaction demonstrates v4.1's **flexible entry point** feature. In previous versions, every FORAY transaction required an Arrangement as the starting point. But a walk-in cash sale has no contract&mdash;and forcing an artificial "arrangement" would misrepresent the reality.

### The Solution: Action-Only

In v4.1, transactions can begin at any component level. For this cash sale:

- **Arrangements**: Empty array \`[]\`
- **Accruals**: Empty array \`[]\`
- **Anticipations**: Empty array \`[]\`
- **Actions**: Contains the complete transaction

The Action captures everything that matters:
- Customer type: Anonymous walk-in
- Payment method: Cash
- Register and cashier IDs
- Complete line-item detail
- Tax calculation breakdown
- Cash tendered and change given

### Why This Structure?

A retail cash sale is fundamentally different from a B2B invoice payment:

| Aspect | B2B Invoice | Retail Cash Sale |
|--------|-------------|------------------|
| Contract | Yes (MSA, PO) | No |
| Credit terms | Yes (Net 30) | No |
| Accounts receivable | Yes | No |
| Customer identity | Known | Anonymous |
| Payment timing | Future | Immediate |

FORAY v4.1 recognizes these differences. The protocol doesn't force SMBs to create fake arrangements just to satisfy a rigid schema.

---

## What's Captured in the Action

The single Action component contains rich detail:

### Point of Sale Details
\`\`\`
Register: REG-001
Cashier: EMP-042
Shift: Morning
Transaction #: 42
\`\`\`

### Line Items
All 6 products with SKU, description, quantity, unit price, and line total.

### Tax Breakdown
\`\`\`
Subtotal:      $124.25
Tax Rate:      8.25%
Tax Amount:    $10.25
Total:         $134.50
Cash Tendered: $140.00
Change Given:  $5.50
\`\`\`

---

## Privacy Considerations

Even for a simple cash sale, FORAY applies privacy principles:

- **Entity hashed**: The coffee shop's identity is hashed
- **Customer anonymous**: Walk-in customers aren't identified
- **Amounts visible**: Transaction totals are not hidden (needed for tax compliance)
- **Minimal obfuscation**: Appropriate for low-sensitivity retail transactions

---

## Why This Matters

### For SMBs
Small businesses shouldn't need complex accounting structures to participate in transparent audit trails. A coffee shop should be able to anchor their daily sales with the same cryptographic proof as a Fortune 500 company.

### For Auditors
Even simple transactions benefit from immutability. Sales tax audits, cash handling reviews, and franchise compliance checks all need reliable records.

### For the Protocol
Supporting action-only transactions means FORAY can scale from enterprise securitizations down to everyday point-of-sale transactions&mdash;capturing the full spectrum of economic activity.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Flexible entry point** | Transaction starts at Action (no Arrangement) |
| **Minimum components** | Only 1 component required (down from 4 in v4.0) |
| **Rich action data** | Line items, tax, POS details all captured |
| **Appropriate privacy** | Minimal obfuscation for public retail transaction |

---

## Try It Yourself

Load \`cash-sale-v41.json\` in the Transaction Review tool to see:
- Notice the empty Arrangements, Accruals, and Anticipations sections
- Expand the Action to see the full line-item detail
- Check the privacy metadata showing "minimal" obfuscation level

---

*This narrative accompanies the \`cash-sale-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      autoLoan: {
        title: 'Auto Loan: Full 4-Component Chain',
        content: `
# Auto Loan: Full 4-Component Chain

## The Business Scenario

Sarah Johnson walks into a Tesla dealership in Palo Alto and purchases a 2025 Model 3. She finances the vehicle through Premier Auto Finance LLC with the following terms:

- **Principal**: $35,000
- **APR**: 5.49%
- **Term**: 60 months
- **Monthly Payment**: $665.28
- **Total Interest**: $4,916.80

The vehicle serves as collateral, with a loan-to-value ratio of 87.5%. The first payment is due February 25, 2026.

This is a classic consumer credit transaction&mdash;and it demonstrates FORAY's complete 4-component model in action.

---

## How FORAY Models This Transaction

Unlike the cash sale (action-only) or batch payment (payment-focused), an auto loan naturally spans all four FORAY components over its 5-year life.

### Component 1: The Arrangement

The Retail Installment Sale Contract is the legal foundation:

**Parties:**
- Lender: Premier Auto Finance LLC (California)
- Borrower: Sarah Johnson (California)

**Key Terms:**
| Term | Value |
|------|-------|
| Principal | $35,000.00 |
| APR | 5.49% |
| Term | 60 months |
| Monthly Payment | $665.28 |
| Total Interest | $4,916.80 |
| Total of Payments | $39,916.80 |
| First Payment Due | February 25, 2026 |

**Collateral:**
- 2025 Tesla Model 3
- VIN: [hashed for privacy]
- Odometer: 150 miles at origination
- Loan-to-Value: 87.5%

**Legal Documentation:**
- Retail Installment Sale Contract
- Truth in Lending Disclosure Statement
- Security Agreement
- Certificate of Title Assignment

### Component 2: The Accruals (Interest Calculations)

Every month, interest accrues on the outstanding principal. FORAY captures each accrual period:

**February 2026 Interest:**
\`\`\`
Principal Balance: $35,000.00
Annual Rate:       5.49%
Days in Period:    31
Interest Accrued:  $163.25
\`\`\`

**March 2026 Interest:**
\`\`\`
Principal Balance: $34,497.97
Annual Rate:       5.49%
Days in Period:    28
Interest Accrued:  $145.32
\`\`\`

Each accrual includes the accounting entry:
- Debit: Interest Receivable
- Credit: Interest Income

The formula ID is hashed (\`hash_simple_interest_daily_365\`) so auditors can verify the calculation method without exposing proprietary rate structures.

### Component 3: The Anticipations (Payment Schedule)

Before each payment is received, FORAY records what's expected:

**Payment #1 (February 2026):**
| Component | Amount |
|-----------|--------|
| Principal | $502.03 |
| Interest | $163.25 |
| **Total** | **$665.28** |
| Balance After | $34,497.97 |

**Payment #2 (March 2026):**
| Component | Amount |
|-----------|--------|
| Principal | $519.96 |
| Interest | $145.32 |
| **Total** | **$665.28** |
| Balance After | $33,978.01 |

Notice the probability factor of 0.97&mdash;this reflects a 3% expected default rate for this credit tier.

### Component 4: The Actions (What Actually Happened)

**Loan Disbursement:**
On January 25, 2026, Premier Auto Finance wires $35,000 to the Tesla dealer. This action:
- References the arrangement (the loan contract)
- Records the wire transfer details
- Confirms vehicle delivery and title receipt

**First Payment Receipt:**
On February 25, 2026, Sarah's ACH payment of $665.28 arrives. The action captures:
- Payment reference number
- Settlement timestamp
- **Allocation breakdown** showing how the payment was applied:
  - $163.25 &rarr; Interest (fully satisfies Feb interest accrual)
  - $502.03 &rarr; Principal (partial reduction of loan balance)

---

## The Complete Chain

\`\`\`
Arrangement (Loan Contract)
     &darr;
Accrual (Feb Interest: $163.25)
     &darr;
Anticipation (Feb Payment Expected: $665.28)
     &darr;
Action (Feb Payment Received: $665.28)
     &rarr; Allocation: $163.25 to interest
     &rarr; Allocation: $502.03 to principal
\`\`\`

This chain continues for all 60 months of the loan. Each month adds:
- 1 Accrual (interest calculation)
- 1 Anticipation (expected payment)
- 1 Action (actual payment received)

---

## Privacy Protections

Consumer credit data requires enhanced privacy. This transaction uses:

| Data Element | Protection |
|--------------|------------|
| Borrower name | Hashed (sha256:borrower_johnson_sarah) |
| VIN | Hashed (sha256:vin_5yj3e1ea_hashed) |
| Dealer name | Hashed |
| Interest formula | ID hashed, calculation verifiable |
| Amounts | Visible (required for regulatory compliance) |

The \`enhanced\` obfuscation level with 3 instance pools provides correlation resistance while maintaining audit trail integrity.

---

## Regulatory Compliance

Auto loans are heavily regulated. This FORAY transaction captures compliance with:
- **Truth in Lending Act (TILA)**: APR disclosure, total of payments
- **Regulation Z**: Payment breakdown, right to rescind
- **Consumer Credit Protection Act**: Fair lending documentation
- **FCRA**: Credit reporting data structure

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Full 4-component chain** | Arrangement &rarr; Accrual &rarr; Anticipation &rarr; Action |
| **Allocation tracking** | Payment split between principal and interest |
| **Formula hashing** | Interest calculation method protected |
| **Enhanced privacy** | Consumer PII hashed, amounts visible |
| **Compliance flags** | TILA, Reg Z, FCRA noted in transaction |

---

## Why This Matters

### For Lenders
- Tamper-evident record of loan terms and payment history
- Proof of regulatory disclosures provided
- Defense against borrower disputes

### For Regulators
- Verify TILA/Reg Z compliance
- Audit interest calculations without accessing proprietary models
- Monitor lending practices across portfolios

### For Borrowers
- Transparent record of what was agreed
- Verifiable payment history
- Protection against servicing errors

---

## Try It Yourself

Load \`auto-loan-v41.json\` in the Transaction Review tool to see:
- The complete dependency chain from Arrangement to Actions
- Click the interest accrual to see the calculation inputs
- Expand the payment action to see principal/interest allocation
- Check the privacy metadata showing "enhanced" protection level

---

*This narrative accompanies the \`auto-loan-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      rmbsWaterfall: {
        title: 'RMBS Waterfall: Securitization Distribution',
        content: `
# RMBS Waterfall: Securitization Distribution

## The Business Scenario

Structured Finance Trust 2025-1 is a $100 million residential mortgage-backed security (RMBS). The trust holds 450 mortgage loans and issues three tranches of notes to investors:

| Tranche | Rating | Balance | Coupon | Priority |
|---------|--------|---------|--------|----------|
| Class A (Senior) | AAA | $72,000,000 | 4.25% | 1st |
| Class B (Mezzanine) | A | $14,250,000 | 5.75% | 2nd |
| Class C (Subordinate) | BBB | $4,750,000 | 8.25% | 3rd |

Every month, homeowners make their mortgage payments. The trust collects these payments and distributes them to investors according to a strict "waterfall" priority&mdash;senior bondholders get paid first, then mezzanine, then subordinate.

This is January 2026's distribution: **$2,492,500** flowing through the waterfall.

---

## How FORAY Models This Transaction

RMBS waterfalls are among the most complex financial structures. Multiple parties, multiple tranches, strict payment priorities, and regulatory scrutiny from the SEC, Basel III, and Dodd-Frank. FORAY v4.1's many-to-many references are essential here.

### The Arrangements (3 Tranches)

Each tranche is modeled as a separate Arrangement:

**Class A - Senior Notes (AAA)**
- Original balance: $80,000,000
- Current balance: $72,000,000
- Coupon: 4.25%
- Credit enhancement: 20% subordination

**Class B - Mezzanine Notes (A)**
- Original balance: $15,000,000
- Current balance: $14,250,000
- Coupon: 5.75%
- Credit enhancement: 5% subordination

**Class C - Subordinate Notes (BBB)**
- Original balance: $5,000,000
- Current balance: $4,750,000
- Coupon: 8.25%
- Credit enhancement: First loss position

The subordination structure means Class C absorbs the first losses, protecting Class A and B investors.

### The Accruals (4 Calculations)

**Pool Collections Accrual**
The trust collected from the underlying mortgages:
\`\`\`
Scheduled Principal:  $1,800,000
Scheduled Interest:   $  650,000
Prepayments:          $   45,000
Defaults:             $   (5,000)
Recoveries:           $    2,500
&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
Total Available:      $2,492,500
\`\`\`

This single accrual references **all three tranches**&mdash;a many-to-many relationship because the pool supports all investors.

**Tranche Interest Accruals (3)**
Each tranche has its own interest calculation:
- Class A: $72M &times; 4.25% &times; 30/360 = $255,000
- Class B: $14.25M &times; 5.75% &times; 30/360 = $68,281.25
- Class C: $4.75M &times; 8.25% &times; 30/360 = $32,656.25

### The Anticipation (Waterfall Priority)

Before distribution, the trustee calculates the expected waterfall:

| Priority | Payment Type | Amount |
|----------|--------------|--------|
| 1 | Trustee Fees | $7,500 |
| 2 | Servicing Fees | $25,000 |
| 3 | Class A Interest | $255,000 |
| 4 | Class A Principal | $1,800,000 |
| 5 | Class B Interest | $68,281.25 |
| 6 | Class B Principal | $225,000 |
| 7 | Class C Interest | $32,656.25 |
| 8 | Class C Principal | $75,000 |
| 9 | Residual | $4,062.50 |

This anticipation references **all four accruals** and **all three arrangements**&mdash;the full complexity of the deal captured in component references.

### The Action (Distribution Executed)

When the waterfall executes, the Action records:
- Total distributed: $2,492,500
- Settlement method: Wire transfers
- Allocations to each tranche with interest/principal breakdown

**Class A Allocation:**
\`\`\`
Interest:  $  255,000.00
Principal: $1,800,000.00
Total:     $2,055,000.00
New Balance: $70,200,000
\`\`\`

**Class B Allocation:**
\`\`\`
Interest:  $   68,281.25
Principal: $  225,000.00
Total:     $  293,281.25
New Balance: $14,025,000
\`\`\`

**Class C Allocation:**
\`\`\`
Interest:  $   32,656.25
Principal: $   75,000.00
Total:     $  107,656.25
New Balance: $4,675,000
\`\`\`

---

## Why Waterfalls Are Hard to Audit

Traditional RMBS audits are notoriously difficult:

1. **Complex calculations**: Interest accrues daily on changing balances
2. **Strict priority**: Payments must flow in exact order
3. **Multiple systems**: Servicer, trustee, and investor records rarely match
4. **Regulatory scrutiny**: SEC Reg AB requires detailed disclosure

### How FORAY Helps

| Audit Challenge | FORAY Solution |
|-----------------|----------------|
| Tracing payment priority | Waterfall captured in anticipation |
| Verifying allocations | Allocations array shows exact splits |
| Matching calculations | Formula IDs allow verification |
| Proving timing | Blockchain anchor timestamps |

---

## Regulatory Compliance

This transaction carries heavy compliance flags:

- **SEC Reg AB**: Asset-backed securities disclosure requirements
- **Dodd-Frank**: Risk retention and reporting rules
- **Basel III**: Capital requirements for securitization exposures
- **IFRS 9**: Expected credit loss accounting

FORAY doesn't replace regulatory filings, but provides a tamper-evident audit trail that supports them.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Many-to-many references** | Pool accrual &rarr; 3 tranches; Anticipation &rarr; 4 accruals |
| **Complex allocations** | Single distribution split across 3 tranches |
| **Interest/principal breakdown** | Each allocation shows component split |
| **Multiple arrangements** | 3 parallel tranches, one pool |
| **Enhanced privacy** | 4 formulas obfuscated, 5 instance pools |

---

## The 2008 Lesson

The 2008 financial crisis revealed that no one&mdash;not investors, not regulators, not even the banks&mdash;could trace mortgage payments through securitization structures. FORAY provides the transparency that was missing.

Every payment, every allocation, every calculation&mdash;cryptographically anchored and fully traceable.

---

## Try It Yourself

Load \`rmbs-waterfall-v41.json\` in the Transaction Review tool to see:
- Three arrangements representing the tranche structure
- Click on the pool collections accrual to see the many-to-many references
- Expand the anticipation to view the complete waterfall priority
- Check the action allocations for interest/principal breakdown per tranche

---

*This narrative accompanies the \`rmbs-waterfall-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      energyPPA: {
        title: 'Energy PPA: Solar Power Purchase Agreement',
        content: `
# Energy PPA: Solar Power Purchase Agreement

## The Business Scenario

SunPower Utilities International, a Spanish energy company, purchases solar electricity from the Noor Ouarzazate Solar Complex in Morocco. This 200 MW solar farm in the Sahara Desert delivers clean energy to the Spanish grid via an undersea HVDC cable.

The 20-year Power Purchase Agreement (PPA) commits to:
- **420,000 MWh** annually
- **&euro;42.50/MWh** base price (with 1.5% annual escalation)
- **Renewable Energy Certificates (RECs)** included
- **Curtailment compensation** at 85% of contract price

January 2026's delivery: **38,500 MWh** of solar power plus **1,500 MWh** curtailed due to grid congestion.

---

## How FORAY Models This Transaction

Energy transactions are unique&mdash;they involve physical delivery of electrons, regulatory certificates, and complex pricing that varies with weather, grid conditions, and time of day. FORAY captures all of this.

### The Arrangement

The PPA is a 20-year contract with detailed terms:

**Facility Details:**
- Name: Noor Ouarzazate Solar Complex - Phase IV
- Type: Solar PV
- Capacity: 200 MW
- Location: Morocco

**Commercial Terms:**
| Term | Value |
|------|-------|
| Contract Duration | 2025-2045 (20 years) |
| Annual Commitment | 420,000 MWh |
| Base Price | &euro;42.50/MWh |
| Price Escalation | 1.5%/year |
| Curtailment Cap | 5% of annual delivery |
| Curtailment Compensation | 85% of contract price |

**Delivery Points:**
- Interconnection: HVDC Morocco-Spain Link
- Delivery: Spanish Grid - Andalusia Node

### The Accruals (3 Types)

**1. Energy Delivery Accrual**
The core transaction&mdash;actual electricity delivered:
\`\`\`
Metered Energy:     38,500 MWh
PPA Price (Year 2): &euro;43.18/MWh
&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
Energy Value:       &euro;1,662,430.00
\`\`\`

The price reflects Year 2 escalation (&euro;42.50 &times; 1.015 = &euro;43.18).

**2. Curtailment Accrual**
Sometimes the grid can't accept all available power. When this happens, the generator is compensated:
\`\`\`
Curtailed Energy:     1,500 MWh
PPA Price:            &euro;43.18/MWh
Compensation Rate:    85%
&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
Curtailment Payment:  &euro;55,054.50
\`\`\`

Curtailment occurred for 45 hours in January due to grid congestion on the Spain interconnect.

**3. Renewable Energy Credits (RECs)**
The PPA includes bundled RECs&mdash;certificates proving the energy is renewable:
\`\`\`
MWh Generated:      40,000 MWh
RECs per MWh:       1
REC Value:          &euro;3.50 each
&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
Total REC Value:    &euro;140,000.00
\`\`\`

These certificates are registered in the EU Guarantees of Origin (GO) Registry and certified by AENOR.

### The Anticipation

Before payment, the anticipated settlement is calculated:
\`\`\`
Energy Delivery:        &euro;1,662,430.00
Curtailment Compensation: &euro;   55,054.50
&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
Expected Payment:       &euro;1,717,484.50
\`\`\`

RECs are transferred separately (not a cash payment).

### The Actions (2 Settlements)

**1. Energy Payment**
On February 14, 2026, SunPower wires payment to Morocco Solar Farm:
- Amount: &euro;1,717,484.50
- Method: SWIFT MT103
- Allocations:
  - &euro;1,662,430.00 &rarr; Energy delivery (38,500 MWh)
  - &euro;55,054.50 &rarr; Curtailment compensation (1,500 MWh)

**2. REC Transfer**
On February 10, 2026, 40,000 RECs transfer in the EU GO Registry:
- Source Account: MA-NOOR-GEN-001 (Generator)
- Destination Account: ES-SUNPOWER-OFF-001 (Offtaker)
- Value: &euro;140,000 (40,000 &times; &euro;3.50)

---

## Why Energy Transactions Need FORAY

Energy markets are complex and heavily regulated:

### Metering and Verification
Every MWh must be metered, verified, and reconciled:
- Generator meters at the solar farm
- Grid operator meters at the interconnect
- Offtaker meters at delivery point

FORAY captures meter IDs and reading timestamps for audit trails.

### Curtailment Disputes
Curtailment compensation is a common source of disputes:
- Was the curtailment necessary?
- Was compensation calculated correctly?
- Did it exceed the annual cap?

FORAY records curtailment hours, reasons, and calculations.

### REC Tracking
RECs are increasingly valuable and subject to fraud:
- Double-counting (selling the same certificate twice)
- Vintage manipulation (claiming old RECs as new)
- Registry discrepancies

FORAY links RECs to specific generation periods with registry confirmation numbers.

---

## Cross-Border Complexity

This transaction spans multiple jurisdictions:

| Element | Jurisdiction |
|---------|--------------|
| Generator | Morocco |
| Grid Operator | Morocco (ONEE) |
| Interconnect | International waters |
| Offtaker | Spain |
| REC Registry | European Union |
| Currency | EUR |

FORAY captures jurisdictional details in party records and compliance flags.

---

## Regulatory Compliance

This PPA triggers multiple regulatory frameworks:

- **IFRS 16**: Lease accounting for energy contracts
- **EU Taxonomy**: Sustainable finance classification
- **REC Certification**: Guarantees of Origin requirements
- **ISDA**: Derivatives documentation (for price hedging)

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Multiple accrual types** | Energy, curtailment, and RECs |
| **Allocation tracking** | Payment split between delivery and curtailment |
| **Non-cash settlements** | REC transfer via registry (not wire) |
| **Physical delivery** | Meter readings and delivery points captured |
| **Cross-border parties** | Morocco generator, Spanish offtaker, EU registry |

---

## The Energy Transition

As the world shifts to renewable energy, PPAs like this are proliferating. Solar and wind projects need long-term offtake agreements to secure financing. Utilities need renewable generation to meet climate commitments.

FORAY provides the transparent, auditable infrastructure these markets need&mdash;tracking every electron from desert sunshine to Spanish homes.

---

## Try It Yourself

Load \`energy-ppa-v41.json\` in the Transaction Review tool to see:
- The comprehensive PPA terms in the arrangement
- Three different accrual types (energy, curtailment, RECs)
- Two separate actions (payment and REC transfer)
- Meter IDs and registry details in the inputs

---

*This narrative accompanies the \`energy-ppa-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      manufacturingWO: {
        title: 'Manufacturing Work Order: BOM and Cost Allocation',
        content: `
# Manufacturing Work Order: BOM and Cost Allocation

## The Business Scenario

Precision Components Manufacturing Inc receives an order from Aerospace Dynamics Corp for 100 hydraulic actuator assemblies. These precision components will be used in aircraft landing gear systems.

**Work Order #500 Details:**
- Product: Hydraulic Actuator Assembly (HA-2000-A)
- Quantity: 100 units
- Unit Price: $478.50
- Quality Standard: AS9100D (aerospace)
- Inspection: 100% testing required

The manufacturing process takes 4 days, moving through machining, assembly, testing, and final inspection before the units transfer to finished goods inventory.

**Total Cost: $47,848.75**

---

## How FORAY Models This Transaction

Manufacturing cost accounting is notoriously complex. Materials, labor, and overhead must be tracked, allocated, and reconciled&mdash;with auditors (and often the Department of Defense) scrutinizing every dollar. FORAY captures the complete cost build-up.

### The Arrangement (Work Order)

The work order defines what's being built and how:

**Product Specification:**
| Attribute | Value |
|-----------|-------|
| Product Code | HA-2000-A |
| Product Name | Hydraulic Actuator Assembly |
| Quantity | 100 units |
| BOM Version | HA-2000-A-R3 |
| Quality Requirement | AS9100D |

**Bill of Materials (BOM):**
| Part Number | Description | Qty/Unit | Unit Cost |
|-------------|-------------|----------|-----------|
| CYL-100 | Cylinder Body | 1 | $85.00 |
| PST-200 | Piston Assembly | 1 | $45.00 |
| SL-300 | Seal Kit | 1 | $12.50 |
| VLV-400 | Control Valve | 2 | $28.00 |
| HSG-500 | Housing | 1 | $65.00 |
| | **Total Material/Unit** | | **$263.50** |

The BOM is the DNA of the product&mdash;every component traced and costed.

### The Accruals (3 Cost Elements)

Manufacturing costs fall into three categories, each captured as an accrual:

**1. Raw Materials Accrual**
When materials are issued from inventory to the work order:

| Part | Qty Issued | Unit Cost | Total |
|------|------------|-----------|-------|
| CYL-100 | 100 | $85.00 | $8,500.00 |
| PST-200 | 100 | $45.00 | $4,500.00 |
| SL-300 | 100 | $12.50 | $1,250.00 |
| VLV-400 | 200 | $28.00 | $5,600.00 |
| HSG-500 | 100 | $65.00 | $6,500.00 |
| **Total** | | | **$26,350.00** |

Accounting entry:
- Debit: Work in Process (1400)
- Credit: Raw Materials Inventory (1200)

**2. Direct Labor Accrual**
Workers track time by operation:

| Operation | Hours | Rate | Total |
|-----------|-------|------|-------|
| 10 - Machining | 80 | $52.00 | $4,160.00 |
| 20 - Assembly | 120 | $52.00 | $6,240.00 |
| 30 - Testing | 35 | $52.00 | $1,820.00 |
| 40 - Inspection | 10 | $52.00 | $520.00 |
| **Total** | **245** | | **$12,740.00** |

Accounting entry:
- Debit: Work in Process (1400)
- Credit: Direct Labor (5100)

**3. Manufacturing Overhead Accrual**
Overhead is allocated based on direct labor hours:

\`\`\`
Labor Hours:        245
Overhead Rate:      $35.75/hour
&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
Total Overhead:     $8,758.75
\`\`\`

**Overhead Components:**
| Category | Amount |
|----------|--------|
| Facility Costs | $3,500.00 |
| Equipment Depreciation | $2,450.00 |
| Utilities | $1,225.00 |
| Supervision | $980.00 |
| Supplies | $603.75 |
| **Total** | **$8,758.75** |

Accounting entry:
- Debit: Work in Process (1400)
- Credit: Manufacturing Overhead Applied (5200)

### The Anticipation (Expected Transfer)

Before completion, the system projects the finished goods transfer:

\`\`\`
Materials:    $26,350.00
Labor:        $12,740.00
Overhead:     $ 8,758.75
&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;
Total Cost:   $47,848.75
Cost/Unit:    $   478.49
\`\`\`

Expected yield: 100 units started, 100 units completed (0 scrap).

### The Action (Finished Goods Receipt)

When the work order completes:

**Production Results:**
| Metric | Value |
|--------|-------|
| Quantity Started | 100 |
| Quantity Completed | 100 |
| Quantity Scrapped | 0 |
| Yield | 100% |
| Lot Number | LOT-2026-HA2000-0042 |
| Quality Status | Passed |
| Quality Certificate | QC-2026-500-PASS |

**Cost Allocations:**
| Cost Element | Amount |
|--------------|--------|
| Raw Materials | $26,350.00 |
| Direct Labor | $12,740.00 |
| Manufacturing Overhead | $8,758.75 |
| **Total** | **$47,848.75** |

Accounting entry:
- Debit: Finished Goods Inventory (1300)
- Credit: Work in Process (1400)

---

## Why Manufacturing Costing Is Audited

Manufacturing cost accounting is subject to intense scrutiny:

### GAAP Cost Accounting
- Materials must be valued consistently (FIFO, weighted average)
- Labor rates must match payroll records
- Overhead allocation must be reasonable and documented

### DCAA Compliance (Defense Contracts)
For government contractors like aerospace suppliers:
- Every cost must be allowable, allocable, and reasonable
- Overhead rates are audited and negotiated
- Cost Accounting Standards (CAS) must be followed

### ISO 9001 / AS9100 Quality
- Traceability from raw material to finished good
- Lot tracking for recall capability
- Inspection records maintained

---

## The Cost Variance Problem

Manufacturing variances are a constant challenge:

| Variance Type | Example |
|---------------|---------|
| Material price | Steel costs more than standard |
| Material usage | More scrap than expected |
| Labor rate | Overtime premiums |
| Labor efficiency | Job took longer than planned |
| Overhead volume | Factory ran below capacity |

FORAY captures expected vs. actual at every step, making variance analysis auditable.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Three cost accruals** | Materials, labor, overhead separately tracked |
| **BOM explosion** | Component-level material detail |
| **Operation tracking** | Labor by manufacturing operation |
| **Overhead allocation** | Rate-based absorption costing |
| **Yield tracking** | Started vs. completed vs. scrapped |
| **Quality linkage** | Lot number and inspection status |

---

## From Shop Floor to Financial Statements

This single work order connects:

1. **Purchasing** &rarr; Material costs from PO prices
2. **Inventory** &rarr; Raw material issues and FG receipts
3. **Payroll** &rarr; Labor hours and rates
4. **Cost Accounting** &rarr; Overhead absorption
5. **Quality** &rarr; Inspection and certification
6. **Financial Reporting** &rarr; Inventory valuation

FORAY provides the audit trail that links them all.

---

## Try It Yourself

Load \`manufacturing-v41.json\` in the Transaction Review tool to see:
- The complete BOM in the arrangement
- Material breakdown by part number in the raw materials accrual
- Labor hours by operation in the direct labor accrual
- Overhead components in the overhead accrual
- All three costs flowing to the finished goods action

---

*This narrative accompanies the \`manufacturing-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      depreciationEntry: {
        title: 'Depreciation Entry: Accrual-Only Transaction',
        content: `
# Depreciation Entry: Accrual-Only Transaction

## The Business Scenario

It's January 31, 2026&mdash;month-end closing at Precision Manufacturing Inc. The accounting team runs the depreciation schedule, recording the monthly wear and tear on company assets:

| Asset Class | Original Cost | Monthly Depreciation |
|-------------|---------------|---------------------|
| CNC Machinery | $750,000 | $25,000 |
| Delivery Vehicles (5) | $250,000 | $3,750 |
| Manufacturing Facility | $8,000,000 | $17,083.33 |
| **Total** | **$9,000,000** | **$45,833.33** |

There's no contract here. No payment. No counterparty. Just an adjusting journal entry that recognizes expense and reduces asset values.

**Total Depreciation: $45,833.33**

---

## How FORAY Models This Transaction

This transaction demonstrates v4.1's **flexible entry point** feature&mdash;specifically, an Accrual-only transaction. Depreciation is a pure accounting recognition with no arrangement, no anticipation, and no action.

### Why Accrual-Only Makes Sense

| Traditional Transaction | Depreciation |
|------------------------|--------------|
| Contract exists | No contract |
| Counterparty involved | No counterparty |
| Cash will flow | No cash flow |
| Future settlement expected | Nothing to settle |

Depreciation is an **allocation of historical cost** over an asset's useful life. It exists entirely within the accounting system&mdash;there's nothing external to link to.

### The Accruals (3 Asset Classes)

**1. CNC Machinery Depreciation**

A high-precision CNC machine, purchased in July 2024:

\`\`\`
Original Cost:     $750,000
Salvage Value:     $ 50,000
Depreciable Base:  $700,000
Method:            MACRS (5-year)
Monthly Expense:   $ 25,000
\`\`\`

After 18 months of depreciation:
- Accumulated: $400,000
- Remaining Book Value: $350,000

**2. Delivery Vehicle Fleet Depreciation**

Five delivery trucks using straight-line depreciation:

\`\`\`
Total Original Cost:  $250,000
Total Salvage Value:  $ 25,000
Depreciable Base:     $225,000
Method:               Straight-line (5-year)
Monthly Expense:      $  3,750
\`\`\`

After 24 months:
- Accumulated: $93,750
- Remaining Book Value: $156,250

**3. Manufacturing Building Depreciation**

The factory building using 39-year straight-line (commercial real estate):

\`\`\`
Original Cost:     $8,000,000
Salvage Value:     $        0
Depreciable Base:  $8,000,000
Method:            Straight-line (39-year)
Monthly Expense:   $   17,083.33
\`\`\`

After 96 months (8 years):
- Accumulated: $1,657,083.33
- Remaining Book Value: $6,342,916.67

### The Empty Components

- **Arrangements**: Empty \`[]\` &mdash; no contract governs depreciation
- **Anticipations**: Empty \`[]\` &mdash; no future event is expected
- **Actions**: Empty \`[]\` &mdash; no settlement will occur

This is the cleanest possible FORAY structure: just the economic recognition, nothing more.

---

## Depreciation Methods Captured

FORAY supports multiple depreciation methods through formula IDs:

| Method | Formula ID | Use Case |
|--------|-----------|----------|
| MACRS | \`hash_depr_macrs_5yr_monthly\` | US tax depreciation |
| Straight-line | \`hash_depr_straightline_monthly\` | Book depreciation |
| Double-declining | \`hash_depr_ddb_monthly\` | Accelerated book |
| Units of production | \`hash_depr_units_monthly\` | Variable usage |

The formula ID is hashed&mdash;auditors can verify the method used without exposing proprietary asset valuation models.

---

## Accounting Entries

Each accrual includes the journal entry:

**CNC Machinery:**
\`\`\`
Debit:  6500 - Depreciation Expense - Machinery    $25,000.00
Credit: 1550 - Accumulated Depreciation - Machinery $25,000.00
\`\`\`

**Delivery Vehicles:**
\`\`\`
Debit:  6510 - Depreciation Expense - Vehicles     $ 3,750.00
Credit: 1560 - Accumulated Depreciation - Vehicles  $ 3,750.00
\`\`\`

**Building:**
\`\`\`
Debit:  6520 - Depreciation Expense - Building     $17,083.33
Credit: 1570 - Accumulated Depreciation - Building  $17,083.33
\`\`\`

These entries reduce net income (expense) while building the contra-asset (accumulated depreciation).

---

## Why Depreciation Needs Audit Trails

Depreciation errors are surprisingly common and consequential:

| Issue | Impact |
|-------|--------|
| Wrong useful life | Over/understated book values |
| Incorrect method | Tax compliance issues |
| Missed assets | Understated expenses |
| Salvage value errors | Incorrect terminal values |

### SOX 404 Requirements

For public companies, depreciation controls are SOX-critical:
- Asset additions properly capitalized
- Useful lives consistently applied
- Depreciation calculated accurately
- Book/tax differences tracked

FORAY provides a tamper-evident audit trail that supports these controls.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Flexible entry point** | Accrual-only (no Arrangement needed) |
| **Multiple accruals** | 3 asset classes, same transaction |
| **Formula hashing** | MACRS vs. straight-line methods protected |
| **Empty components** | Valid structure with only Accruals populated |
| **Accumulated tracking** | Prior periods + current = total depreciation |

---

## Adjusting Entry Pattern

Depreciation is one of several **adjusting entry** types that FORAY v4.1 handles elegantly:

| Adjusting Entry Type | FORAY Pattern |
|---------------------|---------------|
| Depreciation | Accrual-only |
| Amortization | Accrual-only |
| Bad debt expense | Accrual-only |
| Accrued expenses | Accrual &rarr; Action |
| Prepaid expense recognition | Accrual-only |
| Deferred revenue recognition | Accrual-only |

The flexible entry point feature means FORAY accurately represents these transactions without forcing artificial arrangements.

---

## Try It Yourself

Load \`depreciation-entry-v41.json\` in the Transaction Review tool to see:
- Empty Arrangements, Anticipations, and Actions sections
- Three separate accruals for different asset classes
- Accumulated depreciation tracking in each accrual
- Different depreciation methods (MACRS vs. straight-line)

---

*This narrative accompanies the \`depreciation-entry-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      fxSpot: {
        title: 'FX Spot Trade: Multi-Currency Settlement',
        content: `
# FX Spot Trade: Multi-Currency Settlement

## The Business Scenario

Global Treasury Services Inc needs to pay a European supplier in euros. On January 23, 2026, the treasury desk calls their FX counterparty at Deutsche Bank and executes a spot trade:

**Trade Details:**
- **Buy**: &euro;1,000,000
- **Sell**: $1,085,000
- **Spot Rate**: 1.0850
- **Value Date**: January 27, 2026 (T+2)

Two days later, on the value date, the currencies settle:
- Global Treasury receives &euro;1,000,000 in their Deutsche Bank nostro account
- Global Treasury pays $1,085,000 from their JPMorgan Chase nostro account

By settlement, the market has moved&mdash;EUR/USD is now 1.0875. Global Treasury locked in at 1.0850, saving $2,500.

**Realized Gain: $2,500**

---

## How FORAY Models This Transaction

FX transactions are unique&mdash;they involve two currencies flowing in opposite directions, with potential P&L from rate movements. FORAY captures both legs and the valuation changes.

### The Arrangement (FX Spot Contract)

The trade is captured with full execution details:

**Trade Terms:**
| Element | Value |
|---------|-------|
| Currency Pair | EUR/USD |
| Deal Type | Spot |
| Buy Currency | EUR |
| Buy Amount | 1,000,000 |
| Sell Currency | USD |
| Sell Amount | 1,085,000 |
| Spot Rate | 1.0850 |
| Settlement | T+2 |
| Value Date | 2026-01-27 |

**Settlement Instructions:**
- EUR Nostro: Deutsche Bank (DEUTDEFF)
- USD Nostro: JPMorgan Chase (CHASUS33)

Account numbers are hashed for privacy while BIC codes remain visible for operational clarity.

### The Accruals (Mark-to-Market Valuations)

Between trade date and settlement, the position is marked to market daily:

**Trade Date (T+0) - January 23:**
\`\`\`
Market Rate:    1.0850
Contract Rate:  1.0850
Unrealized P&L: $0.00
\`\`\`

No gain or loss&mdash;the trade was just executed at market.

**T+1 - January 24:**
\`\`\`
Market Rate:    1.0875
Contract Rate:  1.0850
Rate Difference: 0.0025
Unrealized P&L: $2,500.00
\`\`\`

The euro strengthened&mdash;good for Global Treasury who locked in at 1.0850.

Accounting entry:
\`\`\`
Debit:  1400 - FX Receivable       $2,500.00
Credit: 4200 - Unrealized FX Gain  $2,500.00
\`\`\`

### The Anticipations (Two Settlement Legs)

FX spot trades have **two legs**&mdash;one for each currency:

**EUR Receipt Anticipation:**
- Expected: &euro;1,000,000
- Date: January 27, 2026
- Receiving Bank: Deutsche Bank
- Cut-off: 17:00 CET

**USD Payment Anticipation:**
- Expected: $1,085,000
- Date: January 27, 2026
- Paying Bank: JPMorgan Chase
- Cut-off: 17:00 EST

The probability factor of 0.999 reflects near-certainty (counterparty risk on a major bank is minimal).

### The Actions (Three Settlements)

**1. EUR Receipt (09:30 CET):**
\`\`\`
Amount:    &euro;1,000,000
Method:    SWIFT MT202
Reference: SWIFT-MT202-20260127-001
\`\`\`

**2. USD Payment (14:45 EST):**
\`\`\`
Amount:    $1,085,000
Method:    Fedwire
Reference: FEDWIRE-20260127-002
\`\`\`

**3. P&L Realization (17:00 EST - End of Day):**
\`\`\`
Contracted Rate: 1.0850
Settlement Rate: 1.0875
Rate Difference: 0.0025
Notional:        &euro;1,000,000
Realized Gain:   $2,500.00
\`\`\`

Accounting entry (reclassification):
\`\`\`
Debit:  4200 - Unrealized FX Gain  $2,500.00
Credit: 4210 - Realized FX Gain    $2,500.00
\`\`\`

---

## FX Settlement Risk

FX trades carry **Herstatt risk**&mdash;the danger that you pay your currency but don't receive the other side. This famously occurred in 1974 when Herstatt Bank failed mid-settlement.

FORAY timestamps both legs precisely:
- EUR received: 09:30 CET (14:30 UTC)
- USD paid: 14:45 EST (19:45 UTC)

The 5-hour gap between receipts is typical due to time zone differences between European and US payment systems.

Modern FX settlement increasingly uses **CLS (Continuous Linked Settlement)** to eliminate this risk through payment-versus-payment. FORAY can capture CLS settlement just as easily.

---

## Regulatory Compliance

FX trades trigger multiple regulatory frameworks:

| Regulation | Requirement |
|------------|-------------|
| **Dodd-Frank** | Swap reporting (if derivative) |
| **EMIR** | European trade reporting |
| **MiFID II** | Best execution documentation |
| **Basel III** | Counterparty credit risk capital |

FORAY's compliance flags indicate which regulations apply to each transaction.

---

## Nostro Account Reconciliation

Treasury operations depend on accurate nostro reconciliation:

| Account | Opening | Receipt | Payment | Closing |
|---------|---------|---------|---------|---------|
| EUR Nostro | &euro;X | +&euro;1,000,000 | &mdash; | &euro;X+1M |
| USD Nostro | $Y | &mdash; | -$1,085,000 | $Y-1.085M |

FORAY provides the audit trail that links FX trades to nostro movements&mdash;critical for cash management and bank reconciliation.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Dual-currency flows** | EUR receipt + USD payment |
| **Mark-to-market accruals** | Daily valuation tracking |
| **Two anticipations** | Separate legs for each currency |
| **Three actions** | Receipt, payment, P&L realization |
| **Variance tracking** | Shows realized gain from rate movement |

---

## Forward vs. Spot

This sample shows a **spot** trade (T+2 settlement). FORAY handles **forward** trades similarly, with:
- Longer settlement periods (T+30, T+90, etc.)
- Forward points captured in the rate
- More mark-to-market accruals over the life
- Potential for margin/collateral requirements

---

## Try It Yourself

Load \`fx-spot-v41.json\` in the Transaction Review tool to see:
- Trade execution details in the arrangement
- Two mark-to-market accruals showing rate movement
- Separate anticipations for EUR and USD legs
- Three actions: receipt, payment, and P&L realization
- Variance showing the $2,500 realized gain

---

*This narrative accompanies the \`fx-spot-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      overnightRepo: {
        title: 'Overnight Repo: Collateral and SOFR',
        content: `
# Overnight Repo: Collateral and SOFR

## The Business Scenario

Alpha Capital's fixed income trading desk needs $50 million in overnight funding to finance their Treasury position. On Friday afternoon, January 24, 2026, they enter a repurchase agreement (repo) with a money market fund:

**Repo Terms:**
- **Principal**: $50,000,000
- **Rate**: SOFR + 5 bps (5.30% all-in)
- **Term**: 3 days (over weekend)
- **Collateral**: US Treasury Note 4.25% due 2028
- **Haircut**: 2%

On Friday, Alpha delivers $51 million in Treasuries and receives $50 million in cash. On Monday, they return the cash plus interest ($50,022,083.33) and get their Treasuries back.

**Interest Earned by Lender: $22,083.33**

---

## How FORAY Models This Transaction

Repos are secured financing transactions&mdash;essentially collateralized loans with two legs (opening and closing). FORAY captures the full lifecycle including collateral, daily accruals, and margin monitoring.

### The Arrangement (Repo Agreement)

The repo contract specifies all terms:

**Financing Terms:**
| Element | Value |
|---------|-------|
| Repo Type | Overnight (extended for weekend) |
| Principal | $50,000,000 |
| Repo Rate | 5.30% (SOFR + 5bps) |
| Day Count | Actual/360 |
| Interest | $22,083.33 |
| Repurchase Price | $50,022,083.33 |
| Haircut | 2% |

**Collateral Details:**
| Element | Value |
|---------|-------|
| Security Type | US Treasury Note |
| Coupon | 4.25% |
| Maturity | November 15, 2028 |
| Face Value | $50,000,000 |
| Market Value | $51,020,000 |
| After Haircut | $50,000,000 |

The 2% haircut means Alpha must pledge $51M in Treasuries to borrow $50M&mdash;providing the lender with a cushion against market movements.

**Legal Framework:**
- SIFMA Master Repurchase Agreement
- Annex I - Supplemental Terms
- Tri-Party Custodial Agreement

### The Accruals (3 Components)

**1. Day 1 Interest Accrual (Friday):**
\`\`\`
Principal:     $50,000,000
SOFR Rate:     5.25%
Spread:        0.05%
All-in Rate:   5.30%
Days:          1
Interest:      $7,361.11
\`\`\`

Formula: $50M &times; 5.30% &times; 1/360 = $7,361.11

**2. Day 2-3 Interest Accrual (Weekend):**
\`\`\`
Principal:     $50,000,000
SOFR Rate:     5.25% (Friday's fixing)
Spread:        0.05%
All-in Rate:   5.30%
Days:          2
Interest:      $14,722.22
\`\`\`

Weekend accrues at Friday's SOFR rate&mdash;the market is closed.

**3. Collateral Valuation:**
\`\`\`
Face Value:        $50,000,000
Market Value:      $51,020,000
Haircut:           2%
Value After Cut:   $50,000,000
Loan Amount:       $50,000,000
Excess Collateral: $1,020,000
Margin Call:       Not Required
\`\`\`

The collateral is worth 2.04% more than the loan&mdash;no margin call needed.

### The Anticipation (Maturity)

At maturity, the repo unwinds:

\`\`\`
Principal Return:     $50,000,000
Accrued Interest:     $   22,083.33
Total Repurchase:     $50,022,083.33
\`\`\`

Plus collateral return:
- UST 4.25% 2028
- Face: $50,000,000
- Expected: Monday 9:00 AM

### The Actions (Two Legs)

**Opening Leg (Friday 4:30 PM):**

*Alpha Capital:*
- Receives $50,000,000 cash via Fedwire
- Delivers UST collateral via DTC

*Money Market Fund:*
- Pays $50,000,000 cash
- Receives UST collateral

**Closing Leg (Monday 9:15 AM):**

*Alpha Capital:*
- Pays $50,022,083.33 cash via Fedwire
- Receives UST collateral via DTC

*Money Market Fund:*
- Receives $50,022,083.33 cash
- Delivers UST collateral

The allocations show how the closing payment covers each day's interest:
- Day 1: $7,361.11
- Days 2-3: $14,722.22
- **Total Interest: $22,083.33**

---

## SOFR: The New Benchmark

SOFR (Secured Overnight Financing Rate) replaced LIBOR as the primary USD benchmark in 2023. Key differences:

| Aspect | LIBOR | SOFR |
|--------|-------|------|
| Basis | Unsecured interbank | Secured repo |
| Calculation | Bank survey | Actual transactions |
| Manipulation risk | High (scandal) | Low (transaction-based) |
| Credit component | Yes | No |

FORAY captures the SOFR fixing date and rate for each accrual period&mdash;critical for audit trail and rate verification.

---

## Repo Market Mechanics

The repo market is enormous&mdash;over $4 trillion daily in the US alone. It's how:
- Dealers finance inventory
- Money market funds earn returns
- The Fed implements monetary policy
- Treasuries circulate efficiently

### Tri-Party vs. Bilateral

This sample shows a **bilateral repo** (direct between parties). **Tri-party repos** use a clearing bank (BNY Mellon or JPMorgan) as custodian:

| Aspect | Bilateral | Tri-Party |
|--------|-----------|-----------|
| Collateral movement | Direct DTC | Via clearing bank |
| Valuation | Each party | Clearing bank |
| Margin calls | Manual | Automated |
| Operational risk | Higher | Lower |

FORAY handles both structures.

---

## Margin and Haircuts

Haircuts protect lenders against collateral price declines:

| Collateral Type | Typical Haircut |
|-----------------|-----------------|
| US Treasuries | 1-2% |
| Agency MBS | 2-4% |
| Corporate bonds | 5-10% |
| Equities | 10-25% |

If collateral value drops below the **margin threshold** (1% in this example), the borrower must post additional collateral or reduce the loan.

FORAY's collateral valuation accrual tracks:
- Current market value
- Haircut applied
- Excess/deficit collateral
- Margin call status

---

## Regulatory Requirements

Repos trigger significant regulatory capital and reporting:

| Regulation | Requirement |
|------------|-------------|
| **Basel III** | Leverage ratio, liquidity coverage |
| **Dodd-Frank** | OFR data collection |
| **SEC 15c3** | Broker-dealer net capital |
| **FINRA 4210** | Margin requirements |

FORAY's compliance flags indicate applicable regulations.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **Two-leg structure** | Opening and closing actions |
| **Daily accruals** | Interest by day with SOFR rates |
| **Collateral tracking** | Market value, haircut, margin status |
| **Reference rate capture** | SOFR fixing date and spread |
| **DTC settlement** | Collateral movement references |

---

## Repo Fails and Settlement Risk

If collateral isn't returned on time, it's a **repo fail**. The Fed monitors fail rates as a market health indicator. FORAY timestamps both legs precisely:

- Opening: January 24, 16:30:00
- Closing: January 27, 09:15:00

This audit trail supports fail tracking and penalty calculations.

---

## Try It Yourself

Load \`overnight-repo-v41.json\` in the Transaction Review tool to see:
- Complete collateral details in the arrangement
- Daily interest accruals with SOFR rate breakdown
- Collateral valuation with margin analysis
- Opening and closing leg actions
- Interest allocation in the closing leg

---

*This narrative accompanies the \`overnight-repo-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      },
      salesforceOpp: {
        title: 'Salesforce Opportunity: CRM Integration',
        content: `
# Salesforce Opportunity: CRM Integration

## The Business Scenario

CloudTech Solutions just closed a major deal. Their sales rep landed MegaCorp Industries as an enterprise customer for the Cloud Platform:

**Opportunity: MegaCorp - Enterprise Cloud Platform**

| Product | Amount | Revenue Type |
|---------|--------|--------------|
| 3-Year Enterprise License | $225,000 | Subscription |
| Implementation Services | $45,000 | Professional Services |
| Training Package | $15,000 | Training |
| **Total Deal** | **$285,000** | |

The opportunity moved through Salesforce stages&mdash;Qualification, Proposal, Negotiation&mdash;and finally **Closed Won** on January 20, 2026.

Now the real work begins: recognizing revenue properly under ASC 606.

---

## How FORAY Models This Transaction

This transaction demonstrates FORAY's **CRM integration pattern**&mdash;linking Salesforce opportunity data to the financial audit trail. Every Salesforce record ID is captured, creating a bridge between CRM and accounting.

### The Arrangement (Salesforce Opportunity)

The opportunity record becomes the arrangement:

**Opportunity Details:**
| Field | Value |
|-------|-------|
| Opportunity Name | MegaCorp - Enterprise Cloud Platform |
| Stage | Closed Won |
| Close Date | January 20, 2026 |
| Amount | $285,000 |
| Probability | 100% |
| Lead Source | Partner Referral |
| Forecast Category | Closed |

**Salesforce Record IDs:**
\`\`\`
Opportunity: 006Dn00000ABC123XYZ
Account:     001Dn00000DEF456UVW
Contact:     003Dn00000GHI789RST
Owner:       005Dn00000JKL012MNO
Quote:       0Q0Dn00000PQR345STU
\`\`\`

These IDs create an unbreakable link between FORAY and Salesforce&mdash;auditors can trace from the blockchain anchor back to the original CRM record.

**Product Lines:**

| Product | Code | Quantity | Unit Price | Total | Recognition |
|---------|------|----------|------------|-------|-------------|
| Enterprise License | ECP-ENT-3YR | 1 | $75,000 | $225,000 | 36 months |
| Implementation | SVC-IMPL-ENT | 1 | $45,000 | $45,000 | 3 months |
| Training | TRN-ENT-PKG | 1 | $15,000 | $15,000 | 1 month |

### The Accruals (ASC 606 Revenue Recognition)

ASC 606 requires revenue recognition when performance obligations are satisfied. Each product line has different recognition timing:

**1. Subscription Revenue (Pro-rated January):**
\`\`\`
Total Contract Value:  $225,000
Contract Term:         36 months
Monthly Revenue:       $  6,250
Recognition Start:     January 20, 2026
Days in January:       12 (of 31)
January Revenue:       $  2,419.35
\`\`\`

This uses the formula \`hash_asc606_subscription\`&mdash;time-based recognition over the contract period.

**2. Implementation Revenue (Milestone-based):**
\`\`\`
Total Service Value:   $45,000
Milestone Completed:   Requirements & Design
Milestone Percentage:  30%
Revenue Recognized:    $13,500
\`\`\`

Implementation uses **percentage of completion** based on milestones:
- Milestone 1: Requirements & Design (30%) &#x2714;
- Milestone 2: Development & Configuration (50%)
- Milestone 3: Go-Live & Acceptance (20%)

**3. Training Revenue (Point-in-time):**
\`\`\`
Training Value:   $15,000
Training Date:    January 22, 2026
Attendees:        25
Revenue:          $15,000 (100%)
\`\`\`

Training is recognized when delivered&mdash;a single point-in-time event.

**4. Accounts Receivable (Invoice):**
\`\`\`
Invoice Number:  INV-2026-001234
Invoice Date:    January 20, 2026
Due Date:        February 19, 2026
Amount:          $135,000
\`\`\`

The invoice covers Year 1 license ($75,000) + implementation ($45,000) + training ($15,000). Years 2-3 of the license will be invoiced annually.

### The Anticipation (Expected Payment)

CloudTech expects payment within 30 days:

\`\`\`
Invoice Amount:      $135,000
Due Date:            February 19, 2026
Early Pay Discount:  2% if within 10 days
Discount Amount:     $2,700
\`\`\`

### The Action (Payment Received)

MegaCorp pays early to capture the discount:

\`\`\`
Payment Date:     January 28, 2026
Gross Amount:     $135,000
Discount Taken:   $  2,700 (2%)
Net Received:     $132,300
Payment Method:   ACH
\`\`\`

**Variance Tracking:**
\`\`\`
Expected:   $135,000
Actual:     $132,300
Difference: -$2,700 (-2.00%)
Reason:     Early payment discount
\`\`\`

**Accounting Entry:**
\`\`\`
Debit:  1000 - Cash                  $132,300
Debit:  6400 - Sales Discounts       $  2,700
Credit: 1200 - Accounts Receivable   $135,000
\`\`\`

---

## The ASC 606 Challenge

Revenue recognition under ASC 606 is complex:

### Five-Step Model
1. **Identify the contract** &rarr; Salesforce opportunity
2. **Identify performance obligations** &rarr; License, implementation, training
3. **Determine transaction price** &rarr; $285,000
4. **Allocate to obligations** &rarr; Based on standalone selling prices
5. **Recognize when satisfied** &rarr; Over time or point-in-time

FORAY captures each step in the component structure.

### Multiple Performance Obligations

This deal has **three distinct performance obligations**:

| Obligation | Recognition Pattern | Timing |
|------------|---------------------|--------|
| License | Over time | 36 months |
| Implementation | Over time (milestones) | 3 months |
| Training | Point-in-time | Day delivered |

Traditional accounting systems struggle with this complexity. FORAY models each obligation as a separate accrual with its own recognition formula.

---

## CRM-to-Cash Integration

The Salesforce integration enables end-to-end traceability:

\`\`\`
Salesforce Opportunity (006Dn00000ABC123XYZ)
         &darr;
FORAY Arrangement (ARR_SF_OPP_ENTERPRISE_2026)
         &darr;
Revenue Accruals (subscription, services, training)
         &darr;
Invoice Accrual (ACC_AR_INVOICE_JAN2026)
         &darr;
Payment Action (ACT_PAYMENT_RECEIVED_001234)
\`\`\`

Every step references the Salesforce Opportunity ID&mdash;auditors can trace from payment back to the original sales opportunity in seconds.

---

## Deferred Revenue Management

At contract signing, the full contract value goes to **Deferred Revenue**:

| Event | Debit | Credit |
|-------|-------|--------|
| Invoice issued | AR $135,000 | Deferred Rev $135,000 |
| Sub rev recognized | Deferred Rev $2,419 | Sub Revenue $2,419 |
| Impl rev recognized | Deferred Rev $13,500 | Services Rev $13,500 |
| Training recognized | Deferred Rev $15,000 | Training Rev $15,000 |

FORAY tracks the deferred revenue balance through each recognition event.

---

## Key v4.1 Features Demonstrated

| Feature | How It's Used |
|---------|---------------|
| **CRM integration** | Salesforce record IDs in every component |
| **Multiple recognition patterns** | Over-time vs. point-in-time |
| **Milestone tracking** | Implementation percentage complete |
| **Discount handling** | Early payment discount with variance |
| **ASC 606 compliance** | Formula IDs for recognition methods |

---

## ERP Adapter Pattern

This sample demonstrates the pattern for FORAY's planned ERP adapters:

\`\`\`
Source System (Salesforce)
         &darr;
Adapter (extracts + transforms)
         &darr;
FORAY JSON
         &darr;
Blockchain Anchor
\`\`\`

The same pattern applies to:
- QuickBooks invoices
- SAP sales orders
- NetSuite transactions
- Workday payroll

---

## Try It Yourself

Load \`salesforce-opportunity-v41.json\` in the Transaction Review tool to see:
- Salesforce record IDs in the arrangement
- Three different revenue recognition accruals
- Milestone details in implementation accrual
- Early payment discount in the action
- Variance explanation for the discount

---

*This narrative accompanies the \`salesforce-opportunity-v41.json\` sample file in the FORAY Protocol v4.1 distribution.*
`
      }
    };

    // Sample Narrative Summaries - Condensed versions
    const sampleNarrativeSummaries = {
      batchPayment: {
        title: "Batch Payment: Many-to-Many References",
        content: `## Summary

**Scenario**: Acme Manufacturing pays GlobalParts Inc for three invoices ($15K + $22.5K + $10K = $47,500) in a single ACH batch payment.

**Key v4.1 Feature**: Many-to-many references &mdash; one Action settles three Anticipations.

**Structure**:
- **Arrangement**: Master Service Agreement (2-year, $500K)
- **Accruals**: 3 invoice obligations
- **Anticipation**: Scheduled batch payment
- **Action**: Single payment with allocations array

**Why It Matters**: Auditors can instantly trace how one payment was allocated across multiple invoices without manual matching.`
      },
      cashSale: {
        title: "Cash Sale: Action-Only Entry Point",
        content: `## Summary

**Scenario**: Coffee shop morning rush &mdash; walk-in customer pays $134.50 cash for office order (lattes, muffins, coffee, bagels).

**Key v4.1 Feature**: Flexible entry point &mdash; transaction starts at Action with no Arrangement needed.

**Structure**:
- **Arrangements**: Empty \`[]\`
- **Accruals**: Empty \`[]\`
- **Anticipations**: Empty \`[]\`
- **Actions**: Single cash receipt with line items

**Why It Matters**: SMBs can use FORAY without creating artificial contracts. A cash sale is just that &mdash; immediate exchange, no credit terms.`
      },
      autoLoan: {
        title: "Auto Loan: Full 4-Component Chain",
        content: `## Summary

**Scenario**: John Doe finances a $35,000 Tesla Model 3 at 5.49% APR for 60 months ($667.33/month).

**Key v4.1 Feature**: Complete dependency chain through all 4 components.

**Structure**:
- **Arrangement**: Retail Installment Contract with collateral (VIN hashed)
- **Accruals**: Monthly interest calculations
- **Anticipations**: Expected payment schedule
- **Actions**: Loan disbursement + monthly payment receipts

**Why It Matters**: Consumer credit requires full auditability. Every payment traces back through interest calculation to the original loan contract.`
      },
      rmbsWaterfall: {
        title: "RMBS Waterfall: Securitization Distribution",
        content: `## Summary

**Scenario**: $100M mortgage-backed security with 3 tranches (AAA/A/BBB) distributes $2.49M monthly collections through strict payment waterfall.

**Key v4.1 Feature**: Complex many-to-many &mdash; pool collections flow to multiple tranches with priority rules.

**Structure**:
- **Arrangements**: 3 tranches (Senior, Mezzanine, Subordinate)
- **Accruals**: Pool collections + 3 interest calculations
- **Anticipation**: Waterfall with 9-step priority
- **Action**: Distribution with interest/principal breakdown per tranche

**Why It Matters**: Post-2008, regulators demand transparency in securitizations. FORAY traces every dollar from borrower payments to investor distributions.`
      },
      energyPPA: {
        title: "Energy PPA: Solar Power Purchase",
        content: `## Summary

**Scenario**: SunPower Utilities buys 38,500 MWh of solar power from Morocco (plus 1,500 MWh curtailed) under a 20-year PPA at &euro;43.18/MWh.

**Key v4.1 Feature**: Multiple accrual types &mdash; energy delivery, curtailment compensation, and RECs.

**Structure**:
- **Arrangement**: 20-year Power Purchase Agreement
- **Accruals**: Energy (&euro;1.66M) + Curtailment (&euro;55K) + RECs (&euro;140K)
- **Anticipation**: Expected payment
- **Actions**: Cash payment (SWIFT) + REC transfer (registry)

**Why It Matters**: Energy transactions involve physical delivery, grid constraints, and environmental certificates &mdash; all captured in one structure.`
      },
      manufacturingWO: {
        title: "Manufacturing: BOM and Cost Allocation",
        content: `## Summary

**Scenario**: Precision Components produces 100 hydraulic actuators. Total cost: $47,848.75 (Materials $26,350 + Labor $12,740 + Overhead $8,759).

**Key v4.1 Feature**: Three-element cost buildup with operation-level labor tracking.

**Structure**:
- **Arrangement**: Work Order with BOM (5 components)
- **Accruals**: Raw materials + Direct labor (by operation) + Overhead
- **Anticipation**: Expected finished goods transfer
- **Action**: FG receipt with lot number and quality cert

**Why It Matters**: Defense contractors (DCAA) and aerospace (AS9100) require detailed cost traceability. Every dollar allocated to the work order is auditable.`
      },
      depreciationEntry: {
        title: "Depreciation: Accrual-Only Entry Point",
        content: `## Summary

**Scenario**: Month-end depreciation for CNC machinery ($25K), vehicles ($3,750), and building ($17,083) = $45,833 total.

**Key v4.1 Feature**: Accrual-only transaction &mdash; no Arrangement, Anticipation, or Action needed.

**Structure**:
- **Arrangements**: Empty \`[]\`
- **Accruals**: 3 depreciation calculations (MACRS + straight-line)
- **Anticipations**: Empty \`[]\`
- **Actions**: Empty \`[]\`

**Why It Matters**: Adjusting entries don't involve contracts or cash. FORAY models what actually happened &mdash; an accounting recognition, nothing more.`
      },
      fxSpot: {
        title: "FX Spot: Multi-Currency Settlement",
        content: `## Summary

**Scenario**: Buy &euro;1,000,000 / Sell $1,085,000 at spot rate 1.0850. T+2 settlement. Market moves to 1.0875 = $2,500 realized gain.

**Key v4.1 Feature**: Dual-currency flows with mark-to-market tracking.

**Structure**:
- **Arrangement**: FX spot contract with nostro accounts
- **Accruals**: Daily mark-to-market valuations
- **Anticipations**: EUR receipt + USD payment (two legs)
- **Actions**: EUR received (SWIFT) + USD paid (Fedwire) + P&L realized

**Why It Matters**: FX trades involve settlement risk (Herstatt) and P&L from rate movements. Both legs and the gain/loss are captured.`
      },
      overnightRepo: {
        title: "Overnight Repo: Collateral and SOFR",
        content: `## Summary

**Scenario**: Borrow $50M overnight against Treasury collateral. Rate: SOFR + 5bps (5.30%). 3-day term (weekend). Interest: $22,083.

**Key v4.1 Feature**: Two-leg structure with collateral tracking and daily SOFR accruals.

**Structure**:
- **Arrangement**: Repo agreement with collateral (UST 4.25% 2028, 2% haircut)
- **Accruals**: Daily interest + Collateral valuation
- **Anticipation**: Maturity settlement
- **Actions**: Opening leg (cash in, collateral out) + Closing leg (reverse)

**Why It Matters**: Repos are critical for market liquidity. Collateral, rates, and margin are all auditable.`
      },
      salesforceOpp: {
        title: "Salesforce Opportunity: CRM Integration",
        content: `## Summary

**Scenario**: CloudTech closes $285K enterprise deal (3-year license $225K + implementation $45K + training $15K). Customer pays early, takes 2% discount.

**Key v4.1 Feature**: CRM integration &mdash; Salesforce record IDs captured for end-to-end traceability.

**Structure**:
- **Arrangement**: Salesforce Opportunity with product lines
- **Accruals**: ASC 606 revenue recognition (subscription/milestone/point-in-time) + AR invoice
- **Anticipation**: Expected payment with early-pay discount option
- **Action**: Payment received ($132,300 after 2% discount)

**Why It Matters**: Opportunity-to-cash is often disconnected. FORAY links CRM records to financial transactions with variance tracking.`
      }
    };

    // Component-specific tips for the 4 A's
    const componentTips = {
      batchPayment: {
        arrangements: "Master Service Agreement (MSA) between Acme & GlobalParts. 2-year contract covering up to $500K in purchases. Terms: Net 30, 2% early payment discount within 10 days, 1.5% late penalty. This is the contractual foundation all invoices reference.",
        accruals: "Three invoice obligations, each referencing the MSA. Each accrual captures: invoice number, date, due date, line items, and accounting entry (Debit: Raw Materials, Credit: Accounts Payable). Uses FixedAmount computation since totals are predetermined.",
        anticipations: "Scheduled batch payment referencing ALL THREE accruals &mdash; this demonstrates v4.1's many-to-many feature. Specifies expected amount ($47,500), planned date, and payment method (ACH).",
        actions: "Single ACH payment with ALLOCATIONS ARRAY showing exact distribution: $15K to invoice 001, $22.5K to invoice 002, $10K to invoice 003. This allocation tracking is critical for auditors matching payments to invoices."
      },
      cashSale: {
        arrangements: null,
        accruals: null,
        anticipations: null,
        actions: "Complete POS transaction capturing everything: register ID, cashier, 6 line items with SKU/price, subtotal ($124.25), tax calculation (8.25% = $10.25), total ($134.50), cash tendered ($140), change given ($5.50). No contract needed &mdash; demonstrates v4.1 flexible entry point."
      },
      autoLoan: {
        arrangements: "Retail Installment Contract with PRIVACY-PROTECTED details: borrower name hashed, VIN hashed. Captures: principal ($35,000), APR (5.49%), term (60 months), monthly payment ($667.33), collateral description.",
        accruals: "Monthly interest calculations using formula: Principal &times; (APR/12). February: $163.25 on $35K balance. March: $145.32 on reduced balance. Formula ID is hashed for privacy while auditors can verify the math.",
        anticipations: "60-month payment schedule. Each anticipation shows: expected date (1st of month), amount ($667.33), breakdown (principal vs interest portions). Creates the amortization schedule auditors need.",
        actions: "Two action types: (1) Disbursement of $35K to dealer, (2) Monthly payment receipts. Each payment shows actual vs expected, enabling variance tracking if borrower pays early/late or different amounts."
      },
      rmbsWaterfall: {
        arrangements: "THREE TRANCHES as separate arrangements: Class A (AAA, $72M, 4.25%), Class B (A, $14.25M, 5.75%), Class C (BBB, $4.75M, 8.25%). Each captures credit rating, subordination level, and coupon rate.",
        accruals: "FOUR calculations: (1) Pool collections from 450 mortgages ($2.49M), (2-4) Interest due to each tranche. Demonstrates how borrower payments flow into the structure before waterfall distribution.",
        anticipations: "9-STEP WATERFALL PRIORITY: 1) Trustee fees, 2) Servicing fees, 3) Class A interest, 4) Class A principal, 5) Class B interest, 6) Class B principal, 7) Class C interest, 8) Class C principal, 9) Residual to equity.",
        actions: "Single distribution action with ALLOCATIONS showing interest/principal breakdown per tranche. This is the transparency 2008 lacked &mdash; every dollar traceable from borrower payment to investor distribution."
      },
      energyPPA: {
        arrangements: "20-year Power Purchase Agreement: 420,000 MWh/year at &euro;42.50/MWh with 1.5% annual escalation. Includes curtailment compensation (85% of foregone revenue) and Renewable Energy Certificates (RECs) at &euro;3.50 each.",
        accruals: "THREE ACCRUAL TYPES: (1) Energy delivery: 38,500 MWh &times; &euro;43.18 = &euro;1.66M, (2) Curtailment: 1,500 MWh &times; &euro;43.18 &times; 85% = &euro;55K, (3) RECs: 40,000 certificates &times; &euro;3.50 = &euro;140K. Shows how physical delivery creates financial obligations.",
        anticipations: "Expected payment combining all three accrual types. Notes payment terms and that REC transfer happens separately from cash settlement.",
        actions: "TWO SETTLEMENT TYPES: (1) Cash payment via SWIFT for energy + curtailment (&euro;1.72M), (2) Registry transfer of 40,000 RECs via EU Guarantees of Origin system. Demonstrates non-cash settlement tracking."
      },
      manufacturingWO: {
        arrangements: "Work Order #500 with BILL OF MATERIALS: 5 components (cylinder body $85, piston assembly $45, seal kit $12.50, control valve $28&times;2, housing $65). BOM version tracked for engineering change control.",
        accruals: "THREE COST ELEMENTS: (1) Raw materials: BOM explosion &times; 100 units = $26,350, (2) Direct labor: 245 hours across 4 operations (machining, assembly, testing, inspection) &times; $52/hr = $12,740, (3) Overhead: 245 hours &times; $35.75/hr = $8,759.",
        anticipations: "Expected transfer of 100 finished goods to inventory. Includes target completion date, expected unit cost ($478.49), and quality requirements (AS9100D aerospace standard).",
        actions: "Finished goods receipt: 100 units transferred with LOT NUMBER for traceability, quality certification reference, 100% yield (0 scrap). Total cost captured: $47,848.75."
      },
      depreciationEntry: {
        arrangements: null,
        accruals: "THREE ASSET CLASSES with different methods: (1) CNC Machinery: MACRS 5-year, $750K cost, $25K/month, (2) Vehicles: Straight-line 5-year, $250K cost, $3,750/month, (3) Building: Straight-line 39-year, $8M cost, $17,083/month. Formula IDs hashed but methods verifiable.",
        anticipations: null,
        actions: null
      },
      fxSpot: {
        arrangements: "FX spot contract: Buy &euro;1M / Sell $1.085M at rate 1.0850. T+2 settlement. Nostro accounts specified: EUR at Deutsche Bank Frankfurt, USD at JPMorgan Chase New York.",
        accruals: "MARK-TO-MARKET valuations: Trade date (T+0): P&L = $0 (at trade rate). T+1: Market moves to 1.0875, creating $2,500 unrealized gain. Daily valuation required for trading book accounting.",
        anticipations: "TWO SETTLEMENT LEGS as separate anticipations: (1) EUR receipt of &euro;1,000,000, (2) USD payment of $1,085,000. Both expected T+2. This split captures Herstatt risk &mdash; the 5-hour gap between EUR and USD settlement.",
        actions: "THREE SETTLEMENTS: (1) EUR received via SWIFT from Deutsche Bank, (2) USD paid via Fedwire to JPMorgan, (3) P&L realization booking $2,500 gain. Variance tracking shows rate movement impact."
      },
      overnightRepo: {
        arrangements: "Repo agreement: $50M principal, SOFR + 5bps rate (5.30%), 3-day term (Friday-Monday). Collateral: $51.02M face value UST 4.25% 2028 with 2% haircut. Governed by SIFMA Master Repo Agreement.",
        accruals: "THREE COMPONENTS: (1) Day 1 interest: $7,361 at Friday's SOFR, (2) Days 2-3 interest: $14,722 (weekend uses Friday rate), (3) Collateral valuation: $51.02M market value, 2.04% margin excess, no margin call needed.",
        anticipations: "Maturity settlement expecting return of principal ($50M) plus total interest ($22,083). Includes collateral return expectation.",
        actions: "TWO LEGS: (1) Opening: Cash received $50M via Fedwire, collateral delivered via DTC participant transfer, (2) Closing: Cash returned $50,022,083, collateral received back. Both legs must match for clean settlement."
      },
      salesforceOpp: {
        arrangements: "Salesforce Opportunity with RECORD IDs: Opportunity 006Dn..., Account 001Dn..., Contact 003Dn..., Quote 0Q0Dn.... Three products: 3-year license ($225K), implementation ($45K), training ($15K). Links CRM to financial record.",
        accruals: "ASC 606 REVENUE RECOGNITION: (1) Subscription: $225K recognized over 36 months ($2,419/month pro-rata), (2) Implementation: $45K recognized at milestones (30% = $13.5K at kickoff), (3) Training: $15K recognized immediately upon delivery. Plus AR invoice accrual of $135K.",
        anticipations: "Expected payment within 30 days with 2% EARLY PAYMENT DISCOUNT option. This creates variance potential &mdash; customer may pay $135K (full) or $132.3K (with discount).",
        actions: "Payment received: Customer took early discount, paid $132,300. VARIANCE captured: Expected $135K, Actual $132.3K, Difference -$2,700 with explanation 'Early payment discount taken.'"
      },
      manukaHoneyProvenance: {
        arrangements: "TWO ARRANGEMENTS establishing authenticity chain: (1) UMF License Agreement with UMFHA (NZ official certifier), (2) Batch Production Record defining 500kg of UMF 15+ Manuka Honey with hive locations, harvest dates, and raw honey analysis. Forms the foundation for all certifications.",
        accruals: "Laboratory analysis from IANZ-accredited Analytica Laboratories. MGO: 514mg/kg, Leptosperin: 185mg/kg, DNA-verified monofloral Manuka. Formula-based UMF grade calculation confirmed at 15+. This scientific testing creates the basis for certification claims.",
        anticipations: "TWO EXPECTED OUTCOMES: (1) UMF certification issuance upon passing lab analysis, (2) MPI export approval enabling international sales. Both anticipations reference the lab analysis accrual as their trigger condition.",
        actions: "UMF certificate issuance action recording certificate number UMF-BATCH-2026-00847 with QR verification URL. This completes the internal certification before export approval.",
        attestations: "THREE-TIER ATTESTATION CHAIN demonstrating trust hierarchy: (1) ATT_LAB_ANALYSIS: Analytica Labs (IANZ/ISO 17025 accredited) attests to chemical analysis results, (2) ATT_UMF_CERTIFICATION: UMF Honey Association (NZ trademark owner) certifies UMF 15+ grade based on lab attestation, (3) ATT_MPI_EXPORT: Ministry for Primary Industries (NZ government) approves export to China, UK, USA, Japan based on UMF certification. Each attestation references its predecessor &mdash; creating a tamper-evident chain of trust from lab bench to export dock."
      }
    };

    // Network Configuration
    const KASPA_NETWORKS = {
      'testnet-10': {
        id: 'testnet-10',
        name: 'Testnet 10',
        description: 'Stable testnet mirroring mainnet (1 BPS)',
        rpcUrl: 'https://api-tn10.kaspa.org',
        explorerUrl: 'https://explorer-tn10.kaspa.org',
        faucetUrl: 'https://faucet-tn10.kaspa.org',
        isTestnet: true,
        bps: 1
      },
      'mainnet': {
        id: 'mainnet',
        name: 'Mainnet',
        description: 'Production network (Real KAS)',
        rpcUrl: 'https://api.kaspa.org',
        explorerUrl: 'https://explorer.kaspa.org',
        faucetUrl: null,
        isTestnet: false,
        bps: 10
      }
    };

    // Main Component
    const ForayTransactionReviewV41 = () => {
      const [jsonInput, setJsonInput] = useState('');
      const [transactionData, setTransactionData] = useState(null);
      const [parseError, setParseError] = useState(null);
      const [validationResult, setValidationResult] = useState(null);
      const [originalVersion, setOriginalVersion] = useState(null);
      const [showSampleDropdown, setShowSampleDropdown] = useState(false);
      const [showNotes, setShowNotes] = useState(false);
      const [showJsonModal, setShowJsonModal] = useState(false);
      const [showNarrativeModal, setShowNarrativeModal] = useState(false);
      const [showNarrativeSummaryModal, setShowNarrativeSummaryModal] = useState(false);
      const [showComponentTip, setShowComponentTip] = useState(null); // 'arrangements', 'accruals', 'anticipations', 'actions'
      const [expandDone, setExpandDone] = useState(false);
      const [currentSampleKey, setCurrentSampleKey] = useState(null);
      const [showAnchorConfirm, setShowAnchorConfirm] = useState(false);
      const [isAnchoring, setIsAnchoring] = useState(false);
      const [anchorResult, setAnchorResult] = useState(null);
      const [selectedNetwork, setSelectedNetwork] = useState('testnet-10');
      const [showNetworkDropdown, setShowNetworkDropdown] = useState(false);
      const [showMainnetWarning, setShowMainnetWarning] = useState(false);
      const [pendingNetworkSwitch, setPendingNetworkSwitch] = useState(null);
      const [walletConnected, setWalletConnected] = useState(false);
      const [walletAddress, setWalletAddress] = useState(null);
      const [expandedSections, setExpandedSections] = useState({
        metadata: true,
        forayCore: true,
        blockchainAnchor: false,
        auditDataAnchor: false,
        arrangements: false,
        accruals: false,
        anticipations: false,
        actions: false,
        attestations: false,
        privacy: false
      });
      
      // Check if all sections are expanded
      const allExpanded = Object.values(expandedSections).every(v => v === true);

      // Check sessionStorage on mount for passed transactions from generator
      useEffect(() => {
        // Check for transaction passed from generator page
        const passedTransaction = sessionStorage.getItem('foray_transaction');
        if (passedTransaction) {
          try {
            const parsed = JSON.parse(passedTransaction);
            const origVersion = parsed.schema_version || parsed.foray_version || parsed._v || '3.0';
            setOriginalVersion(origVersion);
            const migrated = migrateToV41(parsed);
            const validation = validateV41Transaction(migrated);
            setValidationResult(validation);
            setTransactionData(migrated);
            setJsonInput(JSON.stringify(migrated, null, 2));
            // Clear sessionStorage after loading
            sessionStorage.removeItem('foray_transaction');
            console.log('Loaded transaction from generator page');
          } catch (error) {
            console.error('Failed to parse passed transaction:', error);
            setParseError(`Failed to load passed transaction: ${error.message}`);
          }
        }
        
        // Check for sample to load (from reference examples on demo page)
        const sampleToLoad = sessionStorage.getItem('foray_load_sample');
        if (sampleToLoad && sampleTransactions[sampleToLoad]) {
          const sample = sampleTransactions[sampleToLoad];
          setJsonInput(JSON.stringify(sample.data, null, 2));
          setCurrentSampleKey(sampleToLoad);
          // Auto-parse
          const origVersion = sample.data.schema_version || '4.1';
          setOriginalVersion(origVersion);
          const migrated = migrateToV41(sample.data);
          const validation = validateV41Transaction(migrated);
          setValidationResult(validation);
          setTransactionData(migrated);
          sessionStorage.removeItem('foray_load_sample');
          console.log('Loaded sample from demo page:', sampleToLoad);
        }
      }, []);

      // Function to scroll to a component by ID
      const scrollToComponent = (componentId) => {
        // First expand the section containing this component
        if (componentId.startsWith('ARR_')) setExpandedSections(prev => ({ ...prev, arrangements: true }));
        else if (componentId.startsWith('ACC_')) setExpandedSections(prev => ({ ...prev, accruals: true }));
        else if (componentId.startsWith('ANT_')) setExpandedSections(prev => ({ ...prev, anticipations: true }));
        else if (componentId.startsWith('ACT_')) setExpandedSections(prev => ({ ...prev, actions: true }));
        else if (componentId.startsWith('ATT_')) setExpandedSections(prev => ({ ...prev, attestations: true }));
        
        // Small delay to allow section to expand before scrolling
        setTimeout(() => {
          const el = document.getElementById(`component-${componentId}`);
          if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Flash highlight effect
            el.style.transition = 'box-shadow 0.3s ease';
            el.style.boxShadow = `0 0 0 3px ${forayColors.actionAmber}`;
            setTimeout(() => {
              el.style.boxShadow = 'none';
            }, 2000);
          }
        }, 150);
      };

      // Get current network config
      const currentNetwork = KASPA_NETWORKS[selectedNetwork];

      // Handle network change
      const handleNetworkChange = (networkId) => {
        if (networkId === 'mainnet' && selectedNetwork !== 'mainnet') {
          setPendingNetworkSwitch(networkId);
          setShowMainnetWarning(true);
          setShowNetworkDropdown(false);
        } else {
          setSelectedNetwork(networkId);
          setShowNetworkDropdown(false);
        }
      };

      // Confirm mainnet switch
      const confirmMainnetSwitch = () => {
        setSelectedNetwork(pendingNetworkSwitch);
        setShowMainnetWarning(false);
        setPendingNetworkSwitch(null);
      };

      // Cancel mainnet switch
      const cancelMainnetSwitch = () => {
        setShowMainnetWarning(false);
        setPendingNetworkSwitch(null);
      };

      // Check if KasWare wallet is available
      const isKasWareAvailable = () => {
        return typeof window !== 'undefined' && window.kasware;
      };

      // Get KasWare network name for our network ID
      const getKasWareNetworkName = (networkId) => {
        if (networkId === 'mainnet') return 'mainnet';
        return 'testnet'; // KasWare uses 'testnet' for all testnets
      };

      // Connect to KasWare wallet
      const connectWallet = async () => {
        if (!isKasWareAvailable()) {
          alert('KasWare wallet not detected!\n\nPlease install the KasWare browser extension from:\nhttps://kasware.xyz\n\nThen refresh this page and try again.');
          return;
        }

        try {
          // Request account access
          const accounts = await window.kasware.requestAccounts();
          if (accounts && accounts.length > 0) {
            setWalletAddress(accounts[0]);
            setWalletConnected(true);
            
            // Check and sync network
            const walletNetwork = await window.kasware.getNetwork();
            const expectedNetwork = getKasWareNetworkName(selectedNetwork);
            
            // KasWare returns network as string or number depending on version
            const isTestnet = walletNetwork === 'testnet' || walletNetwork === 1;
            const isMainnet = walletNetwork === 'mainnet' || walletNetwork === 0;
            
            if (selectedNetwork === 'mainnet' && !isMainnet) {
              alert('Note: Your KasWare wallet is on Testnet. Please switch to Mainnet in KasWare settings if you want to anchor to Mainnet.');
            } else if (selectedNetwork !== 'mainnet' && !isTestnet) {
              alert('Note: Your KasWare wallet is on Mainnet. Please switch to Testnet in KasWare settings for testing.');
            }
          }
        } catch (err) {
          console.error('Wallet connection error:', err);
          alert('Failed to connect wallet: ' + (err.message || 'Unknown error'));
        }
      };

      // Disconnect wallet
      const disconnectWallet = async () => {
        if (isKasWareAvailable()) {
          try {
            await window.kasware.disconnect(window.location.origin);
          } catch (err) {
            console.log('Disconnect error (non-critical):', err);
          }
        }
        setWalletConnected(false);
        setWalletAddress(null);
      };

      // Compute a simple hash of the transaction data for anchoring
      const computeTransactionHash = async (txData) => {
        const dataString = JSON.stringify(txData);
        const encoder = new TextEncoder();
        const data = encoder.encode(dataString);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
      };

      // Handle blockchain anchoring - REAL KasWare integration
      const handleAnchorToBlockchain = async () => {
        setShowAnchorConfirm(false);
        setIsAnchoring(true);
        
        try {
          // Check wallet connection
          if (!walletConnected || !walletAddress) {
            throw new Error('Wallet not connected. Please connect your KasWare wallet first.');
          }

          if (!isKasWareAvailable()) {
            throw new Error('KasWare wallet not available.');
          }

          // Compute the merkle root / hash of the transaction
          const merkleRoot = await computeTransactionHash(transactionData);
          const startTime = Date.now();

          // Send a transaction to ourselves that satisfies KIP-9 storage mass requirements
          // KIP-9 penalizes small UTXOs to prevent state bloat - we need ~0.2 KAS minimum
          // The transaction itself serves as the anchor - the tx ID is the proof
          // Note: In production, FORAY uses chunked multi-transaction anchoring for full data
          const txResponse = await window.kasware.sendKaspa(
            walletAddress,  // Send to self
            20000000        // 0.2 KAS in sompi (satisfies KIP-9 storage mass)
          );

          const confirmationTime = Date.now() - startTime;

          if (!txResponse) {
            throw new Error('Transaction failed - no transaction ID returned');
          }

          // Extract the transaction ID - KasWare returns complex object
          // Response structure: {id: "txhash", inputs: [...], outputs: [...], ...}
          let txId;
          if (typeof txResponse === 'string') {
            // If it's already a string, check if it's JSON
            try {
              const parsed = JSON.parse(txResponse);
              txId = parsed.id || parsed.txid || parsed.transactionId || txResponse;
            } catch {
              txId = txResponse;
            }
          } else if (typeof txResponse === 'object') {
            // Direct object - extract the id field
            txId = txResponse.id || txResponse.txid || txResponse.transactionId;
            if (!txId) {
              // Log for debugging
              console.log('KasWare response structure:', Object.keys(txResponse));
              console.log('Full response:', JSON.stringify(txResponse).substring(0, 200));
            }
          }
          
          if (!txId) {
            throw new Error('Could not extract transaction ID from response');
          }

          // Build the result with real transaction ID
          const result = {
            success: true,
            timestamp: new Date().toISOString(),
            kaspa: {
              transaction_id: txId,
              block_height: 'Pending confirmation',
              block_hash: 'Pending confirmation',
              confirmations: 0,
              confirmation_time_ms: confirmationTime,
              explorer_url: `${currentNetwork.explorerUrl}/txs/${txId}`
            },
            foray: {
              transaction_id: transactionData.transaction_id,
              schema_version: transactionData.schema_version,
              merkle_root: `sha256:${merkleRoot.substring(0, 32)}...`,
              entity: transactionData.foray_core?.entity || 'Unknown Entity',
              total_value: transactionData.foray_core?.total_value || 0,
              currency: transactionData.foray_core?.currency || 'USD',
              component_summary: {
                arrangements: transactionData.arrangements?.length || 0,
                accruals: transactionData.accruals?.length || 0,
                anticipations: transactionData.anticipations?.length || 0,
                actions: transactionData.actions?.length || 0,
                attestations: transactionData.attestations?.length || 0
              }
            },
            anchored_by: `Wallet: ${walletAddress.substring(0, 20)}...`,
            network: currentNetwork.name
          };

          setAnchorResult(result);

        } catch (err) {
          console.error('Anchoring error:', err);
          alert('Anchoring failed: ' + (err.message || 'Unknown error') + '\n\nMake sure you have enough test KAS in your wallet.');
        } finally {
          setIsAnchoring(false);
        }
      };

      // Print anchor result
      const handlePrintAnchorResult = () => {
        window.print();
      };

      // Copy anchor details to clipboard
      const copyAnchorDetails = () => {
        const details = `FORAY Blockchain Anchor Verification
=====================================
Timestamp: ${anchorResult.timestamp}

KASPA BLOCKCHAIN
Transaction ID: ${anchorResult.kaspa.transaction_id}
Block Height: ${anchorResult.kaspa.block_height}
Block Hash: ${anchorResult.kaspa.block_hash}
Confirmations: ${anchorResult.kaspa.confirmations}
Confirmation Time: ${anchorResult.kaspa.confirmation_time_ms}ms
Explorer: ${anchorResult.kaspa.explorer_url}

FORAY TRANSACTION
Transaction ID: ${anchorResult.foray.transaction_id}
Schema Version: ${anchorResult.foray.schema_version}
Merkle Root: ${anchorResult.foray.merkle_root}
Entity: ${anchorResult.foray.entity}
Total Value: ${anchorResult.foray.total_value} ${anchorResult.foray.currency}
Components: ${anchorResult.foray.component_summary.arrangements} Arrangements, ${anchorResult.foray.component_summary.accruals} Accruals, ${anchorResult.foray.component_summary.anticipations} Anticipations, ${anchorResult.foray.component_summary.actions} Actions${anchorResult.foray.component_summary.attestations > 0 ? `, ${anchorResult.foray.component_summary.attestations} Attestations` : ''}

Network: ${anchorResult.network}
Anchored By: ${anchorResult.anchored_by}`;
        
        navigator.clipboard.writeText(details);
        alert('Anchor details copied to clipboard!');
      };

      const formatCurrency = (amount, currency = 'USD') => {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount || 0);
      };

      const parseJSON = () => {
        try {
          setParseError(null);
          const parsed = JSON.parse(jsonInput);
          const origVersion = parsed.schema_version || parsed._v || '3.0';
          setOriginalVersion(origVersion);
          const migrated = migrateToV41(parsed);
          const validation = validateV41Transaction(migrated);
          setValidationResult(validation);
          setTransactionData(migrated);
        } catch (error) {
          setParseError(`Invalid JSON: ${error.message}`);
          setTransactionData(null);
          setValidationResult(null);
        }
      };

      const loadSampleTransaction = (sampleKey) => {
        const sample = sampleTransactions[sampleKey];
        if (sample) {
          setJsonInput(JSON.stringify(sample.data, null, 2));
          setCurrentSampleKey(sampleKey);
          setShowSampleDropdown(false);
        }
      };

      const clearTransaction = () => {
        // Navigate to the Generator page instead of just clearing
        window.location.href = 'demo.html';
      };

      const resetToInput = () => {
        setTransactionData(null);
        setJsonInput('');
        setParseError(null);
        setValidationResult(null);
        setOriginalVersion(null);
        setCurrentSampleKey(null);
        setExpandedSections(Object.keys(expandedSections).reduce((acc, key) => ({ ...acc, [key]: false }), {}));
        setShowComponentTip(null);
        setExpandDone(false);
      };

      const toggleSection = (section) => {
        setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
      };

      const expandAll = () => {
        setExpandedSections(Object.keys(expandedSections).reduce((acc, key) => ({ ...acc, [key]: true }), {}));
        setExpandDone(true);
        setTimeout(() => setExpandDone(false), 2000);
      };

      const collapseAll = () => {
        setExpandedSections(Object.keys(expandedSections).reduce((acc, key) => ({ ...acc, [key]: false }), {}));
      };

      const handlePrint = () => {
        // Expand all sections before printing
        expandAll();
        // Wait for state update, then print
        setTimeout(() => {
          window.print();
        }, 100);
      };

      const getForayCore = (component) => component.foray_core || component;

      return (
        <div className="min-h-screen p-6" style={{ background: `linear-gradient(to bottom right, ${forayColors.bgLight}, #E8F4F5)` }}>
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="mb-8">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-3">
                  <h1 className="text-3xl font-bold">
                    <span style={{ color: forayColors.primaryTeal }}>FORAY</span>{' '}
                    <span style={{ color: forayColors.highlightMint }}>Protocol</span>{' '}
                    <span style={{ color: forayColors.secondaryNavy }}>Transaction Review</span>
                  </h1>
                  <span className="px-2 py-1 text-xs font-bold rounded" style={{ backgroundColor: forayColors.actionAmber, color: 'white' }}>v4.1</span>
                </div>
                
                {/* Network & Wallet Controls */}
                <div className="flex items-center gap-3">
                  {/* Network Selector */}
                  <div className="relative">
                    <button 
                      onClick={() => setShowNetworkDropdown(!showNetworkDropdown)}
                      className="px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2"
                      style={{ 
                        backgroundColor: '#F3E8FF',
                        color: '#7C3AED',
                        border: '1px solid #C4B5FD'
                      }}
                    >
                      <GitBranch className="w-4 h-4" />
                      {currentNetwork.name}
                      {currentNetwork.isTestnet && <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: '#7C3AED', color: 'white' }}>TEST</span>}
                      {!currentNetwork.isTestnet && <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: forayColors.errorRed, color: 'white' }}>LIVE</span>}
                      <ChevronDown className="w-3 h-3" style={{ transform: showNetworkDropdown ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
                    </button>
                    {showNetworkDropdown && (
                      <div className="absolute top-full right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border z-50" style={{ borderColor: '#C4B5FD' }}>
                        <div className="p-2 border-b text-xs font-medium" style={{ borderColor: '#C4B5FD', color: '#7C3AED' }}>
                          Select Kaspa Network
                        </div>
                        {Object.values(KASPA_NETWORKS).map((network) => (
                          <button
                            key={network.id}
                            onClick={() => network.id !== 'mainnet' && handleNetworkChange(network.id)}
                            disabled={network.id === 'mainnet'}
                            className={`w-full text-left px-4 py-3 flex items-center justify-between ${network.id === 'mainnet' ? 'opacity-50 cursor-not-allowed' : 'hover:bg-purple-50 cursor-pointer'}`}
                            style={{ backgroundColor: selectedNetwork === network.id ? '#F3E8FF' : 'transparent' }}
                            data-tooltip={network.id === 'mainnet' ? 'Disabled for Kaspathon demo' : null}
                          >
                            <div>
                              <div className="flex items-center gap-2">
                                <p className="font-medium" style={{ color: network.id === 'mainnet' ? forayColors.gray400 : '#7C3AED' }}>{network.name}</p>
                                {network.isTestnet ? (
                                  <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: '#EDE9FE', color: '#7C3AED' }}>Testnet</span>
                                ) : (
                                  <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: `${forayColors.gray400}20`, color: forayColors.gray400 }}>Mainnet</span>
                                )}
                                {network.id === 'mainnet' && (
                                  <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: `${forayColors.gray400}20`, color: forayColors.gray600 }}>Demo</span>
                                )}
                              </div>
                              <p className="text-xs mt-0.5" style={{ color: network.id === 'mainnet' ? forayColors.gray400 : forayColors.gray600 }}>
                                {network.id === 'mainnet' ? 'Disabled for Kaspathon demo' : network.description}
                              </p>
                            </div>
                            {selectedNetwork === network.id && (
                              <CheckCircle className="w-4 h-4" style={{ color: forayColors.successGreen }} />
                            )}
                          </button>
                        ))}
                        {currentNetwork.faucetUrl && (
                          <div className="p-3 border-t" style={{ borderColor: '#C4B5FD' }}>
                            <a 
                              href={currentNetwork.faucetUrl} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="text-xs flex items-center gap-1"
                              style={{ color: '#7C3AED' }}
                            >
                              <DollarSign className="w-3 h-3" /> Get free test KAS from faucet &rarr;
                            </a>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  
                  {/* Wallet Connection */}
                  {!walletConnected ? (
                    <button 
                      onClick={connectWallet}
                      className="px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2"
                      style={{ backgroundColor: forayColors.secondaryNavy, color: 'white' }}
                    >
                      <Wallet className="w-5 h-5" />
                      Connect Wallet
                    </button>
                  ) : (
                    <div className="flex items-center gap-2">
                      <div className="px-3 py-2 rounded-lg text-sm flex items-center gap-2" style={{ backgroundColor: `${forayColors.successGreen}20`, color: forayColors.successGreen }}>
                        <CheckCircle className="w-4 h-4" />
                        <span className="font-mono text-xs">{walletAddress?.substring(0, 15)}...</span>
                      </div>
                      <button 
                        onClick={disconnectWallet}
                        className="p-2 rounded-lg hover:bg-gray-100"
                        data-tooltip="Disconnect wallet"
                      >
                        <X className="w-4 h-4" style={{ color: forayColors.gray600 }} />
                      </button>
                    </div>
                  )}
                </div>
              </div>
              <p style={{ color: forayColors.gray600 }}>Blockchain audit trails with many-to-many reference support</p>
            </div>

            {/* Input Section */}
            {!transactionData && (
              <Card className="mb-6">
                <div className="flex items-center gap-3 mb-4">
                  <Upload className="w-6 h-6" style={{ color: forayColors.primaryTeal }} />
                  <div>
                    <h2 className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Load Transaction JSON</h2>
                    <p className="text-sm" style={{ color: forayColors.gray600 }}>Paste FORAY Protocol JSON (v3.0, v4.0, or v4.1 - auto-migrates to v4.1)</p>
                  </div>
                </div>
                
                <textarea
                  value={jsonInput}
                  onChange={(e) => setJsonInput(e.target.value)}
                  placeholder={`{\n  "transaction_id": "FORAY_TX_001",\n  "schema_version": "4.1",\n  "foray_core": { ... },\n  "arrangements": [...],\n  ...\n}`}
                  className="w-full h-80 p-4 border rounded-lg focus:outline-none focus:ring-2 font-mono text-sm"
                  style={{ borderColor: forayColors.gray400 }}
                />
                
                {parseError && (
                  <div className="mt-3 p-3 rounded-lg flex items-center gap-2" style={{ backgroundColor: '#fee2e2', color: '#b91c1c' }}>
                    <AlertCircle className="w-4 h-4" />
                    <span className="text-sm">{parseError}</span>
                  </div>
                )}
                
                <div className="mt-4 flex gap-3">
                  <button onClick={parseJSON} className="px-6 py-2.5 text-white rounded-lg font-medium" style={{ backgroundColor: forayColors.primaryTeal }}>
                    Parse & Review
                  </button>
                </div>
              </Card>
            )}

            {/* Transaction Display */}
            {transactionData && (
              <div className="space-y-4">
                {/* Version & Validation Banner */}
                <Card>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2">
                        <Layers className="w-5 h-5" style={{ color: forayColors.primaryTeal }} />
                        <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Schema Version:</span>
                        <span className="px-2 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.primaryTeal}20`, color: forayColors.primaryTeal }}>
                          {transactionData.schema_version}
                        </span>
                        {originalVersion !== transactionData.schema_version && (
                          <span className="text-xs" style={{ color: forayColors.gray600 }}>(migrated from {originalVersion})</span>
                        )}
                      </div>
                      
                      {validationResult && (
                        <div className="flex items-center gap-2">
                          {validationResult.valid ? (
                            <>
                              <CheckCircle className="w-5 h-5" style={{ color: forayColors.successGreen }} />
                              <span className="text-sm font-medium" style={{ color: forayColors.successGreen }}>Valid Transaction</span>
                            </>
                          ) : (
                            <>
                              <AlertCircle className="w-5 h-5" style={{ color: forayColors.errorRed }} />
                              <span className="text-sm font-medium" style={{ color: forayColors.errorRed }}>{validationResult.errors.length} Validation Error(s)</span>
                            </>
                          )}
                        </div>
                      )}
                    </div>
                    
                    <div className="flex gap-1.5 no-print">
                      <button onClick={clearTransaction} className="px-2.5 py-1.5 text-xs rounded flex items-center gap-1.5" style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}>
                        <ArrowLeft className="w-3.5 h-3.5" /> Create Another
                      </button>
                      <button onClick={handlePrint} className="px-2.5 py-1.5 text-xs rounded flex items-center gap-1.5" style={{ backgroundColor: forayColors.secondaryNavy, color: 'white' }}>
                        <Printer className="w-3.5 h-3.5" /> Print/PDF
                      </button>
                      <button onClick={() => setShowNotes(true)} className="px-2.5 py-1.5 text-xs rounded flex items-center gap-1.5" style={{ backgroundColor: forayColors.highlightMint, color: forayColors.secondaryNavy }}>
                        <FileText className="w-3.5 h-3.5" /> Notes
                      </button>
                      <button onClick={() => setShowJsonModal(true)} className="px-2.5 py-1.5 text-xs rounded flex items-center gap-1.5" style={{ backgroundColor: forayColors.highlightMint, color: forayColors.secondaryNavy }}>
                        <FileText className="w-3.5 h-3.5" /> JSON
                      </button>
                      <button 
                        onClick={() => {
                          if (!walletConnected) {
                            alert('Please connect your KasWare wallet first using the "Connect Wallet" button in the header.');
                            return;
                          }
                          setShowAnchorConfirm(true);
                        }} 
                        className="px-2.5 py-1.5 text-xs rounded flex items-center gap-1.5" 
                        style={{ 
                          backgroundColor: walletConnected ? forayColors.secondaryNavy : forayColors.gray400, 
                          color: 'white',
                          cursor: walletConnected ? 'pointer' : 'not-allowed'
                        }}
                        data-tooltip={walletConnected ? 'Anchor to blockchain' : 'Connect wallet first'}
                      >
                        <Link2 className="w-3.5 h-3.5" /> Anchor
                      </button>
                    </div>
                  </div>
                  
                  {/* Component Counts */}
                  {validationResult && (
                    <div className="mt-4 flex flex-wrap items-center gap-4">
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Arrangements:</span>
                        <span className="font-bold" style={{ color: forayColors.primaryTeal }}>{validationResult.componentCounts.arrangements}</span>
                      </div>
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Accruals:</span>
                        <span className="font-bold" style={{ color: forayColors.accentCyan }}>{validationResult.componentCounts.accruals}</span>
                      </div>
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Anticipations:</span>
                        <span className="font-bold" style={{ color: forayColors.actionAmber }}>{validationResult.componentCounts.anticipations}</span>
                      </div>
                      <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: `${forayColors.successGreen}10` }}>
                        <span className="text-sm" style={{ color: forayColors.gray600 }}>Actions:</span>
                        <span className="font-bold" style={{ color: forayColors.successGreen }}>{validationResult.componentCounts.actions}</span>
                      </div>
                      {validationResult.componentCounts.attestations > 0 && (
                        <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: '#8B5CF610' }}>
                          <span className="text-sm" style={{ color: forayColors.gray600 }}>Attestations:</span>
                          <span className="font-bold" style={{ color: '#8B5CF6' }}>{validationResult.componentCounts.attestations}</span>
                        </div>
                      )}
                      {validationResult.entryPointType && (
                        <div className="flex items-center gap-2 px-3 py-1.5 rounded" style={{ backgroundColor: '#f3e8ff' }}>
                          <span className="text-sm" style={{ color: forayColors.gray600 }}>Entry Point:</span>
                          <span className="font-bold capitalize" style={{ color: '#7c3aed' }}>{validationResult.entryPointType}</span>
                        </div>
                      )}
                    </div>
                  )}
                  
                  {validationResult?.errors?.length > 0 && (
                    <div className="mt-4 p-3 rounded-lg" style={{ backgroundColor: '#fee2e2' }}>
                      <p className="font-medium text-sm mb-2" style={{ color: '#b91c1c' }}>Validation Errors:</p>
                      <ul className="text-sm space-y-1" style={{ color: '#b91c1c' }}>
                        {validationResult.errors.map((err, idx) => <li key={idx}>&bull; {err}</li>)}
                      </ul>
                    </div>
                  )}
                </Card>

                {/* Transaction Metadata */}
                <div>
                  <SectionHeader 
                    title="Transaction Metadata" 
                    icon={FileText} 
                    isExpanded={expandedSections.metadata} 
                    onToggle={() => toggleSection('metadata')}
                    action={
                      <div className="flex items-center gap-2">
                        {currentSampleKey && sampleNarratives[currentSampleKey] && (
                          <>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setShowNarrativeSummaryModal(true);
                              }}
                              className="px-3 py-1.5 text-xs rounded-lg flex items-center gap-1.5 no-print"
                              style={{ 
                                backgroundColor: forayColors.highlightMint,
                                color: forayColors.secondaryNavy
                              }}
                              
                            >
                              <BookOpen className="w-4 h-4" />
                              Summary
                            </button>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setShowNarrativeModal(true);
                              }}
                              className="px-3 py-1.5 text-xs rounded-lg flex items-center gap-1.5 no-print"
                              style={{ 
                                backgroundColor: forayColors.actionAmber,
                                color: forayColors.textDark
                              }}
                              
                            >
                              <BookOpen className="w-4 h-4" />
                              Full Narrative
                            </button>
                          </>
                        )}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (allExpanded) {
                              collapseAll();
                            } else {
                              expandAll();
                            }
                          }}
                          className="px-3 py-1.5 text-xs rounded-lg flex items-center gap-1.5 no-print"
                          style={{ 
                            backgroundColor: expandDone ? forayColors.successGreen : forayColors.primaryTeal,
                            color: 'white'
                          }}
                          
                        >
                          {expandDone ? (
                            <>
                              <CheckCircle className="w-4 h-4" />
                              Done
                            </>
                          ) : allExpanded ? (
                            <>
                              <ChevronRight className="w-4 h-4" />
                              Collapse All
                            </>
                          ) : (
                            <>
                              <ChevronDown className="w-4 h-4" />
                              Expand All
                            </>
                          )}
                        </button>
                      </div>
                    }
                  />
                  {expandedSections.metadata && (
                    <Card className="mt-2">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                          <KeyValue label="Transaction ID" value={transactionData.transaction_id} mono />
                          <KeyValue label="Timestamp" value={transactionData.timestamp} />
                          <KeyValue label="Schema Version" value={transactionData.schema_version} />
                        </div>
                        <div>
                          <KeyValue label="Merkle Root" value={transactionData.merkle_root?.substring(0, 24) + '...'} mono />
                        </div>
                      </div>
                    </Card>
                  )}
                </div>

                {/* FORAY Core */}
                {transactionData.foray_core && (
                  <div>
                    <SectionHeader title="FORAY Core" icon={Layers} isExpanded={expandedSections.forayCore} onToggle={() => toggleSection('forayCore')} badge="v4.1" />
                    {expandedSections.forayCore && (
                      <Card className="mt-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <KeyValue label="Entity" value={transactionData.foray_core.entity} />
                            <KeyValue label="Entity Hash" value={transactionData.foray_core.entity_hash?.substring(0, 20) + '...'} mono />
                            <KeyValue label="Transaction Type" value={transactionData.foray_core.transaction_type} />
                          </div>
                          <div>
                            <KeyValue label="Total Value" value={formatCurrency(transactionData.foray_core.total_value, transactionData.foray_core.currency)} />
                            <KeyValue label="Currency" value={transactionData.foray_core.currency} />
                            <div className="flex justify-between items-center py-2">
                              <span className="text-sm" style={{ color: forayColors.gray600 }}>Status</span>
                              <StatusBadge status={transactionData.foray_core.status} />
                            </div>
                          </div>
                        </div>
                        {transactionData.foray_core.compliance_flags?.length > 0 && (
                          <div className="mt-4 pt-4" style={{ borderTop: `1px solid ${forayColors.gray400}30` }}>
                            <p className="text-sm font-medium mb-2" style={{ color: forayColors.gray600 }}>Compliance Flags</p>
                            <div className="flex flex-wrap gap-2">
                              {transactionData.foray_core.compliance_flags.map((flag, idx) => (
                                <span key={idx} className="px-2 py-1 text-xs rounded" style={{ backgroundColor: `${forayColors.secondaryNavy}15`, color: forayColors.secondaryNavy }}>{flag}</span>
                              ))}
                            </div>
                          </div>
                        )}
                      </Card>
                    )}
                  </div>
                )}

                {/* Blockchain Anchor */}
                {transactionData.blockchain_anchor && (
                  <div>
                    <SectionHeader title="Blockchain Anchor" icon={Lock} isExpanded={expandedSections.blockchainAnchor} onToggle={() => toggleSection('blockchainAnchor')} />
                    {expandedSections.blockchainAnchor && (
                      <Card className="mt-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <KeyValue label="Kaspa TX ID" value={transactionData.blockchain_anchor.kaspa_tx_id?.substring(0, 30) + '...'} mono />
                            <KeyValue label="Block Height" value={transactionData.blockchain_anchor.block_height?.toLocaleString()} />
                          </div>
                          <div>
                            <KeyValue label="Confirmation Time" value={`${transactionData.blockchain_anchor.confirmation_time_ms || 'N/A'} ms`} />
                            <KeyValue label="Anchored At" value={transactionData.blockchain_anchor.anchored_at} />
                          </div>
                        </div>
                      </Card>
                    )}
                  </div>
                )}

                {/* Arrangements */}
                {transactionData.arrangements?.length > 0 && (
                  <div>
                    <SectionHeader 
                      title="Arrangements" 
                      icon={Users} 
                      isExpanded={expandedSections.arrangements} 
                      onToggle={() => toggleSection('arrangements')} 
                      count={transactionData.arrangements.length}
                      action={currentSampleKey && componentTips[currentSampleKey]?.arrangements && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowComponentTip(showComponentTip === 'arrangements' ? null : 'arrangements');
                          }}
                          className="p-1.5 rounded-lg no-print"
                          style={{ 
                            backgroundColor: showComponentTip === 'arrangements' ? forayColors.primaryTeal : 'transparent',
                            color: showComponentTip === 'arrangements' ? 'white' : forayColors.primaryTeal
                          }}
                          data-tooltip="About Arrangements in this sample"
                        >
                          <Info className="w-6 h-6" />
                        </button>
                      )}
                    />
                    {showComponentTip === 'arrangements' && currentSampleKey && componentTips[currentSampleKey]?.arrangements && (
                      <div className="mt-2 p-4 rounded-lg border-l-4 no-print" style={{ backgroundColor: `${forayColors.primaryTeal}08`, borderColor: forayColors.primaryTeal }}>
                        <div className="flex items-start gap-3">
                          <Info className="w-5 h-5 flex-shrink-0 mt-0.5" style={{ color: forayColors.primaryTeal }} />
                          <div>
                            <p className="text-sm font-semibold mb-1" style={{ color: forayColors.secondaryNavy }}>About Arrangements in this sample</p>
                            <p className="text-sm" style={{ color: forayColors.gray600 }}>{componentTips[currentSampleKey].arrangements}</p>
                          </div>
                        </div>
                      </div>
                    )}
                    {expandedSections.arrangements && (
                      <div className="mt-2 space-y-3">
                        {transactionData.arrangements.map((arr, idx) => {
                          const core = getForayCore(arr);
                          return (
                            <Card key={idx} id={`component-${arr.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.primaryTeal}15`, color: forayColors.primaryTeal }}>{arr.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                </div>
                                {core.effective_date && (
                                  <span className="text-sm" style={{ color: forayColors.gray600 }}>Effective: {new Date(core.effective_date).toLocaleDateString()}</span>
                                )}
                              </div>
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.total_value && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Total Value</p>
                                  <p className="text-xl font-bold" style={{ color: forayColors.primaryTeal }}>{formatCurrency(core.total_value, core.currency)}</p>
                                </div>
                              )}
                              {core.parties?.length > 0 && (
                                <div className="mb-4">
                                  <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>Parties</p>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {core.parties.map((party, pIdx) => (
                                      <div key={pIdx} className="p-2 rounded text-sm" style={{ backgroundColor: forayColors.bgLight }}>
                                        <span className="font-medium capitalize">{party.role}: </span>
                                        <span style={{ color: forayColors.gray600 }}>{party.name}</span>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              )}
                              {renderObjectAsTable(core.terms, 'Terms')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Accruals */}
                {transactionData.accruals?.length > 0 && (
                  <div>
                    <SectionHeader 
                      title="Accruals" 
                      icon={TrendingUp} 
                      isExpanded={expandedSections.accruals} 
                      onToggle={() => toggleSection('accruals')} 
                      count={transactionData.accruals.length}
                      action={currentSampleKey && componentTips[currentSampleKey]?.accruals && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowComponentTip(showComponentTip === 'accruals' ? null : 'accruals');
                          }}
                          className="p-1.5 rounded-lg no-print"
                          style={{ 
                            backgroundColor: showComponentTip === 'accruals' ? forayColors.accentCyan : 'transparent',
                            color: showComponentTip === 'accruals' ? 'white' : forayColors.accentCyan
                          }}
                          data-tooltip="About Accruals in this sample"
                        >
                          <Info className="w-6 h-6" />
                        </button>
                      )}
                    />
                    {showComponentTip === 'accruals' && currentSampleKey && componentTips[currentSampleKey]?.accruals && (
                      <div className="mt-2 p-4 rounded-lg border-l-4 no-print" style={{ backgroundColor: `${forayColors.accentCyan}08`, borderColor: forayColors.accentCyan }}>
                        <div className="flex items-start gap-3">
                          <Info className="w-5 h-5 flex-shrink-0 mt-0.5" style={{ color: forayColors.accentCyan }} />
                          <div>
                            <p className="text-sm font-semibold mb-1" style={{ color: forayColors.secondaryNavy }}>About Accruals in this sample</p>
                            <p className="text-sm" style={{ color: forayColors.gray600 }}>{componentTips[currentSampleKey].accruals}</p>
                          </div>
                        </div>
                      </div>
                    )}
                    {expandedSections.accruals && (
                      <div className="mt-2 space-y-3">
                        {transactionData.accruals.map((acc, idx) => {
                          const core = getForayCore(acc);
                          return (
                            <Card key={idx} id={`component-${acc.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.accentCyan}15`, color: forayColors.accentCyan }}>{acc.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                  {core.computation_method && <span className="px-2 py-0.5 text-xs rounded" style={{ backgroundColor: '#f3e8ff', color: '#7c3aed' }}>{core.computation_method}</span>}
                                </div>
                              </div>
                              <ReferencesDisplay refs={core.arrangement_refs} refType="arrangement" label="Arrangement References" onNavigate={scrollToComponent} />
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.output !== undefined && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Computed Output</p>
                                  <p className="text-xl font-bold" style={{ color: forayColors.accentCyan }}>{formatCurrency(core.output, core.currency)}</p>
                                </div>
                              )}
                              {core.accounting_entry && (
                                <div className="mt-4 p-3 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                                  <p className="text-xs font-medium mb-2" style={{ color: forayColors.gray600 }}>Accounting Entry</p>
                                  <div className="grid grid-cols-2 gap-4">
                                    <div className="p-2 rounded" style={{ backgroundColor: '#fef3c7' }}>
                                      <p className="text-xs" style={{ color: '#b45309' }}>Debit</p>
                                      <p className="font-medium text-sm">{core.accounting_entry.debit?.account}</p>
                                      <p className="font-mono">{formatCurrency(core.accounting_entry.debit?.amount)}</p>
                                    </div>
                                    <div className="p-2 rounded" style={{ backgroundColor: '#d1fae5' }}>
                                      <p className="text-xs" style={{ color: '#047857' }}>Credit</p>
                                      <p className="font-medium text-sm">{core.accounting_entry.credit?.account}</p>
                                      <p className="font-mono">{formatCurrency(core.accounting_entry.credit?.amount)}</p>
                                    </div>
                                  </div>
                                </div>
                              )}
                              {renderObjectAsTable(core.inputs, 'Computation Inputs')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Anticipations */}
                {transactionData.anticipations?.length > 0 && (
                  <div>
                    <SectionHeader 
                      title="Anticipations" 
                      icon={TrendingUp} 
                      isExpanded={expandedSections.anticipations} 
                      onToggle={() => toggleSection('anticipations')} 
                      count={transactionData.anticipations.length}
                      action={currentSampleKey && componentTips[currentSampleKey]?.anticipations && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowComponentTip(showComponentTip === 'anticipations' ? null : 'anticipations');
                          }}
                          className="p-1.5 rounded-lg no-print"
                          style={{ 
                            backgroundColor: showComponentTip === 'anticipations' ? forayColors.actionAmber : 'transparent',
                            color: showComponentTip === 'anticipations' ? 'white' : forayColors.actionAmber
                          }}
                          data-tooltip="About Anticipations in this sample"
                        >
                          <Info className="w-6 h-6" />
                        </button>
                      )}
                    />
                    {showComponentTip === 'anticipations' && currentSampleKey && componentTips[currentSampleKey]?.anticipations && (
                      <div className="mt-2 p-4 rounded-lg border-l-4 no-print" style={{ backgroundColor: `${forayColors.actionAmber}08`, borderColor: forayColors.actionAmber }}>
                        <div className="flex items-start gap-3">
                          <Info className="w-5 h-5 flex-shrink-0 mt-0.5" style={{ color: forayColors.actionAmber }} />
                          <div>
                            <p className="text-sm font-semibold mb-1" style={{ color: forayColors.secondaryNavy }}>About Anticipations in this sample</p>
                            <p className="text-sm" style={{ color: forayColors.gray600 }}>{componentTips[currentSampleKey].anticipations}</p>
                          </div>
                        </div>
                      </div>
                    )}
                    {expandedSections.anticipations && (
                      <div className="mt-2 space-y-3">
                        {transactionData.anticipations.map((ant, idx) => {
                          const core = getForayCore(ant);
                          return (
                            <Card key={idx} id={`component-${ant.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.actionAmber}15`, color: forayColors.actionAmber }}>{ant.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                  {core.probability_factor !== undefined && (
                                    <span className="px-2 py-0.5 text-xs rounded" style={{ backgroundColor: core.probability_factor >= 0.9 ? '#d1fae5' : '#fef3c7', color: core.probability_factor >= 0.9 ? '#047857' : '#b45309' }}>
                                      {(core.probability_factor * 100).toFixed(0)}% probability
                                    </span>
                                  )}
                                </div>
                              </div>
                              <ReferencesDisplay refs={core.accrual_refs} refType="accrual" label="Accrual References" onNavigate={scrollToComponent} />
                              <ReferencesDisplay refs={core.arrangement_refs} refType="arrangement" label="Arrangement References" onNavigate={scrollToComponent} />
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.expected_amount !== undefined && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Expected Amount</p>
                                  <p className="text-xl font-bold" style={{ color: forayColors.actionAmber }}>{formatCurrency(core.expected_amount, core.currency)}</p>
                                  {core.expected_date && <p className="text-xs mt-1" style={{ color: forayColors.gray600 }}>Expected: {new Date(core.expected_date).toLocaleDateString()}</p>}
                                </div>
                              )}
                              {renderObjectAsTable(core.assumptions, 'Assumptions')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Actions */}
                {transactionData.actions?.length > 0 && (
                  <div>
                    <SectionHeader 
                      title="Actions" 
                      icon={Activity} 
                      isExpanded={expandedSections.actions} 
                      onToggle={() => toggleSection('actions')} 
                      count={transactionData.actions.length}
                      action={currentSampleKey && componentTips[currentSampleKey]?.actions && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowComponentTip(showComponentTip === 'actions' ? null : 'actions');
                          }}
                          className="p-1.5 rounded-lg no-print"
                          style={{ 
                            backgroundColor: showComponentTip === 'actions' ? forayColors.successGreen : 'transparent',
                            color: showComponentTip === 'actions' ? 'white' : forayColors.successGreen
                          }}
                          data-tooltip="About Actions in this sample"
                        >
                          <Info className="w-6 h-6" />
                        </button>
                      )}
                    />
                    {showComponentTip === 'actions' && currentSampleKey && componentTips[currentSampleKey]?.actions && (
                      <div className="mt-2 p-4 rounded-lg border-l-4 no-print" style={{ backgroundColor: `${forayColors.successGreen}08`, borderColor: forayColors.successGreen }}>
                        <div className="flex items-start gap-3">
                          <Info className="w-5 h-5 flex-shrink-0 mt-0.5" style={{ color: forayColors.successGreen }} />
                          <div>
                            <p className="text-sm font-semibold mb-1" style={{ color: forayColors.secondaryNavy }}>About Actions in this sample</p>
                            <p className="text-sm" style={{ color: forayColors.gray600 }}>{componentTips[currentSampleKey].actions}</p>
                          </div>
                        </div>
                      </div>
                    )}
                    {expandedSections.actions && (
                      <div className="mt-2 space-y-3">
                        {transactionData.actions.map((act, idx) => {
                          const core = getForayCore(act);
                          return (
                            <Card key={idx} id={`component-${act.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: `${forayColors.successGreen}15`, color: forayColors.successGreen }}>{act.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.type}</span>
                                  <StatusBadge status={core.settlement_status} />
                                </div>
                                {core.settlement_date && <span className="text-sm" style={{ color: forayColors.gray600 }}>{new Date(core.settlement_date).toLocaleString()}</span>}
                              </div>
                              <ReferencesDisplay refs={core.anticipation_refs} refType="anticipation" label="Anticipation References" onNavigate={scrollToComponent} />
                              <ReferencesDisplay refs={core.accrual_refs} refType="accrual" label="Accrual References" onNavigate={scrollToComponent} />
                              <ReferencesDisplay refs={core.arrangement_refs} refType="arrangement" label="Arrangement References" onNavigate={scrollToComponent} />
                              {core.description && <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>{core.description}</p>}
                              {core.amount_settled !== undefined && (
                                <div className="p-3 rounded mb-4" style={{ backgroundColor: '#d1fae5' }}>
                                  <p className="text-xs" style={{ color: '#047857' }}>Amount Settled</p>
                                  <p className="text-xl font-bold" style={{ color: '#047857' }}>{formatCurrency(core.amount_settled, core.currency)}</p>
                                  {core.payment_method && <p className="text-xs mt-1" style={{ color: '#047857' }}>Method: {core.payment_method.toUpperCase()}</p>}
                                </div>
                              )}
                              {core.counterparty && (
                                <div className="mb-3">
                                  <p className="text-xs" style={{ color: forayColors.gray600 }}>Counterparty</p>
                                  <p className="text-sm font-medium" style={{ color: forayColors.textDark }}>{core.counterparty}</p>
                                </div>
                              )}
                              <AllocationsDisplay allocations={core.allocations} currency={core.currency} onNavigate={scrollToComponent} />
                              {core.variance && (
                                <div className="mt-4 p-3 rounded" style={{ backgroundColor: '#fef3c7' }}>
                                  <p className="text-xs font-medium mb-2" style={{ color: '#b45309' }}>Variance Analysis</p>
                                  <div className="grid grid-cols-3 gap-3 text-sm">
                                    <div>
                                      <p className="text-xs" style={{ color: forayColors.gray600 }}>Expected</p>
                                      <p className="font-mono font-medium">{formatCurrency(core.variance.expected)}</p>
                                    </div>
                                    <div>
                                      <p className="text-xs" style={{ color: forayColors.gray600 }}>Actual</p>
                                      <p className="font-mono font-medium">{formatCurrency(core.variance.actual)}</p>
                                    </div>
                                    <div>
                                      <p className="text-xs" style={{ color: forayColors.gray600 }}>Difference</p>
                                      <p className="font-mono font-medium" style={{ color: core.variance.difference >= 0 ? '#047857' : '#b91c1c' }}>
                                        {core.variance.difference >= 0 ? '+' : ''}{formatCurrency(core.variance.difference)}
                                      </p>
                                    </div>
                                  </div>
                                  {core.variance.explanation && <p className="mt-2 text-xs" style={{ color: '#b45309' }}>{core.variance.explanation}</p>}
                                </div>
                              )}
                              {renderObjectAsTable(core.details, 'Details')}
                              {renderObjectAsTable(core.breakdown, 'Breakdown')}
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Attestations */}
                {transactionData.attestations?.length > 0 && (
                  <div>
                    <SectionHeader 
                      title="Attestations" 
                      icon={Shield} 
                      isExpanded={expandedSections.attestations} 
                      onToggle={() => toggleSection('attestations')} 
                      count={transactionData.attestations.length}
                      badge="Extension"
                      action={currentSampleKey && componentTips[currentSampleKey]?.attestations && (
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowComponentTip(showComponentTip === 'attestations' ? null : 'attestations');
                          }}
                          className="p-1.5 rounded-lg no-print"
                          style={{ 
                            backgroundColor: showComponentTip === 'attestations' ? '#8B5CF6' : 'transparent',
                            color: showComponentTip === 'attestations' ? 'white' : '#8B5CF6'
                          }}
                          data-tooltip="About Attestations in this sample"
                        >
                          <Info className="w-6 h-6" />
                        </button>
                      )}
                    />
                    {showComponentTip === 'attestations' && currentSampleKey && componentTips[currentSampleKey]?.attestations && (
                      <div className="mt-2 p-4 rounded-lg border-l-4 no-print" style={{ backgroundColor: '#8B5CF608', borderColor: '#8B5CF6' }}>
                        <div className="flex items-start gap-3">
                          <Info className="w-5 h-5 flex-shrink-0 mt-0.5" style={{ color: '#8B5CF6' }} />
                          <div>
                            <p className="text-sm font-semibold mb-1" style={{ color: forayColors.secondaryNavy }}>About Attestations in this sample</p>
                            <p className="text-sm" style={{ color: forayColors.gray600 }}>{componentTips[currentSampleKey].attestations}</p>
                          </div>
                        </div>
                      </div>
                    )}
                    {expandedSections.attestations && (
                      <div className="mt-2 space-y-3">
                        {transactionData.attestations.map((att, idx) => {
                          const core = getForayCore(att);
                          const outcomeColors = {
                            certified: { bg: '#d1fae5', text: '#047857' },
                            approved: { bg: '#dbeafe', text: '#1d4ed8' },
                            verified: { bg: '#e0e7ff', text: '#4338ca' },
                            rejected: { bg: '#fee2e2', text: '#b91c1c' },
                            pending: { bg: '#fef3c7', text: '#b45309' },
                            expired: { bg: '#f3f4f6', text: '#6b7280' }
                          };
                          const outcomeStyle = outcomeColors[core.outcome?.toLowerCase()] || outcomeColors.pending;
                          
                          return (
                            <Card key={idx} id={`component-${att.id}`}>
                              <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                  <span className="px-3 py-1 text-sm font-mono rounded" style={{ backgroundColor: '#8B5CF615', color: '#8B5CF6' }}>{att.id}</span>
                                  <span className="text-sm font-medium" style={{ color: forayColors.secondaryNavy }}>{core.attestation_type}</span>
                                  <span className="px-2 py-0.5 text-xs rounded capitalize" style={{ backgroundColor: outcomeStyle.bg, color: outcomeStyle.text }}>{core.outcome}</span>
                                </div>
                                {core.attestation_date && (
                                  <span className="text-sm" style={{ color: forayColors.gray600 }}>Attested: {new Date(core.attestation_date).toLocaleDateString()}</span>
                                )}
                              </div>
                              
                              {/* Attestor Info */}
                              <div className="p-3 rounded-lg mb-4" style={{ backgroundColor: '#8B5CF610' }}>
                                <div className="flex items-center gap-2 mb-2">
                                  <Award className="w-4 h-4" style={{ color: '#8B5CF6' }} />
                                  <span className="text-sm font-semibold" style={{ color: forayColors.secondaryNavy }}>Attestor</span>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div>
                                    <p className="text-xs" style={{ color: forayColors.gray600 }}>Name</p>
                                    <p className="text-sm font-medium" style={{ color: forayColors.textDark }}>{core.attestor}</p>
                                  </div>
                                  <div>
                                    <p className="text-xs" style={{ color: forayColors.gray600 }}>Type</p>
                                    <p className="text-sm font-medium capitalize" style={{ color: forayColors.textDark }}>{core.attestor_type?.replace(/_/g, ' ')}</p>
                                  </div>
                                </div>
                                {core.attestor_credentials?.length > 0 && (
                                  <div className="mt-2">
                                    <p className="text-xs mb-1" style={{ color: forayColors.gray600 }}>Credentials</p>
                                    <div className="flex flex-wrap gap-1">
                                      {core.attestor_credentials.map((cred, cIdx) => (
                                        <span key={cIdx} className="px-2 py-0.5 text-xs rounded" style={{ backgroundColor: '#f3e8ff', color: '#7c3aed' }}>
                                          {cred.replace(/_/g, ' ')}
                                        </span>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                              
                              {/* Subject References */}
                              {core.subject_refs?.length > 0 && (
                                <div className="mb-3">
                                  <p className="text-xs font-medium mb-1.5" style={{ color: forayColors.gray600 }}>Subject References ({core.subject_refs.length})</p>
                                  <div className="flex flex-wrap gap-1.5">
                                    {core.subject_refs.map((ref, rIdx) => {
                                      let refType = 'arrangement';
                                      if (ref.startsWith('ACC_')) refType = 'accrual';
                                      else if (ref.startsWith('ANT_')) refType = 'anticipation';
                                      else if (ref.startsWith('ACT_')) refType = 'action';
                                      else if (ref.startsWith('ATT_')) refType = 'attestation';
                                      return <RefBadge key={rIdx} refId={ref} refType={refType} onNavigate={scrollToComponent} />;
                                    })}
                                  </div>
                                </div>
                              )}
                              
                              {/* Validity Period */}
                              {core.validity_period && (
                                <div className="mb-4 p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                                  <p className="text-xs font-medium mb-1" style={{ color: forayColors.gray600 }}>Validity Period</p>
                                  <div className="flex items-center gap-4 text-sm">
                                    <span><strong>From:</strong> {core.validity_period.start}</span>
                                    <span><strong>To:</strong> {core.validity_period.end}</span>
                                  </div>
                                </div>
                              )}
                              
                              {/* Evidence */}
                              {core.evidence_hash && (
                                <div className="mb-4">
                                  <p className="text-xs font-medium mb-1" style={{ color: forayColors.gray600 }}>Evidence</p>
                                  <div className="p-2 rounded text-sm" style={{ backgroundColor: forayColors.bgLight }}>
                                    <div className="flex justify-between items-center">
                                      <span className="font-mono text-xs" style={{ color: forayColors.textDark }}>{core.evidence_hash}</span>
                                      <span className="px-2 py-0.5 text-xs rounded" style={{ backgroundColor: core.evidence_location === 'on-chain' ? '#d1fae5' : '#fef3c7', color: core.evidence_location === 'on-chain' ? '#047857' : '#b45309' }}>
                                        {core.evidence_location || 'off-chain'}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              )}
                              
                              {/* Attestation-specific details */}
                              {renderObjectAsTable(core.analysis_summary, 'Analysis Summary')}
                              {renderObjectAsTable(core.certificate_details, 'Certificate Details')}
                              {renderObjectAsTable(core.export_details, 'Export Details')}
                              
                              <DependencyGraph dependencies={core.dependencies} onNavigate={scrollToComponent} />
                            </Card>
                          );
                        })}
                      </div>
                    )}
                  </div>
                )}

                {/* Privacy & Security */}
                {transactionData.privacy_metadata && (
                  <div>
                    <SectionHeader title="Privacy & Security" icon={Lock} isExpanded={expandedSections.privacy} onToggle={() => toggleSection('privacy')} />
                    {expandedSections.privacy && (
                      <Card className="mt-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <div>
                            <KeyValue label="Formulas Obfuscated" value={transactionData.privacy_metadata.formulas_obfuscated} />
                            <KeyValue label="Instance Pools" value={transactionData.privacy_metadata.instance_pools} />
                            <KeyValue label="Attack Complexity" value={transactionData.privacy_metadata.attack_complexity} />
                          </div>
                        </div>
                        <div className="mt-4 p-3 rounded" style={{ backgroundColor: '#f3e5f5', borderLeft: '4px solid #6a1b9a' }}>
                          <p className="text-xs" style={{ color: '#6a1b9a' }}>
                            <strong>Privacy Protection:</strong> Sensitive formulas are protected using salted identifiers and instance pooling, enabling hash-based verification without exposing proprietary business logic. Full auditability is maintained while protecting competitive intelligence.
                          </p>
                        </div>
                      </Card>
                    )}
                  </div>
                )}

                {/* Bottom Control */}
                <div className="flex justify-end no-print">
                  <button 
                    onClick={allExpanded ? collapseAll : expandAll} 
                    className="px-3 py-1.5 text-xs rounded flex items-center gap-1.5" 
                    style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}
                  >
                    {allExpanded ? (
                      <>
                        <ChevronRight className="w-3.5 h-3.5" /> Collapse All
                      </>
                    ) : (
                      <>
                        <ChevronDown className="w-3.5 h-3.5" /> Expand All
                      </>
                    )}
                  </button>
                </div>
              </div>
            )}
            
            {/* Notes Modal */}
            {showNotes && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <FileText className="w-6 h-6" style={{ color: forayColors.primaryTeal }} />
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>FORAY Protocol Version Guide</h2>
                    </div>
                    <button onClick={() => setShowNotes(false)} className="p-2 rounded-lg hover:bg-gray-100">
                      <X className="w-5 h-5" style={{ color: forayColors.gray600 }} />
                    </button>
                  </div>
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 100px)' }}>
                    <div className="space-y-6">
                      
                      {/* Introduction */}
                      <div className="p-4 rounded-lg" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                        <p className="text-sm" style={{ color: forayColors.secondaryNavy }}>
                          <strong>FORAY Protocol</strong> creates tamper-evident audit trails of your ERP transactions that regulators, auditors, and forensic investigators can trust&mdash;without exposing your competitive secrets. Each version adds capabilities while maintaining backward compatibility.
                        </p>
                      </div>
                      
                      {/* Version Cards */}
                      <div className="space-y-4">
                        
                        {/* V1.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-gray-500 text-white">v1.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Foundation</span>
                            <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: '#e5e7eb', color: '#6b7280' }}>Legacy</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Introduced the core 4-component transaction model that forms the foundation of all FORAY transactions.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>4-Component Model (A&rarr;A&rarr;A&rarr;A)</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Basic blockchain anchoring</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Simple hash verification</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Transaction dependency tracking</span></div>
                            </div>
                          </div>
                        </div>
                        
                        {/* V2.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-blue-500 text-white">v2.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Privacy & Adapters</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Added privacy-preserving features and ERP integration adapters for enterprise deployment.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Salted formula IDs</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Zero-knowledge proof support</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>SAP, QuickBooks adapters</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Selective disclosure</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: '#dbeafe', color: '#1e40af' }}>
                              <strong>Best for:</strong> Organizations needing ERP integration with basic privacy controls
                            </div>
                          </div>
                        </div>
                        
                        {/* V3.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-purple-500 text-white">v3.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Storage & Encryption</span>
                            <span className="text-xs px-2 py-0.5 rounded cursor-help" style={{ backgroundColor: '#fef3c7', color: '#b45309' }} data-tooltip="Breaking change - not backward compatible">Breaking</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Introduced tier-based storage architecture and encrypted envelope for cost-effective, secure data management.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Compressed key mapping</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Tier-based storage (hot/warm/cold)</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Encrypted envelope</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Instance pooling for privacy</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: '#f3e8ff', color: '#7c3aed' }}>
                              <strong>Best for:</strong> Enterprises with high-volume transactions needing cost optimization
                            </div>
                          </div>
                        </div>
                        
                        {/* V4.0 */}
                        <div className="border rounded-lg overflow-hidden" style={{ borderColor: forayColors.gray400 }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <span className="px-2 py-1 text-xs font-bold rounded bg-orange-500 text-white">v4.0</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Enterprise Compliance</span>
                            <span className="text-xs px-2 py-0.5 rounded cursor-help" style={{ backgroundColor: '#fef3c7', color: '#b45309' }} data-tooltip="Breaking change - not backward compatible">Breaking</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Separated core protocol from audit metadata with 3-layer architecture for full enterprise compliance (SOX, DCAA, Big 4).
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>foray_core / audit_data separation</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>3-layer storage architecture</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Sealed archive specification</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>~85% audit completeness</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: '#ffedd5', color: '#c2410c' }}>
                              <strong>Best for:</strong> Regulated industries requiring full audit trail with Big 4 / SOX compliance
                            </div>
                          </div>
                        </div>
                        
                        {/* V4.1 - Current */}
                        <div className="border-2 rounded-lg overflow-hidden" style={{ borderColor: forayColors.primaryTeal }}>
                          <div className="px-4 py-3 flex items-center gap-3" style={{ backgroundColor: `${forayColors.primaryTeal}20` }}>
                            <span className="px-2 py-1 text-xs font-bold rounded text-white" style={{ backgroundColor: forayColors.primaryTeal }}>v4.1</span>
                            <span className="font-semibold" style={{ color: forayColors.secondaryNavy }}>Flexible Modeling</span>
                            <span className="text-xs px-2 py-0.5 rounded" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>Current</span>
                            <span className="text-xs px-2 py-0.5 rounded cursor-help" style={{ backgroundColor: '#fef3c7', color: '#b45309' }} data-tooltip="Breaking change - auto-migrates older formats">Breaking</span>
                          </div>
                          <div className="p-4">
                            <p className="text-sm mb-3" style={{ color: forayColors.gray600 }}>
                              Enables flexible entry points and many-to-many relationships for accurate transaction modeling. This viewer auto-migrates v3.0 and v4.0 transactions to v4.1 format.
                            </p>
                            <div className="grid grid-cols-2 gap-2 text-xs">
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Flexible entry points (any component)</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Many-to-many references (*_refs[])</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>Allocation tracking</span></div>
                              <div className="flex items-center gap-2"><CheckCircle className="w-3 h-3" style={{ color: forayColors.successGreen }} /><span>RMBS/structured finance support</span></div>
                            </div>
                            <div className="mt-3 p-2 rounded text-xs" style={{ backgroundColor: `${forayColors.primaryTeal}20`, color: forayColors.secondaryNavy }}>
                              <strong>Best for:</strong> Complex transactions including batch payments, structured finance, and SMB cash transactions
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* Key Changes Summary Table */}
                      <div className="mt-6">
                        <h3 className="font-semibold mb-3" style={{ color: forayColors.secondaryNavy }}>Version Comparison</h3>
                        <div className="overflow-x-auto">
                          <table className="w-full text-xs border-collapse">
                            <thead>
                              <tr style={{ backgroundColor: forayColors.bgLight }}>
                                <th className="border p-2 text-left" style={{ borderColor: forayColors.gray400 }}>Feature</th>
                                <th className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>v3.0</th>
                                <th className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>v4.0</th>
                                <th className="border p-2 text-center" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10` }}>v4.1</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Arrangements Required</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&#x2714;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&#x2714;</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>Optional</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Reference Type</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>_ref (1:1)</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>_ref (1:1)</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>_refs[] (N:N)</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>foray_core Separation</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&mdash;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&#x2714;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10` }}>&#x2714;</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Allocation Tracking</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&mdash;</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>&mdash;</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>&#x2714;</td>
                              </tr>
                              <tr>
                                <td className="border p-2" style={{ borderColor: forayColors.gray400 }}>Entry Points</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>Arrangement</td>
                                <td className="border p-2 text-center" style={{ borderColor: forayColors.gray400 }}>Arrangement</td>
                                <td className="border p-2 text-center font-semibold" style={{ borderColor: forayColors.gray400, backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}>Any</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                      
                      {/* Use Cases */}
                      <div className="mt-6 p-4 rounded-lg" style={{ backgroundColor: forayColors.bgLight }}>
                        <h3 className="font-semibold mb-3" style={{ color: forayColors.secondaryNavy }}>When to Use Each Version</h3>
                        <div className="space-y-2 text-sm">
                          <p><strong style={{ color: forayColors.primaryTeal }}>v4.1 (Recommended):</strong> Most new implementations, especially if you have batch payments, cash sales, adjusting entries, or structured finance.</p>
                          <p><strong style={{ color: '#f97316' }}>v4.0:</strong> If you need maximum audit completeness but don't require many-to-many relationships.</p>
                          <p><strong style={{ color: '#8b5cf6' }}>v3.0:</strong> Simpler implementations where storage cost optimization is the priority.</p>
                        </div>
                      </div>
                      
                      {/* Blockchain Anchoring Section */}
                      <div className="mt-6 border-t pt-6" style={{ borderColor: forayColors.gray400 }}>
                        <h3 className="font-semibold mb-4 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                          <Link2 className="w-5 h-5" style={{ color: forayColors.primaryTeal }} />
                          Blockchain Anchoring (Kaspa)
                        </h3>
                        
                        <div className="space-y-4">
                          {/* Overview */}
                          <div className="p-4 rounded-lg" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                            <p className="text-sm" style={{ color: forayColors.secondaryNavy }}>
                              <strong>How It Works:</strong> FORAY transactions are anchored to the Kaspa blockchain to create a tamper-evident, timestamped proof of existence. The Kaspa transaction ID serves as cryptographic evidence that your FORAY transaction existed at a specific point in time.
                            </p>
                          </div>
                          
                          {/* Technical Approach */}
                          <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.gray400 }}>
                            <h4 className="font-medium mb-3" style={{ color: forayColors.secondaryNavy }}>Technical Approach</h4>
                            <div className="space-y-3 text-sm" style={{ color: forayColors.gray600 }}>
                              <div className="flex gap-3">
                                <span className="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>1</span>
                                <div>
                                  <strong>Hash Computation:</strong> A SHA-256 hash of your complete FORAY transaction JSON is computed locally in your browser.
                                </div>
                              </div>
                              <div className="flex gap-3">
                                <span className="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>2</span>
                                <div>
                                  <strong>Blockchain Transaction:</strong> A Kaspa transaction (0.2 KAS) is submitted to create an on-chain timestamp. The amount satisfies KIP-9 storage mass requirements. The transaction is sent to your own wallet address, so funds are not lost.
                                </div>
                              </div>
                              <div className="flex gap-3">
                                <span className="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>3</span>
                                <div>
                                  <strong>Proof Linkage:</strong> The Kaspa Transaction ID is linked to your FORAY transaction hash. This creates an unbreakable chain: <code className="px-1 rounded" style={{ backgroundColor: forayColors.bgLight }}>Kaspa TX ID &rarr; FORAY Hash &rarr; Original Transaction</code>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          {/* What's Stored Where */}
                          <div className="grid grid-cols-2 gap-4">
                            <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.primaryTeal, backgroundColor: `${forayColors.primaryTeal}05` }}>
                              <h4 className="font-medium mb-2 flex items-center gap-2" style={{ color: forayColors.primaryTeal }}>
                                <Database className="w-4 h-4" /> On Blockchain
                              </h4>
                              <ul className="text-xs space-y-1" style={{ color: forayColors.gray600 }}>
                                <li>&bull; Kaspa Transaction ID</li>
                                <li>&bull; Timestamp (block time)</li>
                                <li>&bull; Wallet address</li>
                                <li>&bull; Block height & hash</li>
                              </ul>
                            </div>
                            <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.secondaryNavy, backgroundColor: `${forayColors.secondaryNavy}05` }}>
                              <h4 className="font-medium mb-2 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                                <FileText className="w-4 h-4" /> In Your System
                              </h4>
                              <ul className="text-xs space-y-1" style={{ color: forayColors.gray600 }}>
                                <li>&bull; Complete FORAY JSON</li>
                                <li>&bull; Transaction hash (SHA-256)</li>
                                <li>&bull; Kaspa TX ID reference</li>
                                <li>&bull; Anchor metadata</li>
                              </ul>
                            </div>
                          </div>
                          
                          {/* Demo Mode Notice */}
                          <div className="p-4 rounded-lg" style={{ backgroundColor: `${forayColors.actionAmber}15` }}>
                            <h4 className="font-medium mb-2 flex items-center gap-2" style={{ color: '#b45309' }}>
                              <AlertCircle className="w-4 h-4" /> Transaction Review Demo Mode
                            </h4>
                            <p className="text-sm" style={{ color: forayColors.gray600 }}>
                              This Transaction Review tool demonstrates blockchain anchoring using actual Kaspa testnet transactions. When you anchor a transaction:
                            </p>
                            <ul className="text-sm mt-2 space-y-1" style={{ color: forayColors.gray600 }}>
                              <li>&bull; <strong>Real Kaspa TX:</strong> A real transaction is submitted to Kaspa Testnet 10 or 11</li>
                              <li>&bull; <strong>Explorer Verification:</strong> Click "View on Explorer" to see the actual blockchain record</li>
                              <li>&bull; <strong>Test Funds Required:</strong> Get free test KAS from the faucet (link in network dropdown)</li>
                              <li>&bull; <strong>No FORAY Data in TX:</strong> The FORAY data itself is NOT embedded in the blockchain transaction&mdash;only the timestamp proof is on-chain</li>
                            </ul>
                            <p className="text-xs mt-3" style={{ color: '#b45309' }}>
                              <strong>Note:</strong> In production, you would store the Kaspa TX ID alongside your FORAY transaction in your audit system. The hash links them cryptographically.
                            </p>
                          </div>
                          
                          {/* Network Information */}
                          <div className="p-4 border rounded-lg" style={{ borderColor: forayColors.gray400 }}>
                            <h4 className="font-medium mb-3" style={{ color: forayColors.secondaryNavy }}>Kaspa Networks</h4>
                            <div className="grid grid-cols-3 gap-3 text-xs">
                              <div className="p-3 rounded" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                                <p className="font-semibold" style={{ color: forayColors.actionAmber }}>Testnet 10</p>
                                <p style={{ color: forayColors.gray600 }}>Stable, mirrors mainnet (1 BPS)</p>
                                <p className="mt-1"><strong>Recommended for testing</strong></p>
                              </div>
                              <div className="p-3 rounded" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                                <p className="font-semibold" style={{ color: forayColors.actionAmber }}>Testnet 11</p>
                                <p style={{ color: forayColors.gray600 }}>Experimental (10 BPS)</p>
                                <p className="mt-1">Faster confirmations</p>
                              </div>
                              <div className="p-3 rounded opacity-50" style={{ backgroundColor: `${forayColors.gray400}10` }}>
                                <p className="font-semibold" style={{ color: forayColors.gray400 }}>Mainnet</p>
                                <p style={{ color: forayColors.gray400 }}>Disabled for demo</p>
                                <p className="mt-1 text-xs">Use testnet for Kaspathon</p>
                              </div>
                            </div>
                          </div>
                          
                          {/* Wallet Requirement */}
                          <div className="p-4 rounded-lg flex items-start gap-3" style={{ backgroundColor: forayColors.bgLight }}>
                            <div className="p-2 rounded" style={{ backgroundColor: forayColors.secondaryNavy }}>
                              <Link2 className="w-4 h-4 text-white" />
                            </div>
                            <div>
                              <h4 className="font-medium mb-1" style={{ color: forayColors.secondaryNavy }}>KasWare Wallet Required</h4>
                              <p className="text-sm" style={{ color: forayColors.gray600 }}>
                                To anchor transactions, install the <a href="https://kasware.xyz" target="_blank" rel="noopener noreferrer" style={{ color: forayColors.primaryTeal, textDecoration: 'underline' }}>KasWare browser extension</a>. 
                                Switch to Testnet in wallet settings and get free test KAS from the faucet.
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* JSON Modal */}
            {showJsonModal && transactionData && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <FileText className="w-6 h-6" style={{ color: forayColors.primaryTeal }} />
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>Transaction JSON</h2>
                      <span className="px-2 py-1 text-xs font-bold rounded" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>v{transactionData.schema_version}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => { navigator.clipboard.writeText(JSON.stringify(transactionData, null, 2)); alert('JSON copied to clipboard!'); }}
                        className="px-3 py-1.5 text-sm rounded-lg flex items-center gap-2"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Copy
                      </button>
                      <button onClick={() => setShowJsonModal(false)} className="p-2 rounded-lg hover:bg-gray-100">
                        <X className="w-5 h-5" style={{ color: forayColors.gray600 }} />
                      </button>
                    </div>
                  </div>
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 100px)' }}>
                    <pre className="text-xs font-mono p-4 rounded-lg overflow-x-auto" style={{ backgroundColor: forayColors.bgLight, color: forayColors.textDark }}>
                      {JSON.stringify(transactionData, null, 2)}
                    </pre>
                  </div>
                </div>
              </div>
            )}
            
            {/* Narrative Summary Modal */}
            {showNarrativeSummaryModal && currentSampleKey && sampleNarrativeSummaries[currentSampleKey] && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <BookOpen className="w-6 h-6" style={{ color: forayColors.highlightMint }} />
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>{sampleNarrativeSummaries[currentSampleKey].title}</h2>
                      <span className="px-2 py-1 text-xs rounded" style={{ backgroundColor: forayColors.highlightMint, color: forayColors.secondaryNavy }}>Summary</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => {
                          setShowNarrativeSummaryModal(false);
                          setShowNarrativeModal(true);
                        }}
                        className="px-2 py-1 text-xs rounded-lg flex items-center gap-1"
                        style={{ backgroundColor: forayColors.actionAmber, color: forayColors.textDark }}
                      >
                        View Full
                      </button>
                      <button 
                        onClick={() => { navigator.clipboard.writeText(sampleNarrativeSummaries[currentSampleKey].content); alert('Summary copied to clipboard!'); }}
                        className="px-2 py-1 text-xs rounded-lg flex items-center gap-1"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Copy
                      </button>
                      <button onClick={() => setShowNarrativeSummaryModal(false)} className="p-1.5 rounded-lg hover:bg-gray-100">
                        <X className="w-4 h-4" style={{ color: forayColors.gray600 }} />
                      </button>
                    </div>
                  </div>
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(80vh - 100px)' }}>
                    <div className="prose prose-sm max-w-none">
                      {sampleNarrativeSummaries[currentSampleKey].content.split('\n').map((line, idx) => {
                        if (line.startsWith('## ')) return <h2 key={idx} className="text-xl font-semibold mt-4 mb-3" style={{ color: forayColors.primaryTeal }}>{line.slice(3)}</h2>;
                        if (line.startsWith('**') && line.endsWith('**')) return <p key={idx} className="font-semibold mt-3 mb-1" style={{ color: forayColors.secondaryNavy }}>{line.slice(2, -2)}</p>;
                        if (line.startsWith('- **')) {
                          const match = line.match(/- \*\*(.+?)\*\*:(.+)/);
                          if (match) return <p key={idx} className="text-sm ml-4 mb-1" style={{ color: forayColors.gray600 }}><strong>{match[1]}:</strong>{match[2]}</p>;
                        }
                        if (line.startsWith('- ')) return <p key={idx} className="text-sm ml-4 mb-1" style={{ color: forayColors.gray600 }}>&bull; {line.slice(2)}</p>;
                        if (line.includes('**')) {
                          const parts = line.split(/\*\*(.*?)\*\*/g);
                          return <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>{parts.map((part, pidx) => pidx % 2 === 1 ? <strong key={pidx}>{part}</strong> : part)}</p>;
                        }
                        if (line.includes('\`')) {
                          const parts = line.split(/\`(.*?)\`/g);
                          return <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>{parts.map((part, pidx) => pidx % 2 === 1 ? <code key={pidx} className="px-1 py-0.5 rounded text-xs" style={{ backgroundColor: forayColors.bgLight, color: forayColors.primaryTeal }}>{part}</code> : part)}</p>;
                        }
                        if (line.trim() === '') return <div key={idx} className="h-2" />;
                        return <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>{line}</p>;
                      })}
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Narrative Modal (Full) */}
            {showNarrativeModal && currentSampleKey && sampleNarratives[currentSampleKey] && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <BookOpen className="w-6 h-6" style={{ color: forayColors.actionAmber }} />
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>{sampleNarratives[currentSampleKey].title}</h2>
                      <span className="px-2 py-1 text-xs rounded" style={{ backgroundColor: forayColors.actionAmber, color: forayColors.textDark }}>Full</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => {
                          setShowNarrativeModal(false);
                          setShowNarrativeSummaryModal(true);
                        }}
                        className="px-2 py-1 text-xs rounded-lg flex items-center gap-1"
                        style={{ backgroundColor: forayColors.highlightMint, color: forayColors.secondaryNavy }}
                      >
                        View Summary
                      </button>
                      <button 
                        onClick={() => { navigator.clipboard.writeText(sampleNarratives[currentSampleKey].content); alert('Narrative copied to clipboard!'); }}
                        className="px-2 py-1 text-xs rounded-lg flex items-center gap-1"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Copy
                      </button>
                      <button onClick={() => setShowNarrativeModal(false)} className="p-1.5 rounded-lg hover:bg-gray-100">
                        <X className="w-4 h-4" style={{ color: forayColors.gray600 }} />
                      </button>
                    </div>
                  </div>
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 100px)' }}>
                    <div className="prose prose-sm max-w-none">
                      {sampleNarratives[currentSampleKey].content.split('\n').map((line, idx) => {
                        // Handle headers
                        if (line.startsWith('# ')) return <h1 key={idx} className="text-2xl font-bold mt-6 mb-4" style={{ color: forayColors.secondaryNavy }}>{line.slice(2)}</h1>;
                        if (line.startsWith('## ')) return <h2 key={idx} className="text-xl font-semibold mt-6 mb-3" style={{ color: forayColors.primaryTeal }}>{line.slice(3)}</h2>;
                        if (line.startsWith('### ')) return <h3 key={idx} className="text-lg font-medium mt-4 mb-2" style={{ color: forayColors.secondaryNavy }}>{line.slice(4)}</h3>;
                        
                        // Handle horizontal rules
                        if (line.startsWith('---')) return <hr key={idx} className="my-6" style={{ borderColor: forayColors.gray400 + '40' }} />;
                        
                        // Handle code blocks
                        if (line.startsWith('\`\`\`')) return null;
                        
                        // Handle tables (simplified - just show as text)
                        if (line.startsWith('|')) {
                          const cells = line.split('|').filter(c => c.trim());
                          if (line.includes('---')) return null; // Skip table separator
                          return (
                            <div key={idx} className="flex gap-4 py-1 text-sm font-mono" style={{ backgroundColor: forayColors.bgLight, padding: '4px 8px', marginBottom: '2px' }}>
                              {cells.map((cell, cidx) => (
                                <span key={cidx} style={{ flex: 1, color: forayColors.textDark }}>{cell.trim()}</span>
                              ))}
                            </div>
                          );
                        }
                        
                        // Handle bullet points
                        if (line.startsWith('- ')) return <li key={idx} className="text-sm ml-4 mb-1" style={{ color: forayColors.gray600 }}>{line.slice(2)}</li>;
                        
                        // Handle bold text
                        if (line.includes('**')) {
                          const parts = line.split(/\*\*(.*?)\*\*/g);
                          return (
                            <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>
                              {parts.map((part, pidx) => pidx % 2 === 1 ? <strong key={pidx}>{part}</strong> : part)}
                            </p>
                          );
                        }
                        
                        // Handle inline code
                        if (line.includes('\`')) {
                          const parts = line.split(/\`(.*?)\`/g);
                          return (
                            <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>
                              {parts.map((part, pidx) => pidx % 2 === 1 ? 
                                <code key={pidx} className="px-1 py-0.5 rounded text-xs" style={{ backgroundColor: forayColors.bgLight, color: forayColors.primaryTeal }}>{part}</code> : part
                              )}
                            </p>
                          );
                        }
                        
                        // Empty lines
                        if (line.trim() === '') return <div key={idx} className="h-2" />;
                        
                        // Regular paragraphs
                        return <p key={idx} className="text-sm mb-2" style={{ color: forayColors.gray600 }}>{line}</p>;
                      })}
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Mainnet Warning Dialog */}
            {showMainnetWarning && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
                  <div className="p-6">
                    <div className="flex items-center gap-3 mb-4">
                      <div className="p-3 rounded-full" style={{ backgroundColor: `${forayColors.errorRed}20` }}>
                        <AlertCircle className="w-6 h-6" style={{ color: forayColors.errorRed }} />
                      </div>
                      <h2 className="text-xl font-bold" style={{ color: forayColors.errorRed }}>Switch to Mainnet?</h2>
                    </div>
                    <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>
                      You are about to switch to <strong>Kaspa Mainnet</strong>. This is the production network where transactions use <strong>real KAS tokens</strong> with actual monetary value.
                    </p>
                    <div className="p-3 rounded-lg mb-4" style={{ backgroundColor: `${forayColors.errorRed}10` }}>
                      <p className="text-xs font-medium" style={{ color: forayColors.errorRed }}>
                        &#x26A0;&#xFE0F; <strong>Warning:</strong> Any blockchain anchoring on Mainnet will cost real KAS and create permanent, irreversible records.
                      </p>
                    </div>
                    <div className="p-3 rounded-lg mb-6" style={{ backgroundColor: forayColors.bgLight }}>
                      <p className="text-xs" style={{ color: forayColors.gray600 }}>
                        <strong>Recommendation:</strong> Use Testnet 10 or Testnet 11 for development and testing. Only switch to Mainnet for production transactions.
                      </p>
                    </div>
                    <div className="flex gap-3">
                      <button 
                        onClick={cancelMainnetSwitch}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Stay on Testnet
                      </button>
                      <button 
                        onClick={confirmMainnetSwitch}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium text-white"
                        style={{ backgroundColor: forayColors.errorRed }}
                      >
                        Switch to Mainnet
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Anchor Confirmation Dialog */}
            {showAnchorConfirm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
                  <div className="p-6">
                    <div className="flex items-center gap-3 mb-4">
                      <div className="p-3 rounded-full" style={{ backgroundColor: `${forayColors.secondaryNavy}20` }}>
                        <Link2 className="w-6 h-6" style={{ color: forayColors.secondaryNavy }} />
                      </div>
                      <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>Anchor to Blockchain</h2>
                    </div>
                    
                    {/* Network Badge */}
                    <div className="flex items-center gap-2 mb-4 p-2 rounded-lg" style={{ backgroundColor: currentNetwork.isTestnet ? `${forayColors.actionAmber}10` : `${forayColors.errorRed}10` }}>
                      <GitBranch className="w-4 h-4" style={{ color: currentNetwork.isTestnet ? forayColors.actionAmber : forayColors.errorRed }} />
                      <span className="text-sm font-medium" style={{ color: currentNetwork.isTestnet ? forayColors.actionAmber : forayColors.errorRed }}>
                        {currentNetwork.name}
                      </span>
                      {currentNetwork.isTestnet ? (
                        <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: forayColors.actionAmber, color: 'white' }}>TEST</span>
                      ) : (
                        <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: forayColors.errorRed, color: 'white' }}>REAL KAS</span>
                      )}
                    </div>
                    
                    <p className="text-sm mb-4" style={{ color: forayColors.gray600 }}>
                      You are about to anchor this FORAY transaction to <strong>{currentNetwork.name}</strong>. This action creates a tamper-evident record anchored to blockchain that is designed to resist modification.
                    </p>
                    
                    {!currentNetwork.isTestnet && (
                      <div className="p-3 rounded-lg mb-4" style={{ backgroundColor: `${forayColors.errorRed}10` }}>
                        <p className="text-xs font-medium" style={{ color: forayColors.errorRed }}>
                          &#x26A0;&#xFE0F; <strong>Mainnet Transaction:</strong> This will use real KAS tokens and incur actual transaction fees.
                        </p>
                      </div>
                    )}
                    
                    <div className="p-3 rounded-lg mb-4" style={{ backgroundColor: `${forayColors.actionAmber}20` }}>
                      <p className="text-xs font-medium" style={{ color: '#b45309' }}>
                        &#x26A0;&#xFE0F; This action is <strong>permanent and irreversible</strong>. Ensure the transaction data is correct before proceeding.
                      </p>
                    </div>
                    
                    <div className="text-xs space-y-1 mb-6" style={{ color: forayColors.gray600 }}>
                      <p><strong>Transaction:</strong> {transactionData?.transaction_id}</p>
                      <p><strong>Entity:</strong> {transactionData?.foray_core?.entity}</p>
                      <p><strong>Value:</strong> {formatCurrency(transactionData?.foray_core?.total_value, transactionData?.foray_core?.currency)}</p>
                      <p><strong>Network:</strong> {currentNetwork.name} ({currentNetwork.bps} BPS)</p>
                      {walletConnected && <p><strong>Wallet:</strong> {walletAddress?.substring(0, 25)}...</p>}
                    </div>
                    
                    <div className="flex gap-3">
                      <button 
                        onClick={() => setShowAnchorConfirm(false)}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium"
                        style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={handleAnchorToBlockchain}
                        className="flex-1 px-4 py-2.5 rounded-lg font-medium text-white"
                        style={{ backgroundColor: currentNetwork.isTestnet ? forayColors.secondaryNavy : forayColors.errorRed }}
                      >
                        {currentNetwork.isTestnet ? 'Confirm & Anchor' : 'Anchor (Mainnet)'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Anchoring In Progress */}
            {isAnchoring && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl shadow-2xl p-8 text-center">
                  <div className="animate-spin w-12 h-12 border-4 rounded-full mx-auto mb-4" style={{ borderColor: `${forayColors.primaryTeal}30`, borderTopColor: forayColors.primaryTeal }}></div>
                  <h2 className="text-xl font-bold mb-2" style={{ color: forayColors.secondaryNavy }}>Anchoring to {currentNetwork.name}...</h2>
                  <p className="text-sm" style={{ color: forayColors.gray600 }}>Creating tamper-evident blockchain record</p>
                  <p className="text-xs mt-2" style={{ color: forayColors.gray600 }}>Expected confirmation: ~{Math.round(1000 / currentNetwork.bps)}ms</p>
                </div>
              </div>
            )}
            
            {/* Anchor Result Modal */}
            {anchorResult && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 anchor-result-modal">
                <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
                  <div className="flex items-center justify-between p-6 border-b" style={{ borderColor: forayColors.gray400 }}>
                    <div className="flex items-center gap-3">
                      <div className="p-2 rounded-full" style={{ backgroundColor: `${forayColors.successGreen}20` }}>
                        <CheckCircle className="w-6 h-6" style={{ color: forayColors.successGreen }} />
                      </div>
                      <div>
                        <h2 className="text-xl font-bold" style={{ color: forayColors.secondaryNavy }}>Transaction Anchored Successfully</h2>
                        <p className="text-xs" style={{ color: forayColors.gray600 }}>{anchorResult.timestamp}</p>
                      </div>
                    </div>
                    <button onClick={() => setAnchorResult(null)} className="p-2 rounded-lg hover:bg-gray-100 no-print">
                      <X className="w-5 h-5" style={{ color: forayColors.gray600 }} />
                    </button>
                  </div>
                  
                  <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 180px)' }}>
                    {/* Kaspa Blockchain Section */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold mb-3 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                        <GitBranch className="w-4 h-4" /> Kaspa Blockchain Verification
                      </h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Transaction ID:</span>
                          <span className="font-mono text-xs" style={{ color: forayColors.primaryTeal }}>{anchorResult.kaspa.transaction_id}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Block Height:</span>
                          <span className="font-mono font-bold" style={{ color: forayColors.textDark }}>{anchorResult.kaspa.block_height.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Block Hash:</span>
                          <span className="font-mono text-xs truncate ml-4" style={{ color: forayColors.textDark, maxWidth: '300px' }}>{anchorResult.kaspa.block_hash}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Confirmations:</span>
                          <span className="font-bold" style={{ color: forayColors.successGreen }}>{anchorResult.kaspa.confirmations}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Confirmation Time:</span>
                          <span className="font-mono" style={{ color: forayColors.textDark }}>{anchorResult.kaspa.confirmation_time_ms}ms</span>
                        </div>
                      </div>
                      <a 
                        href={anchorResult.kaspa.explorer_url} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="mt-3 inline-flex items-center gap-2 text-sm px-4 py-2 rounded-lg no-print"
                        style={{ backgroundColor: `${forayColors.primaryTeal}10`, color: forayColors.primaryTeal }}
                      >
                        <Link2 className="w-4 h-4" /> View on Kaspa Explorer &rarr;
                      </a>
                    </div>
                    
                    {/* FORAY Transaction Section */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold mb-3 flex items-center gap-2" style={{ color: forayColors.secondaryNavy }}>
                        <FileText className="w-4 h-4" /> FORAY Transaction Details
                      </h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Transaction ID:</span>
                          <span className="font-mono text-xs" style={{ color: forayColors.textDark }}>{anchorResult.foray.transaction_id}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Schema Version:</span>
                          <span className="px-2 py-0.5 text-xs font-bold rounded" style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}>v{anchorResult.foray.schema_version}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Merkle Root:</span>
                          <span className="font-mono text-xs" style={{ color: forayColors.textDark }}>{anchorResult.foray.merkle_root}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Entity:</span>
                          <span className="font-semibold" style={{ color: forayColors.textDark }}>{anchorResult.foray.entity}</span>
                        </div>
                        <div className="flex justify-between p-2 rounded" style={{ backgroundColor: forayColors.bgLight }}>
                          <span style={{ color: forayColors.gray600 }}>Total Value:</span>
                          <span className="font-bold" style={{ color: forayColors.primaryTeal }}>{formatCurrency(anchorResult.foray.total_value, anchorResult.foray.currency)}</span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Component Summary */}
                    <div className="mb-6">
                      <h3 className="text-sm font-bold mb-3" style={{ color: forayColors.secondaryNavy }}>Components Anchored</h3>
                      <div className={`grid gap-2 ${anchorResult.foray.component_summary.attestations > 0 ? 'grid-cols-5' : 'grid-cols-4'}`}>
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.primaryTeal}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.primaryTeal }}>{anchorResult.foray.component_summary.arrangements}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Arrangements</p>
                        </div>
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.accentCyan}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.accentCyan }}>{anchorResult.foray.component_summary.accruals}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Accruals</p>
                        </div>
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.actionAmber}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.actionAmber }}>{anchorResult.foray.component_summary.anticipations}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Anticipations</p>
                        </div>
                        <div className="p-3 rounded-lg text-center" style={{ backgroundColor: `${forayColors.successGreen}10` }}>
                          <p className="text-2xl font-bold" style={{ color: forayColors.successGreen }}>{anchorResult.foray.component_summary.actions}</p>
                          <p className="text-xs" style={{ color: forayColors.gray600 }}>Actions</p>
                        </div>
                        {anchorResult.foray.component_summary.attestations > 0 && (
                          <div className="p-3 rounded-lg text-center" style={{ backgroundColor: '#8B5CF610' }}>
                            <p className="text-2xl font-bold" style={{ color: '#8B5CF6' }}>{anchorResult.foray.component_summary.attestations}</p>
                            <p className="text-xs" style={{ color: forayColors.gray600 }}>Attestations</p>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    {/* Metadata */}
                    <div className="p-3 rounded-lg text-xs" style={{ backgroundColor: forayColors.bgLight }}>
                      <div className="flex justify-between">
                        <span style={{ color: forayColors.gray600 }}>Network:</span>
                        <span className="font-medium">{anchorResult.network}</span>
                      </div>
                      <div className="flex justify-between mt-1">
                        <span style={{ color: forayColors.gray600 }}>Anchored By:</span>
                        <span className="font-medium">{anchorResult.anchored_by}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Footer Actions */}
                  <div className="p-4 border-t flex gap-3 no-print" style={{ borderColor: forayColors.gray400 }}>
                    <a 
                      href={anchorResult.kaspa.explorer_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex-1 px-4 py-2.5 rounded-lg font-medium flex items-center justify-center gap-2"
                      style={{ backgroundColor: forayColors.primaryTeal, color: 'white' }}
                    >
                      <Link2 className="w-4 h-4" /> View on Explorer
                    </a>
                    <button 
                      onClick={copyAnchorDetails}
                      className="flex-1 px-4 py-2.5 rounded-lg font-medium flex items-center justify-center gap-2"
                      style={{ backgroundColor: forayColors.bgLight, color: forayColors.gray600, border: `1px solid ${forayColors.gray400}` }}
                    >
                      Copy Details
                    </button>
                    <button 
                      onClick={handlePrintAnchorResult}
                      className="flex-1 px-4 py-2.5 rounded-lg font-medium text-white flex items-center justify-center gap-2"
                      style={{ backgroundColor: forayColors.secondaryNavy }}
                    >
                      <Printer className="w-4 h-4" /> Print / Save PDF
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    // Render
    ReactDOM.render(<ForayTransactionReviewV41 />, document.getElementById('root'));
  </script>
</body>
</html>
